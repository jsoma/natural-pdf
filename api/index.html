
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A more intuitive interface for working with PDFs">
      
      
      
        <link rel="canonical" href="https://jsoma.github.io/natural-pdf/api/">
      
      
        <link rel="prev" href="../finetuning/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>API Reference - Natural PDF</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CSFMono-Regular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"SFMono-Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Natural PDF" class="md-header__button md-logo" aria-label="Natural PDF" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Natural PDF
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jsoma/natural-pdf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jsoma/natural-pdf
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Natural PDF" class="md-nav__button md-logo" aria-label="Natural PDF" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Natural PDF
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jsoma/natural-pdf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    jsoma/natural-pdf
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../installation/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/01-loading-and-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loading and Basic Text Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/02-finding-elements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finding Specific Elements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/03-extracting-blocks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extracting Text Blocks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/04-table-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Table Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/05-excluding-content/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Excluding Content (Headers/Footers)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/06-document-qa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Question Answering (QA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/07-layout-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Layout Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/07-working-with-regions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Regions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/08-spatial-navigation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spatial Navigation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/09-section-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Section Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/10-form-field-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Form Field Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/11-enhanced-table-processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enhanced Table Processing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/12-ocr-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCR Integration for Scanned Documents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/13-semantic-search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Semantic Search Across Multiple Documents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/14-categorizing-documents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Categorizing documents
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../ocr/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../text-extraction/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Text Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extracting-clean-text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clean Text Without Headers/Footers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fix-messy-tables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fix Messy Tables
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Tables Out of PDFs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../process-forms-and-invoices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extract from Forms/Invoices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Structured Data Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../document-qa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Question Answering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../categorizing-documents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Categorize Documents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../element-selection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finding What You Need in PDFs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pdf-navigation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Navigation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../layout-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Layout Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../regions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Regions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../visual-debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visual Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../interactive-widget/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Extra fun features
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Extra fun features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../describe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Describe Functionality
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../loops-and-groups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loops, groups and repetitive tasks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../text-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reflowing-pages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Restructuring page content
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCR Fine-tuning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Core Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf" class="md-nav__link">
    <span class="md-ellipsis">
      natural_pdf
    </span>
  </a>
  
    <nav class="md-nav" aria-label="natural_pdf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf.ConfigSection" class="md-nav__link">
    <span class="md-ellipsis">
      ConfigSection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Options" class="md-nav__link">
    <span class="md-ellipsis">
      Options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.PDF" class="md-nav__link">
    <span class="md-ellipsis">
      PDF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PDF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf.PDF-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.PDF-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Page" class="md-nav__link">
    <span class="md-ellipsis">
      Page
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Page-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Page-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region" class="md-nav__link">
    <span class="md-ellipsis">
      Region
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Region">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.apply_custom_ocr--using-with-an-llm" class="md-nav__link">
    <span class="md-ellipsis">
      Using with an LLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.apply_custom_ocr--using-with-a-custom-ocr-service" class="md-nav__link">
    <span class="md-ellipsis">
      Using with a custom OCR service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.apply_ocr--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.apply_ocr--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.clip--clip-to-another-regions-bounds" class="md-nav__link">
    <span class="md-ellipsis">
      Clip to another region's bounds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.clip--clip-to-any-elements-bounds" class="md-nav__link">
    <span class="md-ellipsis">
      Clip to any element's bounds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.clip--clip-to-specific-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      Clip to specific coordinates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.clip--mix-object-bounds-with-specific-overrides" class="md-nav__link">
    <span class="md-ellipsis">
      Mix object bounds with specific overrides
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.trim--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf.Region.trim--examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#natural_pdf-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#natural_pdf.configure_logging" class="md-nav__link">
    <span class="md-ellipsis">
      configure_logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<p>This section provides detailed documentation for all the classes and methods in Natural PDF.</p>
<h2 id="core-classes">Core Classes</h2>


<div class="doc doc-object doc-module">



<h3 id="natural_pdf" class="doc doc-heading">
            <code>natural_pdf</code>


</h3>

    <div class="doc doc-contents first">

        <p>Natural PDF - A more intuitive interface for working with PDFs.</p>









  <div class="doc doc-children">






<h4 id="natural_pdf-classes">Classes</h4>

<div class="doc doc-object doc-class">



<h5 id="natural_pdf.ConfigSection" class="doc doc-heading">
            <code>natural_pdf.ConfigSection</code>


</h5>


    <div class="doc doc-contents ">


        <p>A configuration section that holds key-value option pairs.</p>







              <details class="quote">
                <summary>Source code in <code>natural_pdf/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ConfigSection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A configuration section that holds key-value option pairs.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="natural_pdf.Options" class="doc doc-heading">
            <code>natural_pdf.Options</code>


</h5>


    <div class="doc doc-contents ">


        <p>Global options for natural-pdf, similar to pandas options.</p>







              <details class="quote">
                <summary>Source code in <code>natural_pdf/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Options</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Global options for natural-pdf, similar to pandas options.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Image rendering defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ConfigSection</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

        <span class="c1"># OCR defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ocr</span> <span class="o">=</span> <span class="n">ConfigSection</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;easyocr&quot;</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;en&quot;</span><span class="p">],</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Text extraction defaults (empty for now)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ConfigSection</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="natural_pdf.PDF" class="doc doc-heading">
            <code>natural_pdf.PDF</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="natural_pdf.extraction.mixin.ExtractionMixin">ExtractionMixin</span></code>, <code><span title="natural_pdf.export.mixin.ExportMixin">ExportMixin</span></code>, <code><span title="natural_pdf.classification.mixin.ClassificationMixin">ClassificationMixin</span></code></p>


        <p>Enhanced PDF wrapper built on top of pdfplumber.</p>
<p>This class provides a fluent interface for working with PDF documents,
with improved selection, navigation, and extraction capabilities. It integrates
OCR, layout analysis, and AI-powered data extraction features while maintaining
compatibility with the underlying pdfplumber API.</p>
<p>The PDF class supports loading from files, URLs, or streams, and provides
spatial navigation, element selection with CSS-like selectors, and advanced
document processing workflows including multi-page content flows.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.PDF.pages

  
      property
   (natural_pdf.PDF.pages)" href="#natural_pdf.PDF.pages">pages</a></code></td>
            <td>
                  <code><span title="PageCollection">PageCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lazy-loaded list of Page objects for document pages.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.PDF.path">path</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolved path to the PDF file or source identifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.PDF.source_path">source_path</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original path, URL, or stream identifier provided during initialization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.PDF.highlighter">highlighter</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Service for rendering highlighted visualizations of document content.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Basic usage:
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npdf</span>

<span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">text_elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;Summary&quot;)&#39;</span><span class="p">)</span>
</code></pre></div></p>
<p>Advanced usage with OCR:
<div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;scanned_document.pdf&quot;</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;easyocr&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">144</span><span class="p">)</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
</code></pre></div></p>
</details>






              <details class="quote">
                <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PDF</span><span class="p">(</span><span class="n">ExtractionMixin</span><span class="p">,</span> <span class="n">ExportMixin</span><span class="p">,</span> <span class="n">ClassificationMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced PDF wrapper built on top of pdfplumber.</span>

<span class="sd">    This class provides a fluent interface for working with PDF documents,</span>
<span class="sd">    with improved selection, navigation, and extraction capabilities. It integrates</span>
<span class="sd">    OCR, layout analysis, and AI-powered data extraction features while maintaining</span>
<span class="sd">    compatibility with the underlying pdfplumber API.</span>

<span class="sd">    The PDF class supports loading from files, URLs, or streams, and provides</span>
<span class="sd">    spatial navigation, element selection with CSS-like selectors, and advanced</span>
<span class="sd">    document processing workflows including multi-page content flows.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pages: Lazy-loaded list of Page objects for document pages.</span>
<span class="sd">        path: Resolved path to the PDF file or source identifier.</span>
<span class="sd">        source_path: Original path, URL, or stream identifier provided during initialization.</span>
<span class="sd">        highlighter: Service for rendering highlighted visualizations of document content.</span>

<span class="sd">    Example:</span>
<span class="sd">        Basic usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        import natural_pdf as npdf</span>

<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        page = pdf.pages[0]</span>
<span class="sd">        text_elements = page.find_all(&#39;text:contains(&quot;Summary&quot;)&#39;)</span>
<span class="sd">        ```</span>

<span class="sd">        Advanced usage with OCR:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;scanned_document.pdf&quot;)</span>
<span class="sd">        pdf.apply_ocr(engine=&quot;easyocr&quot;, resolution=144)</span>
<span class="sd">        tables = pdf.pages[0].find_all(&#39;table&#39;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_or_url_or_stream</span><span class="p">,</span>
        <span class="n">reading_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">font_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_spaces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">text_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_text_tolerance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">text_layer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the enhanced PDF object.</span>

<span class="sd">        Args:</span>
<span class="sd">            path_or_url_or_stream: Path to the PDF file (str/Path), a URL (str),</span>
<span class="sd">                or a file-like object (stream). URLs must start with &#39;http://&#39; or &#39;https://&#39;.</span>
<span class="sd">            reading_order: If True, use natural reading order for text extraction.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            font_attrs: List of font attributes for grouping characters into words.</span>
<span class="sd">                Common attributes include [&#39;fontname&#39;, &#39;size&#39;]. Defaults to None.</span>
<span class="sd">            keep_spaces: If True, include spaces in word elements during text extraction.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            text_tolerance: PDFplumber-style tolerance settings for text grouping.</span>
<span class="sd">                Dictionary with keys like &#39;x_tolerance&#39;, &#39;y_tolerance&#39;. Defaults to None.</span>
<span class="sd">            auto_text_tolerance: If True, automatically scale text tolerance based on</span>
<span class="sd">                font size and document characteristics. Defaults to True.</span>
<span class="sd">            text_layer: If True, preserve existing text layer from the PDF. If False,</span>
<span class="sd">                removes all existing text elements during initialization, useful for</span>
<span class="sd">                OCR-only workflows. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If path_or_url_or_stream is not a valid type.</span>
<span class="sd">            IOError: If the PDF file cannot be opened or read.</span>
<span class="sd">            ValueError: If URL download fails.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # From file path</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>

<span class="sd">            # From URL</span>
<span class="sd">            pdf = npdf.PDF(&quot;https://example.com/document.pdf&quot;)</span>

<span class="sd">            # From stream</span>
<span class="sd">            with open(&quot;document.pdf&quot;, &quot;rb&quot;) as f:</span>
<span class="sd">                pdf = npdf.PDF(f)</span>

<span class="sd">            # With custom settings</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;,</span>
<span class="sd">                          reading_order=False,</span>
<span class="sd">                          text_layer=False,  # For OCR-only processing</span>
<span class="sd">                          font_attrs=[&#39;fontname&#39;, &#39;size&#39;, &#39;flags&#39;])</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_path_or_stream</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span> <span class="o">=</span> <span class="n">text_layer</span>
        <span class="n">stream_to_open</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s file-like</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing PDF from in-memory stream.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No resolved file path for streams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="s2">&quot;&lt;stream&gt;&quot;</span>  <span class="c1"># Identifier for source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>  <span class="c1"># Use source identifier as path for streams</span>
            <span class="n">stream_to_open</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">):</span>
                    <span class="c1"># If caller provided an in-memory binary stream, capture bytes for potential re-export</span>
                    <span class="n">current_pos</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_original_bytes</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">current_pos</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">path_or_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">path_or_url</span>  <span class="c1"># Store original path/URL as source</span>
            <span class="n">is_url</span> <span class="o">=</span> <span class="n">path_or_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path_or_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading PDF from URL: </span><span class="si">{</span><span class="n">path_or_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">path_or_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="c1"># Load directly into an in-memory buffer  no temp file needed</span>
                    <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No on-disk temp file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="n">path_or_url</span>  <span class="c1"># For repr / get_id purposes</span>
                    <span class="n">stream_to_open</span> <span class="o">=</span> <span class="n">buffer</span>  <span class="c1"># pdfplumber accepts file-like objects</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download PDF from URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download PDF from URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path_or_url</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>  <span class="c1"># Resolve local paths</span>
                <span class="n">stream_to_open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span>  <span class="c1"># Use resolved path for file-based PDFs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid input type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected path (str/Path), URL (str), or file-like object.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening PDF source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Parameters: reading_order=</span><span class="si">{</span><span class="n">reading_order</span><span class="si">}</span><span class="s2">, font_attrs=</span><span class="si">{</span><span class="n">font_attrs</span><span class="si">}</span><span class="s2">, keep_spaces=</span><span class="si">{</span><span class="n">keep_spaces</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="o">=</span> <span class="n">pdfplumber</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream_to_open</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Attempt cleanup if opening fails</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open PDF source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Store configuration used for initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reading_order</span> <span class="o">=</span> <span class="n">reading_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keep_spaces&quot;</span><span class="p">:</span> <span class="n">keep_spaces</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_font_attrs</span> <span class="o">=</span> <span class="n">font_attrs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="n">OCRManager</span><span class="p">()</span> <span class="k">if</span> <span class="n">OCRManager</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="n">LayoutManager</span><span class="p">()</span> <span class="k">if</span> <span class="n">LayoutManager</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlighter</span> <span class="o">=</span> <span class="n">HighlightingService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># self._classification_manager_instance = ClassificationManager() # Removed this line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager_registry</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Lazily instantiate pages only when accessed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="n">_LazyPageList</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="n">font_attrs</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_element_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&#39; initialized with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_managers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_highlighter</span><span class="p">()</span>

        <span class="c1"># Remove text layer if requested</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing text layer as requested (text_layer=False)&quot;</span><span class="p">)</span>
            <span class="c1"># Text layer is not loaded when text_layer=False, so no need to remove</span>
            <span class="k">pass</span>

        <span class="c1"># Analysis results accessed via self.analyses property (see below)</span>

        <span class="c1"># --- Automatic cleanup when object is garbage-collected ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">PDF</span><span class="o">.</span><span class="n">_finalize_cleanup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_temp_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># --- Text tolerance settings ------------------------------------</span>
        <span class="c1"># Users can pass pdfplumber-style keys (x_tolerance, x_tolerance_ratio,</span>
        <span class="c1"># y_tolerance, etc.) via *text_tolerance*.  We also keep a flag that</span>
        <span class="c1"># enables automatic tolerance scaling when explicit values are not</span>
        <span class="c1"># supplied.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;auto_text_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_text_tolerance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text_tolerance</span><span class="p">:</span>
            <span class="c1"># Only copy recognised primitives (numbers / None); ignore junk.</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x_tolerance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x_tolerance_ratio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;keep_blank_chars&quot;</span><span class="p">,</span>  <span class="c1"># passthrough convenience</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">text_tolerance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up manager factories for lazy instantiation.&quot;&quot;&quot;</span>
        <span class="c1"># Store factories/classes for each manager key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager_factories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DEFAULT_MANAGERS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Will hold instantiated managers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a manager instance by its key, instantiating it lazily if needed.</span>

<span class="sd">        Managers are specialized components that handle specific functionality like</span>
<span class="sd">        classification, structured data extraction, or OCR processing. They are</span>
<span class="sd">        instantiated on-demand to minimize memory usage and startup time.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: The manager key to retrieve. Common keys include &#39;classification&#39;</span>
<span class="sd">                and &#39;structured_data&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The manager instance for the specified key.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If no manager is registered for the given key.</span>
<span class="sd">            RuntimeError: If the manager failed to initialize.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">            classification_mgr = pdf.get_manager(&#39;classification&#39;)</span>
<span class="sd">            structured_data_mgr = pdf.get_manager(&#39;structured_data&#39;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if already instantiated</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">:</span>
            <span class="n">manager_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">manager_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manager &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; failed to initialize previously.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">manager_instance</span>

        <span class="c1"># Not instantiated yet: get factory/class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_manager_factories&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager_factories</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No manager registered for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;. Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_manager_factories&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">factory_or_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager_factories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">factory_or_class</span>
            <span class="c1"># If it&#39;s a callable that&#39;s not a class, call it to get the class/instance</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
                <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolved</span><span class="p">()</span>
            <span class="c1"># If it&#39;s a class, instantiate it</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">resolved</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">resolved</span>  <span class="c1"># Already an instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="k">return</span> <span class="n">instance</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize manager for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manager &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; failed to initialize: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_highlighter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Access PDF metadata as a dictionary.</span>

<span class="sd">        Returns document metadata such as title, author, creation date, and other</span>
<span class="sd">        properties embedded in the PDF file. The exact keys available depend on</span>
<span class="sd">        what metadata was included when the PDF was created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing PDF metadata. Common keys include &#39;Title&#39;,</span>
<span class="sd">            &#39;Author&#39;, &#39;Subject&#39;, &#39;Creator&#39;, &#39;Producer&#39;, &#39;CreationDate&#39;, and</span>
<span class="sd">            &#39;ModDate&#39;. May be empty if no metadata is available.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">            print(pdf.metadata.get(&#39;Title&#39;, &#39;No title&#39;))</span>
<span class="sd">            print(f&quot;Created: {pdf.metadata.get(&#39;CreationDate&#39;)}&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PageCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Access pages as a PageCollection object.</span>

<span class="sd">        Provides access to individual pages of the PDF document through a</span>
<span class="sd">        collection interface that supports indexing, slicing, and iteration.</span>
<span class="sd">        Pages are lazy-loaded to minimize memory usage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PageCollection object that provides list-like access to PDF pages.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If PDF pages are not yet initialized.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>

<span class="sd">            # Access individual pages</span>
<span class="sd">            first_page = pdf.pages[0]</span>
<span class="sd">            last_page = pdf.pages[-1]</span>

<span class="sd">            # Slice pages</span>
<span class="sd">            first_three = pdf.pages[0:3]</span>

<span class="sd">            # Iterate over pages</span>
<span class="sd">            for page in pdf.pages:</span>
<span class="sd">                print(f&quot;Page {page.index} has {len(page.chars)} characters&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PageCollection</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PageCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all exclusion functions from the PDF.</span>

<span class="sd">        Removes all previously added exclusion functions that were used to filter</span>
<span class="sd">        out unwanted content (like headers, footers, or administrative text) from</span>
<span class="sd">        text extraction and analysis operations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If PDF pages are not yet initialized.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">            pdf.add_exclusion(lambda page: page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;).above())</span>

<span class="sd">            # Later, remove all exclusions</span>
<span class="sd">            pdf.clear_exclusions()</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">clear_exclusions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_exclusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exclusion_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]],</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an exclusion function to the PDF.</span>

<span class="sd">        Exclusion functions define regions of each page that should be ignored during</span>
<span class="sd">        text extraction and analysis operations. This is useful for filtering out headers,</span>
<span class="sd">        footers, watermarks, or other administrative content that shouldn&#39;t be included</span>
<span class="sd">        in the main document processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            exclusion_func: A function that takes a Page object and returns a Region</span>
<span class="sd">                to exclude from processing, or None if no exclusion should be applied</span>
<span class="sd">                to that page. The function is called once per page.</span>
<span class="sd">            label: Optional descriptive label for this exclusion rule, useful for</span>
<span class="sd">                debugging and identification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError: If PDF pages are not yet initialized.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>

<span class="sd">            # Exclude headers (top 50 points of each page)</span>
<span class="sd">            pdf.add_exclusion(</span>
<span class="sd">                lambda page: page.region(0, 0, page.width, 50),</span>
<span class="sd">                label=&quot;header_exclusion&quot;</span>
<span class="sd">            )</span>

<span class="sd">            # Exclude any text containing &quot;CONFIDENTIAL&quot;</span>
<span class="sd">            pdf.add_exclusion(</span>
<span class="sd">                lambda page: page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;).above(include_source=True)</span>
<span class="sd">                if page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;) else None,</span>
<span class="sd">                label=&quot;confidential_exclusion&quot;</span>
<span class="sd">            )</span>

<span class="sd">            # Chain multiple exclusions</span>
<span class="sd">            pdf.add_exclusion(header_func).add_exclusion(footer_func)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion_data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">exclusion_func</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">detect_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply OCR to specified pages of the PDF using batch processing.</span>

<span class="sd">        Performs optical character recognition on the specified pages, converting</span>
<span class="sd">        image-based text into searchable and extractable text elements. This method</span>
<span class="sd">        supports multiple OCR engines and provides batch processing for efficiency.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine: Name of the OCR engine to use. Supported engines include</span>
<span class="sd">                &#39;easyocr&#39; (default), &#39;surya&#39;, &#39;paddle&#39;, and &#39;doctr&#39;. If None,</span>
<span class="sd">                uses the global default from natural_pdf.options.ocr.engine.</span>
<span class="sd">            languages: List of language codes for OCR recognition (e.g., [&#39;en&#39;, &#39;es&#39;]).</span>
<span class="sd">                If None, uses the global default from natural_pdf.options.ocr.languages.</span>
<span class="sd">            min_confidence: Minimum confidence threshold (0.0-1.0) for accepting</span>
<span class="sd">                OCR results. Text with lower confidence will be filtered out.</span>
<span class="sd">                If None, uses the global default.</span>
<span class="sd">            device: Device to run OCR on (&#39;cpu&#39;, &#39;cuda&#39;, &#39;mps&#39;). Engine-specific</span>
<span class="sd">                availability varies. If None, uses engine defaults.</span>
<span class="sd">            resolution: DPI resolution for rendering pages to images before OCR.</span>
<span class="sd">                Higher values improve accuracy but increase processing time and memory.</span>
<span class="sd">                Typical values: 150 (fast), 300 (balanced), 600 (high quality).</span>
<span class="sd">            apply_exclusions: If True, mask excluded regions before OCR to prevent</span>
<span class="sd">                processing of headers, footers, or other unwanted content.</span>
<span class="sd">            detect_only: If True, only detect text bounding boxes without performing</span>
<span class="sd">                character recognition. Useful for layout analysis workflows.</span>
<span class="sd">            replace: If True, replace any existing OCR elements on the pages.</span>
<span class="sd">                If False, append new OCR results to existing elements.</span>
<span class="sd">            options: Engine-specific options object (e.g., EasyOCROptions, SuryaOptions).</span>
<span class="sd">                Allows fine-tuning of engine behavior beyond common parameters.</span>
<span class="sd">            pages: Page indices to process. Can be:</span>
<span class="sd">                - None: Process all pages</span>
<span class="sd">                - slice: Process a range of pages (e.g., slice(0, 10))</span>
<span class="sd">                - Iterable[int]: Process specific page indices (e.g., [0, 2, 5])</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If invalid page index is provided.</span>
<span class="sd">            TypeError: If pages parameter has invalid type.</span>
<span class="sd">            RuntimeError: If OCR engine is not available or fails.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;scanned_document.pdf&quot;)</span>

<span class="sd">            # Basic OCR on all pages</span>
<span class="sd">            pdf.apply_ocr()</span>

<span class="sd">            # High-quality OCR with specific settings</span>
<span class="sd">            pdf.apply_ocr(</span>
<span class="sd">                engine=&#39;easyocr&#39;,</span>
<span class="sd">                languages=[&#39;en&#39;, &#39;es&#39;],</span>
<span class="sd">                resolution=300,</span>
<span class="sd">                min_confidence=0.8</span>
<span class="sd">            )</span>

<span class="sd">            # OCR specific pages only</span>
<span class="sd">            pdf.apply_ocr(pages=[0, 1, 2])  # First 3 pages</span>
<span class="sd">            pdf.apply_ocr(pages=slice(5, 10))  # Pages 5-9</span>

<span class="sd">            # Detection-only workflow for layout analysis</span>
<span class="sd">            pdf.apply_ocr(detect_only=True, resolution=150)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            OCR processing can be time and memory intensive, especially at high</span>
<span class="sd">            resolutions. Consider using exclusions to mask unwanted regions and</span>
<span class="sd">            processing pages in batches for large documents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OCRManager not available. Cannot apply OCR.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Apply global options as defaults, but allow explicit parameters to override</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="c1"># Use global OCR options if parameters are not explicitly set</span>
        <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">engine</span>
        <span class="k">if</span> <span class="n">languages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">languages</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">languages</span>
        <span class="k">if</span> <span class="n">min_confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_confidence</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">min_confidence</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># No default device in options.ocr anymore</span>

        <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] PDF.apply_ocr starting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid page index provided in &#39;pages&#39; iterable.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for OCR processing.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">page_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">number</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying batch OCR to pages: </span><span class="si">{</span><span class="n">page_numbers</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">resolution</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using OCR image resolution: </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI&quot;</span><span class="p">)</span>

        <span class="n">images_pil</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">page_image_map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages...&quot;</span><span class="p">)</span>
        <span class="n">failed_page_num</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">render_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">target_pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rendering pages&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
                <span class="n">failed_page_num</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rendering page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> (index </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
                <span class="n">to_image_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="n">final_resolution</span><span class="p">,</span>
                    <span class="s2">&quot;include_highlights&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;exclusions&quot;</span><span class="p">:</span> <span class="s2">&quot;mask&quot;</span> <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="o">**</span><span class="n">to_image_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                    <span class="k">continue</span>
                <span class="n">images_pil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">page_image_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">page</span><span class="p">,</span> <span class="n">img</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render pages for batch OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render pages for batch OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render page </span><span class="si">{</span><span class="n">failed_page_num</span><span class="si">}</span><span class="s2"> for OCR.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="n">render_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Finished rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">)</span><span class="si">}</span><span class="s2"> images (Duration: </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">render_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Finished rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">)</span><span class="si">}</span><span class="s2"> images (Duration: </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">render_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">images_pil</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">page_image_map</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No images were successfully rendered for batch OCR.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">images_pil</span><span class="p">,</span>
            <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
            <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">languages</span><span class="p">,</span>
            <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
            <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
            <span class="s2">&quot;detect_only&quot;</span><span class="p">:</span> <span class="n">detect_only</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">ocr_call_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;images&quot;</span><span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Calling OCR Manager with args: </span><span class="si">{</span><span class="n">ocr_call_args</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Calling OCR Manager with args: </span><span class="si">{</span><span class="n">ocr_call_args</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">ocr_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="n">batch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OCR Manager returned unexpected result format or length.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR Manager batch processing complete.&quot;</span><span class="p">)</span>

        <span class="n">ocr_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] OCR processing finished (Duration: </span><span class="si">{</span><span class="n">ocr_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ocr_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding OCR results to respective pages...&quot;</span><span class="p">)</span>
        <span class="n">total_elements_added</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">page_image_map</span><span class="p">):</span>
            <span class="n">results_for_page</span> <span class="o">=</span> <span class="n">batch_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skipping results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Expected list, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">)</span><span class="si">}</span><span class="s2"> results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_ocr_elements</span><span class="p">()</span>

                <span class="n">img_scale_x</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">img_scale_y</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">create_text_elements_from_ocr</span><span class="p">(</span>
                    <span class="n">results_for_page</span><span class="p">,</span> <span class="n">img_scale_x</span><span class="p">,</span> <span class="n">img_scale_y</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">elements</span><span class="p">:</span>
                    <span class="n">total_elements_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> OCR TextElements to page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No valid TextElements created for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error adding OCR elements to page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished adding OCR results. Total elements added: </span><span class="si">{</span><span class="n">total_elements_added</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_region</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">region_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a region function to the PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            region_func: A function that takes a Page and returns a Region, or None</span>
<span class="sd">            region_func: A function that takes a Page and returns a Region, or None</span>
<span class="sd">            name: Optional name for the region</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="n">region_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_func</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">region_instance</span> <span class="o">=</span> <span class="n">region_func</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">region_instance</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region_instance</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region_instance</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;named&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">region_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Region function did not return a valid Region for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding region for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the first element matching the selector OR text content across all pages.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional filter parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Element object or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

        <span class="c1"># Search page by page</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="c1"># Note: _apply_selector is on Page, so we call find directly here</span>
            <span class="c1"># We pass the constructed/validated effective_selector</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>  <span class="c1"># Use the processed selector</span>
                <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
                <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>  <span class="c1"># Pass down flags</span>
                <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">element</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Not found on any page</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all elements matching the selector OR text content across all pages.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional filter parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection with matching elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

        <span class="c1"># Instead of parsing here, let each page parse and apply</span>
        <span class="c1"># This avoids parsing the same selector multiple times if not needed</span>
        <span class="c1"># selector_obj = parse_selector(effective_selector)</span>

        <span class="c1"># kwargs[&quot;regex&quot;] = regex # Removed: Already passed explicitly</span>
        <span class="c1"># kwargs[&quot;case&quot;] = case   # Removed: Already passed explicitly</span>

        <span class="n">all_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="c1"># Call page.find_all with the effective selector and flags</span>
            <span class="n">page_elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>
                <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
                <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">page_elements</span><span class="p">:</span>
                <span class="n">all_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page_elements</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract text from the entire document or matching elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: Optional selector to filter elements</span>
<span class="sd">            preserve_whitespace: Whether to keep blank characters</span>
<span class="sd">            use_exclusions: Whether to apply exclusion regions</span>
<span class="sd">            debug_exclusions: Whether to output detailed debugging for exclusions</span>
<span class="sd">            preserve_whitespace: Whether to keep blank characters</span>
<span class="sd">            use_exclusions: Whether to apply exclusion regions</span>
<span class="sd">            debug_exclusions: Whether to output detailed debugging for exclusions</span>
<span class="sd">            **kwargs: Additional extraction parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Extracted text as string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">use_exclusions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">preserve_whitespace</span><span class="o">=</span><span class="n">preserve_whitespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Extracting text with exclusions from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span><span class="si">}</span><span class="s2"> document-level exclusions&quot;</span><span class="p">)</span>

        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
                    <span class="n">preserve_whitespace</span><span class="o">=</span><span class="n">preserve_whitespace</span><span class="p">,</span>
                    <span class="n">use_exclusions</span><span class="o">=</span><span class="n">use_exclusions</span><span class="p">,</span>
                    <span class="n">debug_exclusions</span><span class="o">=</span><span class="n">debug_exclusions</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Combined </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages of text&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">merge_across_pages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract tables from the document or matching elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: Optional selector to filter tables</span>
<span class="sd">            merge_across_pages: Whether to merge tables that span across pages</span>
<span class="sd">            **kwargs: Additional extraction parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of extracted tables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PDF.extract_tables is not fully implemented yet.&quot;</span><span class="p">)</span>
        <span class="n">all_tables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;extract_tables&quot;</span><span class="p">):</span>
                <span class="n">all_tables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> does not have extract_tables method.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Filtering extracted tables by selector is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">merge_across_pages</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Merging tables across pages is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_tables</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_searchable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Path&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: Use save_pdf(..., ocr=True) instead.</span>
<span class="sd">        Saves the PDF with an OCR text layer, making content searchable.</span>

<span class="sd">        Requires optional dependencies. Install with: pip install \&quot;natural-pdf[ocr-export]\&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path: Path to save the searchable PDF</span>
<span class="sd">            dpi: Resolution for rendering and OCR overlay</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the exporter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;PDF.save_searchable() is deprecated. Use PDF.save_pdf(..., ocr=True) instead.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">create_searchable_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Saving searchable PDF requires &#39;pikepdf&#39;. &quot;</span>
                <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ocr-export]&quot;&#39;</span>
            <span class="p">)</span>
        <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="c1"># Call the exporter directly, passing self (the PDF instance)</span>
        <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Logger info is handled within the exporter now</span>
        <span class="c1"># logger.info(f&quot;Searchable PDF saved to: {output_path_str}&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_pdf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the PDF object (all its pages) to a new file.</span>

<span class="sd">        Choose one saving mode:</span>
<span class="sd">        - `ocr=True`: Creates a new, image-based PDF using OCR results from all pages.</span>
<span class="sd">          Text generated during the natural-pdf session becomes searchable,</span>
<span class="sd">          but original vector content is lost. Requires &#39;ocr-export&#39; extras.</span>
<span class="sd">        - `original=True`: Saves a copy of the original PDF file this object represents.</span>
<span class="sd">          Any OCR results or analyses from the natural-pdf session are NOT included.</span>
<span class="sd">          If the PDF was opened from an in-memory buffer, this mode may not be suitable.</span>
<span class="sd">          Requires &#39;ocr-export&#39; extras.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path: Path to save the new PDF file.</span>
<span class="sd">            ocr: If True, save as a searchable, image-based PDF using OCR data.</span>
<span class="sd">            original: If True, save the original source PDF content.</span>
<span class="sd">            dpi: Resolution (dots per inch) used only when ocr=True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the PDF has no pages, if neither or both &#39;ocr&#39;</span>
<span class="sd">                        and &#39;original&#39; are True.</span>
<span class="sd">            ImportError: If required libraries are not installed for the chosen mode.</span>
<span class="sd">            RuntimeError: If an unexpected error occurs during saving.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot save an empty PDF object.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ocr</span> <span class="o">^</span> <span class="n">original</span><span class="p">):</span>  <span class="c1"># XOR: exactly one must be true</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exactly one of &#39;ocr&#39; or &#39;original&#39; must be True.&quot;</span><span class="p">)</span>

        <span class="n">output_path_obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path_obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ocr</span><span class="p">:</span>
            <span class="n">has_vector_elements</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;rects&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">rects</span>
                    <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">lines</span>
                    <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;curves&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">curves</span>
                    <span class="ow">or</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;chars&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">has_vector_elements</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">has_vector_elements</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: Saving with ocr=True creates an image-based PDF. &quot;</span>
                    <span class="s2">&quot;Original vector elements (rects, lines, non-OCR text/chars) &quot;</span>
                    <span class="s2">&quot;will not be preserved in the output file.&quot;</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving searchable PDF (OCR text layer) to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Delegate to the searchable PDF exporter, passing self (PDF instance)</span>
                <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create searchable PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">elif</span> <span class="n">original</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create_original_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;Saving with original=True requires &#39;pikepdf&#39;. &quot;</span>
                    <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ocr-export]&quot;&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Optional: Add warning about losing OCR data similar to PageCollection</span>
            <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;find_all&quot;</span><span class="p">):</span>
                    <span class="n">ocr_text_elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ocr_text_elements</span><span class="p">:</span>
                        <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">):</span>  <span class="c1"># Fallback</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
                        <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">has_ocr_elements</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: Saving with original=True preserves original page content. &quot;</span>
                    <span class="s2">&quot;OCR text generated in this session will not be included in the saved file.&quot;</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving original PDF content to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Delegate to the original PDF exporter, passing self (PDF instance)</span>
                <span class="n">create_original_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Re-raise exception from exporter</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;extractive&quot;</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask a single question about the document content.</span>

<span class="sd">        Args:</span>
<span class="sd">            question: Question string to ask about the document</span>
<span class="sd">            mode: &quot;extractive&quot; to extract answer from document, &quot;generative&quot; to generate</span>
<span class="sd">            pages: Specific pages to query (default: all pages)</span>
<span class="sd">            min_confidence: Minimum confidence threshold for answers</span>
<span class="sd">            model: Optional model name for question answering</span>
<span class="sd">            **kwargs: Additional parameters passed to the QA engine</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict containing: answer, confidence, found, page_num, source_elements, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Delegate to ask_batch and return the first result</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_batch</span><span class="p">([</span><span class="n">question</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="n">pages</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ask_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;extractive&quot;</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask multiple questions about the document content using batch processing.</span>

<span class="sd">        This method processes multiple questions efficiently in a single batch,</span>
<span class="sd">        avoiding the multiprocessing resource accumulation that can occur with</span>
<span class="sd">        sequential individual question calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            questions: List of question strings to ask about the document</span>
<span class="sd">            mode: &quot;extractive&quot; to extract answer from document, &quot;generative&quot; to generate</span>
<span class="sd">            pages: Specific pages to query (default: all pages)</span>
<span class="sd">            min_confidence: Minimum confidence threshold for answers</span>
<span class="sd">            model: Optional model name for question answering</span>
<span class="sd">            **kwargs: Additional parameters passed to the QA engine</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Dicts, each containing: answer, confidence, found, page_num, source_elements, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;questions&#39; must be a list of strings&quot;</span><span class="p">)</span>

        <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">()</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Resolve target pages</span>
        <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pages</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">page_idx</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                    <span class="n">target_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_idx</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2"> out of range, skipping&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid pages parameter: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid pages found for QA processing.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">questions</span>
            <span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="si">}</span><span class="s2"> question(s) across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> page(s) using batch QA...&quot;</span><span class="p">)</span>

        <span class="c1"># Collect all page images and metadata for batch processing</span>
        <span class="n">page_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">page_word_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">page_metadata</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="c1"># Get page image</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page_image</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">page_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render image for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">, skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Get text elements for word boxes</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No text elements found on page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">word_boxes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">word_boxes</span> <span class="o">=</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">_get_word_boxes_from_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">offset_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset_y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">page_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_image</span><span class="p">)</span>
                <span class="n">page_word_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_boxes</span><span class="p">)</span>
                <span class="n">page_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                    <span class="s2">&quot;page_object&quot;</span><span class="p">:</span> <span class="n">page</span>
                <span class="p">})</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">page_images</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No page images could be processed for QA.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">questions</span>
            <span class="p">]</span>

        <span class="c1"># Process all questions against all pages in batch</span>
        <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">question_text</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
            <span class="n">question_results</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Ask this question against each page (but in batch per page)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">page_image</span><span class="p">,</span> <span class="n">word_boxes</span><span class="p">,</span> <span class="n">page_meta</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">page_images</span><span class="p">,</span> <span class="n">page_word_boxes</span><span class="p">,</span> <span class="n">page_metadata</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use the DocumentQA batch interface </span>
                    <span class="n">page_result</span> <span class="o">=</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                        <span class="n">image</span><span class="o">=</span><span class="n">page_image</span><span class="p">,</span>
                        <span class="n">question</span><span class="o">=</span><span class="n">question_text</span><span class="p">,</span>
                        <span class="n">word_boxes</span><span class="o">=</span><span class="n">word_boxes</span><span class="p">,</span>
                        <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">page_result</span> <span class="ow">and</span> <span class="n">page_result</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
                        <span class="c1"># Add page metadata to result</span>
                        <span class="n">page_result_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span>
                            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
                            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">found</span><span class="p">,</span>
                            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="n">page_meta</span><span class="p">[</span><span class="s2">&quot;page_number&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;source_elements&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                            <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                        <span class="p">}</span>
                        <span class="n">question_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_result_dict</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing question &#39;</span><span class="si">{</span><span class="n">question_text</span><span class="si">}</span><span class="s2">&#39; on page </span><span class="si">{</span><span class="n">page_meta</span><span class="p">[</span><span class="s1">&#39;page_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># Sort results by confidence and take the best one for this question</span>
            <span class="n">question_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">question_results</span><span class="p">:</span>
                <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No results found for this question</span>
                <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">all_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_within_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s2">&quot;Region&quot;</span><span class="p">],</span>
        <span class="n">search_service</span><span class="p">:</span> <span class="s2">&quot;SearchServiceProtocol&quot;</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;SearchOptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds relevant documents from this PDF within a search index.</span>
<span class="sd">        Finds relevant documents from this PDF within a search index.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: The search query (text, image path, PIL Image, Region)</span>
<span class="sd">            search_service: A pre-configured SearchService instance</span>
<span class="sd">            options: Optional SearchOptions to configure the query</span>
<span class="sd">            query: The search query (text, image path, PIL Image, Region)</span>
<span class="sd">            search_service: A pre-configured SearchService instance</span>
<span class="sd">            options: Optional SearchOptions to configure the query</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of result dictionaries, sorted by relevance</span>
<span class="sd">            A list of result dictionaries, sorted by relevance</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If search dependencies are not installed</span>
<span class="sd">            ValueError: If search_service is None</span>
<span class="sd">            TypeError: If search_service does not conform to the protocol</span>
<span class="sd">            FileNotFoundError: If the collection managed by the service does not exist</span>
<span class="sd">            RuntimeError: For other search failures</span>
<span class="sd">            ImportError: If search dependencies are not installed</span>
<span class="sd">            ValueError: If search_service is None</span>
<span class="sd">            TypeError: If search_service does not conform to the protocol</span>
<span class="sd">            FileNotFoundError: If the collection managed by the service does not exist</span>
<span class="sd">            RuntimeError: For other search failures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search_service</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A configured SearchServiceProtocol instance must be provided.&quot;</span><span class="p">)</span>

        <span class="n">collection_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">search_service</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;Unknown Collection&gt;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Searching within index &#39;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&#39; for content from PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

        <span class="n">service</span> <span class="o">=</span> <span class="n">search_service</span>

        <span class="n">query_input</span> <span class="o">=</span> <span class="n">query</span>
        <span class="n">effective_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">TextSearchOptions</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query is a Region object. Extracting text.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="p">,</span> <span class="n">TextSearchOptions</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Querying with Region image requires MultiModalSearchOptions. Falling back to text extraction.&quot;</span>
                <span class="p">)</span>
            <span class="n">query_input</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query_input</span> <span class="ow">or</span> <span class="n">query_input</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Region has no extractable text for query.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Add filter to scope search to THIS PDF</span>
        <span class="c1"># Add filter to scope search to THIS PDF</span>
        <span class="n">pdf_scope_filter</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;pdf_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying filter to scope search to PDF: </span><span class="si">{</span><span class="n">pdf_scope_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Combine with existing filters in options (if any)</span>
        <span class="k">if</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining PDF scope filter with existing filters&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operator&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AND&quot;</span>
            <span class="p">):</span>
                <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf_scope_filter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">+</span> <span class="p">[</span><span class="n">pdf_scope_filter</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="n">pdf_scope_filter</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported format for existing filters. Overwriting with PDF scope filter.&quot;</span>
                <span class="p">)</span>
                <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">pdf_scope_filter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">pdf_scope_filter</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final filters for service search: </span><span class="si">{</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query_input</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">effective_options</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results from PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">fnf</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search failed: Collection not found. Error: </span><span class="si">{</span><span class="n">fnf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search failed: Collection not found. Error: </span><span class="si">{</span><span class="n">fnf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search within index failed. See logs for details.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search within index failed. See logs for details.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export_ocr_correction_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports OCR results from this PDF into a correction task package.</span>
<span class="sd">        Exports OCR results from this PDF into a correction task package.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_zip_path: The path to save the output zip file</span>
<span class="sd">            output_zip_path: The path to save the output zip file</span>
<span class="sd">            **kwargs: Additional arguments passed to create_correction_task_package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.utils.packaging</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_correction_task_package</span>

            <span class="n">create_correction_task_package</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_zip_path</span><span class="o">=</span><span class="n">output_zip_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to import &#39;create_correction_task_package&#39;. Packaging utility might be missing.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to import &#39;create_correction_task_package&#39;. Packaging utility might be missing.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to export correction task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to export correction task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies corrections to OCR text elements using a callback function.</span>
<span class="sd">        Applies corrections to OCR text elements using a callback function.</span>

<span class="sd">        Args:</span>
<span class="sd">            correction_callback: Function that takes an element and returns corrected text or None</span>
<span class="sd">            correction_callback: Function that takes an element and returns corrected text or None</span>
<span class="sd">            pages: Optional page indices/slice to limit the scope of correction</span>
<span class="sd">            max_workers: Maximum number of threads to use for parallel execution</span>
<span class="sd">            progress_callback: Optional callback function for progress updates</span>
<span class="sd">            max_workers: Maximum number of threads to use for parallel execution</span>
<span class="sd">            progress_callback: Optional callback function for progress updates</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_page_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">target_page_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">pages</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">target_page_indices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid page index in &#39;pages&#39;: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid page index in &#39;pages&#39;: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_page_indices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for OCR correction.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting OCR correction for pages: </span><span class="si">{</span><span class="n">target_page_indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting OCR correction for pages: </span><span class="si">{</span><span class="n">target_page_indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page_idx</span> <span class="ow">in</span> <span class="n">target_page_indices</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">page_idx</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">correct_ocr</span><span class="p">(</span>
                    <span class="n">correction_callback</span><span class="o">=</span><span class="n">correction_callback</span><span class="p">,</span>
                    <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">,</span>
                    <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during correct_ocr on page </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during correct_ocr on page </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR correction process finished.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR correction process finished.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of pages in the PDF.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Page&quot;</span><span class="p">,</span> <span class="s2">&quot;PageCollection&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Access pages by index or slice.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not initialized yet.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PageCollection</span>

            <span class="k">return</span> <span class="n">PageCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page indices must be integers or slices, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the underlying PDF file and clean up any temporary files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pdf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed pdfplumber PDF object for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing pdfplumber object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_temp_file&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_file_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">temp_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="o">.</span><span class="n">name</span>
                    <span class="c1"># Only unlink if it exists and _is_stream is False (meaning WE created it)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed temporary PDF file: </span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to clean up temporary file &#39;</span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Cancels the weakref finalizer so we don&#39;t double-clean</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_finalizer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager entry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager exit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the PDF object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
            <span class="n">page_count_str</span> <span class="o">=</span> <span class="s2">&quot;uninitialized&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page_count_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">))</span>

        <span class="n">source_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;source_path&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown source&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;PDF source=&#39;</span><span class="si">{</span><span class="n">source_info</span><span class="si">}</span><span class="s2">&#39; pages=</span><span class="si">{</span><span class="n">page_count_str</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get unique identifier for this PDF.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get unique identifier for this PDF.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>

    <span class="c1"># --- Deskew Method --- #</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deskew</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">detection_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
        <span class="n">force_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new, in-memory PDF object containing deskewed versions of the</span>
<span class="sd">        specified pages from the original PDF.</span>

<span class="sd">        This method renders each selected page, detects and corrects skew using the &#39;deskew&#39;</span>
<span class="sd">        library, and then combines the resulting images into a new PDF using &#39;img2pdf&#39;.</span>
<span class="sd">        The new PDF object is returned directly.</span>

<span class="sd">        Important: The returned PDF is image-based. Any existing text, OCR results,</span>
<span class="sd">        annotations, or other elements from the original pages will *not* be carried over.</span>

<span class="sd">        Args:</span>
<span class="sd">            pages: Page indices/slice to include (0-based). If None, processes all pages.</span>
<span class="sd">            resolution: DPI resolution for rendering the output deskewed pages.</span>
<span class="sd">            angle: The specific angle (in degrees) to rotate by. If None, detects automatically.</span>
<span class="sd">            detection_resolution: DPI resolution used for skew detection if angles are not</span>
<span class="sd">                                  already cached on the page objects.</span>
<span class="sd">            force_overwrite: If False (default), raises a ValueError if any target page</span>
<span class="sd">                             already contains processed elements (text, OCR, regions) to</span>
<span class="sd">                             prevent accidental data loss. Set to True to proceed anyway.</span>
<span class="sd">            **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                             during automatic detection (e.g., `max_angle`, `num_peaks`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new PDF object representing the deskewed document.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If &#39;deskew&#39; or &#39;img2pdf&#39; libraries are not installed.</span>
<span class="sd">            ValueError: If `force_overwrite` is False and target pages contain elements.</span>
<span class="sd">            FileNotFoundError: If the source PDF cannot be read (if file-based).</span>
<span class="sd">            IOError: If creating the in-memory PDF fails.</span>
<span class="sd">            RuntimeError: If rendering or deskewing individual pages fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Deskew/img2pdf libraries missing. Install with: pip install natural-pdf[deskew]&quot;</span>
            <span class="p">)</span>

        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>  <span class="c1"># Use helper to resolve pages</span>

        <span class="c1"># --- Safety Check --- #</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_overwrite</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
                <span class="c1"># Check if the element manager has been initialized and contains any elements</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span>
                    <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">has_elements</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> contains existing elements (text, OCR, etc.). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Deskewing creates an image-only PDF, discarding these elements. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Set force_overwrite=True to proceed.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># --- Process Pages --- #</span>
        <span class="n">deskewed_images_bytes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deskewing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages (output resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI)...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Deskewing Pages&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use page.deskew to get the corrected PIL image</span>
                <span class="c1"># Pass down resolutions and kwargs</span>
                <span class="n">deskewed_img</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">deskew</span><span class="p">(</span>
                    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                    <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>  <span class="c1"># Let page.deskew handle detection/caching</span>
                    <span class="n">detection_resolution</span><span class="o">=</span><span class="n">detection_resolution</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">deskewed_img</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to generate deskewed image, skipping.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Convert image to bytes for img2pdf (use PNG for lossless quality)</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">deskewed_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
                    <span class="n">deskewed_images_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed during deskewing process: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="c1"># Option: Raise a runtime error, or continue and skip the page?</span>
                <span class="c1"># Raising makes the whole operation fail if one page fails.</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> during deskewing.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># --- Create PDF --- #</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deskewed_images_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No pages were successfully processed to create the deskewed PDF.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">deskewed_images_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> deskewed images into in-memory PDF...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use img2pdf to combine image bytes into PDF bytes</span>
            <span class="n">pdf_bytes</span> <span class="o">=</span> <span class="n">img2pdf</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">deskewed_images_bytes</span><span class="p">)</span>

            <span class="c1"># Wrap bytes in a stream</span>
            <span class="n">pdf_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pdf_bytes</span><span class="p">)</span>

            <span class="c1"># Create a new PDF object from the stream using original config</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new PDF object from deskewed stream...&quot;</span><span class="p">)</span>
            <span class="n">new_pdf</span> <span class="o">=</span> <span class="n">PDF</span><span class="p">(</span>
                <span class="n">pdf_stream</span><span class="p">,</span>
                <span class="n">reading_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reading_order</span><span class="p">,</span>
                <span class="n">font_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_font_attrs</span><span class="p">,</span>
                <span class="n">keep_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_spaces&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">text_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">new_pdf</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create in-memory PDF using img2pdf/PDF init: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Failed to create deskewed PDF object from image stream.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># --- End Deskew Method --- #</span>

    <span class="c1"># --- Classification Methods --- #</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classify_pages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">analysis_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span>
        <span class="n">using</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classifies specified pages of the PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels: List of category names</span>
<span class="sd">            model: Model identifier (&#39;text&#39;, &#39;vision&#39;, or specific HF ID)</span>
<span class="sd">            pages: Page indices, slice, or None for all pages</span>
<span class="sd">            analysis_key: Key to store results in page&#39;s analyses dict</span>
<span class="sd">            using: Processing mode (&#39;text&#39; or &#39;vision&#39;)</span>
<span class="sd">            **kwargs: Additional arguments for the ClassificationManager</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Labels list cannot be empty.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot get ClassificationManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.classification.manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_classification_available</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_classification_available</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">&quot;Classification dependencies missing. &quot;</span>
                    <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ai]&quot;&#39;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="s2">&quot;ClassificationManager not available.&quot;</span><span class="p">)</span>

        <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid page index provided.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for classification.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">inferred_using</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">infer_using</span><span class="p">(</span><span class="n">model</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">manager</span><span class="o">.</span><span class="n">DEFAULT_TEXT_MODEL</span><span class="p">,</span> <span class="n">using</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Classifying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages using model &#39;</span><span class="si">{</span><span class="n">model</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;(default)&#39;</span><span class="si">}</span><span class="s2">&#39; (mode: </span><span class="si">{</span><span class="n">inferred_using</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="n">page_contents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pages_to_classify</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathering content for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">_get_classification_content</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="n">inferred_using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">page_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">pages_to_classify</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Cannot get content - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error getting content - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">page_contents</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No content could be gathered for batch classification.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathered content for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">classify_batch</span><span class="p">(</span>
                <span class="n">item_contents</span><span class="o">=</span><span class="n">page_contents</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">using</span><span class="o">=</span><span class="n">inferred_using</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch classification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch classification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mismatch between number of results (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span><span class="si">}</span><span class="s2">) and pages (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Distributing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results to pages under key &#39;</span><span class="si">{</span><span class="n">analysis_key</span><span class="si">}</span><span class="s2">&#39;...&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">page</span><span class="p">,</span> <span class="n">result_obj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;analyses&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">analyses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">analyses</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">page</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_obj</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to store classification results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished classifying PDF pages.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># --- End Classification Methods --- #</span>

    <span class="c1"># --- Extraction Support --- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_extraction_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the content for the entire PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            using: &#39;text&#39; or &#39;vision&#39;</span>
<span class="sd">            **kwargs: Additional arguments passed to extract_text or page.to_image</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Extracted text if using=&#39;text&#39;</span>
<span class="sd">            List[PIL.Image.Image]: List of page images if using=&#39;vision&#39;</span>
<span class="sd">            None: If content cannot be retrieved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">using</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting text from PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">using</span> <span class="o">==</span> <span class="s2">&quot;vision&quot;</span><span class="p">:</span>
            <span class="n">page_images</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages to images...&quot;</span><span class="p">)</span>

            <span class="n">resolution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>
            <span class="n">include_highlights</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;include_highlights&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rendering Pages&quot;</span><span class="p">):</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
                        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                        <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">img</span><span class="p">:</span>
                        <span class="n">page_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">page_images</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to render any pages.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">page_images</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering pages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported value for &#39;using&#39;: </span><span class="si">{</span><span class="n">using</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- End Extraction Support --- #</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_analysis_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">include_content</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">include_images</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">image_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
        <span class="n">image_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">image_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gather analysis data from all pages in the PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            analysis_keys: Keys in the analyses dictionary to export</span>
<span class="sd">            include_content: Whether to include extracted text</span>
<span class="sd">            include_images: Whether to export images</span>
<span class="sd">            image_dir: Directory to save images</span>
<span class="sd">            image_format: Format to save images</span>
<span class="sd">            image_resolution: Resolution for exported images</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dictionaries containing analysis data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pages found in PDF </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Gathering page data&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Basic page information</span>
            <span class="n">page_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pdf_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;page_index&quot;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Include extracted text if requested</span>
            <span class="k">if</span> <span class="n">include_content</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">page_data</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting text from page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">page_data</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Save image if requested</span>
            <span class="k">if</span> <span class="n">include_images</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create image filename</span>
                    <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pdf_</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_page_</span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">image_format</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">image_path</span> <span class="o">=</span> <span class="n">image_dir</span> <span class="o">/</span> <span class="n">image_filename</span>

                    <span class="c1"># Save image</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">image_path</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="n">image_resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                    <span class="c1"># Add relative path to data</span>
                    <span class="n">page_data</span><span class="p">[</span><span class="s2">&quot;image_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">image_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving image for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">page_data</span><span class="p">[</span><span class="s2">&quot;image_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Add analyses data</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">analysis_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;analyses&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> does not have analyses data&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Get the analysis result</span>
                <span class="n">analysis_result</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="c1"># If the result has a to_dict method, use it</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">analysis_result</span><span class="p">,</span> <span class="s2">&quot;to_dict&quot;</span><span class="p">):</span>
                    <span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_result</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise, use the result directly if it&#39;s dict-like</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analysis_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">analysis_result</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="c1"># Last resort: convert to string</span>
                        <span class="n">analysis_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;raw_result&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_result</span><span class="p">)}</span>

                <span class="c1"># Add analysis data to page data with the key as prefix</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analysis_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">page_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_target_pages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Page&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to get a list of Page objects based on the input pages.</span>

<span class="sd">        Args:</span>
<span class="sd">            pages: Page indices, slice, or None for all pages</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Page objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid page index provided in &#39;pages&#39; iterable.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Classification Mixin Implementation --- #</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClassificationManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the ClassificationManager instance for this PDF.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not retrieve ClassificationManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides the content for classifying the entire PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_type: &#39;text&#39; or &#39;vision&#39;.</span>
<span class="sd">            **kwargs: Additional arguments (e.g., for text extraction or image rendering).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Extracted text (str) or the first page&#39;s image (PIL.Image).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If model_type is &#39;vision&#39; and PDF has != 1 page,</span>
<span class="sd">                      or if model_type is unsupported, or if content cannot be generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Extract text from the whole document</span>
                <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Pass relevant kwargs</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PDF contains no extractable text for classification.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">text</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting text for PDF classification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to extract text for classification.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;vision&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Use the single page&#39;s content method</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_get_classification_content</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;vision&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting image from single page for classification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to get image from single page.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot classify empty PDF using vision model.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Vision classification for a PDF object is only supported for single-page PDFs. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;This PDF has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages. Use pdf.pages[0].classify() or pdf.classify_pages().&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model_type for PDF classification: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- End Classification Mixin Implementation ---</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Unified analysis storage (maps to metadata[&quot;analysis&quot;])</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># For PDF, metadata property returns self._pdf.metadata which may be None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Fallback safeguard</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="nd">@analyses</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="c1"># Static helper for weakref.finalize to avoid capturing &#39;self&#39;</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_cleanup</span><span class="p">(</span><span class="n">plumber_pdf</span><span class="p">,</span> <span class="n">temp_file_obj</span><span class="p">,</span> <span class="n">is_stream</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plumber_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plumber_pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">temp_file_obj</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_stream</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">temp_file_obj</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">temp_file_obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to clean up temporary file &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="natural_pdf.PDF-attributes">Attributes</h6>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.PDF.metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">metadata</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Access PDF metadata as a dictionary.</p>
<p>Returns document metadata such as title, author, creation date, and other
properties embedded in the PDF file. The exact keys available depend on
what metadata was included when the PDF was created.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing PDF metadata. Common keys include 'Title',</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>'Author', 'Subject', 'Creator', 'Producer', 'CreationDate', and</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>'ModDate'. May be empty if no metadata is available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="s1">&#39;No title&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created: </span><span class="si">{</span><span class="n">pdf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CreationDate&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.PDF.pages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">pages</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Access pages as a PageCollection object.</p>
<p>Provides access to individual pages of the PDF document through a
collection interface that supports indexing, slicing, and iteration.
Pages are lazy-loaded to minimize memory usage.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="PageCollection">PageCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PageCollection object that provides list-like access to PDF pages.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AttributeError">AttributeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If PDF pages are not yet initialized.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>

<span class="c1"># Access individual pages</span>
<span class="n">first_page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">last_page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Slice pages</span>
<span class="n">first_three</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Iterate over pages</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span><span class="si">}</span><span class="s2"> characters&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
    </div>

</div>

<h6 id="natural_pdf.PDF-functions">Functions</h6>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__enter__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Context manager entry.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager entry.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__exit__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Context manager exit.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager exit.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Access pages by index or slice.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Page&quot;</span><span class="p">,</span> <span class="s2">&quot;PageCollection&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Access pages by index or slice.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not initialized yet.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PageCollection</span>

        <span class="k">return</span> <span class="n">PageCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page indices must be integers or slices, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="n">reading_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_text_tolerance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Initialize the enhanced PDF object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path_or_url_or_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the PDF file (str/Path), a URL (str),
or a file-like object (stream). URLs must start with 'http://' or 'https://'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reading_order</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use natural reading order for text extraction.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>font_attrs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of font attributes for grouping characters into words.
Common attributes include ['fontname', 'size']. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_spaces</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include spaces in word elements during text extraction.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_tolerance</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PDFplumber-style tolerance settings for text grouping.
Dictionary with keys like 'x_tolerance', 'y_tolerance'. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>auto_text_tolerance</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, automatically scale text tolerance based on
font size and document characteristics. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_layer</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, preserve existing text layer from the PDF. If False,
removes all existing text elements during initialization, useful for
OCR-only workflows. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If path_or_url_or_stream is not a valid type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IOError">IOError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the PDF file cannot be opened or read.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If URL download fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># From file path</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>

<span class="c1"># From URL</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;https://example.com/document.pdf&quot;</span><span class="p">)</span>

<span class="c1"># From stream</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># With custom settings</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">,</span>
              <span class="n">reading_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">text_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># For OCR-only processing</span>
              <span class="n">font_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fontname&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">])</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path_or_url_or_stream</span><span class="p">,</span>
    <span class="n">reading_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">font_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_spaces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">text_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_text_tolerance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">text_layer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the enhanced PDF object.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_or_url_or_stream: Path to the PDF file (str/Path), a URL (str),</span>
<span class="sd">            or a file-like object (stream). URLs must start with &#39;http://&#39; or &#39;https://&#39;.</span>
<span class="sd">        reading_order: If True, use natural reading order for text extraction.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        font_attrs: List of font attributes for grouping characters into words.</span>
<span class="sd">            Common attributes include [&#39;fontname&#39;, &#39;size&#39;]. Defaults to None.</span>
<span class="sd">        keep_spaces: If True, include spaces in word elements during text extraction.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        text_tolerance: PDFplumber-style tolerance settings for text grouping.</span>
<span class="sd">            Dictionary with keys like &#39;x_tolerance&#39;, &#39;y_tolerance&#39;. Defaults to None.</span>
<span class="sd">        auto_text_tolerance: If True, automatically scale text tolerance based on</span>
<span class="sd">            font size and document characteristics. Defaults to True.</span>
<span class="sd">        text_layer: If True, preserve existing text layer from the PDF. If False,</span>
<span class="sd">            removes all existing text elements during initialization, useful for</span>
<span class="sd">            OCR-only workflows. Defaults to True.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If path_or_url_or_stream is not a valid type.</span>
<span class="sd">        IOError: If the PDF file cannot be opened or read.</span>
<span class="sd">        ValueError: If URL download fails.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # From file path</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>

<span class="sd">        # From URL</span>
<span class="sd">        pdf = npdf.PDF(&quot;https://example.com/document.pdf&quot;)</span>

<span class="sd">        # From stream</span>
<span class="sd">        with open(&quot;document.pdf&quot;, &quot;rb&quot;) as f:</span>
<span class="sd">            pdf = npdf.PDF(f)</span>

<span class="sd">        # With custom settings</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;,</span>
<span class="sd">                      reading_order=False,</span>
<span class="sd">                      text_layer=False,  # For OCR-only processing</span>
<span class="sd">                      font_attrs=[&#39;fontname&#39;, &#39;size&#39;, &#39;flags&#39;])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_path_or_stream</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span> <span class="o">=</span> <span class="n">text_layer</span>
    <span class="n">stream_to_open</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s file-like</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing PDF from in-memory stream.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No resolved file path for streams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="s2">&quot;&lt;stream&gt;&quot;</span>  <span class="c1"># Identifier for source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>  <span class="c1"># Use source identifier as path for streams</span>
        <span class="n">stream_to_open</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">):</span>
                <span class="c1"># If caller provided an in-memory binary stream, capture bytes for potential re-export</span>
                <span class="n">current_pos</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_bytes</span> <span class="o">=</span> <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">path_or_url_or_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">current_pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
        <span class="n">path_or_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">path_or_url</span>  <span class="c1"># Store original path/URL as source</span>
        <span class="n">is_url</span> <span class="o">=</span> <span class="n">path_or_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path_or_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading PDF from URL: </span><span class="si">{</span><span class="n">path_or_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">path_or_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># Load directly into an in-memory buffer  no temp file needed</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No on-disk temp file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="n">path_or_url</span>  <span class="c1"># For repr / get_id purposes</span>
                <span class="n">stream_to_open</span> <span class="o">=</span> <span class="n">buffer</span>  <span class="c1"># pdfplumber accepts file-like objects</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download PDF from URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download PDF from URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path_or_url</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>  <span class="c1"># Resolve local paths</span>
            <span class="n">stream_to_open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_path</span>  <span class="c1"># Use resolved path for file-based PDFs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid input type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">path_or_url_or_stream</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Expected path (str/Path), URL (str), or file-like object.&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening PDF source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Parameters: reading_order=</span><span class="si">{</span><span class="n">reading_order</span><span class="si">}</span><span class="s2">, font_attrs=</span><span class="si">{</span><span class="n">font_attrs</span><span class="si">}</span><span class="s2">, keep_spaces=</span><span class="si">{</span><span class="n">keep_spaces</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="o">=</span> <span class="n">pdfplumber</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream_to_open</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Attempt cleanup if opening fails</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open PDF source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Store configuration used for initialization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_reading_order</span> <span class="o">=</span> <span class="n">reading_order</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keep_spaces&quot;</span><span class="p">:</span> <span class="n">keep_spaces</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_font_attrs</span> <span class="o">=</span> <span class="n">font_attrs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="n">OCRManager</span><span class="p">()</span> <span class="k">if</span> <span class="n">OCRManager</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="n">LayoutManager</span><span class="p">()</span> <span class="k">if</span> <span class="n">LayoutManager</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">highlighter</span> <span class="o">=</span> <span class="n">HighlightingService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c1"># self._classification_manager_instance = ClassificationManager() # Removed this line</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_manager_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Lazily instantiate pages only when accessed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="n">_LazyPageList</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="n">font_attrs</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_element_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&#39; initialized with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_managers</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_highlighter</span><span class="p">()</span>

    <span class="c1"># Remove text layer if requested</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing text layer as requested (text_layer=False)&quot;</span><span class="p">)</span>
        <span class="c1"># Text layer is not loaded when text_layer=False, so no need to remove</span>
        <span class="k">pass</span>

    <span class="c1"># Analysis results accessed via self.analyses property (see below)</span>

    <span class="c1"># --- Automatic cleanup when object is garbage-collected ---</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">PDF</span><span class="o">.</span><span class="n">_finalize_cleanup</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_temp_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># --- Text tolerance settings ------------------------------------</span>
    <span class="c1"># Users can pass pdfplumber-style keys (x_tolerance, x_tolerance_ratio,</span>
    <span class="c1"># y_tolerance, etc.) via *text_tolerance*.  We also keep a flag that</span>
    <span class="c1"># enables automatic tolerance scaling when explicit values are not</span>
    <span class="c1"># supplied.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;auto_text_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_text_tolerance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text_tolerance</span><span class="p">:</span>
        <span class="c1"># Only copy recognised primitives (numbers / None); ignore junk.</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x_tolerance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x_tolerance_ratio&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;keep_blank_chars&quot;</span><span class="p">,</span>  <span class="c1"># passthrough convenience</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">text_tolerance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Return the number of pages in the PDF.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the number of pages in the PDF.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Return a string representation of the PDF object.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of the PDF object.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="n">page_count_str</span> <span class="o">=</span> <span class="s2">&quot;uninitialized&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_count_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">))</span>

    <span class="n">source_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;source_path&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown source&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;PDF source=&#39;</span><span class="si">{</span><span class="n">source_info</span><span class="si">}</span><span class="s2">&#39; pages=</span><span class="si">{</span><span class="n">page_count_str</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.add_exclusion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">exclusion_func</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add an exclusion function to the PDF.</p>
<p>Exclusion functions define regions of each page that should be ignored during
text extraction and analysis operations. This is useful for filtering out headers,
footers, watermarks, or other administrative content that shouldn't be included
in the main document processing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>exclusion_func</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a>], <span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a Page object and returns a Region
to exclude from processing, or None if no exclusion should be applied
to that page. The function is called once per page.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional descriptive label for this exclusion rule, useful for
debugging and identification.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AttributeError">AttributeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If PDF pages are not yet initialized.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>

<span class="c1"># Exclude headers (top 50 points of each page)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">page</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;header_exclusion&quot;</span>
<span class="p">)</span>

<span class="c1"># Exclude any text containing &quot;CONFIDENTIAL&quot;</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">page</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">above</span><span class="p">(</span><span class="n">include_source</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;confidential_exclusion&quot;</span>
<span class="p">)</span>

<span class="c1"># Chain multiple exclusions</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">header_func</span><span class="p">)</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">footer_func</span><span class="p">)</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_exclusion</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">exclusion_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]],</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add an exclusion function to the PDF.</span>

<span class="sd">    Exclusion functions define regions of each page that should be ignored during</span>
<span class="sd">    text extraction and analysis operations. This is useful for filtering out headers,</span>
<span class="sd">    footers, watermarks, or other administrative content that shouldn&#39;t be included</span>
<span class="sd">    in the main document processing.</span>

<span class="sd">    Args:</span>
<span class="sd">        exclusion_func: A function that takes a Page object and returns a Region</span>
<span class="sd">            to exclude from processing, or None if no exclusion should be applied</span>
<span class="sd">            to that page. The function is called once per page.</span>
<span class="sd">        label: Optional descriptive label for this exclusion rule, useful for</span>
<span class="sd">            debugging and identification.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AttributeError: If PDF pages are not yet initialized.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>

<span class="sd">        # Exclude headers (top 50 points of each page)</span>
<span class="sd">        pdf.add_exclusion(</span>
<span class="sd">            lambda page: page.region(0, 0, page.width, 50),</span>
<span class="sd">            label=&quot;header_exclusion&quot;</span>
<span class="sd">        )</span>

<span class="sd">        # Exclude any text containing &quot;CONFIDENTIAL&quot;</span>
<span class="sd">        pdf.add_exclusion(</span>
<span class="sd">            lambda page: page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;).above(include_source=True)</span>
<span class="sd">            if page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;) else None,</span>
<span class="sd">            label=&quot;confidential_exclusion&quot;</span>
<span class="sd">        )</span>

<span class="sd">        # Chain multiple exclusions</span>
<span class="sd">        pdf.add_exclusion(header_func).add_exclusion(footer_func)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion_data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">exclusion_func</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.add_region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region_func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add a region function to the PDF.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>region_func</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a>], <span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a Page and returns a Region, or None</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>region_func</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a>], <span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a Page and returns a Region, or None</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the region</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_region</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">region_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a region function to the PDF.</span>

<span class="sd">    Args:</span>
<span class="sd">        region_func: A function that takes a Page and returns a Region, or None</span>
<span class="sd">        region_func: A function that takes a Page and returns a Region, or None</span>
<span class="sd">        name: Optional name for the region</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="n">region_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_func</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">region_instance</span> <span class="o">=</span> <span class="n">region_func</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">region_instance</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region_instance</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
                <span class="n">page</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region_instance</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;named&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">region_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region function did not return a valid Region for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding region for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.apply_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detect_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Apply OCR to specified pages of the PDF using batch processing.</p>
<p>Performs optical character recognition on the specified pages, converting
image-based text into searchable and extractable text elements. This method
supports multiple OCR engines and provides batch processing for efficiency.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the OCR engine to use. Supported engines include
'easyocr' (default), 'surya', 'paddle', and 'doctr'. If None,
uses the global default from natural_pdf.options.ocr.engine.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>languages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of language codes for OCR recognition (e.g., ['en', 'es']).
If None, uses the global default from natural_pdf.options.ocr.languages.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold (0.0-1.0) for accepting
OCR results. Text with lower confidence will be filtered out.
If None, uses the global default.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run OCR on ('cpu', 'cuda', 'mps'). Engine-specific
availability varies. If None, uses engine defaults.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for rendering pages to images before OCR.
Higher values improve accuracy but increase processing time and memory.
Typical values: 150 (fast), 300 (balanced), 600 (high quality).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, mask excluded regions before OCR to prevent
processing of headers, footers, or other unwanted content.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detect_only</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only detect text bounding boxes without performing
character recognition. Useful for layout analysis workflows.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>replace</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, replace any existing OCR elements on the pages.
If False, append new OCR results to existing elements.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine-specific options object (e.g., EasyOCROptions, SuryaOptions).
Allows fine-tuning of engine behavior beyond common parameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Iterable">Iterable</span>[<span title="int">int</span>], <span title="range">range</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Page indices to process. Can be:
- None: Process all pages
- slice: Process a range of pages (e.g., slice(0, 10))
- Iterable[int]: Process specific page indices (e.g., [0, 2, 5])</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If invalid page index is provided.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If pages parameter has invalid type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If OCR engine is not available or fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;scanned_document.pdf&quot;</span><span class="p">)</span>

<span class="c1"># Basic OCR on all pages</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">()</span>

<span class="c1"># High-quality OCR with specific settings</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span>
    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;easyocr&#39;</span><span class="p">,</span>
    <span class="n">languages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">],</span>
    <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">)</span>

<span class="c1"># OCR specific pages only</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># First 3 pages</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Pages 5-9</span>

<span class="c1"># Detection-only workflow for layout analysis</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">detect_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>OCR processing can be time and memory intensive, especially at high
resolutions. Consider using exclusions to mask unwanted regions and
processing pages in batches for large documents.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">detect_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply OCR to specified pages of the PDF using batch processing.</span>

<span class="sd">    Performs optical character recognition on the specified pages, converting</span>
<span class="sd">    image-based text into searchable and extractable text elements. This method</span>
<span class="sd">    supports multiple OCR engines and provides batch processing for efficiency.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine: Name of the OCR engine to use. Supported engines include</span>
<span class="sd">            &#39;easyocr&#39; (default), &#39;surya&#39;, &#39;paddle&#39;, and &#39;doctr&#39;. If None,</span>
<span class="sd">            uses the global default from natural_pdf.options.ocr.engine.</span>
<span class="sd">        languages: List of language codes for OCR recognition (e.g., [&#39;en&#39;, &#39;es&#39;]).</span>
<span class="sd">            If None, uses the global default from natural_pdf.options.ocr.languages.</span>
<span class="sd">        min_confidence: Minimum confidence threshold (0.0-1.0) for accepting</span>
<span class="sd">            OCR results. Text with lower confidence will be filtered out.</span>
<span class="sd">            If None, uses the global default.</span>
<span class="sd">        device: Device to run OCR on (&#39;cpu&#39;, &#39;cuda&#39;, &#39;mps&#39;). Engine-specific</span>
<span class="sd">            availability varies. If None, uses engine defaults.</span>
<span class="sd">        resolution: DPI resolution for rendering pages to images before OCR.</span>
<span class="sd">            Higher values improve accuracy but increase processing time and memory.</span>
<span class="sd">            Typical values: 150 (fast), 300 (balanced), 600 (high quality).</span>
<span class="sd">        apply_exclusions: If True, mask excluded regions before OCR to prevent</span>
<span class="sd">            processing of headers, footers, or other unwanted content.</span>
<span class="sd">        detect_only: If True, only detect text bounding boxes without performing</span>
<span class="sd">            character recognition. Useful for layout analysis workflows.</span>
<span class="sd">        replace: If True, replace any existing OCR elements on the pages.</span>
<span class="sd">            If False, append new OCR results to existing elements.</span>
<span class="sd">        options: Engine-specific options object (e.g., EasyOCROptions, SuryaOptions).</span>
<span class="sd">            Allows fine-tuning of engine behavior beyond common parameters.</span>
<span class="sd">        pages: Page indices to process. Can be:</span>
<span class="sd">            - None: Process all pages</span>
<span class="sd">            - slice: Process a range of pages (e.g., slice(0, 10))</span>
<span class="sd">            - Iterable[int]: Process specific page indices (e.g., [0, 2, 5])</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If invalid page index is provided.</span>
<span class="sd">        TypeError: If pages parameter has invalid type.</span>
<span class="sd">        RuntimeError: If OCR engine is not available or fails.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;scanned_document.pdf&quot;)</span>

<span class="sd">        # Basic OCR on all pages</span>
<span class="sd">        pdf.apply_ocr()</span>

<span class="sd">        # High-quality OCR with specific settings</span>
<span class="sd">        pdf.apply_ocr(</span>
<span class="sd">            engine=&#39;easyocr&#39;,</span>
<span class="sd">            languages=[&#39;en&#39;, &#39;es&#39;],</span>
<span class="sd">            resolution=300,</span>
<span class="sd">            min_confidence=0.8</span>
<span class="sd">        )</span>

<span class="sd">        # OCR specific pages only</span>
<span class="sd">        pdf.apply_ocr(pages=[0, 1, 2])  # First 3 pages</span>
<span class="sd">        pdf.apply_ocr(pages=slice(5, 10))  # Pages 5-9</span>

<span class="sd">        # Detection-only workflow for layout analysis</span>
<span class="sd">        pdf.apply_ocr(detect_only=True, resolution=150)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        OCR processing can be time and memory intensive, especially at high</span>
<span class="sd">        resolutions. Consider using exclusions to mask unwanted regions and</span>
<span class="sd">        processing pages in batches for large documents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OCRManager not available. Cannot apply OCR.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Apply global options as defaults, but allow explicit parameters to override</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="c1"># Use global OCR options if parameters are not explicitly set</span>
    <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">engine</span>
    <span class="k">if</span> <span class="n">languages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">languages</span>
    <span class="k">if</span> <span class="n">min_confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_confidence</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ocr</span><span class="o">.</span><span class="n">min_confidence</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># No default device in options.ocr anymore</span>

    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] PDF.apply_ocr starting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid page index provided in &#39;pages&#39; iterable.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for OCR processing.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">page_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">number</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying batch OCR to pages: </span><span class="si">{</span><span class="n">page_numbers</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">resolution</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using OCR image resolution: </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI&quot;</span><span class="p">)</span>

    <span class="n">images_pil</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">page_image_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages...&quot;</span><span class="p">)</span>
    <span class="n">failed_page_num</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">render_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">target_pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rendering pages&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">failed_page_num</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rendering page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> (index </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
            <span class="n">to_image_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="n">final_resolution</span><span class="p">,</span>
                <span class="s2">&quot;include_highlights&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;exclusions&quot;</span><span class="p">:</span> <span class="s2">&quot;mask&quot;</span> <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="o">**</span><span class="n">to_image_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
                <span class="k">continue</span>
            <span class="n">images_pil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">page_image_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">page</span><span class="p">,</span> <span class="n">img</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render pages for batch OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render pages for batch OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render page </span><span class="si">{</span><span class="n">failed_page_num</span><span class="si">}</span><span class="s2"> for OCR.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="n">render_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Finished rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">)</span><span class="si">}</span><span class="s2"> images (Duration: </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">render_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Finished rendering </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">)</span><span class="si">}</span><span class="s2"> images (Duration: </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">render_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">images_pil</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">page_image_map</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No images were successfully rendered for batch OCR.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">images_pil</span><span class="p">,</span>
        <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
        <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">languages</span><span class="p">,</span>
        <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
        <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
        <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
        <span class="s2">&quot;detect_only&quot;</span><span class="p">:</span> <span class="n">detect_only</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">ocr_call_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;images&quot;</span><span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Calling OCR Manager with args: </span><span class="si">{</span><span class="n">ocr_call_args</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Calling OCR Manager with args: </span><span class="si">{</span><span class="n">ocr_call_args</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">ocr_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="n">batch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_pil</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OCR Manager returned unexpected result format or length.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR Manager batch processing complete.&quot;</span><span class="p">)</span>

    <span class="n">ocr_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] OCR processing finished (Duration: </span><span class="si">{</span><span class="n">ocr_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ocr_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding OCR results to respective pages...&quot;</span><span class="p">)</span>
    <span class="n">total_elements_added</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">page_image_map</span><span class="p">):</span>
        <span class="n">results_for_page</span> <span class="o">=</span> <span class="n">batch_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Expected list, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results_for_page</span><span class="p">)</span><span class="si">}</span><span class="s2"> results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_ocr_elements</span><span class="p">()</span>

            <span class="n">img_scale_x</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">img_scale_y</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">create_text_elements_from_ocr</span><span class="p">(</span>
                <span class="n">results_for_page</span><span class="p">,</span> <span class="n">img_scale_x</span><span class="p">,</span> <span class="n">img_scale_y</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">elements</span><span class="p">:</span>
                <span class="n">total_elements_added</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> OCR TextElements to page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No valid TextElements created for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error adding OCR elements to page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished adding OCR results. Total elements added: </span><span class="si">{</span><span class="n">total_elements_added</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.ask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;extractive&#39;</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Ask a single question about the document content.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>question</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Question string to ask about the document</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>"extractive" to extract answer from document, "generative" to generate</p>
              </div>
            </td>
            <td>
                  <code>&#39;extractive&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>], <span title="range">range</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pages to query (default: all pages)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold for answers</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional model name for question answering</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters passed to the QA engine</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict containing: answer, confidence, found, page_num, source_elements, etc.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;extractive&quot;</span><span class="p">,</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask a single question about the document content.</span>

<span class="sd">    Args:</span>
<span class="sd">        question: Question string to ask about the document</span>
<span class="sd">        mode: &quot;extractive&quot; to extract answer from document, &quot;generative&quot; to generate</span>
<span class="sd">        pages: Specific pages to query (default: all pages)</span>
<span class="sd">        min_confidence: Minimum confidence threshold for answers</span>
<span class="sd">        model: Optional model name for question answering</span>
<span class="sd">        **kwargs: Additional parameters passed to the QA engine</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict containing: answer, confidence, found, page_num, source_elements, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delegate to ask_batch and return the first result</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_batch</span><span class="p">([</span><span class="n">question</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="n">pages</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="p">{</span>
        <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.ask_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">ask_batch</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;extractive&#39;</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Ask multiple questions about the document content using batch processing.</p>
<p>This method processes multiple questions efficiently in a single batch,
avoiding the multiprocessing resource accumulation that can occur with
sequential individual question calls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>questions</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of question strings to ask about the document</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>"extractive" to extract answer from document, "generative" to generate</p>
              </div>
            </td>
            <td>
                  <code>&#39;extractive&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>], <span title="range">range</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific pages to query (default: all pages)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold for answers</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional model name for question answering</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters passed to the QA engine</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Dicts, each containing: answer, confidence, found, page_num, source_elements, etc.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ask_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;extractive&quot;</span><span class="p">,</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask multiple questions about the document content using batch processing.</span>

<span class="sd">    This method processes multiple questions efficiently in a single batch,</span>
<span class="sd">    avoiding the multiprocessing resource accumulation that can occur with</span>
<span class="sd">    sequential individual question calls.</span>

<span class="sd">    Args:</span>
<span class="sd">        questions: List of question strings to ask about the document</span>
<span class="sd">        mode: &quot;extractive&quot; to extract answer from document, &quot;generative&quot; to generate</span>
<span class="sd">        pages: Specific pages to query (default: all pages)</span>
<span class="sd">        min_confidence: Minimum confidence threshold for answers</span>
<span class="sd">        model: Optional model name for question answering</span>
<span class="sd">        **kwargs: Additional parameters passed to the QA engine</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of Dicts, each containing: answer, confidence, found, page_num, source_elements, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;questions&#39; must be a list of strings&quot;</span><span class="p">)</span>

    <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">()</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Resolve target pages</span>
    <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pages</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">page_idx</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
                <span class="n">target_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2"> out of range, skipping&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid pages parameter: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid pages found for QA processing.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">questions</span>
        <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="si">}</span><span class="s2"> question(s) across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> page(s) using batch QA...&quot;</span><span class="p">)</span>

    <span class="c1"># Collect all page images and metadata for batch processing</span>
    <span class="n">page_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">page_word_boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">page_metadata</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
        <span class="c1"># Get page image</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page_image</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render image for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get text elements for word boxes</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No text elements found on page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">word_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">word_boxes</span> <span class="o">=</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">_get_word_boxes_from_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">offset_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset_y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">page_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_image</span><span class="p">)</span>
            <span class="n">page_word_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_boxes</span><span class="p">)</span>
            <span class="n">page_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;page_object&quot;</span><span class="p">:</span> <span class="n">page</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">page_images</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No page images could be processed for QA.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">questions</span>
        <span class="p">]</span>

    <span class="c1"># Process all questions against all pages in batch</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">question_text</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
        <span class="n">question_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ask this question against each page (but in batch per page)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">page_image</span><span class="p">,</span> <span class="n">word_boxes</span><span class="p">,</span> <span class="n">page_meta</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">page_images</span><span class="p">,</span> <span class="n">page_word_boxes</span><span class="p">,</span> <span class="n">page_metadata</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use the DocumentQA batch interface </span>
                <span class="n">page_result</span> <span class="o">=</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">page_image</span><span class="p">,</span>
                    <span class="n">question</span><span class="o">=</span><span class="n">question_text</span><span class="p">,</span>
                    <span class="n">word_boxes</span><span class="o">=</span><span class="n">word_boxes</span><span class="p">,</span>
                    <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">page_result</span> <span class="ow">and</span> <span class="n">page_result</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
                    <span class="c1"># Add page metadata to result</span>
                    <span class="n">page_result_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span>
                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
                        <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">page_result</span><span class="o">.</span><span class="n">found</span><span class="p">,</span>
                        <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="n">page_meta</span><span class="p">[</span><span class="s2">&quot;page_number&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;source_elements&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page_result</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="p">}</span>
                    <span class="n">question_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_result_dict</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing question &#39;</span><span class="si">{</span><span class="n">question_text</span><span class="si">}</span><span class="s2">&#39; on page </span><span class="si">{</span><span class="n">page_meta</span><span class="p">[</span><span class="s1">&#39;page_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Sort results by confidence and take the best one for this question</span>
        <span class="n">question_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">question_results</span><span class="p">:</span>
            <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No results found for this question</span>
            <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">all_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.classify_pages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">classify_pages</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_key</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Classifies specified pages of the PDF.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of category names</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model identifier ('text', 'vision', or specific HF ID)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Iterable">Iterable</span>[<span title="int">int</span>], <span title="range">range</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Page indices, slice, or None for all pages</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>analysis_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to store results in page's analyses dict</p>
              </div>
            </td>
            <td>
                  <code>&#39;classification&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>using</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processing mode ('text' or 'vision')</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the ClassificationManager</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">classify_pages</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">analysis_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span>
    <span class="n">using</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classifies specified pages of the PDF.</span>

<span class="sd">    Args:</span>
<span class="sd">        labels: List of category names</span>
<span class="sd">        model: Model identifier (&#39;text&#39;, &#39;vision&#39;, or specific HF ID)</span>
<span class="sd">        pages: Page indices, slice, or None for all pages</span>
<span class="sd">        analysis_key: Key to store results in page&#39;s analyses dict</span>
<span class="sd">        using: Processing mode (&#39;text&#39; or &#39;vision&#39;)</span>
<span class="sd">        **kwargs: Additional arguments for the ClassificationManager</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Labels list cannot be empty.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot get ClassificationManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.classification.manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_classification_available</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_classification_available</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Classification dependencies missing. &quot;</span>
                <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ai]&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="s2">&quot;ClassificationManager not available.&quot;</span><span class="p">)</span>

    <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_pages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid page index provided.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for classification.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">inferred_using</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">infer_using</span><span class="p">(</span><span class="n">model</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">manager</span><span class="o">.</span><span class="n">DEFAULT_TEXT_MODEL</span><span class="p">,</span> <span class="n">using</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Classifying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages using model &#39;</span><span class="si">{</span><span class="n">model</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;(default)&#39;</span><span class="si">}</span><span class="s2">&#39; (mode: </span><span class="si">{</span><span class="n">inferred_using</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="n">page_contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pages_to_classify</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathering content for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages...&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">_get_classification_content</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="n">inferred_using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">page_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">pages_to_classify</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Cannot get content - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error getting content - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">page_contents</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No content could be gathered for batch classification.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gathered content for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">batch_results</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">classify_batch</span><span class="p">(</span>
            <span class="n">item_contents</span><span class="o">=</span><span class="n">page_contents</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">model_id</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">using</span><span class="o">=</span><span class="n">inferred_using</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch classification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch classification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mismatch between number of results (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span><span class="si">}</span><span class="s2">) and pages (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Distributing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results to pages under key &#39;</span><span class="si">{</span><span class="n">analysis_key</span><span class="si">}</span><span class="s2">&#39;...&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">page</span><span class="p">,</span> <span class="n">result_obj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pages_to_classify</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;analyses&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">analyses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">analyses</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">page</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_obj</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to store classification results for page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished classifying PDF pages.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.clear_exclusions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">clear_exclusions</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Clear all exclusion functions from the PDF.</p>
<p>Removes all previously added exclusion functions that were used to filter
out unwanted content (like headers, footers, or administrative text) from
text extraction and analysis operations.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AttributeError">AttributeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If PDF pages are not yet initialized.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="k">lambda</span> <span class="n">page</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">above</span><span class="p">())</span>

<span class="c1"># Later, remove all exclusions</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">clear_exclusions</span><span class="p">()</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear all exclusion functions from the PDF.</span>

<span class="sd">    Removes all previously added exclusion functions that were used to filter</span>
<span class="sd">    out unwanted content (like headers, footers, or administrative text) from</span>
<span class="sd">    text extraction and analysis operations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AttributeError: If PDF pages are not yet initialized.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        pdf.add_exclusion(lambda page: page.find(&#39;text:contains(&quot;CONFIDENTIAL&quot;)&#39;).above())</span>

<span class="sd">        # Later, remove all exclusions</span>
<span class="sd">        pdf.clear_exclusions()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">clear_exclusions</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Close the underlying PDF file and clean up any temporary files.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the underlying PDF file and clean up any temporary files.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pdf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed pdfplumber PDF object for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing pdfplumber object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_temp_file&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">temp_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_file</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># Only unlink if it exists and _is_stream is False (meaning WE created it)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_stream</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed temporary PDF file: </span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to clean up temporary file &#39;</span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Cancels the weakref finalizer so we don&#39;t double-clean</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_finalizer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.correct_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">correct_ocr</span><span class="p">(</span><span class="n">correction_callback</span><span class="p">,</span> <span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Applies corrections to OCR text elements using a callback function.
Applies corrections to OCR text elements using a callback function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>correction_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that takes an element and returns corrected text or None</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>correction_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that takes an element and returns corrected text or None</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Iterable">Iterable</span>[<span title="int">int</span>], <span title="range">range</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional page indices/slice to limit the scope of correction</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_workers</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use for parallel execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function for progress updates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_workers</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use for parallel execution</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function for progress updates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies corrections to OCR text elements using a callback function.</span>
<span class="sd">    Applies corrections to OCR text elements using a callback function.</span>

<span class="sd">    Args:</span>
<span class="sd">        correction_callback: Function that takes an element and returns corrected text or None</span>
<span class="sd">        correction_callback: Function that takes an element and returns corrected text or None</span>
<span class="sd">        pages: Optional page indices/slice to limit the scope of correction</span>
<span class="sd">        max_workers: Maximum number of threads to use for parallel execution</span>
<span class="sd">        progress_callback: Optional callback function for progress updates</span>
<span class="sd">        max_workers: Maximum number of threads to use for parallel execution</span>
<span class="sd">        progress_callback: Optional callback function for progress updates</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">pages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_page_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">target_page_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">pages</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">))))</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_page_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">target_page_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> out of range (0-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid page index in &#39;pages&#39;: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid page index in &#39;pages&#39;: </span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;pages&#39; must be None, a slice, or an iterable of page indices.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_page_indices</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No pages selected for OCR correction.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting OCR correction for pages: </span><span class="si">{</span><span class="n">target_page_indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting OCR correction for pages: </span><span class="si">{</span><span class="n">target_page_indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page_idx</span> <span class="ow">in</span> <span class="n">target_page_indices</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">page_idx</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">correct_ocr</span><span class="p">(</span>
                <span class="n">correction_callback</span><span class="o">=</span><span class="n">correction_callback</span><span class="p">,</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">,</span>
                <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during correct_ocr on page </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during correct_ocr on page </span><span class="si">{</span><span class="n">page_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR correction process finished.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OCR correction process finished.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.deskew" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">deskew</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detection_resolution</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="n">force_overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Creates a new, in-memory PDF object containing deskewed versions of the
specified pages from the original PDF.</p>
<p>This method renders each selected page, detects and corrects skew using the 'deskew'
library, and then combines the resulting images into a new PDF using 'img2pdf'.
The new PDF object is returned directly.</p>
<p>Important: The returned PDF is image-based. Any existing text, OCR results,
annotations, or other elements from the original pages will <em>not</em> be carried over.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Iterable">Iterable</span>[<span title="int">int</span>], <span title="range">range</span>, <span title="slice">slice</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Page indices/slice to include (0-based). If None, processes all pages.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for rendering the output deskewed pages.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The specific angle (in degrees) to rotate by. If None, detects automatically.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detection_resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution used for skew detection if angles are not
                  already cached on the page objects.</p>
              </div>
            </td>
            <td>
                  <code>72</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_overwrite</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False (default), raises a ValueError if any target page
             already contains processed elements (text, OCR, regions) to
             prevent accidental data loss. Set to True to proceed anyway.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**deskew_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to <code>deskew.determine_skew</code>
             during automatic detection (e.g., <code>max_angle</code>, <code>num_peaks</code>).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new PDF object representing the deskewed document.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'deskew' or 'img2pdf' libraries are not installed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>force_overwrite</code> is False and target pages contain elements.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the source PDF cannot be read (if file-based).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="IOError">IOError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If creating the in-memory PDF fails.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If rendering or deskewing individual pages fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">deskew</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">detection_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
    <span class="n">force_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new, in-memory PDF object containing deskewed versions of the</span>
<span class="sd">    specified pages from the original PDF.</span>

<span class="sd">    This method renders each selected page, detects and corrects skew using the &#39;deskew&#39;</span>
<span class="sd">    library, and then combines the resulting images into a new PDF using &#39;img2pdf&#39;.</span>
<span class="sd">    The new PDF object is returned directly.</span>

<span class="sd">    Important: The returned PDF is image-based. Any existing text, OCR results,</span>
<span class="sd">    annotations, or other elements from the original pages will *not* be carried over.</span>

<span class="sd">    Args:</span>
<span class="sd">        pages: Page indices/slice to include (0-based). If None, processes all pages.</span>
<span class="sd">        resolution: DPI resolution for rendering the output deskewed pages.</span>
<span class="sd">        angle: The specific angle (in degrees) to rotate by. If None, detects automatically.</span>
<span class="sd">        detection_resolution: DPI resolution used for skew detection if angles are not</span>
<span class="sd">                              already cached on the page objects.</span>
<span class="sd">        force_overwrite: If False (default), raises a ValueError if any target page</span>
<span class="sd">                         already contains processed elements (text, OCR, regions) to</span>
<span class="sd">                         prevent accidental data loss. Set to True to proceed anyway.</span>
<span class="sd">        **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                         during automatic detection (e.g., `max_angle`, `num_peaks`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new PDF object representing the deskewed document.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If &#39;deskew&#39; or &#39;img2pdf&#39; libraries are not installed.</span>
<span class="sd">        ValueError: If `force_overwrite` is False and target pages contain elements.</span>
<span class="sd">        FileNotFoundError: If the source PDF cannot be read (if file-based).</span>
<span class="sd">        IOError: If creating the in-memory PDF fails.</span>
<span class="sd">        RuntimeError: If rendering or deskewing individual pages fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Deskew/img2pdf libraries missing. Install with: pip install natural-pdf[deskew]&quot;</span>
        <span class="p">)</span>

    <span class="n">target_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>  <span class="c1"># Use helper to resolve pages</span>

    <span class="c1"># --- Safety Check --- #</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_overwrite</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">target_pages</span><span class="p">:</span>
            <span class="c1"># Check if the element manager has been initialized and contains any elements</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span>
                <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">has_elements</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> contains existing elements (text, OCR, etc.). &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Deskewing creates an image-only PDF, discarding these elements. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Set force_overwrite=True to proceed.&quot;</span>
                <span class="p">)</span>

    <span class="c1"># --- Process Pages --- #</span>
    <span class="n">deskewed_images_bytes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deskewing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages (output resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI)...&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">target_pages</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Deskewing Pages&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use page.deskew to get the corrected PIL image</span>
            <span class="c1"># Pass down resolutions and kwargs</span>
            <span class="n">deskewed_img</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">deskew</span><span class="p">(</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>  <span class="c1"># Let page.deskew handle detection/caching</span>
                <span class="n">detection_resolution</span><span class="o">=</span><span class="n">detection_resolution</span><span class="p">,</span>
                <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">deskewed_img</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to generate deskewed image, skipping.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Convert image to bytes for img2pdf (use PNG for lossless quality)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">deskewed_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
                <span class="n">deskewed_images_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed during deskewing process: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Option: Raise a runtime error, or continue and skip the page?</span>
            <span class="c1"># Raising makes the whole operation fail if one page fails.</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> during deskewing.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># --- Create PDF --- #</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">deskewed_images_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No pages were successfully processed to create the deskewed PDF.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">deskewed_images_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> deskewed images into in-memory PDF...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use img2pdf to combine image bytes into PDF bytes</span>
        <span class="n">pdf_bytes</span> <span class="o">=</span> <span class="n">img2pdf</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">deskewed_images_bytes</span><span class="p">)</span>

        <span class="c1"># Wrap bytes in a stream</span>
        <span class="n">pdf_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pdf_bytes</span><span class="p">)</span>

        <span class="c1"># Create a new PDF object from the stream using original config</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new PDF object from deskewed stream...&quot;</span><span class="p">)</span>
        <span class="n">new_pdf</span> <span class="o">=</span> <span class="n">PDF</span><span class="p">(</span>
            <span class="n">pdf_stream</span><span class="p">,</span>
            <span class="n">reading_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reading_order</span><span class="p">,</span>
            <span class="n">font_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_font_attrs</span><span class="p">,</span>
            <span class="n">keep_spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_spaces&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">text_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_layer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_pdf</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create in-memory PDF using img2pdf/PDF init: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Failed to create deskewed PDF object from image stream.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.export_ocr_correction_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">export_ocr_correction_task</span><span class="p">(</span><span class="n">output_zip_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Exports OCR results from this PDF into a correction task package.
Exports OCR results from this PDF into a correction task package.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_zip_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the output zip file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_zip_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the output zip file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to create_correction_task_package</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_ocr_correction_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports OCR results from this PDF into a correction task package.</span>
<span class="sd">    Exports OCR results from this PDF into a correction task package.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_zip_path: The path to save the output zip file</span>
<span class="sd">        output_zip_path: The path to save the output zip file</span>
<span class="sd">        **kwargs: Additional arguments passed to create_correction_task_package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.utils.packaging</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_correction_task_package</span>

        <span class="n">create_correction_task_package</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_zip_path</span><span class="o">=</span><span class="n">output_zip_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Failed to import &#39;create_correction_task_package&#39;. Packaging utility might be missing.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Failed to import &#39;create_correction_task_package&#39;. Packaging utility might be missing.&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to export correction task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to export correction task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.extract_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge_across_pages</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract tables from the document or matching elements.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector to filter tables</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_across_pages</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to merge tables that span across pages</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional extraction parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of extracted tables</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">merge_across_pages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract tables from the document or matching elements.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: Optional selector to filter tables</span>
<span class="sd">        merge_across_pages: Whether to merge tables that span across pages</span>
<span class="sd">        **kwargs: Additional extraction parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of extracted tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PDF.extract_tables is not fully implemented yet.&quot;</span><span class="p">)</span>
    <span class="n">all_tables</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;extract_tables&quot;</span><span class="p">):</span>
            <span class="n">all_tables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> does not have extract_tables method.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Filtering extracted tables by selector is not implemented.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">merge_across_pages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Merging tables across pages is not implemented.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_tables</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.extract_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract text from the entire document or matching elements.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector to filter elements</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_whitespace</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to keep blank characters</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to output detailed debugging for exclusions</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preserve_whitespace</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to keep blank characters</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to output detailed debugging for exclusions</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional extraction parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extracted text as string</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract text from the entire document or matching elements.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: Optional selector to filter elements</span>
<span class="sd">        preserve_whitespace: Whether to keep blank characters</span>
<span class="sd">        use_exclusions: Whether to apply exclusion regions</span>
<span class="sd">        debug_exclusions: Whether to output detailed debugging for exclusions</span>
<span class="sd">        preserve_whitespace: Whether to keep blank characters</span>
<span class="sd">        use_exclusions: Whether to apply exclusion regions</span>
<span class="sd">        debug_exclusions: Whether to output detailed debugging for exclusions</span>
<span class="sd">        **kwargs: Additional extraction parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Extracted text as string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">use_exclusions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">preserve_whitespace</span><span class="o">=</span><span class="n">preserve_whitespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Extracting text with exclusions from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span><span class="si">}</span><span class="s2"> document-level exclusions&quot;</span><span class="p">)</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
                <span class="n">preserve_whitespace</span><span class="o">=</span><span class="n">preserve_whitespace</span><span class="p">,</span>
                <span class="n">use_exclusions</span><span class="o">=</span><span class="n">use_exclusions</span><span class="p">,</span>
                <span class="n">debug_exclusions</span><span class="o">=</span><span class="n">debug_exclusions</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF: Combined </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages of text&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.find" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find the first element matching the selector OR text content across all pages.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional filter parameters.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element object or None if not found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the first element matching the selector OR text content across all pages.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional filter parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Element object or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
    <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

    <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

    <span class="c1"># Search page by page</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
        <span class="c1"># Note: _apply_selector is on Page, so we call find directly here</span>
        <span class="c1"># We pass the constructed/validated effective_selector</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>  <span class="c1"># Use the processed selector</span>
            <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>  <span class="c1"># Pass down flags</span>
            <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">element</span>
    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Not found on any page</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.find_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find all elements matching the selector OR text content across all pages.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional filter parameters.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.ElementCollection">ElementCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ElementCollection with matching elements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all elements matching the selector OR text content across all pages.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional filter parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ElementCollection with matching elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pages&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;PDF pages not yet initialized.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
    <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

    <span class="c1"># Instead of parsing here, let each page parse and apply</span>
    <span class="c1"># This avoids parsing the same selector multiple times if not needed</span>
    <span class="c1"># selector_obj = parse_selector(effective_selector)</span>

    <span class="c1"># kwargs[&quot;regex&quot;] = regex # Removed: Already passed explicitly</span>
    <span class="c1"># kwargs[&quot;case&quot;] = case   # Removed: Already passed explicitly</span>

    <span class="n">all_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
        <span class="c1"># Call page.find_all with the effective selector and flags</span>
        <span class="n">page_elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>
            <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
            <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">page_elements</span><span class="p">:</span>
            <span class="n">all_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page_elements</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.get_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get unique identifier for this PDF.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get unique identifier for this PDF.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get unique identifier for this PDF.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.get_manager" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Retrieve a manager instance by its key, instantiating it lazily if needed.</p>
<p>Managers are specialized components that handle specific functionality like
classification, structured data extraction, or OCR processing. They are
instantiated on-demand to minimize memory usage and startup time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The manager key to retrieve. Common keys include 'classification'
and 'structured_data'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The manager instance for the specified key.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no manager is registered for the given key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the manager failed to initialize.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">classification_mgr</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s1">&#39;classification&#39;</span><span class="p">)</span>
<span class="n">structured_data_mgr</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s1">&#39;structured_data&#39;</span><span class="p">)</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a manager instance by its key, instantiating it lazily if needed.</span>

<span class="sd">    Managers are specialized components that handle specific functionality like</span>
<span class="sd">    classification, structured data extraction, or OCR processing. They are</span>
<span class="sd">    instantiated on-demand to minimize memory usage and startup time.</span>

<span class="sd">    Args:</span>
<span class="sd">        key: The manager key to retrieve. Common keys include &#39;classification&#39;</span>
<span class="sd">            and &#39;structured_data&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The manager instance for the specified key.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If no manager is registered for the given key.</span>
<span class="sd">        RuntimeError: If the manager failed to initialize.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        classification_mgr = pdf.get_manager(&#39;classification&#39;)</span>
<span class="sd">        structured_data_mgr = pdf.get_manager(&#39;structured_data&#39;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if already instantiated</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">:</span>
        <span class="n">manager_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">manager_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manager &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; failed to initialize previously.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manager_instance</span>

    <span class="c1"># Not instantiated yet: get factory/class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_manager_factories&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager_factories</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No manager registered for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;. Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_manager_factories&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">factory_or_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager_factories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">factory_or_class</span>
        <span class="c1"># If it&#39;s a callable that&#39;s not a class, call it to get the class/instance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">resolved</span><span class="p">):</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolved</span><span class="p">()</span>
        <span class="c1"># If it&#39;s a class, instantiate it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">resolved</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">resolved</span>  <span class="c1"># Already an instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="k">return</span> <span class="n">instance</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize manager for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manager &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; failed to initialize: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.save_pdf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">save_pdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Saves the PDF object (all its pages) to a new file.</p>
<p>Choose one saving mode:
- <code>ocr=True</code>: Creates a new, image-based PDF using OCR results from all pages.
  Text generated during the natural-pdf session becomes searchable,
  but original vector content is lost. Requires 'ocr-export' extras.
- <code>original=True</code>: Saves a copy of the original PDF file this object represents.
  Any OCR results or analyses from the natural-pdf session are NOT included.
  If the PDF was opened from an in-memory buffer, this mode may not be suitable.
  Requires 'ocr-export' extras.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the new PDF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, save as a searchable, image-based PDF using OCR data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, save the original source PDF content.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution (dots per inch) used only when ocr=True.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the PDF has no pages, if neither or both 'ocr'
        and 'original' are True.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required libraries are not installed for the chosen mode.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an unexpected error occurs during saving.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_pdf</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
    <span class="n">ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the PDF object (all its pages) to a new file.</span>

<span class="sd">    Choose one saving mode:</span>
<span class="sd">    - `ocr=True`: Creates a new, image-based PDF using OCR results from all pages.</span>
<span class="sd">      Text generated during the natural-pdf session becomes searchable,</span>
<span class="sd">      but original vector content is lost. Requires &#39;ocr-export&#39; extras.</span>
<span class="sd">    - `original=True`: Saves a copy of the original PDF file this object represents.</span>
<span class="sd">      Any OCR results or analyses from the natural-pdf session are NOT included.</span>
<span class="sd">      If the PDF was opened from an in-memory buffer, this mode may not be suitable.</span>
<span class="sd">      Requires &#39;ocr-export&#39; extras.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path: Path to save the new PDF file.</span>
<span class="sd">        ocr: If True, save as a searchable, image-based PDF using OCR data.</span>
<span class="sd">        original: If True, save the original source PDF content.</span>
<span class="sd">        dpi: Resolution (dots per inch) used only when ocr=True.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the PDF has no pages, if neither or both &#39;ocr&#39;</span>
<span class="sd">                    and &#39;original&#39; are True.</span>
<span class="sd">        ImportError: If required libraries are not installed for the chosen mode.</span>
<span class="sd">        RuntimeError: If an unexpected error occurs during saving.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot save an empty PDF object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ocr</span> <span class="o">^</span> <span class="n">original</span><span class="p">):</span>  <span class="c1"># XOR: exactly one must be true</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exactly one of &#39;ocr&#39; or &#39;original&#39; must be True.&quot;</span><span class="p">)</span>

    <span class="n">output_path_obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path_obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ocr</span><span class="p">:</span>
        <span class="n">has_vector_elements</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;rects&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">rects</span>
                <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">lines</span>
                <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;curves&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">curves</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;chars&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">has_vector_elements</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">has_vector_elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Warning: Saving with ocr=True creates an image-based PDF. &quot;</span>
                <span class="s2">&quot;Original vector elements (rects, lines, non-OCR text/chars) &quot;</span>
                <span class="s2">&quot;will not be preserved in the output file.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving searchable PDF (OCR text layer) to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Delegate to the searchable PDF exporter, passing self (PDF instance)</span>
            <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create searchable PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">elif</span> <span class="n">original</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">create_original_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Saving with original=True requires &#39;pikepdf&#39;. &quot;</span>
                <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ocr-export]&quot;&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Optional: Add warning about losing OCR data similar to PageCollection</span>
        <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;find_all&quot;</span><span class="p">):</span>
                <span class="n">ocr_text_elements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ocr_text_elements</span><span class="p">:</span>
                    <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;words&quot;</span><span class="p">):</span>  <span class="c1"># Fallback</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
                    <span class="n">has_ocr_elements</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">has_ocr_elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Warning: Saving with original=True preserves original page content. &quot;</span>
                <span class="s2">&quot;OCR text generated in this session will not be included in the saved file.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving original PDF content to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Delegate to the original PDF exporter, passing self (PDF instance)</span>
            <span class="n">create_original_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Re-raise exception from exporter</span>
            <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.save_searchable" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">save_searchable</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>DEPRECATED: Use save_pdf(..., ocr=True) instead.
Saves the PDF with an OCR text layer, making content searchable.</p>
<p>Requires optional dependencies. Install with: pip install "natural-pdf[ocr-export]"</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the searchable PDF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution for rendering and OCR overlay</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to the exporter</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_searchable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Path&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED: Use save_pdf(..., ocr=True) instead.</span>
<span class="sd">    Saves the PDF with an OCR text layer, making content searchable.</span>

<span class="sd">    Requires optional dependencies. Install with: pip install \&quot;natural-pdf[ocr-export]\&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path: Path to save the searchable PDF</span>
<span class="sd">        dpi: Resolution for rendering and OCR overlay</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to the exporter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;PDF.save_searchable() is deprecated. Use PDF.save_pdf(..., ocr=True) instead.&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">create_searchable_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Saving searchable PDF requires &#39;pikepdf&#39;. &quot;</span>
            <span class="s1">&#39;Install with: pip install &quot;natural-pdf[ocr-export]&quot;&#39;</span>
        <span class="p">)</span>
    <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="c1"># Call the exporter directly, passing self (the PDF instance)</span>
    <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.PDF.search_within_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">PDF</span><span class="o">.</span><span class="n">search_within_index</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">search_service</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Finds relevant documents from this PDF within a search index.
Finds relevant documents from this PDF within a search index.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>, <span title="PIL.Image.Image">Image</span>, <a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The search query (text, image path, PIL Image, Region)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>search_service</code>
            </td>
            <td>
                  <code><span title="natural_pdf.search.SearchServiceProtocol">SearchServiceProtocol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pre-configured SearchService instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.search.SearchOptions">SearchOptions</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional SearchOptions to configure the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>, <span title="PIL.Image.Image">Image</span>, <a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The search query (text, image path, PIL Image, Region)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>search_service</code>
            </td>
            <td>
                  <code><span title="natural_pdf.search.SearchServiceProtocol">SearchServiceProtocol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pre-configured SearchService instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.search.SearchOptions">SearchOptions</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional SearchOptions to configure the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of result dictionaries, sorted by relevance</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of result dictionaries, sorted by relevance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search dependencies are not installed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search_service is None</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search_service does not conform to the protocol</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the collection managed by the service does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other search failures</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search dependencies are not installed</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search_service is None</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If search_service does not conform to the protocol</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the collection managed by the service does not exist</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other search failures</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/pdf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">search_within_index</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s2">&quot;Region&quot;</span><span class="p">],</span>
    <span class="n">search_service</span><span class="p">:</span> <span class="s2">&quot;SearchServiceProtocol&quot;</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;SearchOptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds relevant documents from this PDF within a search index.</span>
<span class="sd">    Finds relevant documents from this PDF within a search index.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The search query (text, image path, PIL Image, Region)</span>
<span class="sd">        search_service: A pre-configured SearchService instance</span>
<span class="sd">        options: Optional SearchOptions to configure the query</span>
<span class="sd">        query: The search query (text, image path, PIL Image, Region)</span>
<span class="sd">        search_service: A pre-configured SearchService instance</span>
<span class="sd">        options: Optional SearchOptions to configure the query</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of result dictionaries, sorted by relevance</span>
<span class="sd">        A list of result dictionaries, sorted by relevance</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If search dependencies are not installed</span>
<span class="sd">        ValueError: If search_service is None</span>
<span class="sd">        TypeError: If search_service does not conform to the protocol</span>
<span class="sd">        FileNotFoundError: If the collection managed by the service does not exist</span>
<span class="sd">        RuntimeError: For other search failures</span>
<span class="sd">        ImportError: If search dependencies are not installed</span>
<span class="sd">        ValueError: If search_service is None</span>
<span class="sd">        TypeError: If search_service does not conform to the protocol</span>
<span class="sd">        FileNotFoundError: If the collection managed by the service does not exist</span>
<span class="sd">        RuntimeError: For other search failures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">search_service</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A configured SearchServiceProtocol instance must be provided.&quot;</span><span class="p">)</span>

    <span class="n">collection_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">search_service</span><span class="p">,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;Unknown Collection&gt;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Searching within index &#39;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&#39; for content from PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">search_service</span>

    <span class="n">query_input</span> <span class="o">=</span> <span class="n">query</span>
    <span class="n">effective_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">TextSearchOptions</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query is a Region object. Extracting text.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="p">,</span> <span class="n">TextSearchOptions</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Querying with Region image requires MultiModalSearchOptions. Falling back to text extraction.&quot;</span>
            <span class="p">)</span>
        <span class="n">query_input</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_input</span> <span class="ow">or</span> <span class="n">query_input</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Region has no extractable text for query.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Add filter to scope search to THIS PDF</span>
    <span class="c1"># Add filter to scope search to THIS PDF</span>
    <span class="n">pdf_scope_filter</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;pdf_path&quot;</span><span class="p">,</span>
        <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying filter to scope search to PDF: </span><span class="si">{</span><span class="n">pdf_scope_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Combine with existing filters in options (if any)</span>
    <span class="k">if</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining PDF scope filter with existing filters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operator&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AND&quot;</span>
        <span class="p">):</span>
            <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf_scope_filter</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">+</span> <span class="p">[</span><span class="n">pdf_scope_filter</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="n">pdf_scope_filter</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported format for existing filters. Overwriting with PDF scope filter.&quot;</span>
            <span class="p">)</span>
            <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">pdf_scope_filter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">pdf_scope_filter</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final filters for service search: </span><span class="si">{</span><span class="n">effective_options</span><span class="o">.</span><span class="n">filters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query_input</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">effective_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results from PDF &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">fnf</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search failed: Collection not found. Error: </span><span class="si">{</span><span class="n">fnf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search failed: Collection not found. Error: </span><span class="si">{</span><span class="n">fnf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search within index failed. See logs for details.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SearchService search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search within index failed. See logs for details.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="natural_pdf.Page" class="doc doc-heading">
            <code>natural_pdf.Page</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="natural_pdf.classification.mixin.ClassificationMixin">ClassificationMixin</span></code>, <code><span title="natural_pdf.extraction.mixin.ExtractionMixin">ExtractionMixin</span></code>, <code><span title="natural_pdf.analyzers.shape_detection_mixin.ShapeDetectionMixin">ShapeDetectionMixin</span></code>, <code><span title="natural_pdf.describe.mixin.DescribeMixin">DescribeMixin</span></code></p>


        <p>Enhanced Page wrapper built on top of pdfplumber.Page.</p>
<p>This class provides a fluent interface for working with PDF pages,
with improved selection, navigation, extraction, and question-answering capabilities.
It integrates multiple analysis capabilities through mixins and provides spatial
navigation with CSS-like selectors.</p>
<p>The Page class serves as the primary interface for document analysis, offering:
- Element selection and spatial navigation
- OCR and layout analysis integration
- Table detection and extraction
- AI-powered classification and data extraction
- Visual debugging with highlighting and cropping
- Text style analysis and structure detection</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.index

  
      property
   (natural_pdf.Page.index)" href="#natural_pdf.Page.index">index</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Zero-based index of this page in the PDF.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.number

  
      property
   (natural_pdf.Page.number)" href="#natural_pdf.Page.number">number</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One-based page number (index + 1).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.width

  
      property
   (natural_pdf.Page.width)" href="#natural_pdf.Page.width">width</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Page width in points.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.height

  
      property
   (natural_pdf.Page.height)" href="#natural_pdf.Page.height">height</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Page height in points.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.Page.bbox">bbox</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box tuple (x0, top, x1, bottom) of the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.chars

  
      property
   (natural_pdf.Page.chars)" href="#natural_pdf.Page.chars">chars</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of character elements on the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.words

  
      property
   (natural_pdf.Page.words)" href="#natural_pdf.Page.words">words</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of word elements on the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.lines

  
      property
   (natural_pdf.Page.lines)" href="#natural_pdf.Page.lines">lines</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of line elements on the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.rects

  
      property
   (natural_pdf.Page.rects)" href="#natural_pdf.Page.rects">rects</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of rectangle elements on the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Page.images

  
      property
   (natural_pdf.Page.images)" href="#natural_pdf.Page.images">images</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of image elements on the page.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.Page.metadata">metadata</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary for storing analysis results and custom data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Basic usage:
<div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Find elements with CSS-like selectors</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;text[size&gt;12]:bold&#39;</span><span class="p">)</span>
<span class="n">summaries</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;Summary&quot;)&#39;</span><span class="p">)</span>

<span class="c1"># Spatial navigation</span>
<span class="n">content_below</span> <span class="o">=</span> <span class="n">summaries</span><span class="o">.</span><span class="n">below</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="s1">&#39;text[size&gt;12]:bold&#39;</span><span class="p">)</span>

<span class="c1"># Table extraction</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_table</span><span class="p">()</span>
</code></pre></div></p>
<p>Advanced usage:
<div class="highlight"><pre><span></span><code><span class="c1"># Apply OCR if needed</span>
<span class="n">page</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;easyocr&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># Layout analysis</span>
<span class="n">page</span><span class="o">.</span><span class="n">analyze_layout</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;yolo&#39;</span><span class="p">)</span>

<span class="c1"># AI-powered extraction</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_structured_data</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span>

<span class="c1"># Visual debugging</span>
<span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;Important&quot;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></p>
</details>






              <details class="quote">
                <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Page</span><span class="p">(</span><span class="n">ClassificationMixin</span><span class="p">,</span> <span class="n">ExtractionMixin</span><span class="p">,</span> <span class="n">ShapeDetectionMixin</span><span class="p">,</span> <span class="n">DescribeMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced Page wrapper built on top of pdfplumber.Page.</span>

<span class="sd">    This class provides a fluent interface for working with PDF pages,</span>
<span class="sd">    with improved selection, navigation, extraction, and question-answering capabilities.</span>
<span class="sd">    It integrates multiple analysis capabilities through mixins and provides spatial</span>
<span class="sd">    navigation with CSS-like selectors.</span>

<span class="sd">    The Page class serves as the primary interface for document analysis, offering:</span>
<span class="sd">    - Element selection and spatial navigation</span>
<span class="sd">    - OCR and layout analysis integration</span>
<span class="sd">    - Table detection and extraction</span>
<span class="sd">    - AI-powered classification and data extraction</span>
<span class="sd">    - Visual debugging with highlighting and cropping</span>
<span class="sd">    - Text style analysis and structure detection</span>

<span class="sd">    Attributes:</span>
<span class="sd">        index: Zero-based index of this page in the PDF.</span>
<span class="sd">        number: One-based page number (index + 1).</span>
<span class="sd">        width: Page width in points.</span>
<span class="sd">        height: Page height in points.</span>
<span class="sd">        bbox: Bounding box tuple (x0, top, x1, bottom) of the page.</span>
<span class="sd">        chars: Collection of character elements on the page.</span>
<span class="sd">        words: Collection of word elements on the page.</span>
<span class="sd">        lines: Collection of line elements on the page.</span>
<span class="sd">        rects: Collection of rectangle elements on the page.</span>
<span class="sd">        images: Collection of image elements on the page.</span>
<span class="sd">        metadata: Dictionary for storing analysis results and custom data.</span>

<span class="sd">    Example:</span>
<span class="sd">        Basic usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        page = pdf.pages[0]</span>

<span class="sd">        # Find elements with CSS-like selectors</span>
<span class="sd">        headers = page.find_all(&#39;text[size&gt;12]:bold&#39;)</span>
<span class="sd">        summaries = page.find(&#39;text:contains(&quot;Summary&quot;)&#39;)</span>

<span class="sd">        # Spatial navigation</span>
<span class="sd">        content_below = summaries.below(until=&#39;text[size&gt;12]:bold&#39;)</span>

<span class="sd">        # Table extraction</span>
<span class="sd">        tables = page.extract_table()</span>
<span class="sd">        ```</span>

<span class="sd">        Advanced usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Apply OCR if needed</span>
<span class="sd">        page.apply_ocr(engine=&#39;easyocr&#39;, resolution=300)</span>

<span class="sd">        # Layout analysis</span>
<span class="sd">        page.analyze_layout(engine=&#39;yolo&#39;)</span>

<span class="sd">        # AI-powered extraction</span>
<span class="sd">        data = page.extract_structured_data(MySchema)</span>

<span class="sd">        # Visual debugging</span>
<span class="sd">        page.find(&#39;text:contains(&quot;Important&quot;)&#39;).show()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">page</span><span class="p">:</span> <span class="s2">&quot;pdfplumber.page.Page&quot;</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;PDF&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">font_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">load_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a page wrapper.</span>

<span class="sd">        Creates an enhanced Page object that wraps a pdfplumber page with additional</span>
<span class="sd">        functionality for spatial navigation, analysis, and AI-powered extraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            page: The underlying pdfplumber page object that provides raw PDF data.</span>
<span class="sd">            parent: Parent PDF object that contains this page and provides access</span>
<span class="sd">                to managers and global settings.</span>
<span class="sd">            index: Zero-based index of this page in the PDF document.</span>
<span class="sd">            font_attrs: List of font attributes to consider when grouping characters</span>
<span class="sd">                into words. Common attributes include [&#39;fontname&#39;, &#39;size&#39;, &#39;flags&#39;].</span>
<span class="sd">                If None, uses default character-to-word grouping rules.</span>
<span class="sd">            load_text: If True, load and process text elements from the PDF&#39;s text layer.</span>
<span class="sd">                If False, skip text layer processing (useful for OCR-only workflows).</span>

<span class="sd">        Note:</span>
<span class="sd">            This constructor is typically called automatically when accessing pages</span>
<span class="sd">            through the PDF.pages collection. Direct instantiation is rarely needed.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Pages are usually accessed through the PDF object</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">            page = pdf.pages[0]  # Page object created automatically</span>

<span class="sd">            # Direct construction (advanced usage)</span>
<span class="sd">            import pdfplumber</span>
<span class="sd">            with pdfplumber.open(&quot;document.pdf&quot;) as plumber_pdf:</span>
<span class="sd">                plumber_page = plumber_pdf.pages[0]</span>
<span class="sd">                page = Page(plumber_page, pdf, 0, load_text=True)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page</span> <span class="o">=</span> <span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_text</span> <span class="o">=</span> <span class="n">load_text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_styles</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Lazy-loaded text style analyzer results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List to store exclusion functions/regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Stores detected skew angle</span>

        <span class="c1"># --- ADDED --- Metadata store for mixins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># --- END ADDED ---</span>

        <span class="c1"># Region management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;detected&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Layout detection results</span>
            <span class="s2">&quot;named&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Named regions (name -&gt; region)</span>
        <span class="p">}</span>

        <span class="c1"># -------------------------------------------------------------</span>
        <span class="c1"># Page-scoped configuration begins as a shallow copy of the parent</span>
        <span class="c1"># PDF-level configuration so that auto-computed tolerances or other</span>
        <span class="c1"># page-specific values do not overwrite siblings.</span>
        <span class="c1"># -------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="c1"># Initialize ElementManager, passing font_attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span> <span class="o">=</span> <span class="n">ElementManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="n">font_attrs</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_text</span><span class="p">)</span>
        <span class="c1"># self._highlighter = HighlightingService(self) # REMOVED - Use property accessor</span>
        <span class="c1"># --- NEW --- Central registry for analysis results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># --- Get OCR Manager Instance ---</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">OCRManager</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;_ocr_manager&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">,</span> <span class="n">OCRManager</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_ocr_manager</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Using OCRManager instance from parent PDF.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">OCRManager</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCRManager instance not found on parent PDF object.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- Get Layout Manager Instance ---</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">LayoutManager</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;_layout_manager&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_layout_manager</span><span class="p">,</span> <span class="n">LayoutManager</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_layout_manager</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Using LayoutManager instance from parent PDF.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">LayoutManager</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: LayoutManager instance not found on parent PDF object. Layout analysis will fail.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Initialize the internal variable with a single underscore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout_analyzer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_elements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Image.Image&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PDF&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides public access to the parent PDF object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page number (1-based).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">page_number</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page number (1-based).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">page_number</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page index (0-based).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page width.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page height.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">height</span>

    <span class="c1"># --- Highlighting Service Accessor ---</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_highlighter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;HighlightingService&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides access to the parent PDF&#39;s HighlightingService.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;highlighter&quot;</span><span class="p">):</span>
            <span class="c1"># This should ideally not happen if PDF.__init__ works correctly</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Parent PDF object does not have a &#39;highlighter&#39; attribute.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">highlighter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all exclusions from the page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_exclusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exclusion_func_or_region</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="s2">&quot;Region&quot;</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an exclusion to the page. Text from these regions will be excluded from extraction.</span>
<span class="sd">        Ensures non-callable items are stored as Region objects if possible.</span>

<span class="sd">        Args:</span>
<span class="sd">            exclusion_func_or_region: Either a callable function returning a Region,</span>
<span class="sd">                                      a Region object, or another object with a valid .bbox attribute.</span>
<span class="sd">            label: Optional label for this exclusion (e.g., &#39;header&#39;, &#39;footer&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If a non-callable, non-Region object without a valid bbox is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exclusion_data</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize exclusion data</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">):</span>
            <span class="c1"># Store callable functions along with their label</span>
            <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added callable exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
            <span class="c1"># Store Region objects directly, assigning the label</span>
            <span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>  <span class="c1"># Assign label</span>
            <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>  <span class="c1"># Store as tuple for consistency</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added Region exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="p">):</span>
            <span class="c1"># Convert objects with a valid bbox to a Region before storing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bbox_coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
                <span class="c1"># Pass the label to the Region constructor</span>
                <span class="n">region_to_add</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox_coords</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_to_add</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>  <span class="c1"># Store as tuple</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39; converted to Region from </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">region_to_add</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Raise an error if conversion fails</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to convert exclusion object </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2"> with bbox </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bbox&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to Region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Reject invalid types</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid exclusion type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">)</span><span class="si">}</span><span class="s2">. Must be callable, Region, or have a valid .bbox attribute.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Append the stored data (tuple of object/callable and label)</span>
        <span class="k">if</span> <span class="n">exclusion_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="s2">&quot;Region&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a region to the page.</span>

<span class="sd">        Args:</span>
<span class="sd">            region: Region object to add</span>
<span class="sd">            name: Optional name for the region</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if it&#39;s actually a Region object</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;region must be a Region object&quot;</span><span class="p">)</span>

        <span class="c1"># Set the source and name</span>
        <span class="n">region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;named&quot;</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="c1"># Add to named regions dictionary (overwriting if name already exists)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add to detected regions list (unnamed but registered)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="c1"># Add to element manager for selector queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add multiple regions to the page.</span>

<span class="sd">        Args:</span>
<span class="sd">            regions: List of Region objects to add</span>
<span class="sd">            prefix: Optional prefix for automatic naming (regions will be named prefix_1, prefix_2, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="c1"># Add with automatic sequential naming</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add without names</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_exclusion_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all exclusion regions for this page.</span>
<span class="sd">        Assumes self._exclusions contains tuples of (callable/Region, label).</span>

<span class="sd">        Args:</span>
<span class="sd">            include_callable: Whether to evaluate callable exclusion functions</span>
<span class="sd">            debug: Enable verbose debug logging for exclusion evaluation</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Region objects to exclude, with labels assigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">)</span><span class="si">}</span><span class="s2"> exclusions&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exclusion_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">):</span>
            <span class="c1"># Unpack the exclusion object/callable and its label</span>
            <span class="n">exclusion_item</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">exclusion_data</span>
            <span class="n">exclusion_label</span> <span class="o">=</span> <span class="n">label</span> <span class="k">if</span> <span class="n">label</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;exclusion </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Process callable exclusion functions</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">exclusion_item</span><span class="p">)</span> <span class="ow">and</span> <span class="n">include_callable</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Evaluating callable &#39;</span><span class="si">{</span><span class="n">exclusion_label</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

                    <span class="c1"># Temporarily clear exclusions (consider if really needed)</span>
                    <span class="n">temp_original_exclusions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># Call the function - Expects it to return a Region or None</span>
                    <span class="n">region_result</span> <span class="o">=</span> <span class="n">exclusion_item</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                    <span class="c1"># Restore exclusions</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="n">temp_original_exclusions</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region_result</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
                        <span class="c1"># Assign the label to the returned region</span>
                        <span class="n">region_result</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
                        <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Added region from callable &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">region_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">region_result</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Callable exclusion &#39;</span><span class="si">{</span><span class="n">exclusion_label</span><span class="si">}</span><span class="s2">&#39; returned non-Region object: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">region_result</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Callable returned non-Region/None: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">region_result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;     Callable &#39;</span><span class="si">{</span><span class="n">exclusion_label</span><span class="si">}</span><span class="s2">&#39; returned None, no region added&quot;</span>
                            <span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error evaluating callable exclusion &#39;</span><span class="si">{</span><span class="n">exclusion_label</span><span class="si">}</span><span class="s2">&#39; for page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Process direct Region objects (label was assigned in add_exclusion)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusion_item</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
                <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion_item</span><span class="p">)</span>  <span class="c1"># Label is already on the Region object</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Added direct region &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exclusion_item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># No else needed, add_exclusion should prevent invalid types</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid exclusion regions to apply&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">regions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_elements_by_exclusions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">],</span> <span class="n">debug_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters a list of elements, removing those within the page&#39;s exclusion regions.</span>

<span class="sd">        Args:</span>
<span class="sd">            elements: The list of elements to filter.</span>
<span class="sd">            debug_exclusions: Whether to output detailed exclusion debugging info (default: False).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new list containing only the elements not falling within any exclusion region.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: No exclusions defined, returning all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">elements</span>

        <span class="c1"># Get all exclusion regions, including evaluating callable functions</span>
        <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span>
            <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_exclusions</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exclusion_regions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: No valid exclusion regions found, returning all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">elements</span>

        <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Applying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclusion_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> exclusion regions to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements.&quot;</span>
            <span class="p">)</span>

        <span class="n">filtered_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">excluded_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">exclusion_regions</span><span class="p">:</span>
                <span class="c1"># Use the region&#39;s method to check if the element is inside</span>
                <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">_is_element_in_region</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
                    <span class="n">exclude</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>  <span class="c1"># No need to check other regions for this element</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="n">filtered_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Excluded </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> elements, keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_elements</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_elements</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
        <span class="o">*</span><span class="p">,</span>  <span class="c1"># Force subsequent args to be keyword-only</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find first element on this page matching selector OR text content.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional filter parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Element object or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Escape quotes within the text for the selector string</span>
            <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="c1"># Default to &#39;text:contains(...)&#39;</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="c1"># Note: regex/case handled by kwargs passed down</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should be unreachable due to checks above</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

        <span class="c1"># Pass regex and case flags to selector function via kwargs</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regex</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">case</span>

        <span class="c1"># First get all matching elements without applying exclusions initially within _apply_selector</span>
        <span class="n">results_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_selector</span><span class="p">(</span>
            <span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>  <span class="c1"># _apply_selector doesn&#39;t filter</span>

        <span class="c1"># Filter the results based on exclusions if requested</span>
        <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="ow">and</span> <span class="n">results_collection</span><span class="p">:</span>
            <span class="n">filtered_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span><span class="n">results_collection</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="c1"># Return the first element from the filtered list</span>
            <span class="k">return</span> <span class="n">filtered_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">filtered_elements</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">results_collection</span><span class="p">:</span>
            <span class="c1"># Return the first element from the unfiltered results</span>
            <span class="k">return</span> <span class="n">results_collection</span><span class="o">.</span><span class="n">first</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
        <span class="o">*</span><span class="p">,</span>  <span class="c1"># Force subsequent args to be keyword-only</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all elements on this page matching selector OR text content.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional filter parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection with matching elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>  <span class="c1"># Import here for type hint</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Escape quotes within the text for the selector string</span>
            <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="c1"># Default to &#39;text:contains(...)&#39;</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should be unreachable due to checks above</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

        <span class="c1"># Pass regex and case flags to selector function via kwargs</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regex</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">case</span>

        <span class="c1"># First get all matching elements without applying exclusions initially within _apply_selector</span>
        <span class="n">results_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_selector</span><span class="p">(</span>
            <span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>  <span class="c1"># _apply_selector doesn&#39;t filter</span>

        <span class="c1"># Filter the results based on exclusions if requested</span>
        <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="ow">and</span> <span class="n">results_collection</span><span class="p">:</span>
            <span class="n">filtered_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span><span class="n">results_collection</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">filtered_elements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return the unfiltered collection</span>
            <span class="k">return</span> <span class="n">results_collection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_selector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selector_obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>  <span class="c1"># Removed apply_exclusions arg</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply selector to page elements.</span>
<span class="sd">        Exclusions are now handled by the calling methods (find, find_all) if requested.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector_obj: Parsed selector dictionary (single or compound OR selector)</span>
<span class="sd">            **kwargs: Additional filter parameters including &#39;regex&#39; and &#39;case&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection of matching elements (unfiltered by exclusions)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.selectors.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">selector_to_filter_func</span>

        <span class="c1"># Handle compound OR selectors</span>
        <span class="k">if</span> <span class="n">selector_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;or&quot;</span><span class="p">:</span>
            <span class="c1"># For OR selectors, search all elements and let the filter function decide</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">get_all_elements</span><span class="p">()</span>

            <span class="c1"># Create filter function from compound selector</span>
            <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Apply the filter to all elements</span>
            <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements_to_search</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span>

            <span class="c1"># Sort elements in reading order if requested</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reading_order&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span><span class="p">):</span>
                    <span class="n">matching_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot sort elements in reading order: Missing required attributes (top, x0).&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Return result collection</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">matching_elements</span><span class="p">)</span>

        <span class="c1"># Handle single selectors (existing logic)</span>
        <span class="c1"># Get element type to filter</span>
        <span class="n">element_type</span> <span class="o">=</span> <span class="n">selector_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Determine which elements to search based on element type</span>
        <span class="n">elements_to_search</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">get_all_elements</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;rect&quot;</span> <span class="ow">or</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;rectangle&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">rects</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">lines</span>
        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;region&quot;</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elements_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">get_all_elements</span><span class="p">()</span>

        <span class="c1"># Create filter function from selector, passing any additional parameters</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Apply the filter to matching elements</span>
        <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements_to_search</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span>

        <span class="c1"># Handle spatial pseudo-classes that require relationship checking</span>
        <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="n">selector_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudo_classes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pseudo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">pseudo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;above&quot;</span><span class="p">,</span> <span class="s2">&quot;below&quot;</span><span class="p">,</span> <span class="s2">&quot;near&quot;</span><span class="p">,</span> <span class="s2">&quot;left-of&quot;</span><span class="p">,</span> <span class="s2">&quot;right-of&quot;</span><span class="p">):</span>
                <span class="c1"># Find the reference element first</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.selectors.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_selector</span>

                <span class="n">ref_selector</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span>
                <span class="c1"># Recursively call _apply_selector for reference element (exclusions handled later)</span>
                <span class="n">ref_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_selector</span><span class="p">(</span><span class="n">ref_selector</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ref_elements</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>

                <span class="n">ref_element</span> <span class="o">=</span> <span class="n">ref_elements</span><span class="o">.</span><span class="n">first</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ref_element</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Filter elements based on spatial relationship</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;above&quot;</span><span class="p">:</span>
                    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">el</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_element</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="n">ref_element</span><span class="o">.</span><span class="n">top</span>
                    <span class="p">]</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;below&quot;</span><span class="p">:</span>
                    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">el</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_element</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">top</span> <span class="o">&gt;=</span> <span class="n">ref_element</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="p">]</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;left-of&quot;</span><span class="p">:</span>
                    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">el</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_element</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">x1</span> <span class="o">&lt;=</span> <span class="n">ref_element</span><span class="o">.</span><span class="n">x0</span>
                    <span class="p">]</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;right-of&quot;</span><span class="p">:</span>
                    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">el</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_element</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">ref_element</span><span class="o">.</span><span class="n">x1</span>
                    <span class="p">]</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;near&quot;</span><span class="p">:</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">distance</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="n">el2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                            <span class="nb">hasattr</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el1</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el2</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el2</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el2</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el2</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Cannot calculate distance</span>
                        <span class="n">el1_center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">el1</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">el1</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">el1_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">el1</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">el1</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">el2_center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">el2</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">el2</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">el2_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">el2</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">el2</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">el1_center_x</span> <span class="o">-</span> <span class="n">el2_center_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">el1_center_y</span> <span class="o">-</span> <span class="n">el2_center_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;near_threshold&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span> <span class="k">if</span> <span class="n">distance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">ref_element</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
                    <span class="p">]</span>

        <span class="c1"># Sort elements in reading order if requested</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reading_order&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span><span class="p">):</span>
                <span class="n">matching_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot sort elements in reading order: Missing required attributes (top, x0).&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Create result collection - exclusions are handled by the calling methods (find, find_all)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">matching_elements</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a region on this page with the specified coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            x0: Left x-coordinate</span>
<span class="sd">            top: Top y-coordinate</span>
<span class="sd">            x1: Right x-coordinate</span>
<span class="sd">            bottom: Bottom y-coordinate</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object for the specified coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">region</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">top</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bottom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a region on this page with more intuitive named parameters,</span>
<span class="sd">        allowing definition by coordinates or by coordinate + dimension.</span>

<span class="sd">        Args:</span>
<span class="sd">            left: Left x-coordinate (default: 0 if width not used).</span>
<span class="sd">            top: Top y-coordinate (default: 0 if height not used).</span>
<span class="sd">            right: Right x-coordinate (default: page width if width not used).</span>
<span class="sd">            bottom: Bottom y-coordinate (default: page height if height not used).</span>
<span class="sd">            width: Width definition. Can be:</span>
<span class="sd">                   - Numeric: The width of the region in points. Cannot be used with both left and right.</span>
<span class="sd">                   - String &#39;full&#39;: Sets region width to full page width (overrides left/right).</span>
<span class="sd">                   - String &#39;element&#39; or None (default): Uses provided/calculated left/right,</span>
<span class="sd">                     defaulting to page width if neither are specified.</span>
<span class="sd">            height: Numeric height of the region. Cannot be used with both top and bottom.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object for the specified coordinates</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If conflicting arguments are provided (e.g., top, bottom, and height)</span>
<span class="sd">                      or if width is an invalid string.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; page.region(top=100, height=50)  # Region from y=100 to y=150, default width</span>
<span class="sd">            &gt;&gt;&gt; page.region(left=50, width=100)   # Region from x=50 to x=150, default height</span>
<span class="sd">            &gt;&gt;&gt; page.region(bottom=500, height=50) # Region from y=450 to y=500</span>
<span class="sd">            &gt;&gt;&gt; page.region(right=200, width=50)  # Region from x=150 to x=200</span>
<span class="sd">            &gt;&gt;&gt; page.region(top=100, bottom=200, width=&quot;full&quot;) # Explicit full width</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Percentage support  convert strings like &quot;30%&quot; to absolute values</span>
        <span class="c1"># based on page dimensions.  X-axis params (left, right, width) use</span>
        <span class="c1"># page.width; Y-axis params (top, bottom, height) use page.height.</span>
        <span class="c1"># ------------------------------------------------------------------</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_pct_to_abs</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pct</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span>  <span class="c1"># leave unchanged if not a number</span>
                <span class="k">return</span> <span class="n">pct</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># --- Type checking and basic validation ---</span>
        <span class="n">is_width_numeric</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="n">is_width_string</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">width_mode</span> <span class="o">=</span> <span class="s2">&quot;element&quot;</span>  <span class="c1"># Default mode</span>

        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify top, bottom, and height simultaneously.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_width_numeric</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify left, right, and a numeric width simultaneously.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_width_string</span><span class="p">:</span>
            <span class="n">width_lower</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">width_lower</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;String width argument must be &#39;full&#39; or &#39;element&#39;.&quot;</span><span class="p">)</span>
            <span class="n">width_mode</span> <span class="o">=</span> <span class="n">width_lower</span>

        <span class="c1"># --- Calculate Coordinates ---</span>
        <span class="n">final_top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="n">final_left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">final_right</span> <span class="o">=</span> <span class="n">right</span>

        <span class="c1"># Height calculations</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">height</span>
            <span class="k">elif</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">height</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Neither top nor bottom provided, default top to 0</span>
                <span class="n">final_top</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">height</span>

        <span class="c1"># Width calculations (numeric only)</span>
        <span class="k">if</span> <span class="n">is_width_numeric</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">width</span>
            <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">width</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Neither left nor right provided, default left to 0</span>
                <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">final_right</span> <span class="o">=</span> <span class="n">width</span>

        <span class="c1"># --- Apply Defaults for Unset Coordinates ---</span>
        <span class="c1"># Only default coordinates if they weren&#39;t set by dimension calculation</span>
        <span class="k">if</span> <span class="n">final_top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_top</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">final_bottom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if bottom should have been set by height calc</span>
            <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

        <span class="k">if</span> <span class="n">final_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">final_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if right should have been set by width calc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_width_numeric</span> <span class="ow">or</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

        <span class="c1"># --- Handle width_mode == &#39;full&#39; ---</span>
        <span class="k">if</span> <span class="n">width_mode</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="c1"># Override left/right if mode is full</span>
            <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">final_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

        <span class="c1"># --- Final Validation &amp; Creation ---</span>
        <span class="c1"># Ensure coordinates are within page bounds (clamp)</span>
        <span class="n">final_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_left</span><span class="p">)</span>
        <span class="n">final_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_top</span><span class="p">)</span>
        <span class="n">final_right</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">final_right</span><span class="p">)</span>
        <span class="n">final_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">)</span>

        <span class="c1"># Ensure valid box (x0&lt;=x1, top&lt;=bottom)</span>
        <span class="k">if</span> <span class="n">final_left</span> <span class="o">&gt;</span> <span class="n">final_right</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated left (</span><span class="si">{</span><span class="n">final_left</span><span class="si">}</span><span class="s2">) &gt; right (</span><span class="si">{</span><span class="n">final_right</span><span class="si">}</span><span class="s2">). Swapping.&quot;</span><span class="p">)</span>
            <span class="n">final_left</span><span class="p">,</span> <span class="n">final_right</span> <span class="o">=</span> <span class="n">final_right</span><span class="p">,</span> <span class="n">final_left</span>
        <span class="k">if</span> <span class="n">final_top</span> <span class="o">&gt;</span> <span class="n">final_bottom</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated top (</span><span class="si">{</span><span class="n">final_top</span><span class="si">}</span><span class="s2">) &gt; bottom (</span><span class="si">{</span><span class="n">final_bottom</span><span class="si">}</span><span class="s2">). Swapping.&quot;</span><span class="p">)</span>
            <span class="n">final_top</span><span class="p">,</span> <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">final_bottom</span><span class="p">,</span> <span class="n">final_top</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">final_left</span><span class="p">,</span> <span class="n">final_top</span><span class="p">,</span> <span class="n">final_right</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_elements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all elements on this page.</span>

<span class="sd">        Args:</span>
<span class="sd">            apply_exclusions: Whether to apply exclusion regions (default: True).</span>
<span class="sd">            debug_exclusions: Whether to output detailed exclusion debugging info (default: False).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of all elements on the page, potentially filtered by exclusions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all elements from the element manager</span>
        <span class="n">all_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">get_all_elements</span><span class="p">()</span>

        <span class="c1"># Apply exclusions if requested</span>
        <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span>
                <span class="n">all_elements</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="n">debug_exclusions</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: get_elements returning all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements (exclusions not applied).&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">all_elements</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_elements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">],</span> <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter a list of elements based on a selector.</span>

<span class="sd">        Args:</span>
<span class="sd">            elements: List of elements to filter</span>
<span class="sd">            selector: CSS-like selector string</span>
<span class="sd">            **kwargs: Additional filter parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of elements that match the selector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.selectors.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_selector</span><span class="p">,</span> <span class="n">selector_to_filter_func</span>

        <span class="c1"># Parse the selector</span>
        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

        <span class="c1"># Create filter function from selector</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Apply the filter to the elements</span>
        <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span>

        <span class="c1"># Sort elements in reading order if requested</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reading_order&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span><span class="p">):</span>
                <span class="n">matching_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot sort elements in reading order: Missing required attributes (top, x0).&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">matching_elements</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select content from the top of the page until matching selector.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string</span>
<span class="sd">            include_endpoint: Whether to include the endpoint element in the region</span>
<span class="sd">            **kwargs: Additional selection parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object representing the selected content</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; page.until(&#39;text:contains(&quot;Conclusion&quot;)&#39;)  # Select from top to conclusion</span>
<span class="sd">            &gt;&gt;&gt; page.until(&#39;line[width&gt;=2]&#39;, include_endpoint=False)  # Select up to thick line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the target element</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="c1"># If target not found, return a default region (full page)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

        <span class="c1"># Create a region from the top of the page to the target</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

        <span class="c1"># Ensure target has positional attributes before using them</span>
        <span class="n">target_top</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target_bottom</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_endpoint</span><span class="p">:</span>
            <span class="c1"># Include the target element</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">target_bottom</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Up to the target element</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">target_top</span><span class="p">))</span>

        <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">target</span>
        <span class="k">return</span> <span class="n">region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop the page to the specified bounding box.</span>

<span class="sd">        This is a direct wrapper around pdfplumber&#39;s crop method.</span>

<span class="sd">        Args:</span>
<span class="sd">            bbox: Bounding box (x0, top, x1, bottom) or None</span>
<span class="sd">            **kwargs: Additional parameters (top, bottom, left, right)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cropped page object (pdfplumber.Page)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Returns the pdfplumber page object, not a natural-pdf Page</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract text from this page, respecting exclusions and using pdfplumber&#39;s</span>
<span class="sd">        layout engine (chars_to_textmap) if layout arguments are provided or default.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_exclusions: Whether to apply exclusion regions (default: True).</span>
<span class="sd">                          Note: Filtering logic is now always applied if exclusions exist.</span>
<span class="sd">            debug_exclusions: Whether to output detailed exclusion debugging info (default: False).</span>
<span class="sd">            **kwargs: Additional layout parameters passed directly to pdfplumber&#39;s</span>
<span class="sd">                      `chars_to_textmap` function. Common parameters include:</span>
<span class="sd">                      - layout (bool): If True (default), inserts spaces/newlines.</span>
<span class="sd">                      - x_density (float): Pixels per character horizontally.</span>
<span class="sd">                      - y_density (float): Pixels per line vertically.</span>
<span class="sd">                      - x_tolerance (float): Tolerance for horizontal character grouping.</span>
<span class="sd">                      - y_tolerance (float): Tolerance for vertical character grouping.</span>
<span class="sd">                      - line_dir (str): &#39;ttb&#39;, &#39;btt&#39;, &#39;ltr&#39;, &#39;rtl&#39;</span>
<span class="sd">                      - char_dir (str): &#39;ttb&#39;, &#39;btt&#39;, &#39;ltr&#39;, &#39;rtl&#39;</span>
<span class="sd">                      See pdfplumber documentation for more.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Extracted text as string, potentially with layout-based spacing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: extract_text called with kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="p">)</span>  <span class="c1"># Allow &#39;debug&#39; kwarg</span>

        <span class="c1"># 1. Get Word Elements (triggers load_elements if needed)</span>
        <span class="n">word_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">words</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">word_elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No word elements found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># 2. Get Exclusions</span>
        <span class="n">apply_exclusions_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_exclusions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">apply_exclusions_flag</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
            <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span><span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Applying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclusion_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> exclusions.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Not applying exclusions.&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Collect All Character Dictionaries from Word Elements</span>
        <span class="n">all_char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_elements</span><span class="p">:</span>
            <span class="n">all_char_dicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;_char_dicts&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># 4. Spatially Filter Characters</span>
        <span class="n">filtered_chars</span> <span class="o">=</span> <span class="n">filter_chars_spatially</span><span class="p">(</span>
            <span class="n">char_dicts</span><span class="o">=</span><span class="n">all_char_dicts</span><span class="p">,</span>
            <span class="n">exclusion_regions</span><span class="o">=</span><span class="n">exclusion_regions</span><span class="p">,</span>
            <span class="n">target_region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No target region for full page extraction</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 5. Generate Text Layout using Utility</span>
        <span class="c1"># Pass page bbox as layout context</span>
        <span class="n">page_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="c1"># Merge PDF-level default tolerances if caller did not override</span>
        <span class="n">merged_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tol_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">,</span> <span class="s2">&quot;x_tolerance_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;y_tolerance&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tol_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_kwargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
                    <span class="n">merged_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}):</span>
                    <span class="n">merged_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">generate_text_layout</span><span class="p">(</span>
            <span class="n">char_dicts</span><span class="o">=</span><span class="n">filtered_chars</span><span class="p">,</span>
            <span class="n">layout_context_bbox</span><span class="o">=</span><span class="n">page_bbox</span><span class="p">,</span>
            <span class="n">user_kwargs</span><span class="o">=</span><span class="n">merged_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># --- Optional: apply Unicode BiDi algorithm for mixed RTL/LTR correctness ---</span>
        <span class="n">apply_bidi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidi&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_bidi</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
            <span class="c1"># Quick check for any RTL character</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_contains_rtl</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">unicodedata</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_contains_rtl</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">bidi.algorithm</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_display</span>  <span class="c1"># type: ignore</span>

                    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.utils.bidi_mirror</span><span class="w"> </span><span class="kn">import</span> <span class="n">mirror_brackets</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">mirror_brackets</span><span class="p">(</span>
                            <span class="n">get_display</span><span class="p">(</span>
                                <span class="n">line</span><span class="p">,</span>
                                <span class="n">base_dir</span><span class="o">=</span><span class="p">(</span>
                                    <span class="s2">&quot;R&quot;</span>
                                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                                        <span class="n">unicodedata</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span>
                                    <span class="p">)</span>
                                    <span class="k">else</span> <span class="s2">&quot;L&quot;</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># silently skip if python-bidi not available</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: extract_text finished, result length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ocr_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">text_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cell_extraction_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the largest table from this page using enhanced region-based extraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: Method to use: &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction.</span>
<span class="sd">            use_ocr: Whether to use OCR for text extraction (currently only applicable with &#39;tatr&#39; method).</span>
<span class="sd">            ocr_config: OCR configuration parameters.</span>
<span class="sd">            text_options: Dictionary of options for the &#39;text&#39; method.</span>
<span class="sd">            cell_extraction_func: Optional callable function that takes a cell Region object</span>
<span class="sd">                                  and returns its string content. For &#39;text&#39; method only.</span>
<span class="sd">            show_progress: If True, display a progress bar during cell text extraction for the &#39;text&#39; method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Table data as a list of rows, where each row is a list of cell values (str or None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a full-page region and delegate to its enhanced extract_table method</span>
        <span class="n">page_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">page_region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="p">,</span>
            <span class="n">use_ocr</span><span class="o">=</span><span class="n">use_ocr</span><span class="p">,</span>
            <span class="n">ocr_config</span><span class="o">=</span><span class="n">ocr_config</span><span class="p">,</span>
            <span class="n">text_options</span><span class="o">=</span><span class="n">text_options</span><span class="p">,</span>
            <span class="n">cell_extraction_func</span><span class="o">=</span><span class="n">cell_extraction_func</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">check_tatr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all tables from this page with enhanced method support.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: Method to use: &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                    &#39;stream&#39; uses text-based strategies, &#39;lattice&#39; uses line-based strategies.</span>
<span class="sd">                    Note: &#39;tatr&#39; and &#39;text&#39; methods are not supported for extract_tables.</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction.</span>
<span class="sd">            check_tatr: If True (default), first check for TATR-detected table regions</span>
<span class="sd">                        and extract from those before falling back to pdfplumber methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tables, where each table is a list of rows, and each row is a list of cell values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Check for TATR-detected table regions first if enabled</span>
        <span class="k">if</span> <span class="n">check_tatr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tatr_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table][model=tatr]&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tatr_tables</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tatr_tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> TATR table regions, extracting from those...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">extracted_tables</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">table_region</span> <span class="ow">in</span> <span class="n">tatr_tables</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;tatr&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">table_data</span><span class="p">:</span>  <span class="c1"># Only add non-empty tables</span>
                                <span class="n">extracted_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Failed to extract table from TATR region </span><span class="si">{</span><span class="n">table_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="n">extracted_tables</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Successfully extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extracted_tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables from TATR regions&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">extracted_tables</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: TATR regions found but no tables extracted, falling back to pdfplumber&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No TATR table regions found, using pdfplumber methods&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error checking TATR regions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to pdfplumber&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Auto-detect method if not specified (try lattice first, then stream)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Auto-detecting tables extraction method...&quot;</span><span class="p">)</span>

            <span class="c1"># Try lattice first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lattice_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
                <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first for tables...&quot;</span><span class="p">)</span>
                <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">lattice_settings</span><span class="p">)</span>

                <span class="c1"># Check if lattice found meaningful tables</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">lattice_result</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span>
                            <span class="k">if</span> <span class="n">table</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">lattice_result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful tables&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Fall back to stream</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method for tables...&quot;</span><span class="p">)</span>
            <span class="n">stream_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">stream_settings</span><span class="p">)</span>

        <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># Handle method aliases</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
            <span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

        <span class="c1"># Use the selected method</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
            <span class="c1"># ---------------------------------------------------------</span>
            <span class="c1"># Inject auto-computed or user-specified text tolerances so</span>
            <span class="c1"># pdfplumber uses the same numbers we used for word grouping</span>
            <span class="c1"># whenever the table algorithm relies on word positions.</span>
            <span class="c1"># ---------------------------------------------------------</span>
            <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SETTING IT UP&quot;</span><span class="p">)</span>
                <span class="n">pdf_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>
                <span class="k">if</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                    <span class="n">x_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">,</span> <span class="n">x_tol</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                    <span class="n">y_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">y_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">,</span> <span class="n">y_tol</span><span class="p">)</span>

                <span class="c1"># pdfplumber&#39;s text strategy benefits from a tight snap tolerance.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;snap_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                    <span class="ow">and</span> <span class="s2">&quot;snap_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                <span class="p">):</span>
                    <span class="c1"># Derive from y_tol if available, else default 1</span>
                    <span class="n">snap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">))</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="n">snap</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;join_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                    <span class="ow">and</span> <span class="s2">&quot;join_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                <span class="p">):</span>
                    <span class="n">join</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_x_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_y_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown tables extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all elements from the page via ElementManager.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">load_elements</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_char_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Use self._element_mgr.chars&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_create_char_elements is deprecated. Access via self._element_mgr.chars.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span>  <span class="c1"># Delegate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_font_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Handled by ElementManager&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_process_font_information is deprecated. Handled by ElementManager.&quot;</span><span class="p">)</span>
        <span class="c1"># ElementManager handles this internally</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_group_chars_into_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Use self._element_mgr.words&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_group_chars_into_words is deprecated. Access via self._element_mgr.words.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span>  <span class="c1"># Delegate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_line_into_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_chars</span><span class="p">,</span> <span class="n">keep_spaces</span><span class="p">,</span> <span class="n">font_attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Handled by ElementManager&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_process_line_into_words is deprecated. Handled by ElementManager.&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_font_attributes_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">prev_char</span><span class="p">,</span> <span class="n">font_attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Handled by ElementManager&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_check_font_attributes_match is deprecated. Handled by ElementManager.&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_word_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">font_attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Handled by ElementManager&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_create_word_element is deprecated. Handled by ElementManager.&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all character elements on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">words</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all word elements on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all rectangle elements on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">rects</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all line elements on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">lines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Highlight a bounding box or the entire page.</span>
<span class="sd">        Delegates to the central HighlightingService.</span>

<span class="sd">        Args:</span>
<span class="sd">            bbox: Bounding box (x0, top, x1, bottom). If None, highlight entire page.</span>
<span class="sd">            color: RGBA color tuple/string for the highlight.</span>
<span class="sd">            label: Optional label for the highlight.</span>
<span class="sd">            use_color_cycling: If True and no label/color, use next cycle color.</span>
<span class="sd">            element: Optional original element being highlighted (for attribute extraction).</span>
<span class="sd">            include_attrs: List of attribute names from &#39;element&#39; to display.</span>
<span class="sd">            existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_bbox</span> <span class="o">=</span> <span class="n">bbox</span> <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">target_bbox</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">use_color_cycling</span><span class="o">=</span><span class="n">use_color_cycling</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">include_attrs</span><span class="o">=</span><span class="n">include_attrs</span><span class="p">,</span>
            <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">highlight_polygon</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Highlight a polygon shape on the page.</span>
<span class="sd">        Delegates to the central HighlightingService.</span>

<span class="sd">        Args:</span>
<span class="sd">            polygon: List of (x, y) points defining the polygon.</span>
<span class="sd">            color: RGBA color tuple/string for the highlight.</span>
<span class="sd">            label: Optional label for the highlight.</span>
<span class="sd">            use_color_cycling: If True and no label/color, use next cycle color.</span>
<span class="sd">            element: Optional original element being highlighted (for attribute extraction).</span>
<span class="sd">            include_attrs: List of attribute names from &#39;element&#39; to display.</span>
<span class="sd">            existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">add_polygon</span><span class="p">(</span>
            <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">polygon</span><span class="o">=</span><span class="n">polygon</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">use_color_cycling</span><span class="o">=</span><span class="n">use_color_cycling</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">include_attrs</span><span class="o">=</span><span class="n">include_attrs</span><span class="p">,</span>
            <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates and returns an image of the page with persistent highlights rendered.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">            width: Optional width for the output image.</span>
<span class="sd">            labels: Whether to include a legend for labels.</span>
<span class="sd">            legend_position: Position of the legend.</span>
<span class="sd">            render_ocr: Whether to render OCR text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image object of the page with highlights, or None if rendering fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
            <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
            <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Ensure highlights are requested</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Allow saving without highlights</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the page image to a file, rendering highlights via HighlightingService.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to save the image to.</span>
<span class="sd">            width: Optional width for the output image.</span>
<span class="sd">            labels: Whether to include a legend.</span>
<span class="sd">            legend_position: Position of the legend.</span>
<span class="sd">            render_ocr: Whether to render OCR text.</span>
<span class="sd">            include_highlights: Whether to render highlights.</span>
<span class="sd">            resolution: Resolution in DPI for base image rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">            **kwargs: Additional args for pdfplumber&#39;s to_image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use to_image to generate and save the image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
            <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
            <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all highlights *from this specific page* via HighlightingService.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">clear_page</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_text_styles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextStyleOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze text elements by style, adding attributes directly to elements.</span>

<span class="sd">        This method uses TextStyleAnalyzer to process text elements (typically words)</span>
<span class="sd">        on the page. It adds the following attributes to each processed element:</span>
<span class="sd">        - style_label: A descriptive or numeric label for the style group.</span>
<span class="sd">        - style_key: A hashable tuple representing the style properties used for grouping.</span>
<span class="sd">        - style_properties: A dictionary containing the extracted style properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            options: Optional TextStyleOptions to configure the analysis.</span>
<span class="sd">                     If None, the analyzer&#39;s default options are used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection containing all processed text elements with added style attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create analyzer (optionally pass default options from PDF config here)</span>
        <span class="c1"># For now, it uses its own defaults if options=None</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">TextStyleAnalyzer</span><span class="p">()</span>

        <span class="c1"># Analyze the page. The analyzer now modifies elements directly</span>
        <span class="c1"># and returns the collection of processed elements.</span>
        <span class="n">processed_elements_collection</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Return the collection of elements which now have style attributes</span>
        <span class="k">return</span> <span class="n">processed_elements_collection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New parameter</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a PIL image of the page, using HighlightingService if needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Optional path to save the image to.</span>
<span class="sd">            width: Optional width for the output image.</span>
<span class="sd">            labels: Whether to include a legend for highlights.</span>
<span class="sd">            legend_position: Position of the legend.</span>
<span class="sd">            render_ocr: Whether to render OCR text on highlights.</span>
<span class="sd">            resolution: Resolution in DPI for base page image. If None, uses global setting or defaults to 144 DPI.</span>
<span class="sd">            include_highlights: Whether to render highlights.</span>
<span class="sd">            exclusions: Accepts one of the following:</span>
<span class="sd">                         None   no masking (default)</span>
<span class="sd">                         &quot;mask&quot;  mask using solid white (back-compat)</span>
<span class="sd">                         CSS/HTML colour string (e.g. &quot;red&quot;, &quot;#ff0000&quot;, &quot;#ff000080&quot;)</span>
<span class="sd">                         Tuple of RGB or RGBA values (ints 0-255 or floats 0-1)</span>
<span class="sd">                        All excluded regions are filled with this colour.</span>
<span class="sd">            **kwargs: Additional parameters for pdfplumber.to_image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image of the page, or None if rendering fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults, but allow explicit parameters to override</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="c1"># Use global options if parameters are not explicitly set</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">width</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>
        <span class="c1"># 1. Create cache key (excluding path)</span>
        <span class="n">cache_key_parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">legend_position</span><span class="p">,</span>
            <span class="n">render_ocr</span><span class="p">,</span>
            <span class="n">resolution</span><span class="p">,</span>
            <span class="n">include_highlights</span><span class="p">,</span>
            <span class="n">exclusions</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Convert kwargs to a stable, hashable representation</span>
        <span class="n">sorted_kwargs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># Convert lists to tuples</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="c1"># If list contains unhashable items, fall back to repr or skip</span>
                    <span class="c1"># For simplicity, we&#39;ll try to proceed; hashing will fail if v remains unhashable</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cache key generation: List item in kwargs[&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;] could not be converted to tuple due to unhashable elements.&quot;</span>
                    <span class="p">)</span>
            <span class="n">sorted_kwargs_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="n">cache_key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sorted_kwargs_list</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cache_key_parts</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Could not create cache key for to_image due to unhashable item: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding without cache for this call.&quot;</span>
            <span class="p">)</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fallback to not using cache for this call</span>

        <span class="n">image_to_return</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 2. Check cache</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">:</span>
            <span class="n">image_to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Returning cached image for key: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># --- This is the original logic to generate the image ---</span>
            <span class="n">rendered_image_component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">None</span>  <span class="c1"># Renamed from &#39;image&#39; in original</span>
            <span class="p">)</span>
            <span class="n">render_resolution</span> <span class="o">=</span> <span class="n">resolution</span>
            <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Attempting to acquire pdf_render_lock for to_image...&quot;</span>
            <span class="p">)</span>
            <span class="n">lock_wait_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Acquire the global PDF rendering lock</span>
                <span class="k">with</span> <span class="n">pdf_render_lock</span><span class="p">:</span>
                    <span class="n">lock_acquired_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Acquired pdf_render_lock (waited </span><span class="si">{</span><span class="n">lock_acquired_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lock_wait_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s). Starting render...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">include_highlights</span><span class="p">:</span>
                        <span class="c1"># Delegate rendering to the central service</span>
                        <span class="n">rendered_image_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">render_page</span><span class="p">(</span>
                            <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">resolution</span><span class="o">=</span><span class="n">render_resolution</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
                            <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rendered_image_component</span> <span class="o">=</span> <span class="n">render_plain_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render_resolution</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># rendered_image_component remains None</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">render_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Released pdf_render_lock. Total render time (incl. lock wait): </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lock_wait_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">rendered_image_component</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Cache the failure</span>
                <span class="c1"># Save the image if path is provided (will try to save None, handled by PIL/OS)</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">rendered_image_component</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Should be None here</span>
                            <span class="n">rendered_image_component</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># This line won&#39;t be hit if None</span>
                        <span class="c1"># else: logger.debug(&quot;Not saving None image&quot;) # Not strictly needed</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save image to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># --- Apply exclusion masking if requested ---</span>
            <span class="c1"># This modifies &#39;rendered_image_component&#39;</span>
            <span class="n">image_after_masking</span> <span class="o">=</span> <span class="n">rendered_image_component</span>  <span class="c1"># Start with the rendered image</span>

            <span class="c1"># Determine if masking is requested and establish the fill colour</span>
            <span class="n">mask_requested</span> <span class="o">=</span> <span class="n">exclusions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span>
            <span class="n">mask_color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>  <span class="c1"># default</span>

            <span class="k">if</span> <span class="n">mask_requested</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exclusions</span> <span class="o">!=</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span>
                    <span class="c1"># Attempt to parse custom colour input</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                            <span class="c1"># Handle RGB/RGBA tuples with ints 0-255 or floats 0-1</span>
                            <span class="n">processed</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">all_float</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exclusions</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_float</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">val</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="c1"># add full alpha</span>
                            <span class="n">mask_color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="c1"># Try using the optional &#39;colour&#39; library for rich parsing</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">colour</span><span class="w"> </span><span class="kn">import</span> <span class="n">Color</span>  <span class="c1"># type: ignore</span>

                                <span class="n">color_obj</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>
                                <span class="n">mask_color</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">red</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">green</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">blue</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                    <span class="mi">255</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># Fallback: if parsing fails, treat as plain string accepted by PIL</span>
                                <span class="n">mask_color</span> <span class="o">=</span> <span class="n">exclusions</span>  <span class="c1"># e.g. &quot;red&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Unsupported exclusions colour spec: </span><span class="si">{</span><span class="n">exclusions</span><span class="si">!r}</span><span class="s2">. Using white.&quot;</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">colour_parse_err</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to parse exclusions colour </span><span class="si">{</span><span class="n">exclusions</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">colour_parse_err</span><span class="si">}</span><span class="s2">. Using white.&quot;</span>
                        <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Ensure image is mutable (RGB or RGBA)</span>
                    <span class="k">if</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">):</span>
                        <span class="n">image_after_masking</span> <span class="o">=</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

                    <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span>
                        <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">exclusion_regions</span><span class="p">:</span>
                        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image_after_masking</span><span class="p">)</span>
                        <span class="c1"># Scaling factor for converting PDF pts  image px</span>
                        <span class="n">img_scale</span> <span class="o">=</span> <span class="n">render_resolution</span> <span class="o">/</span> <span class="mf">72.0</span>

                        <span class="c1"># Determine fill colour compatible with current mode</span>
                        <span class="k">def</span><span class="w"> </span><span class="nf">_mode_compatible</span><span class="p">(</span><span class="n">colour</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">colour</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># drop alpha for RGB images</span>
                            <span class="k">return</span> <span class="n">colour</span>

                        <span class="n">fill_colour</span> <span class="o">=</span> <span class="n">_mode_compatible</span><span class="p">(</span><span class="n">mask_color</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">exclusion_regions</span><span class="p">:</span>
                            <span class="n">img_x0</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">x0</span> <span class="o">*</span> <span class="n">img_scale</span>
                            <span class="n">img_top</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">top</span> <span class="o">*</span> <span class="n">img_scale</span>
                            <span class="n">img_x1</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">x1</span> <span class="o">*</span> <span class="n">img_scale</span>
                            <span class="n">img_bottom</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">bottom</span> <span class="o">*</span> <span class="n">img_scale</span>

                            <span class="n">img_coords</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_x0</span><span class="p">),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_top</span><span class="p">),</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">image_after_masking</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">img_x1</span><span class="p">),</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">image_after_masking</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">img_bottom</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_coords</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill_colour</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Skipping invalid exclusion rect for masking: </span><span class="si">{</span><span class="n">img_coords</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                        <span class="k">del</span> <span class="n">draw</span>  <span class="c1"># Release drawing context</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">mask_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error applying exclusion mask to page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mask_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Continue with potentially unmasked or partially masked image</span>

            <span class="c1"># --- Resize the final image if width is provided ---</span>
            <span class="n">image_final_content</span> <span class="o">=</span> <span class="n">image_after_masking</span>  <span class="c1"># Start with image after masking</span>
            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">width</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">image_final_content</span> <span class="o">=</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">resize_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not resize image: </span><span class="si">{</span><span class="n">resize_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># image_final_content remains the un-resized version if resize fails</span>

            <span class="c1"># Store in cache</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_final_content</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Cached image for key: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">image_to_return</span> <span class="o">=</span> <span class="n">image_final_content</span>
        <span class="c1"># --- End of cache miss block ---</span>

        <span class="c1"># Save the image (either from cache or newly generated) if path is provided</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">image_to_return</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Ensure directory exists</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># Only call makedirs if there&#39;s a directory part</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">image_to_return</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved page image to: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save image to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image_to_return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_text_elements_from_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ocr_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">image_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_height</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TextElement&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DEPRECATED: Use self._element_mgr.create_text_elements_from_ocr&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;_create_text_elements_from_ocr is deprecated. Use self._element_mgr version.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">create_text_elements_from_ocr</span><span class="p">(</span>
            <span class="n">ocr_results</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OCROptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">detect_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply OCR to THIS page and add results to page elements via PDF.apply_ocr.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine: Name of the OCR engine.</span>
<span class="sd">            options: Engine-specific options object or dict.</span>
<span class="sd">            languages: List of engine-specific language codes.</span>
<span class="sd">            min_confidence: Minimum confidence threshold.</span>
<span class="sd">            device: Device to run OCR on.</span>
<span class="sd">            resolution: DPI resolution for rendering page image before OCR.</span>
<span class="sd">            apply_exclusions: If True (default), render page image for OCR</span>
<span class="sd">                              with excluded areas masked (whited out).</span>
<span class="sd">            detect_only: If True, only detect text bounding boxes, don&#39;t perform OCR.</span>
<span class="sd">            replace: If True (default), remove any existing OCR elements before</span>
<span class="sd">                    adding new ones. If False, add new OCR elements to existing ones.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;apply_ocr&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Parent PDF missing &#39;apply_ocr&#39;. Cannot apply OCR.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>

        <span class="c1"># Remove existing OCR elements if replace is True</span>
        <span class="k">if</span> <span class="n">replace</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying new OCR.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_ocr_elements</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Delegating apply_ocr to PDF.apply_ocr.&quot;</span><span class="p">)</span>
        <span class="c1"># Delegate to parent PDF, targeting only this page&#39;s index</span>
        <span class="c1"># Pass all relevant parameters through, including apply_exclusions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span>
            <span class="n">pages</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
            <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">detect_only</span><span class="o">=</span><span class="n">detect_only</span><span class="p">,</span>
            <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>  <span class="c1"># Pass the replace parameter to PDF.apply_ocr</span>
        <span class="p">)</span>

        <span class="c1"># Return self for chaining</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_ocr_elements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OCROptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TextElement&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract text elements using OCR *without* adding them to the page&#39;s elements.</span>
<span class="sd">        Uses the shared OCRManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine: Name of the OCR engine.</span>
<span class="sd">            options: Engine-specific options object or dict.</span>
<span class="sd">            languages: List of engine-specific language codes.</span>
<span class="sd">            min_confidence: Minimum confidence threshold.</span>
<span class="sd">            device: Device to run OCR on.</span>
<span class="sd">            resolution: DPI resolution for rendering page image before OCR.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of created TextElement objects derived from OCR results for this page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCRManager not available. Cannot extract OCR elements.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Extracting OCR elements (extract only)...&quot;</span><span class="p">)</span>

        <span class="c1"># Determine rendering resolution</span>
        <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">resolution</span> <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">150</span>  <span class="c1"># Default to 150 DPI</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Using rendering resolution: </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get base image without highlights using the determined resolution</span>
            <span class="c1"># Use the global PDF rendering lock</span>
            <span class="k">with</span> <span class="n">pdf_render_lock</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">final_resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image for OCR extraction.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rendered image size: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Prepare arguments for the OCR Manager call</span>
        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
            <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
            <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">languages</span><span class="p">,</span>
            <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Calling OCR Manager (extract only) with args: </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;images&#39;</span><span class="p">}</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># apply_ocr now returns List[List[Dict]] or List[Dict]</span>
            <span class="n">results_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>
            <span class="c1"># If it returned a list of lists (batch mode), take the first list</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">results_list</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">results_list</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR Manager returned unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR Manager returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results for extraction.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR processing failed during extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Convert results but DO NOT add to ElementManager</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Converting OCR results to TextElements (extract only)...&quot;</span><span class="p">)</span>
        <span class="n">temp_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scale_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># Added try-except around result processing</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]]</span>
                <span class="n">elem_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="n">top</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                    <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">bottom</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                    <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>  <span class="c1"># Using text for temporary elements</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ocr&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="s2">&quot;OCR-extract&quot;</span><span class="p">,</span>  <span class="c1"># Different name for clarity</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
                    <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">temp_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextElement</span><span class="p">(</span><span class="n">elem_data</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">convert_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Skipping invalid OCR result during conversion: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">convert_err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> TextElements from OCR (extract only).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_elements</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the size of the page in points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">layout_analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LayoutAnalyzer&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create the layout analyzer for this page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LayoutManager not available, cannot create LayoutAnalyzer.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout_analyzer</span> <span class="o">=</span> <span class="n">LayoutAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout_analyzer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_layout</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LayoutOptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add client parameter</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the page layout using the configured LayoutManager.</span>
<span class="sd">        Adds detected Region objects to the page&#39;s element manager.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection containing the detected Region objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_analyzer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Layout analysis failed: LayoutAnalyzer not initialized (is LayoutManager available?).&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Return empty collection</span>

        <span class="c1"># Clear existing detected regions if &#39;replace&#39; is specified</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_detected_layout_regions</span><span class="p">()</span>

        <span class="c1"># The analyzer&#39;s analyze_layout method already adds regions to the page</span>
        <span class="c1"># and its element manager. We just need to retrieve them.</span>
        <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_layout</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
            <span class="n">exclude_classes</span><span class="o">=</span><span class="n">exclude_classes</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>  <span class="c1"># Pass client down</span>
        <span class="p">)</span>

        <span class="c1"># Retrieve the detected regions from the element manager</span>
        <span class="c1"># Filter regions based on source=&#39;detected&#39; and potentially the model used if available</span>
        <span class="n">detected_regions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;detected&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">engine</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">engine</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">detected_regions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_detected_layout_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all regions from this page that were added by layout analysis</span>
<span class="sd">        (i.e., regions where `source` attribute is &#39;detected&#39;).</span>

<span class="sd">        This clears the regions both from the page&#39;s internal `_regions[&#39;detected&#39;]` list</span>
<span class="sd">        and from the ElementManager&#39;s internal list of regions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="p">,</span> <span class="s2">&quot;regions&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="p">,</span> <span class="s2">&quot;_elements&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="s2">&quot;regions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: No regions found in ElementManager, nothing to clear.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Ensure page&#39;s list is also clear</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Filter ElementManager&#39;s list to keep only non-detected regions</span>
        <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;detected&quot;</span>
        <span class="p">]</span>
        <span class="n">new_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span>
        <span class="n">removed_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">new_count</span>

        <span class="c1"># Clear the page&#39;s specific list of detected regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Cleared </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> detected layout regions.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_section_between</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]:</span>  <span class="c1"># Return Optional</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a section between two elements on this page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a full-page region to operate within</span>
        <span class="n">page_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

        <span class="c1"># Delegate to the region&#39;s method</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">page_region</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span>
                <span class="n">start_element</span><span class="o">=</span><span class="n">start_element</span><span class="p">,</span>
                <span class="n">end_element</span><span class="o">=</span><span class="n">end_element</span><span class="p">,</span>
                <span class="n">boundary_inclusion</span><span class="o">=</span><span class="n">boundary_inclusion</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error getting section between elements on page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">divider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Divides the page into sections based on the provided divider elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">start_elements</span><span class="o">=</span><span class="n">divider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sections</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_sections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
        <span class="n">y_threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bounding_box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get sections of a page defined by start/end elements.</span>
<span class="sd">        Uses the page-level implementation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An ElementCollection containing the found Region objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Helper function to get bounds from bounding_box parameter</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_bounds</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bounding_box</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">bounding_box</span>
                <span class="c1"># Clamp to page boundaries</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">bottom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Handle cases where elements are provided as strings (selectors)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">start_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">start_elements</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span>  <span class="c1"># Get list of elements</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>  <span class="c1"># Handle ElementCollection input</span>
            <span class="n">start_elements</span> <span class="o">=</span> <span class="n">start_elements</span><span class="o">.</span><span class="n">elements</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">end_elements</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="n">end_elements</span><span class="o">.</span><span class="n">elements</span>

        <span class="c1"># Ensure start_elements is a list</span>
        <span class="k">if</span> <span class="n">start_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">valid_inclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_inclusions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boundary_inclusion must be one of </span><span class="si">{</span><span class="n">valid_inclusions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">start_elements</span><span class="p">:</span>
            <span class="c1"># Return an empty ElementCollection if no start elements</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>

        <span class="c1"># Combine start and end elements with their type</span>
        <span class="n">all_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">start_elements</span><span class="p">:</span>
            <span class="n">all_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">end_elements</span><span class="p">:</span>
            <span class="n">all_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">))</span>

        <span class="c1"># Sort all boundary elements primarily by top, then x0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sorting boundaries: Element missing top/x0 attribute? </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Cannot proceed if elements lack position</span>

        <span class="c1"># Process sorted boundaries to find sections</span>
        <span class="n">current_start_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_type</span> <span class="ow">in</span> <span class="n">all_boundaries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
                <span class="c1"># If we have an active section, this start implicitly ends it</span>
                <span class="k">if</span> <span class="n">active_section_started</span><span class="p">:</span>
                    <span class="n">end_boundary_el</span> <span class="o">=</span> <span class="n">element</span>  <span class="c1"># Use this start as the end boundary</span>
                    <span class="c1"># Determine region boundaries</span>
                    <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
                        <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                        <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="p">)</span>
                    <span class="n">sec_bottom</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">top</span>
                        <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                        <span class="k">else</span> <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">sec_bottom</span><span class="p">:</span>  <span class="c1"># Ensure valid region</span>
                        <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
                        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">sec_bottom</span><span class="p">)</span>
                        <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
                        <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_boundary_el</span>  <span class="c1"># Mark the element that ended it</span>
                        <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Mark how it ended</span>
                        <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                    <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Reset for the new start</span>

                <span class="c1"># Set this as the potential start of the next section</span>
                <span class="n">current_start_element</span> <span class="o">=</span> <span class="n">element</span>
                <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="ow">and</span> <span class="n">active_section_started</span><span class="p">:</span>
                <span class="c1"># We found an explicit end for the current section</span>
                <span class="n">end_boundary_el</span> <span class="o">=</span> <span class="n">element</span>
                <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
                    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
                <span class="p">)</span>
                <span class="n">sec_bottom</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">top</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">sec_bottom</span><span class="p">:</span>  <span class="c1"># Ensure valid region</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">sec_bottom</span><span class="p">)</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_boundary_el</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

                <span class="c1"># Reset: section ended explicitly</span>
                <span class="n">current_start_element</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Handle the last section if it was started but never explicitly ended</span>
        <span class="k">if</span> <span class="n">active_section_started</span><span class="p">:</span>
            <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
                <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
            <span class="p">)</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">page_bottom</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">page_bottom</span><span class="p">:</span>
                <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">page_bottom</span><span class="p">)</span>
                <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
                <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ended by page end</span>
                <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation of the page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Page number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">question</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask a question about the page content using document QA.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa.document_qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>

            <span class="c1"># Get or initialize QA engine with specified model</span>
            <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">()</span>
            <span class="c1"># Ask the question using the QA engine</span>
            <span class="k">return</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask_pdf_page</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Question answering requires the &#39;natural_pdf.qa&#39; module. Please install necessary dependencies.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during page.ask: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_preview</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">temporary_highlights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates and returns a non-stateful preview image containing only</span>
<span class="sd">        the provided temporary highlights.</span>

<span class="sd">        Args:</span>
<span class="sd">            temporary_highlights: List of highlight data dictionaries (as prepared by</span>
<span class="sd">                                  ElementCollection._prepare_highlight_data).</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">            width: Optional width for the output image.</span>
<span class="sd">            labels: Whether to include a legend.</span>
<span class="sd">            legend_position: Position of the legend.</span>
<span class="sd">            render_ocr: Whether to render OCR text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image object of the preview, or None if rendering fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Delegate rendering to the highlighter service&#39;s preview method</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">render_preview</span><span class="p">(</span>
                <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">temporary_highlights</span><span class="o">=</span><span class="n">temporary_highlights</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
                <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HighlightingService does not have the required &#39;render_preview&#39; method.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error calling highlighter.render_preview for page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Return the rendered image directly</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">text_style_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a sorted list of unique text style labels found on the page.</span>

<span class="sd">        Runs text style analysis with default options if it hasn&#39;t been run yet.</span>
<span class="sd">        To use custom options, call `analyze_text_styles(options=...)` explicitly first.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A sorted list of unique style label strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the summary attribute exists from a previous run</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_text_styles_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_styles_summary</span><span class="p">:</span>
            <span class="c1"># If not, run the analysis with default options</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Running default text style analysis to get labels.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_text_styles</span><span class="p">()</span>  <span class="c1"># Use default options</span>

        <span class="c1"># Extract labels from the summary dictionary</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_text_styles_summary&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_styles_summary</span><span class="p">:</span>
            <span class="c1"># The summary maps style_key -&gt; {&#39;label&#39;: ..., &#39;properties&#39;: ...}</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">style_info</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">style_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_styles_summary</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback if summary wasn&#39;t created for some reason (e.g., no text elements)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Text style summary not found after analysis.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">viewer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="c1"># elements_to_render: Optional[List[&#39;Element&#39;]] = None, # No longer needed, from_page handles it</span>
        <span class="c1"># include_source_types: List[str] = [&#39;word&#39;, &#39;line&#39;, &#39;rect&#39;, &#39;region&#39;] # No longer needed</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;InteractiveViewerWidget&quot;</span><span class="p">]:</span>  <span class="c1"># Return type hint updated</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and returns an interactive ipywidget for exploring elements on this page.</span>

<span class="sd">        Uses InteractiveViewerWidget.from_page() to create the viewer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A InteractiveViewerWidget instance ready for display in Jupyter,</span>
<span class="sd">            or None if ipywidgets is not installed or widget creation fails.</span>

<span class="sd">        Raises:</span>
<span class="sd">            # Optional: Could raise ImportError instead of returning None</span>
<span class="sd">            # ImportError: If required dependencies (ipywidgets) are missing.</span>
<span class="sd">            ValueError: If image rendering or data preparation fails within from_page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for availability using the imported flag and class variable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_IPYWIDGETS_AVAILABLE</span> <span class="ow">or</span> <span class="n">InteractiveViewerWidget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Interactive viewer requires &#39;ipywidgets&#39;. &quot;</span>
                <span class="s1">&#39;Please install with: pip install &quot;ipywidgets&gt;=7.0.0,&lt;10.0.0&quot;&#39;</span>
            <span class="p">)</span>
            <span class="c1"># raise ImportError(&quot;ipywidgets not found.&quot;) # Option 1: Raise error</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Option 2: Return None gracefully</span>

        <span class="c1"># If we reach here, InteractiveViewerWidget should be the actual class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Pass self (the Page object) to the factory method</span>
            <span class="k">return</span> <span class="n">InteractiveViewerWidget</span><span class="o">.</span><span class="n">from_page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch potential errors during widget creation (e.g., image rendering)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error creating viewer widget from page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># raise # Option 1: Re-raise error (might include ValueError from from_page)</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Option 2: Return None on creation error</span>

    <span class="c1"># --- Indexable Protocol Methods ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a unique identifier for the page (required by Indexable protocol).&quot;&quot;&quot;</span>
        <span class="c1"># Ensure path is safe for use in IDs (replace problematic chars)</span>
        <span class="n">safe_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_-]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;pdf_</span><span class="si">{</span><span class="n">safe_path</span><span class="si">}</span><span class="s2">_page_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns metadata associated with the page (required by Indexable protocol).&quot;&quot;&quot;</span>
        <span class="c1"># Add content hash here for sync</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pdf_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
            <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;content_hash&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_hash</span><span class="p">(),</span>  <span class="c1"># Include the hash</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the primary content object (self) for indexing (required by Indexable protocol).</span>
<span class="sd">        SearchService implementations decide how to process this (e.g., call extract_text).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return the Page object itself</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_content_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a SHA256 hash of the extracted text content (required by Indexable for sync).&quot;&quot;&quot;</span>
        <span class="c1"># Hash the extracted text (without exclusions for consistency)</span>
        <span class="c1"># Consider if exclusions should be part of the hash? For now, hash raw text.</span>
        <span class="c1"># Using extract_text directly might be slow if called repeatedly. Cache? TODO: Optimization</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
            <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># Normalize whitespace?</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">text_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c1"># --- New Method: save_searchable ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_searchable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Path&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the PDF page with an OCR text layer, making content searchable.</span>

<span class="sd">        Requires optional dependencies. Install with: pip install &quot;natural-pdf[ocr-save]&quot;</span>

<span class="sd">        Note: OCR must have been applied to the pages beforehand</span>
<span class="sd">              (e.g., pdf.apply_ocr()).</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path: Path to save the searchable PDF.</span>
<span class="sd">            dpi: Resolution for rendering and OCR overlay (default 300).</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the exporter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import moved here, assuming it&#39;s always available now</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.exporters.searchable_pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_searchable_pdf</span>

        <span class="c1"># Convert pathlib.Path to string if necessary</span>
        <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searchable PDF saved to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Added correct_ocr method ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">,</span>
        <span class="n">max_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Added progress callback</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>  <span class="c1"># Return self for chaining</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies corrections to OCR-generated text elements on this page</span>
<span class="sd">        using a user-provided callback function, potentially in parallel.</span>

<span class="sd">        Finds text elements on this page whose &#39;source&#39; attribute starts</span>
<span class="sd">        with &#39;ocr&#39; and calls the `correction_callback` for each, passing the</span>
<span class="sd">        element itself. Updates the element&#39;s text if the callback returns</span>
<span class="sd">        a new string.</span>

<span class="sd">        Args:</span>
<span class="sd">            correction_callback: A function accepting an element and returning</span>
<span class="sd">                                 `Optional[str]` (new text or None).</span>
<span class="sd">            max_workers: The maximum number of threads to use for parallel execution.</span>
<span class="sd">                         If None or 0 or 1, runs sequentially.</span>
<span class="sd">            progress_callback: Optional callback function to call after processing each element.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Starting OCR correction with callback &#39;</span><span class="si">{</span><span class="n">correction_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; (max_workers=</span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="n">target_elements_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">target_elements</span> <span class="o">=</span> <span class="n">target_elements_collection</span><span class="o">.</span><span class="n">elements</span>  <span class="c1"># Get the list</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No OCR elements found to correct.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">element_pbar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">element_pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_elements</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Correcting OCR Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;element&quot;</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Define the task to be run by the worker thread or sequentially</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_process_element_task</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># Call the user-provided callback</span>
                    <span class="n">corrected_text</span> <span class="o">=</span> <span class="n">correction_callback</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

                    <span class="c1"># Validate result type</span>
                    <span class="k">if</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">corrected_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Correction callback for element &#39;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; returned non-string, non-None type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">corrected_text</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping update.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Treat as no correction</span>

                    <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Return element, result, no error</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error applying correction callback to element &#39;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; (</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Keep log concise</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span>  <span class="c1"># Return element, no result, error</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># --- Update internal tqdm progress bar ---</span>
                    <span class="k">if</span> <span class="n">element_pbar</span><span class="p">:</span>
                        <span class="n">element_pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># --- Call user&#39;s progress callback --- #</span>
                    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">progress_callback</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cb_e</span><span class="p">:</span>
                            <span class="c1"># Log error in callback itself, but don&#39;t stop processing</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error executing progress_callback: </span><span class="si">{</span><span class="n">cb_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="c1"># Choose execution strategy based on max_workers</span>
            <span class="k">if</span> <span class="n">max_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_workers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># --- Parallel execution --- #</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Running OCR correction in parallel with </span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2"> workers.&quot;</span>
                <span class="p">)</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="c1"># Submit all tasks</span>
                    <span class="n">future_to_element</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_element_task</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span> <span class="n">element</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">target_elements</span>
                    <span class="p">}</span>

                    <span class="c1"># Process results as they complete (progress_callback called by worker)</span>
                    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_element</span><span class="p">):</span>
                        <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                                <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="c1"># Error already logged in worker</span>
                            <span class="k">elif</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># Apply correction if text changed</span>
                                <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">corrected_text</span> <span class="o">!=</span> <span class="n">current_text</span><span class="p">:</span>
                                    <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">corrected_text</span>
                                    <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="c1"># Catch errors from future.result() itself</span>
                            <span class="n">element</span> <span class="o">=</span> <span class="n">future_to_element</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>  <span class="c1"># Find original element</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Internal error retrieving correction result for element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># Note: progress_callback was already called in the worker&#39;s finally block</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># --- Sequential execution --- #</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Running OCR correction sequentially.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">target_elements</span><span class="p">:</span>
                    <span class="c1"># Call the task function directly (it handles progress_callback)</span>
                    <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">_element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">_process_element_task</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Apply correction if text changed</span>
                        <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">corrected_text</span> <span class="o">!=</span> <span class="n">current_text</span><span class="p">:</span>
                            <span class="n">_element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">corrected_text</span>
                            <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCR correction finished. Processed: </span><span class="si">{</span><span class="n">processed_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_elements</span><span class="p">)</span><span class="si">}</span><span class="s2">, Updated: </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">error_count</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element_pbar</span><span class="p">:</span>
                <span class="n">element_pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># --- Classification Mixin Implementation --- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClassificationManager&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="s2">&quot;get_manager&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;ClassificationManager cannot be accessed: Parent PDF or get_manager method missing.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the PDF&#39;s manager registry accessor</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Wrap potential errors from get_manager for clarity</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get ClassificationManager from PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Image&quot;</span><span class="p">]:</span>  <span class="c1"># Use &quot;Image&quot; for lazy import</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
                <span class="n">layout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>  <span class="c1"># Simple join, ignore exclusions for classification</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text_content</span> <span class="ow">or</span> <span class="n">text_content</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot classify page with &#39;text&#39; model: No text content found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text_content</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;vision&quot;</span><span class="p">:</span>
            <span class="c1"># Get resolution from manager/kwargs if possible, else default</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_classification_manager</span><span class="p">()</span>
            <span class="n">default_resolution</span> <span class="o">=</span> <span class="mi">150</span>
            <span class="c1"># Access kwargs passed to classify method if needed</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">default_resolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span>
                <span class="k">else</span> <span class="n">default_resolution</span>
            <span class="p">)</span>

            <span class="c1"># Use to_image, ensuring no highlights interfere</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Don&#39;t mask exclusions for classification input image</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot classify page with &#39;vision&#39; model: Failed to render image.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model_type for classification: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_metadata_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># Ensure metadata exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

    <span class="c1"># --- Content Extraction ---</span>

    <span class="c1"># --- Skew Detection and Correction --- #</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">skew_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the detected skew angle for this page (if calculated).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_skew_angle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
        <span class="n">grayscale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">force_recalculate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects the skew angle of the page image and stores it.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolution: DPI resolution for rendering the page image for detection.</span>
<span class="sd">            grayscale: Whether to convert the image to grayscale before detection.</span>
<span class="sd">            force_recalculate: If True, recalculate even if an angle exists.</span>
<span class="sd">            **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                             (e.g., `max_angle`, `num_peaks`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The detected skew angle in degrees, or None if detection failed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If the &#39;deskew&#39; library is not installed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Deskew library not found. Install with: pip install natural-pdf[deskew]&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_recalculate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Returning cached skew angle: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Detecting skew angle (resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI)...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Render the page at the specified detection resolution</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to render image for skew detection.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Convert to numpy array</span>
            <span class="n">img_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="c1"># Convert to grayscale if needed</span>
            <span class="k">if</span> <span class="n">grayscale</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">gray_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_np</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Already grayscale</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Unexpected image shape </span><span class="si">{</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> for grayscale conversion.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Try using it anyway</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Use original if grayscale=False</span>

            <span class="c1"># Determine skew angle using the deskew library</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">determine_skew</span><span class="p">(</span><span class="n">gray_np</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="n">angle</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Detected skew angle = </span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">angle</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed during skew detection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deskew</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">detection_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
        <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and returns a deskewed PIL image of the page.</span>

<span class="sd">        If `angle` is not provided, it will first try to detect the skew angle</span>
<span class="sd">        using `detect_skew_angle` (or use the cached angle if available).</span>

<span class="sd">        Args:</span>
<span class="sd">            resolution: DPI resolution for the output deskewed image.</span>
<span class="sd">            angle: The specific angle (in degrees) to rotate by. If None, detects automatically.</span>
<span class="sd">            detection_resolution: DPI resolution used for detection if `angle` is None.</span>
<span class="sd">            **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                             if automatic detection is performed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A deskewed PIL.Image.Image object, or None if rendering/rotation fails.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If the &#39;deskew&#39; library is not installed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Deskew library not found. Install with: pip install natural-pdf[deskew]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Determine the angle to use</span>
        <span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="k">if</span> <span class="n">rotation_angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Detect angle (or use cached) if not explicitly provided</span>
            <span class="n">rotation_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_skew_angle</span><span class="p">(</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">detection_resolution</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Preparing to deskew (output resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI). Using angle: </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Render the original page at the desired output resolution</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to render image for deskewing.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Rotate if a significant angle was found/provided</span>
            <span class="k">if</span> <span class="n">rotation_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rotation_angle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Rotating by </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> degrees.&quot;</span><span class="p">)</span>
                <span class="c1"># Determine fill color based on image mode</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span> <span class="k">else</span> <span class="mi">255</span>  <span class="c1"># White background</span>
                <span class="c1"># Rotate the image using PIL</span>
                <span class="n">rotated_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
                    <span class="n">rotation_angle</span><span class="p">,</span>  <span class="c1"># deskew provides angle, PIL rotates counter-clockwise</span>
                    <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                    <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Expand image to fit rotated content</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">rotated_img</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No significant rotation needed (angle=</span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">}</span><span class="s2">). Returning original render.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">img</span>  <span class="c1"># Return the original rendered image if no rotation needed</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error during deskewing image generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- End Skew Detection and Correction --- #</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Unified analysis storage (maps to metadata[&quot;analysis&quot;])</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="nd">@analyses</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;InspectionSummary&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspect all elements on this page with detailed tabular view.</span>
<span class="sd">        Equivalent to page.find_all(&#39;*&#39;).inspect().</span>

<span class="sd">        Args:</span>
<span class="sd">            limit: Maximum elements per type to show (default: 30)</span>

<span class="sd">        Returns:</span>
<span class="sd">            InspectionSummary with element tables showing coordinates,</span>
<span class="sd">            properties, and other details for each element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_text_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all text elements from this page.</span>

<span class="sd">        This removes all text elements (words and characters) from the page,</span>
<span class="sd">        effectively clearing the text layer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removing all text elements...&quot;</span><span class="p">)</span>

        <span class="c1"># Remove all words and chars from the element manager</span>
        <span class="n">removed_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
        <span class="n">removed_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>

        <span class="c1"># Clear the lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;chars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_words</span><span class="si">}</span><span class="s2"> words and </span><span class="si">{</span><span class="n">removed_chars</span><span class="si">}</span><span class="s2"> characters&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all line elements on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">lines</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Image elements</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all embedded raster images on this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">images</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="natural_pdf.Page-attributes">Attributes</h6>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.chars" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">chars</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get all character elements on this page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.height" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">height</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get page height.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.images" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">images</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get all embedded raster images on this page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">index</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get page index (0-based).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.layout_analyzer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">layout_analyzer</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get or create the layout analyzer for this page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.lines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">lines</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get all line elements on this page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.number" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">number</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get page number (1-based).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.page_number" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">page_number</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get page number (1-based).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.pdf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">pdf</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Provides public access to the parent PDF object.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.rects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">rects</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get all rectangle elements on this page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.size" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the size of the page in points.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.skew_angle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">skew_angle</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the detected skew angle for this page (if calculated).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.text_style_labels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">text_style_labels</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get a sorted list of unique text style labels found on the page.</p>
<p>Runs text style analysis with default options if it hasn't been run yet.
To use custom options, call <code>analyze_text_styles(options=...)</code> explicitly first.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sorted list of unique style label strings.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.width" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">width</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get page width.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Page.words" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">words</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get all word elements on this page.</p>

    </div>

</div>

<h6 id="natural_pdf.Page-functions">Functions</h6>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Initialize a page wrapper.</p>
<p>Creates an enhanced Page object that wraps a pdfplumber page with additional
functionality for spatial navigation, analysis, and AI-powered extraction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>page</code>
            </td>
            <td>
                  <code><span title="pdfplumber.page.Page">Page</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The underlying pdfplumber page object that provides raw PDF data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parent</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.PDF (natural_pdf.core.pdf.PDF)" href="#natural_pdf.PDF">PDF</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parent PDF object that contains this page and provides access
to managers and global settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Zero-based index of this page in the PDF document.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>font_attrs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of font attributes to consider when grouping characters
into words. Common attributes include ['fontname', 'size', 'flags'].
If None, uses default character-to-word grouping rules.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_text</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, load and process text elements from the PDF's text layer.
If False, skip text layer processing (useful for OCR-only workflows).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This constructor is typically called automatically when accessing pages
through the PDF.pages collection. Direct instantiation is rarely needed.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="c1"># Pages are usually accessed through the PDF object</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Page object created automatically</span>

<span class="c1"># Direct construction (advanced usage)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pdfplumber</span>
<span class="k">with</span> <span class="n">pdfplumber</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">plumber_pdf</span><span class="p">:</span>
    <span class="n">plumber_page</span> <span class="o">=</span> <span class="n">plumber_pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">plumber_page</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">page</span><span class="p">:</span> <span class="s2">&quot;pdfplumber.page.Page&quot;</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;PDF&quot;</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">font_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">load_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a page wrapper.</span>

<span class="sd">    Creates an enhanced Page object that wraps a pdfplumber page with additional</span>
<span class="sd">    functionality for spatial navigation, analysis, and AI-powered extraction.</span>

<span class="sd">    Args:</span>
<span class="sd">        page: The underlying pdfplumber page object that provides raw PDF data.</span>
<span class="sd">        parent: Parent PDF object that contains this page and provides access</span>
<span class="sd">            to managers and global settings.</span>
<span class="sd">        index: Zero-based index of this page in the PDF document.</span>
<span class="sd">        font_attrs: List of font attributes to consider when grouping characters</span>
<span class="sd">            into words. Common attributes include [&#39;fontname&#39;, &#39;size&#39;, &#39;flags&#39;].</span>
<span class="sd">            If None, uses default character-to-word grouping rules.</span>
<span class="sd">        load_text: If True, load and process text elements from the PDF&#39;s text layer.</span>
<span class="sd">            If False, skip text layer processing (useful for OCR-only workflows).</span>

<span class="sd">    Note:</span>
<span class="sd">        This constructor is typically called automatically when accessing pages</span>
<span class="sd">        through the PDF.pages collection. Direct instantiation is rarely needed.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Pages are usually accessed through the PDF object</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        page = pdf.pages[0]  # Page object created automatically</span>

<span class="sd">        # Direct construction (advanced usage)</span>
<span class="sd">        import pdfplumber</span>
<span class="sd">        with pdfplumber.open(&quot;document.pdf&quot;) as plumber_pdf:</span>
<span class="sd">            plumber_page = plumber_pdf.pages[0]</span>
<span class="sd">            page = Page(plumber_page, pdf, 0, load_text=True)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_page</span> <span class="o">=</span> <span class="n">page</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_load_text</span> <span class="o">=</span> <span class="n">load_text</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_styles</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Lazy-loaded text style analyzer results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List to store exclusion functions/regions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Stores detected skew angle</span>

    <span class="c1"># --- ADDED --- Metadata store for mixins</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># --- END ADDED ---</span>

    <span class="c1"># Region management</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;detected&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Layout detection results</span>
        <span class="s2">&quot;named&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Named regions (name -&gt; region)</span>
    <span class="p">}</span>

    <span class="c1"># -------------------------------------------------------------</span>
    <span class="c1"># Page-scoped configuration begins as a shallow copy of the parent</span>
    <span class="c1"># PDF-level configuration so that auto-computed tolerances or other</span>
    <span class="c1"># page-specific values do not overwrite siblings.</span>
    <span class="c1"># -------------------------------------------------------------</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="c1"># Initialize ElementManager, passing font_attrs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span> <span class="o">=</span> <span class="n">ElementManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_attrs</span><span class="o">=</span><span class="n">font_attrs</span><span class="p">,</span> <span class="n">load_text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_text</span><span class="p">)</span>
    <span class="c1"># self._highlighter = HighlightingService(self) # REMOVED - Use property accessor</span>
    <span class="c1"># --- NEW --- Central registry for analysis results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- Get OCR Manager Instance ---</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">OCRManager</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;_ocr_manager&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">,</span> <span class="n">OCRManager</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_ocr_manager</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Using OCRManager instance from parent PDF.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">OCRManager</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCRManager instance not found on parent PDF object.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># --- Get Layout Manager Instance ---</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">LayoutManager</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;_layout_manager&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_layout_manager</span><span class="p">,</span> <span class="n">LayoutManager</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_layout_manager</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Using LayoutManager instance from parent PDF.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">LayoutManager</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: LayoutManager instance not found on parent PDF object. Layout analysis will fail.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Initialize the internal variable with a single underscore</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_layout_analyzer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_load_elements</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Image.Image&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>String representation of the page.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;String representation of the page.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Page number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.add_exclusion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">add_exclusion</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add an exclusion to the page. Text from these regions will be excluded from extraction.
Ensures non-callable items are stored as Region objects if possible.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>exclusion_func_or_region</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a>], <a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>], <a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a callable function returning a Region,
                      a Region object, or another object with a valid .bbox attribute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional label for this exclusion (e.g., 'header', 'footer').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a non-callable, non-Region object without a valid bbox is provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_exclusion</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">exclusion_func_or_region</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Page&quot;</span><span class="p">],</span> <span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="s2">&quot;Region&quot;</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an exclusion to the page. Text from these regions will be excluded from extraction.</span>
<span class="sd">    Ensures non-callable items are stored as Region objects if possible.</span>

<span class="sd">    Args:</span>
<span class="sd">        exclusion_func_or_region: Either a callable function returning a Region,</span>
<span class="sd">                                  a Region object, or another object with a valid .bbox attribute.</span>
<span class="sd">        label: Optional label for this exclusion (e.g., &#39;header&#39;, &#39;footer&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If a non-callable, non-Region object without a valid bbox is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclusion_data</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize exclusion data</span>

    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">):</span>
        <span class="c1"># Store callable functions along with their label</span>
        <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added callable exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
        <span class="c1"># Store Region objects directly, assigning the label</span>
        <span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>  <span class="c1"># Assign label</span>
        <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>  <span class="c1"># Store as tuple for consistency</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added Region exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="p">):</span>
        <span class="c1"># Convert objects with a valid bbox to a Region before storing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bbox_coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exclusion_func_or_region</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
            <span class="c1"># Pass the label to the Region constructor</span>
            <span class="n">region_to_add</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox_coords</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">exclusion_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_to_add</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>  <span class="c1"># Store as tuple</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Added exclusion &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39; converted to Region from </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">region_to_add</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Raise an error if conversion fails</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to convert exclusion object </span><span class="si">{</span><span class="n">exclusion_func_or_region</span><span class="si">}</span><span class="s2"> with bbox </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bbox&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to Region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Reject invalid types</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid exclusion type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exclusion_func_or_region</span><span class="p">)</span><span class="si">}</span><span class="s2">. Must be callable, Region, or have a valid .bbox attribute.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Append the stored data (tuple of object/callable and label)</span>
    <span class="k">if</span> <span class="n">exclusion_data</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.add_region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add a region to the page.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>region</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object to add</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the region</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="s2">&quot;Region&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a region to the page.</span>

<span class="sd">    Args:</span>
<span class="sd">        region: Region object to add</span>
<span class="sd">        name: Optional name for the region</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if it&#39;s actually a Region object</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;region must be a Region object&quot;</span><span class="p">)</span>

    <span class="c1"># Set the source and name</span>
    <span class="n">region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;named&quot;</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Add to named regions dictionary (overwriting if name already exists)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;named&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add to detected regions list (unnamed but registered)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="c1"># Add to element manager for selector queries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.add_regions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">add_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add multiple regions to the page.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>regions</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Region objects to add</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional prefix for automatic naming (regions will be named prefix_1, prefix_2, etc.)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add multiple regions to the page.</span>

<span class="sd">    Args:</span>
<span class="sd">        regions: List of Region objects to add</span>
<span class="sd">        prefix: Optional prefix for automatic naming (regions will be named prefix_1, prefix_2, etc.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="c1"># Add with automatic sequential naming</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add without names</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.analyze_layout" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">analyze_layout</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Analyze the page layout using the configured LayoutManager.
Adds detected Region objects to the page's element manager.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ElementCollection containing the detected Region objects.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_layout</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LayoutOptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add client parameter</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze the page layout using the configured LayoutManager.</span>
<span class="sd">    Adds detected Region objects to the page&#39;s element manager.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ElementCollection containing the detected Region objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_analyzer</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">analyzer</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Layout analysis failed: LayoutAnalyzer not initialized (is LayoutManager available?).&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Return empty collection</span>

    <span class="c1"># Clear existing detected regions if &#39;replace&#39; is specified</span>
    <span class="k">if</span> <span class="n">existing</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_detected_layout_regions</span><span class="p">()</span>

    <span class="c1"># The analyzer&#39;s analyze_layout method already adds regions to the page</span>
    <span class="c1"># and its element manager. We just need to retrieve them.</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_layout</span><span class="p">(</span>
        <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
        <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
        <span class="n">exclude_classes</span><span class="o">=</span><span class="n">exclude_classes</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>  <span class="c1"># Pass client down</span>
    <span class="p">)</span>

    <span class="c1"># Retrieve the detected regions from the element manager</span>
    <span class="c1"># Filter regions based on source=&#39;detected&#39; and potentially the model used if available</span>
    <span class="n">detected_regions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">r</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;detected&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">engine</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">engine</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">detected_regions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.analyze_text_styles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">analyze_text_styles</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Analyze text elements by style, adding attributes directly to elements.</p>
<p>This method uses TextStyleAnalyzer to process text elements (typically words)
on the page. It adds the following attributes to each processed element:
- style_label: A descriptive or numeric label for the style group.
- style_key: A hashable tuple representing the style properties used for grouping.
- style_properties: A dictionary containing the extracted style properties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.analyzers.text_options.TextStyleOptions">TextStyleOptions</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional TextStyleOptions to configure the analysis.
     If None, the analyzer's default options are used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ElementCollection containing all processed text elements with added style attributes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_text_styles</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextStyleOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze text elements by style, adding attributes directly to elements.</span>

<span class="sd">    This method uses TextStyleAnalyzer to process text elements (typically words)</span>
<span class="sd">    on the page. It adds the following attributes to each processed element:</span>
<span class="sd">    - style_label: A descriptive or numeric label for the style group.</span>
<span class="sd">    - style_key: A hashable tuple representing the style properties used for grouping.</span>
<span class="sd">    - style_properties: A dictionary containing the extracted style properties.</span>

<span class="sd">    Args:</span>
<span class="sd">        options: Optional TextStyleOptions to configure the analysis.</span>
<span class="sd">                 If None, the analyzer&#39;s default options are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ElementCollection containing all processed text elements with added style attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create analyzer (optionally pass default options from PDF config here)</span>
    <span class="c1"># For now, it uses its own defaults if options=None</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">TextStyleAnalyzer</span><span class="p">()</span>

    <span class="c1"># Analyze the page. The analyzer now modifies elements directly</span>
    <span class="c1"># and returns the collection of processed elements.</span>
    <span class="n">processed_elements_collection</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

    <span class="c1"># Return the collection of elements which now have style attributes</span>
    <span class="k">return</span> <span class="n">processed_elements_collection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.apply_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detect_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Apply OCR to THIS page and add results to page elements via PDF.apply_ocr.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the OCR engine.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.ocr.OCROptions">OCROptions</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine-specific options object or dict.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>languages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of engine-specific language codes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run OCR on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for rendering page image before OCR.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), render page image for OCR
              with excluded areas masked (whited out).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detect_only</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only detect text bounding boxes, don't perform OCR.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>replace</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), remove any existing OCR elements before
    adding new ones. If False, add new OCR elements to existing ones.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OCROptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">detect_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply OCR to THIS page and add results to page elements via PDF.apply_ocr.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine: Name of the OCR engine.</span>
<span class="sd">        options: Engine-specific options object or dict.</span>
<span class="sd">        languages: List of engine-specific language codes.</span>
<span class="sd">        min_confidence: Minimum confidence threshold.</span>
<span class="sd">        device: Device to run OCR on.</span>
<span class="sd">        resolution: DPI resolution for rendering page image before OCR.</span>
<span class="sd">        apply_exclusions: If True (default), render page image for OCR</span>
<span class="sd">                          with excluded areas masked (whited out).</span>
<span class="sd">        detect_only: If True, only detect text bounding boxes, don&#39;t perform OCR.</span>
<span class="sd">        replace: If True (default), remove any existing OCR elements before</span>
<span class="sd">                adding new ones. If False, add new OCR elements to existing ones.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;apply_ocr&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Parent PDF missing &#39;apply_ocr&#39;. Cannot apply OCR.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>

    <span class="c1"># Remove existing OCR elements if replace is True</span>
    <span class="k">if</span> <span class="n">replace</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying new OCR.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_ocr_elements</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Delegating apply_ocr to PDF.apply_ocr.&quot;</span><span class="p">)</span>
    <span class="c1"># Delegate to parent PDF, targeting only this page&#39;s index</span>
    <span class="c1"># Pass all relevant parameters through, including apply_exclusions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span>
        <span class="n">pages</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
        <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">languages</span><span class="o">=</span><span class="n">languages</span><span class="p">,</span>
        <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="n">detect_only</span><span class="o">=</span><span class="n">detect_only</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
        <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>  <span class="c1"># Pass the replace parameter to PDF.apply_ocr</span>
    <span class="p">)</span>

    <span class="c1"># Return self for chaining</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.ask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Ask a question about the page content using document QA.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">question</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask a question about the page content using document QA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa.document_qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>

        <span class="c1"># Get or initialize QA engine with specified model</span>
        <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">()</span>
        <span class="c1"># Ask the question using the QA engine</span>
        <span class="k">return</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask_pdf_page</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Question answering requires the &#39;natural_pdf.qa&#39; module. Please install necessary dependencies.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during page.ask: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.clear_detected_layout_regions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">clear_detected_layout_regions</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Removes all regions from this page that were added by layout analysis
(i.e., regions where <code>source</code> attribute is 'detected').</p>
<p>This clears the regions both from the page's internal <code>_regions['detected']</code> list
and from the ElementManager's internal list of regions.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear_detected_layout_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes all regions from this page that were added by layout analysis</span>
<span class="sd">    (i.e., regions where `source` attribute is &#39;detected&#39;).</span>

<span class="sd">    This clears the regions both from the page&#39;s internal `_regions[&#39;detected&#39;]` list</span>
<span class="sd">    and from the ElementManager&#39;s internal list of regions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="p">,</span> <span class="s2">&quot;regions&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="p">,</span> <span class="s2">&quot;_elements&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="s2">&quot;regions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: No regions found in ElementManager, nothing to clear.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Ensure page&#39;s list is also clear</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Filter ElementManager&#39;s list to keep only non-detected regions</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;detected&quot;</span>
    <span class="p">]</span>
    <span class="n">new_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span>
    <span class="n">removed_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">new_count</span>

    <span class="c1"># Clear the page&#39;s specific list of detected regions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Cleared </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> detected layout regions.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.clear_exclusions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">clear_exclusions</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Clear all exclusions from the page.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear all exclusions from the page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.clear_highlights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">clear_highlights</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Clear all highlights <em>from this specific page</em> via HighlightingService.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear all highlights *from this specific page* via HighlightingService.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">clear_page</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.correct_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">correct_ocr</span><span class="p">(</span><span class="n">correction_callback</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="s1">&#39;text[source=ocr]&#39;</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Applies corrections to OCR-generated text elements on this page
using a user-provided callback function, potentially in parallel.</p>
<p>Finds text elements on this page whose 'source' attribute starts
with 'ocr' and calls the <code>correction_callback</code> for each, passing the
element itself. Updates the element's text if the callback returns
a new string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>correction_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function accepting an element and returning
                 <code>Optional[str]</code> (new text or None).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_workers</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of threads to use for parallel execution.
         If None or 0 or 1, runs sequentially.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function to call after processing each element.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">,</span>
    <span class="n">max_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Added progress callback</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>  <span class="c1"># Return self for chaining</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies corrections to OCR-generated text elements on this page</span>
<span class="sd">    using a user-provided callback function, potentially in parallel.</span>

<span class="sd">    Finds text elements on this page whose &#39;source&#39; attribute starts</span>
<span class="sd">    with &#39;ocr&#39; and calls the `correction_callback` for each, passing the</span>
<span class="sd">    element itself. Updates the element&#39;s text if the callback returns</span>
<span class="sd">    a new string.</span>

<span class="sd">    Args:</span>
<span class="sd">        correction_callback: A function accepting an element and returning</span>
<span class="sd">                             `Optional[str]` (new text or None).</span>
<span class="sd">        max_workers: The maximum number of threads to use for parallel execution.</span>
<span class="sd">                     If None or 0 or 1, runs sequentially.</span>
<span class="sd">        progress_callback: Optional callback function to call after processing each element.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Starting OCR correction with callback &#39;</span><span class="si">{</span><span class="n">correction_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; (max_workers=</span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="n">target_elements_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">target_elements</span> <span class="o">=</span> <span class="n">target_elements_collection</span><span class="o">.</span><span class="n">elements</span>  <span class="c1"># Get the list</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_elements</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No OCR elements found to correct.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">element_pbar</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">element_pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_elements</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Correcting OCR Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;element&quot;</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Define the task to be run by the worker thread or sequentially</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_process_element_task</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Call the user-provided callback</span>
                <span class="n">corrected_text</span> <span class="o">=</span> <span class="n">correction_callback</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

                <span class="c1"># Validate result type</span>
                <span class="k">if</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">corrected_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Correction callback for element &#39;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; returned non-string, non-None type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">corrected_text</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping update.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Treat as no correction</span>

                <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Return element, result, no error</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error applying correction callback to element &#39;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; (</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Keep log concise</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span>  <span class="c1"># Return element, no result, error</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># --- Update internal tqdm progress bar ---</span>
                <span class="k">if</span> <span class="n">element_pbar</span><span class="p">:</span>
                    <span class="n">element_pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># --- Call user&#39;s progress callback --- #</span>
                <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">progress_callback</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cb_e</span><span class="p">:</span>
                        <span class="c1"># Log error in callback itself, but don&#39;t stop processing</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error executing progress_callback: </span><span class="si">{</span><span class="n">cb_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># Choose execution strategy based on max_workers</span>
        <span class="k">if</span> <span class="n">max_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_workers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># --- Parallel execution --- #</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Running OCR correction in parallel with </span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2"> workers.&quot;</span>
            <span class="p">)</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="c1"># Submit all tasks</span>
                <span class="n">future_to_element</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_element_task</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span> <span class="n">element</span>
                    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">target_elements</span>
                <span class="p">}</span>

                <span class="c1"># Process results as they complete (progress_callback called by worker)</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_element</span><span class="p">):</span>
                    <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                            <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># Error already logged in worker</span>
                        <span class="k">elif</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># Apply correction if text changed</span>
                            <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">corrected_text</span> <span class="o">!=</span> <span class="n">current_text</span><span class="p">:</span>
                                <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">corrected_text</span>
                                <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="c1"># Catch errors from future.result() itself</span>
                        <span class="n">element</span> <span class="o">=</span> <span class="n">future_to_element</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>  <span class="c1"># Find original element</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Internal error retrieving correction result for element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># Note: progress_callback was already called in the worker&#39;s finally block</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># --- Sequential execution --- #</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Running OCR correction sequentially.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">target_elements</span><span class="p">:</span>
                <span class="c1"># Call the task function directly (it handles progress_callback)</span>
                <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_element</span><span class="p">,</span> <span class="n">corrected_text</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">_process_element_task</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">corrected_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Apply correction if text changed</span>
                    <span class="n">current_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_element</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">corrected_text</span> <span class="o">!=</span> <span class="n">current_text</span><span class="p">:</span>
                        <span class="n">_element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">corrected_text</span>
                        <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCR correction finished. Processed: </span><span class="si">{</span><span class="n">processed_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_elements</span><span class="p">)</span><span class="si">}</span><span class="s2">, Updated: </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2">, Errors: </span><span class="si">{</span><span class="n">error_count</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">element_pbar</span><span class="p">:</span>
            <span class="n">element_pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.create_region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Create a region on this page with the specified coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Left x-coordinate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Top y-coordinate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x1</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Right x-coordinate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bottom</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bottom y-coordinate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object for the specified coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a region on this page with the specified coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        x0: Left x-coordinate</span>
<span class="sd">        top: Top y-coordinate</span>
<span class="sd">        x1: Right x-coordinate</span>
<span class="sd">        bottom: Bottom y-coordinate</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object for the specified coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

    <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.crop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Crop the page to the specified bounding box.</p>
<p>This is a direct wrapper around pdfplumber's crop method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bbox</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box (x0, top, x1, bottom) or None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters (top, bottom, left, right)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cropped page object (pdfplumber.Page)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crop the page to the specified bounding box.</span>

<span class="sd">    This is a direct wrapper around pdfplumber&#39;s crop method.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox: Bounding box (x0, top, x1, bottom) or None</span>
<span class="sd">        **kwargs: Additional parameters (top, bottom, left, right)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Cropped page object (pdfplumber.Page)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Returns the pdfplumber page object, not a natural-pdf Page</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.deskew" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">deskew</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detection_resolution</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Creates and returns a deskewed PIL image of the page.</p>
<p>If <code>angle</code> is not provided, it will first try to detect the skew angle
using <code>detect_skew_angle</code> (or use the cached angle if available).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for the output deskewed image.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>angle</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The specific angle (in degrees) to rotate by. If None, detects automatically.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detection_resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution used for detection if <code>angle</code> is None.</p>
              </div>
            </td>
            <td>
                  <code>72</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**deskew_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to <code>deskew.determine_skew</code>
             if automatic detection is performed.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A deskewed PIL.Image.Image object, or None if rendering/rotation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the 'deskew' library is not installed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">deskew</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">angle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">detection_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
    <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and returns a deskewed PIL image of the page.</span>

<span class="sd">    If `angle` is not provided, it will first try to detect the skew angle</span>
<span class="sd">    using `detect_skew_angle` (or use the cached angle if available).</span>

<span class="sd">    Args:</span>
<span class="sd">        resolution: DPI resolution for the output deskewed image.</span>
<span class="sd">        angle: The specific angle (in degrees) to rotate by. If None, detects automatically.</span>
<span class="sd">        detection_resolution: DPI resolution used for detection if `angle` is None.</span>
<span class="sd">        **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                         if automatic detection is performed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A deskewed PIL.Image.Image object, or None if rendering/rotation fails.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If the &#39;deskew&#39; library is not installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Deskew library not found. Install with: pip install natural-pdf[deskew]&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Determine the angle to use</span>
    <span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="k">if</span> <span class="n">rotation_angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Detect angle (or use cached) if not explicitly provided</span>
        <span class="n">rotation_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_skew_angle</span><span class="p">(</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">detection_resolution</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Preparing to deskew (output resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI). Using angle: </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Render the original page at the desired output resolution</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to render image for deskewing.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Rotate if a significant angle was found/provided</span>
        <span class="k">if</span> <span class="n">rotation_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rotation_angle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Rotating by </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> degrees.&quot;</span><span class="p">)</span>
            <span class="c1"># Determine fill color based on image mode</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span> <span class="k">else</span> <span class="mi">255</span>  <span class="c1"># White background</span>
            <span class="c1"># Rotate the image using PIL</span>
            <span class="n">rotated_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
                <span class="n">rotation_angle</span><span class="p">,</span>  <span class="c1"># deskew provides angle, PIL rotates counter-clockwise</span>
                <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Expand image to fit rotated content</span>
                <span class="n">fillcolor</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">rotated_img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No significant rotation needed (angle=</span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">}</span><span class="s2">). Returning original render.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>  <span class="c1"># Return the original rendered image if no rotation needed</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error during deskewing image generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.detect_skew_angle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">detect_skew_angle</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="n">grayscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_recalculate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Detects the skew angle of the page image and stores it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for rendering the page image for detection.</p>
              </div>
            </td>
            <td>
                  <code>72</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grayscale</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to convert the image to grayscale before detection.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_recalculate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, recalculate even if an angle exists.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**deskew_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to <code>deskew.determine_skew</code>
             (e.g., <code>max_angle</code>, <code>num_peaks</code>).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The detected skew angle in degrees, or None if detection failed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the 'deskew' library is not installed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">detect_skew_angle</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
    <span class="n">grayscale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">force_recalculate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects the skew angle of the page image and stores it.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolution: DPI resolution for rendering the page image for detection.</span>
<span class="sd">        grayscale: Whether to convert the image to grayscale before detection.</span>
<span class="sd">        force_recalculate: If True, recalculate even if an angle exists.</span>
<span class="sd">        **deskew_kwargs: Additional keyword arguments passed to `deskew.determine_skew`</span>
<span class="sd">                         (e.g., `max_angle`, `num_peaks`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The detected skew angle in degrees, or None if detection failed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If the &#39;deskew&#39; library is not installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DESKEW_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Deskew library not found. Install with: pip install natural-pdf[deskew]&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_recalculate</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Returning cached skew angle: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Detecting skew angle (resolution=</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> DPI)...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Render the page at the specified detection resolution</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed to render image for skew detection.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Convert to numpy array</span>
        <span class="n">img_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># Convert to grayscale if needed</span>
        <span class="k">if</span> <span class="n">grayscale</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">gray_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_np</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Already grayscale</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Unexpected image shape </span><span class="si">{</span><span class="n">img_np</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> for grayscale conversion.&quot;</span>
                <span class="p">)</span>
                <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Try using it anyway</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gray_np</span> <span class="o">=</span> <span class="n">img_np</span>  <span class="c1"># Use original if grayscale=False</span>

        <span class="c1"># Determine skew angle using the deskew library</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">determine_skew</span><span class="p">(</span><span class="n">gray_np</span><span class="p">,</span> <span class="o">**</span><span class="n">deskew_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Detected skew angle = </span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">angle</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Failed during skew detection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skew_angle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.extract_ocr_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">extract_ocr_elements</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract text elements using OCR <em>without</em> adding them to the page's elements.
Uses the shared OCRManager instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the OCR engine.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.ocr.OCROptions">OCROptions</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine-specific options object or dict.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>languages</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of engine-specific language codes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run OCR on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI resolution for rendering page image before OCR.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="natural_pdf.elements.text.TextElement">TextElement</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of created TextElement objects derived from OCR results for this page.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_ocr_elements</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;OCROptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">languages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TextElement&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract text elements using OCR *without* adding them to the page&#39;s elements.</span>
<span class="sd">    Uses the shared OCRManager instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine: Name of the OCR engine.</span>
<span class="sd">        options: Engine-specific options object or dict.</span>
<span class="sd">        languages: List of engine-specific language codes.</span>
<span class="sd">        min_confidence: Minimum confidence threshold.</span>
<span class="sd">        device: Device to run OCR on.</span>
<span class="sd">        resolution: DPI resolution for rendering page image before OCR.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of created TextElement objects derived from OCR results for this page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: OCRManager not available. Cannot extract OCR elements.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Extracting OCR elements (extract only)...&quot;</span><span class="p">)</span>

    <span class="c1"># Determine rendering resolution</span>
    <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">resolution</span> <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">150</span>  <span class="c1"># Default to 150 DPI</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Using rendering resolution: </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get base image without highlights using the determined resolution</span>
        <span class="c1"># Use the global PDF rendering lock</span>
        <span class="k">with</span> <span class="n">pdf_render_lock</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">final_resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image for OCR extraction.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rendered image size: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to render page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> to image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Prepare arguments for the OCR Manager call</span>
    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
        <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
        <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">languages</span><span class="p">,</span>
        <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">min_confidence</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
        <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;  Calling OCR Manager (extract only) with args: </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;images&#39;</span><span class="p">}</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># apply_ocr now returns List[List[Dict]] or List[Dict]</span>
        <span class="n">results_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ocr_manager</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>
        <span class="c1"># If it returned a list of lists (batch mode), take the first list</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">results_list</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">results_list</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR Manager returned unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR Manager returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results for extraction.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OCR processing failed during extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Convert results but DO NOT add to ElementManager</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Converting OCR results to TextElements (extract only)...&quot;</span><span class="p">)</span>
    <span class="n">temp_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Added try-except around result processing</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]]</span>
            <span class="n">elem_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
                <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="n">top</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">bottom</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>  <span class="c1"># Using text for temporary elements</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ocr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="s2">&quot;OCR-extract&quot;</span><span class="p">,</span>  <span class="c1"># Different name for clarity</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">temp_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextElement</span><span class="p">(</span><span class="n">elem_data</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">convert_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Skipping invalid OCR result during conversion: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">convert_err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> TextElements from OCR (extract only).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">temp_elements</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.extract_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ocr_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_extraction_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract the largest table from this page using enhanced region-based extraction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method to use: 'tatr', 'pdfplumber', 'text', 'stream', 'lattice', or None (auto-detect).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_settings</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Settings for pdfplumber table extraction.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use OCR for text extraction (currently only applicable with 'tatr' method).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ocr_config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OCR configuration parameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of options for the 'text' method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cell_extraction_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable function that takes a cell Region object
                  and returns its string content. For 'text' method only.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, display a progress bar during cell text extraction for the 'text' method.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="typing.Optional">Optional</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Table data as a list of rows, where each row is a list of cell values (str or None).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_table</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ocr_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">text_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell_extraction_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the largest table from this page using enhanced region-based extraction.</span>

<span class="sd">    Args:</span>
<span class="sd">        method: Method to use: &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">        table_settings: Settings for pdfplumber table extraction.</span>
<span class="sd">        use_ocr: Whether to use OCR for text extraction (currently only applicable with &#39;tatr&#39; method).</span>
<span class="sd">        ocr_config: OCR configuration parameters.</span>
<span class="sd">        text_options: Dictionary of options for the &#39;text&#39; method.</span>
<span class="sd">        cell_extraction_func: Optional callable function that takes a cell Region object</span>
<span class="sd">                              and returns its string content. For &#39;text&#39; method only.</span>
<span class="sd">        show_progress: If True, display a progress bar during cell text extraction for the &#39;text&#39; method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table data as a list of rows, where each row is a list of cell values (str or None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a full-page region and delegate to its enhanced extract_table method</span>
    <span class="n">page_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">page_region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="p">,</span>
        <span class="n">use_ocr</span><span class="o">=</span><span class="n">use_ocr</span><span class="p">,</span>
        <span class="n">ocr_config</span><span class="o">=</span><span class="n">ocr_config</span><span class="p">,</span>
        <span class="n">text_options</span><span class="o">=</span><span class="n">text_options</span><span class="p">,</span>
        <span class="n">cell_extraction_func</span><span class="o">=</span><span class="n">cell_extraction_func</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.extract_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_tatr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract all tables from this page with enhanced method support.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method to use: 'pdfplumber', 'stream', 'lattice', or None (auto-detect).
    'stream' uses text-based strategies, 'lattice' uses line-based strategies.
    Note: 'tatr' and 'text' methods are not supported for extract_tables.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_settings</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Settings for pdfplumber table extraction.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>check_tatr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), first check for TATR-detected table regions
        and extract from those before falling back to pdfplumber methods.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tables, where each table is a list of rows, and each row is a list of cell values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">check_tatr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract all tables from this page with enhanced method support.</span>

<span class="sd">    Args:</span>
<span class="sd">        method: Method to use: &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                &#39;stream&#39; uses text-based strategies, &#39;lattice&#39; uses line-based strategies.</span>
<span class="sd">                Note: &#39;tatr&#39; and &#39;text&#39; methods are not supported for extract_tables.</span>
<span class="sd">        table_settings: Settings for pdfplumber table extraction.</span>
<span class="sd">        check_tatr: If True (default), first check for TATR-detected table regions</span>
<span class="sd">                    and extract from those before falling back to pdfplumber methods.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tables, where each table is a list of rows, and each row is a list of cell values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Check for TATR-detected table regions first if enabled</span>
    <span class="k">if</span> <span class="n">check_tatr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tatr_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table][model=tatr]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tatr_tables</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tatr_tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> TATR table regions, extracting from those...&quot;</span>
                <span class="p">)</span>
                <span class="n">extracted_tables</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">table_region</span> <span class="ow">in</span> <span class="n">tatr_tables</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;tatr&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">table_data</span><span class="p">:</span>  <span class="c1"># Only add non-empty tables</span>
                            <span class="n">extracted_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to extract table from TATR region </span><span class="si">{</span><span class="n">table_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">extracted_tables</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Successfully extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extracted_tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables from TATR regions&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">extracted_tables</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: TATR regions found but no tables extracted, falling back to pdfplumber&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No TATR table regions found, using pdfplumber methods&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Error checking TATR regions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to pdfplumber&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Auto-detect method if not specified (try lattice first, then stream)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Auto-detecting tables extraction method...&quot;</span><span class="p">)</span>

        <span class="c1"># Try lattice first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lattice_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
            <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first for tables...&quot;</span><span class="p">)</span>
            <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">lattice_settings</span><span class="p">)</span>

            <span class="c1"># Check if lattice found meaningful tables</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">lattice_result</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span>
                        <span class="k">if</span> <span class="n">table</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">lattice_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful tables&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fall back to stream</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method for tables...&quot;</span><span class="p">)</span>
        <span class="n">stream_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">stream_settings</span><span class="p">)</span>

    <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="c1"># Handle method aliases</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
        <span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

    <span class="c1"># Use the selected method</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="c1"># Inject auto-computed or user-specified text tolerances so</span>
        <span class="c1"># pdfplumber uses the same numbers we used for word grouping</span>
        <span class="c1"># whenever the table algorithm relies on word positions.</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SETTING IT UP&quot;</span><span class="p">)</span>
            <span class="n">pdf_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="k">if</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="n">x_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">,</span> <span class="n">x_tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="n">y_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">,</span> <span class="n">y_tol</span><span class="p">)</span>

            <span class="c1"># pdfplumber&#39;s text strategy benefits from a tight snap tolerance.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;snap_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                <span class="ow">and</span> <span class="s2">&quot;snap_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="p">):</span>
                <span class="c1"># Derive from y_tol if available, else default 1</span>
                <span class="n">snap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">))</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="n">snap</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;join_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
                <span class="ow">and</span> <span class="s2">&quot;join_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="p">):</span>
                <span class="n">join</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_x_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_y_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown tables extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.extract_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract text from this page, respecting exclusions and using pdfplumber's
layout engine (chars_to_textmap) if layout arguments are provided or default.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>use_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions (default: True).
          Note: Filtering logic is now always applied if exclusions exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to output detailed exclusion debugging info (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional layout parameters passed directly to pdfplumber's
      <code>chars_to_textmap</code> function. Common parameters include:
      - layout (bool): If True (default), inserts spaces/newlines.
      - x_density (float): Pixels per character horizontally.
      - y_density (float): Pixels per line vertically.
      - x_tolerance (float): Tolerance for horizontal character grouping.
      - y_tolerance (float): Tolerance for vertical character grouping.
      - line_dir (str): 'ttb', 'btt', 'ltr', 'rtl'
      - char_dir (str): 'ttb', 'btt', 'ltr', 'rtl'
      See pdfplumber documentation for more.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extracted text as string, potentially with layout-based spacing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract text from this page, respecting exclusions and using pdfplumber&#39;s</span>
<span class="sd">    layout engine (chars_to_textmap) if layout arguments are provided or default.</span>

<span class="sd">    Args:</span>
<span class="sd">        use_exclusions: Whether to apply exclusion regions (default: True).</span>
<span class="sd">                      Note: Filtering logic is now always applied if exclusions exist.</span>
<span class="sd">        debug_exclusions: Whether to output detailed exclusion debugging info (default: False).</span>
<span class="sd">        **kwargs: Additional layout parameters passed directly to pdfplumber&#39;s</span>
<span class="sd">                  `chars_to_textmap` function. Common parameters include:</span>
<span class="sd">                  - layout (bool): If True (default), inserts spaces/newlines.</span>
<span class="sd">                  - x_density (float): Pixels per character horizontally.</span>
<span class="sd">                  - y_density (float): Pixels per line vertically.</span>
<span class="sd">                  - x_tolerance (float): Tolerance for horizontal character grouping.</span>
<span class="sd">                  - y_tolerance (float): Tolerance for vertical character grouping.</span>
<span class="sd">                  - line_dir (str): &#39;ttb&#39;, &#39;btt&#39;, &#39;ltr&#39;, &#39;rtl&#39;</span>
<span class="sd">                  - char_dir (str): &#39;ttb&#39;, &#39;btt&#39;, &#39;ltr&#39;, &#39;rtl&#39;</span>
<span class="sd">                  See pdfplumber documentation for more.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Extracted text as string, potentially with layout-based spacing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: extract_text called with kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="p">)</span>  <span class="c1"># Allow &#39;debug&#39; kwarg</span>

    <span class="c1"># 1. Get Word Elements (triggers load_elements if needed)</span>
    <span class="n">word_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">words</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">word_elements</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: No word elements found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># 2. Get Exclusions</span>
    <span class="n">apply_exclusions_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_exclusions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">apply_exclusions_flag</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
        <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span><span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Applying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclusion_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> exclusions.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Not applying exclusions.&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Collect All Character Dictionaries from Word Elements</span>
    <span class="n">all_char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_elements</span><span class="p">:</span>
        <span class="n">all_char_dicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;_char_dicts&quot;</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="c1"># 4. Spatially Filter Characters</span>
    <span class="n">filtered_chars</span> <span class="o">=</span> <span class="n">filter_chars_spatially</span><span class="p">(</span>
        <span class="n">char_dicts</span><span class="o">=</span><span class="n">all_char_dicts</span><span class="p">,</span>
        <span class="n">exclusion_regions</span><span class="o">=</span><span class="n">exclusion_regions</span><span class="p">,</span>
        <span class="n">target_region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No target region for full page extraction</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 5. Generate Text Layout using Utility</span>
    <span class="c1"># Pass page bbox as layout context</span>
    <span class="n">page_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="c1"># Merge PDF-level default tolerances if caller did not override</span>
    <span class="n">merged_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">tol_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">,</span> <span class="s2">&quot;x_tolerance_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;y_tolerance&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tol_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
                <span class="n">merged_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}):</span>
                <span class="n">merged_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">generate_text_layout</span><span class="p">(</span>
        <span class="n">char_dicts</span><span class="o">=</span><span class="n">filtered_chars</span><span class="p">,</span>
        <span class="n">layout_context_bbox</span><span class="o">=</span><span class="n">page_bbox</span><span class="p">,</span>
        <span class="n">user_kwargs</span><span class="o">=</span><span class="n">merged_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># --- Optional: apply Unicode BiDi algorithm for mixed RTL/LTR correctness ---</span>
    <span class="n">apply_bidi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidi&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apply_bidi</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
        <span class="c1"># Quick check for any RTL character</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_contains_rtl</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">unicodedata</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_contains_rtl</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">bidi.algorithm</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_display</span>  <span class="c1"># type: ignore</span>

                <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.utils.bidi_mirror</span><span class="w"> </span><span class="kn">import</span> <span class="n">mirror_brackets</span>

                <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">mirror_brackets</span><span class="p">(</span>
                        <span class="n">get_display</span><span class="p">(</span>
                            <span class="n">line</span><span class="p">,</span>
                            <span class="n">base_dir</span><span class="o">=</span><span class="p">(</span>
                                <span class="s2">&quot;R&quot;</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                                    <span class="n">unicodedata</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span>
                                <span class="p">)</span>
                                <span class="k">else</span> <span class="s2">&quot;L&quot;</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># silently skip if python-bidi not available</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: extract_text finished, result length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.filter_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">filter_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Filter a list of elements based on a selector.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>elements</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="natural_pdf.elements.base.Element">Element</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of elements to filter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional filter parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="natural_pdf.elements.base.Element">Element</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of elements that match the selector</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_elements</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">],</span> <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter a list of elements based on a selector.</span>

<span class="sd">    Args:</span>
<span class="sd">        elements: List of elements to filter</span>
<span class="sd">        selector: CSS-like selector string</span>
<span class="sd">        **kwargs: Additional filter parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of elements that match the selector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.selectors.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_selector</span><span class="p">,</span> <span class="n">selector_to_filter_func</span>

    <span class="c1"># Parse the selector</span>
    <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

    <span class="c1"># Create filter function from selector</span>
    <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Apply the filter to the elements</span>
    <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span>

    <span class="c1"># Sort elements in reading order if requested</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reading_order&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">matching_elements</span><span class="p">):</span>
            <span class="n">matching_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot sort elements in reading order: Missing required attributes (top, x0).&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">matching_elements</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.find" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find first element on this page matching selector OR text content.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional filter parameters.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element object or None if not found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
    <span class="o">*</span><span class="p">,</span>  <span class="c1"># Force subsequent args to be keyword-only</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find first element on this page matching selector OR text content.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional filter parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Element object or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
    <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Escape quotes within the text for the selector string</span>
        <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># Default to &#39;text:contains(...)&#39;</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="c1"># Note: regex/case handled by kwargs passed down</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Should be unreachable due to checks above</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

    <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

    <span class="c1"># Pass regex and case flags to selector function via kwargs</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regex</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">case</span>

    <span class="c1"># First get all matching elements without applying exclusions initially within _apply_selector</span>
    <span class="n">results_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_selector</span><span class="p">(</span>
        <span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>  <span class="c1"># _apply_selector doesn&#39;t filter</span>

    <span class="c1"># Filter the results based on exclusions if requested</span>
    <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="ow">and</span> <span class="n">results_collection</span><span class="p">:</span>
        <span class="n">filtered_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span><span class="n">results_collection</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="c1"># Return the first element from the filtered list</span>
        <span class="k">return</span> <span class="n">filtered_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">filtered_elements</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">results_collection</span><span class="p">:</span>
        <span class="c1"># Return the first element from the unfiltered results</span>
        <span class="k">return</span> <span class="n">results_collection</span><span class="o">.</span><span class="n">first</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.find_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find all elements on this page matching selector OR text content.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional filter parameters.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ElementCollection with matching elements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
    <span class="o">*</span><span class="p">,</span>  <span class="c1"># Force subsequent args to be keyword-only</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all elements on this page matching selector OR text content.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional filter parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ElementCollection with matching elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>  <span class="c1"># Import here for type hint</span>

    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
    <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Escape quotes within the text for the selector string</span>
        <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># Default to &#39;text:contains(...)&#39;</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Should be unreachable due to checks above</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

    <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

    <span class="c1"># Pass regex and case flags to selector function via kwargs</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regex</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">case</span>

    <span class="c1"># First get all matching elements without applying exclusions initially within _apply_selector</span>
    <span class="n">results_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_selector</span><span class="p">(</span>
        <span class="n">selector_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>  <span class="c1"># _apply_selector doesn&#39;t filter</span>

    <span class="c1"># Filter the results based on exclusions if requested</span>
    <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="ow">and</span> <span class="n">results_collection</span><span class="p">:</span>
        <span class="n">filtered_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span><span class="n">results_collection</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">filtered_elements</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return the unfiltered collection</span>
        <span class="k">return</span> <span class="n">results_collection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_content" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Returns the primary content object (self) for indexing (required by Indexable protocol).
SearchService implementations decide how to process this (e.g., call extract_text).</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the primary content object (self) for indexing (required by Indexable protocol).</span>
<span class="sd">    SearchService implementations decide how to process this (e.g., call extract_text).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return the Page object itself</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_content_hash" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_content_hash</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Returns a SHA256 hash of the extracted text content (required by Indexable for sync).</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_content_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a SHA256 hash of the extracted text content (required by Indexable for sync).&quot;&quot;&quot;</span>
    <span class="c1"># Hash the extracted text (without exclusions for consistency)</span>
    <span class="c1"># Consider if exclusions should be part of the hash? For now, hash raw text.</span>
    <span class="c1"># Using extract_text directly might be slow if called repeatedly. Cache? TODO: Optimization</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
        <span class="n">use_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_whitespace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>  <span class="c1"># Normalize whitespace?</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">text_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_elements</span><span class="p">(</span><span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get all elements on this page.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to output detailed exclusion debugging info (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="natural_pdf.elements.base.Element">Element</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of all elements on the page, potentially filtered by exclusions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_elements</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all elements on this page.</span>

<span class="sd">    Args:</span>
<span class="sd">        apply_exclusions: Whether to apply exclusion regions (default: True).</span>
<span class="sd">        debug_exclusions: Whether to output detailed exclusion debugging info (default: False).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of all elements on the page, potentially filtered by exclusions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all elements from the element manager</span>
    <span class="n">all_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">get_all_elements</span><span class="p">()</span>

    <span class="c1"># Apply exclusions if requested</span>
    <span class="k">if</span> <span class="n">apply_exclusions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_elements_by_exclusions</span><span class="p">(</span>
            <span class="n">all_elements</span><span class="p">,</span> <span class="n">debug_exclusions</span><span class="o">=</span><span class="n">debug_exclusions</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug_exclusions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: get_elements returning all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements (exclusions not applied).&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">all_elements</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Returns a unique identifier for the page (required by Indexable protocol).</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a unique identifier for the page (required by Indexable protocol).&quot;&quot;&quot;</span>
    <span class="c1"># Ensure path is safe for use in IDs (replace problematic chars)</span>
    <span class="n">safe_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_-]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;pdf_</span><span class="si">{</span><span class="n">safe_path</span><span class="si">}</span><span class="s2">_page_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Returns metadata associated with the page (required by Indexable protocol).</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns metadata associated with the page (required by Indexable protocol).&quot;&quot;&quot;</span>
    <span class="c1"># Add content hash here for sync</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pdf_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
        <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="s2">&quot;content_hash&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_hash</span><span class="p">(),</span>  <span class="c1"># Include the hash</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_section_between" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get a section between two elements on this page.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_section_between</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]:</span>  <span class="c1"># Return Optional</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a section between two elements on this page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a full-page region to operate within</span>
    <span class="n">page_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Delegate to the region&#39;s method</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">page_region</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span>
            <span class="n">start_element</span><span class="o">=</span><span class="n">start_element</span><span class="p">,</span>
            <span class="n">end_element</span><span class="o">=</span><span class="n">end_element</span><span class="p">,</span>
            <span class="n">boundary_inclusion</span><span class="o">=</span><span class="n">boundary_inclusion</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error getting section between elements on page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.get_sections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">y_threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get sections of a page defined by start/end elements.
Uses the page-level implementation.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An ElementCollection containing the found Region objects.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_sections</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
    <span class="n">y_threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">bounding_box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get sections of a page defined by start/end elements.</span>
<span class="sd">    Uses the page-level implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An ElementCollection containing the found Region objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Helper function to get bounds from bounding_box parameter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bounds</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">bounding_box</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">bounding_box</span>
            <span class="c1"># Clamp to page boundaries</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">bottom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Handle cases where elements are provided as strings (selectors)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">start_elements</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span>  <span class="c1"># Get list of elements</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>  <span class="c1"># Handle ElementCollection input</span>
        <span class="n">start_elements</span> <span class="o">=</span> <span class="n">start_elements</span><span class="o">.</span><span class="n">elements</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">end_elements</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="n">end_elements</span><span class="o">.</span><span class="n">elements</span>

    <span class="c1"># Ensure start_elements is a list</span>
    <span class="k">if</span> <span class="n">start_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">valid_inclusions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_inclusions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boundary_inclusion must be one of </span><span class="si">{</span><span class="n">valid_inclusions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">start_elements</span><span class="p">:</span>
        <span class="c1"># Return an empty ElementCollection if no start elements</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>

    <span class="c1"># Combine start and end elements with their type</span>
    <span class="n">all_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">start_elements</span><span class="p">:</span>
        <span class="n">all_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">end_elements</span><span class="p">:</span>
        <span class="n">all_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">el</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">))</span>

    <span class="c1"># Sort all boundary elements primarily by top, then x0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sorting boundaries: Element missing top/x0 attribute? </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Cannot proceed if elements lack position</span>

    <span class="c1"># Process sorted boundaries to find sections</span>
    <span class="n">current_start_element</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">element_type</span> <span class="ow">in</span> <span class="n">all_boundaries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
            <span class="c1"># If we have an active section, this start implicitly ends it</span>
            <span class="k">if</span> <span class="n">active_section_started</span><span class="p">:</span>
                <span class="n">end_boundary_el</span> <span class="o">=</span> <span class="n">element</span>  <span class="c1"># Use this start as the end boundary</span>
                <span class="c1"># Determine region boundaries</span>
                <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
                    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
                <span class="p">)</span>
                <span class="n">sec_bottom</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">top</span>
                    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">bottom</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">sec_bottom</span><span class="p">:</span>  <span class="c1"># Ensure valid region</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">sec_bottom</span><span class="p">)</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_boundary_el</span>  <span class="c1"># Mark the element that ended it</span>
                    <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Mark how it ended</span>
                    <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Reset for the new start</span>

            <span class="c1"># Set this as the potential start of the next section</span>
            <span class="n">current_start_element</span> <span class="o">=</span> <span class="n">element</span>
            <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">element_type</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="ow">and</span> <span class="n">active_section_started</span><span class="p">:</span>
            <span class="c1"># We found an explicit end for the current section</span>
            <span class="n">end_boundary_el</span> <span class="o">=</span> <span class="n">element</span>
            <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
                <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
            <span class="p">)</span>
            <span class="n">sec_bottom</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">bottom</span>
                <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">end_boundary_el</span><span class="o">.</span><span class="n">top</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">sec_bottom</span><span class="p">:</span>  <span class="c1"># Ensure valid region</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
                <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">sec_bottom</span><span class="p">)</span>
                <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
                <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_boundary_el</span>
                <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

            <span class="c1"># Reset: section ended explicitly</span>
            <span class="n">current_start_element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">active_section_started</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Handle the last section if it was started but never explicitly ended</span>
    <span class="k">if</span> <span class="n">active_section_started</span><span class="p">:</span>
        <span class="n">sec_top</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current_start_element</span><span class="o">.</span><span class="n">top</span>
            <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="n">current_start_element</span><span class="o">.</span><span class="n">bottom</span>
        <span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">page_bottom</span> <span class="o">=</span> <span class="n">get_bounds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sec_top</span> <span class="o">&lt;</span> <span class="n">page_bottom</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">sec_top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">page_bottom</span><span class="p">)</span>
            <span class="n">region</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_element</span>
            <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ended by page end</span>
            <span class="n">region</span><span class="o">.</span><span class="n">is_end_next_start</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.highlight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_color_cycling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Highlight a bounding box or the entire page.
Delegates to the central HighlightingService.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bbox</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box (x0, top, x1, bottom). If None, highlight entire page.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGBA color tuple/string for the highlight.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional label for the highlight.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_color_cycling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and no label/color, use next cycle color.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>element</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional original element being highlighted (for attribute extraction).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_attrs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of attribute names from 'element' to display.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>existing</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to handle existing highlights ('append' or 'replace').</p>
              </div>
            </td>
            <td>
                  <code>&#39;append&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Highlight a bounding box or the entire page.</span>
<span class="sd">    Delegates to the central HighlightingService.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox: Bounding box (x0, top, x1, bottom). If None, highlight entire page.</span>
<span class="sd">        color: RGBA color tuple/string for the highlight.</span>
<span class="sd">        label: Optional label for the highlight.</span>
<span class="sd">        use_color_cycling: If True and no label/color, use next cycle color.</span>
<span class="sd">        element: Optional original element being highlighted (for attribute extraction).</span>
<span class="sd">        include_attrs: List of attribute names from &#39;element&#39; to display.</span>
<span class="sd">        existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_bbox</span> <span class="o">=</span> <span class="n">bbox</span> <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="n">target_bbox</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">use_color_cycling</span><span class="o">=</span><span class="n">use_color_cycling</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
        <span class="n">include_attrs</span><span class="o">=</span><span class="n">include_attrs</span><span class="p">,</span>
        <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.highlight_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">highlight_polygon</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_color_cycling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Highlight a polygon shape on the page.
Delegates to the central HighlightingService.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>polygon</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (x, y) points defining the polygon.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGBA color tuple/string for the highlight.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional label for the highlight.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_color_cycling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True and no label/color, use next cycle color.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>element</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional original element being highlighted (for attribute extraction).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_attrs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of attribute names from 'element' to display.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>existing</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to handle existing highlights ('append' or 'replace').</p>
              </div>
            </td>
            <td>
                  <code>&#39;append&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">highlight_polygon</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Highlight a polygon shape on the page.</span>
<span class="sd">    Delegates to the central HighlightingService.</span>

<span class="sd">    Args:</span>
<span class="sd">        polygon: List of (x, y) points defining the polygon.</span>
<span class="sd">        color: RGBA color tuple/string for the highlight.</span>
<span class="sd">        label: Optional label for the highlight.</span>
<span class="sd">        use_color_cycling: If True and no label/color, use next cycle color.</span>
<span class="sd">        element: Optional original element being highlighted (for attribute extraction).</span>
<span class="sd">        include_attrs: List of attribute names from &#39;element&#39; to display.</span>
<span class="sd">        existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">add_polygon</span><span class="p">(</span>
        <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">polygon</span><span class="o">=</span><span class="n">polygon</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">use_color_cycling</span><span class="o">=</span><span class="n">use_color_cycling</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
        <span class="n">include_attrs</span><span class="o">=</span><span class="n">include_attrs</span><span class="p">,</span>
        <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.inspect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Inspect all elements on this page with detailed tabular view.
Equivalent to page.find_all('*').inspect().</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum elements per type to show (default: 30)</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="InspectionSummary">InspectionSummary</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>InspectionSummary with element tables showing coordinates,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="InspectionSummary">InspectionSummary</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>properties, and other details for each element</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;InspectionSummary&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect all elements on this page with detailed tabular view.</span>
<span class="sd">    Equivalent to page.find_all(&#39;*&#39;).inspect().</span>

<span class="sd">    Args:</span>
<span class="sd">        limit: Maximum elements per type to show (default: 30)</span>

<span class="sd">    Returns:</span>
<span class="sd">        InspectionSummary with element tables showing coordinates,</span>
<span class="sd">        properties, and other details for each element</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Create a region on this page with more intuitive named parameters,
allowing definition by coordinates or by coordinate + dimension.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Left x-coordinate (default: 0 if width not used).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Top y-coordinate (default: 0 if height not used).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Right x-coordinate (default: page width if width not used).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bottom</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bottom y-coordinate (default: page height if height not used).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width definition. Can be:
   - Numeric: The width of the region in points. Cannot be used with both left and right.
   - String 'full': Sets region width to full page width (overrides left/right).
   - String 'element' or None (default): Uses provided/calculated left/right,
     defaulting to page width if neither are specified.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Numeric height of the region. Cannot be used with both top and bottom.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object for the specified coordinates</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If conflicting arguments are provided (e.g., top, bottom, and height)
      or if width is an invalid string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Region from y=100 to y=150, default width</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>   <span class="c1"># Region from x=50 to x=150, default height</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1"># Region from y=450 to y=500</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Region from x=150 to x=200</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span> <span class="c1"># Explicit full width</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">region</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">left</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">top</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bottom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a region on this page with more intuitive named parameters,</span>
<span class="sd">    allowing definition by coordinates or by coordinate + dimension.</span>

<span class="sd">    Args:</span>
<span class="sd">        left: Left x-coordinate (default: 0 if width not used).</span>
<span class="sd">        top: Top y-coordinate (default: 0 if height not used).</span>
<span class="sd">        right: Right x-coordinate (default: page width if width not used).</span>
<span class="sd">        bottom: Bottom y-coordinate (default: page height if height not used).</span>
<span class="sd">        width: Width definition. Can be:</span>
<span class="sd">               - Numeric: The width of the region in points. Cannot be used with both left and right.</span>
<span class="sd">               - String &#39;full&#39;: Sets region width to full page width (overrides left/right).</span>
<span class="sd">               - String &#39;element&#39; or None (default): Uses provided/calculated left/right,</span>
<span class="sd">                 defaulting to page width if neither are specified.</span>
<span class="sd">        height: Numeric height of the region. Cannot be used with both top and bottom.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object for the specified coordinates</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If conflicting arguments are provided (e.g., top, bottom, and height)</span>
<span class="sd">                  or if width is an invalid string.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; page.region(top=100, height=50)  # Region from y=100 to y=150, default width</span>
<span class="sd">        &gt;&gt;&gt; page.region(left=50, width=100)   # Region from x=50 to x=150, default height</span>
<span class="sd">        &gt;&gt;&gt; page.region(bottom=500, height=50) # Region from y=450 to y=500</span>
<span class="sd">        &gt;&gt;&gt; page.region(right=200, width=50)  # Region from x=150 to x=200</span>
<span class="sd">        &gt;&gt;&gt; page.region(top=100, bottom=200, width=&quot;full&quot;) # Explicit full width</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Percentage support  convert strings like &quot;30%&quot; to absolute values</span>
    <span class="c1"># based on page dimensions.  X-axis params (left, right, width) use</span>
    <span class="c1"># page.width; Y-axis params (top, bottom, height) use page.height.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pct_to_abs</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pct</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span>  <span class="c1"># leave unchanged if not a number</span>
            <span class="k">return</span> <span class="n">pct</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="n">left</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">_pct_to_abs</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="c1"># --- Type checking and basic validation ---</span>
    <span class="n">is_width_numeric</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
    <span class="n">is_width_string</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">width_mode</span> <span class="o">=</span> <span class="s2">&quot;element&quot;</span>  <span class="c1"># Default mode</span>

    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify top, bottom, and height simultaneously.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_width_numeric</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify left, right, and a numeric width simultaneously.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_width_string</span><span class="p">:</span>
        <span class="n">width_lower</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">width_lower</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;String width argument must be &#39;full&#39; or &#39;element&#39;.&quot;</span><span class="p">)</span>
        <span class="n">width_mode</span> <span class="o">=</span> <span class="n">width_lower</span>

    <span class="c1"># --- Calculate Coordinates ---</span>
    <span class="n">final_top</span> <span class="o">=</span> <span class="n">top</span>
    <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">bottom</span>
    <span class="n">final_left</span> <span class="o">=</span> <span class="n">left</span>
    <span class="n">final_right</span> <span class="o">=</span> <span class="n">right</span>

    <span class="c1"># Height calculations</span>
    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">height</span>
        <span class="k">elif</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">height</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Neither top nor bottom provided, default top to 0</span>
            <span class="n">final_top</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">height</span>

    <span class="c1"># Width calculations (numeric only)</span>
    <span class="k">if</span> <span class="n">is_width_numeric</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">width</span>
        <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">width</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Neither left nor right provided, default left to 0</span>
            <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">final_right</span> <span class="o">=</span> <span class="n">width</span>

    <span class="c1"># --- Apply Defaults for Unset Coordinates ---</span>
    <span class="c1"># Only default coordinates if they weren&#39;t set by dimension calculation</span>
    <span class="k">if</span> <span class="n">final_top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_top</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">final_bottom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check if bottom should have been set by height calc</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

    <span class="k">if</span> <span class="n">final_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">final_right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check if right should have been set by width calc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_width_numeric</span> <span class="ow">or</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="c1"># --- Handle width_mode == &#39;full&#39; ---</span>
    <span class="k">if</span> <span class="n">width_mode</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
        <span class="c1"># Override left/right if mode is full</span>
        <span class="n">final_left</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">final_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="c1"># --- Final Validation &amp; Creation ---</span>
    <span class="c1"># Ensure coordinates are within page bounds (clamp)</span>
    <span class="n">final_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_left</span><span class="p">)</span>
    <span class="n">final_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_top</span><span class="p">)</span>
    <span class="n">final_right</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">final_right</span><span class="p">)</span>
    <span class="n">final_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">)</span>

    <span class="c1"># Ensure valid box (x0&lt;=x1, top&lt;=bottom)</span>
    <span class="k">if</span> <span class="n">final_left</span> <span class="o">&gt;</span> <span class="n">final_right</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated left (</span><span class="si">{</span><span class="n">final_left</span><span class="si">}</span><span class="s2">) &gt; right (</span><span class="si">{</span><span class="n">final_right</span><span class="si">}</span><span class="s2">). Swapping.&quot;</span><span class="p">)</span>
        <span class="n">final_left</span><span class="p">,</span> <span class="n">final_right</span> <span class="o">=</span> <span class="n">final_right</span><span class="p">,</span> <span class="n">final_left</span>
    <span class="k">if</span> <span class="n">final_top</span> <span class="o">&gt;</span> <span class="n">final_bottom</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated top (</span><span class="si">{</span><span class="n">final_top</span><span class="si">}</span><span class="s2">) &gt; bottom (</span><span class="si">{</span><span class="n">final_bottom</span><span class="si">}</span><span class="s2">). Swapping.&quot;</span><span class="p">)</span>
        <span class="n">final_top</span><span class="p">,</span> <span class="n">final_bottom</span> <span class="o">=</span> <span class="n">final_bottom</span><span class="p">,</span> <span class="n">final_top</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

    <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">final_left</span><span class="p">,</span> <span class="n">final_top</span><span class="p">,</span> <span class="n">final_right</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">region</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.remove_text_layer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">remove_text_layer</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Remove all text elements from this page.</p>
<p>This removes all text elements (words and characters) from the page,
effectively clearing the text layer.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_text_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove all text elements from this page.</span>

<span class="sd">    This removes all text elements (words and characters) from the page,</span>
<span class="sd">    effectively clearing the text layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removing all text elements...&quot;</span><span class="p">)</span>

    <span class="c1"># Remove all words and chars from the element manager</span>
    <span class="n">removed_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
    <span class="n">removed_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>

    <span class="c1"># Clear the lists</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="s2">&quot;chars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_words</span><span class="si">}</span><span class="s2"> words and </span><span class="si">{</span><span class="n">removed_chars</span><span class="si">}</span><span class="s2"> characters&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.save_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">render_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">144</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Save the page image to a file, rendering highlights via HighlightingService.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the image to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional width for the output image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend.</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>render_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render OCR text.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_highlights</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render highlights.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for base image rendering (default: 144 DPI, equivalent to previous scale=2.0).</p>
              </div>
            </td>
            <td>
                  <code>144</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional args for pdfplumber's to_image.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Allow saving without highlights</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the page image to a file, rendering highlights via HighlightingService.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to save the image to.</span>
<span class="sd">        width: Optional width for the output image.</span>
<span class="sd">        labels: Whether to include a legend.</span>
<span class="sd">        legend_position: Position of the legend.</span>
<span class="sd">        render_ocr: Whether to render OCR text.</span>
<span class="sd">        include_highlights: Whether to render highlights.</span>
<span class="sd">        resolution: Resolution in DPI for base image rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">        **kwargs: Additional args for pdfplumber&#39;s to_image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use to_image to generate and save the image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.save_searchable" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">save_searchable</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Saves the PDF page with an OCR text layer, making content searchable.</p>
<p>Requires optional dependencies. Install with: pip install "natural-pdf[ocr-save]"</p>


<details class="note" open>
  <summary>OCR must have been applied to the pages beforehand</summary>
  <p>(e.g., pdf.apply_ocr()).</p>
</details>

<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the searchable PDF.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution for rendering and OCR overlay (default 300).</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to the exporter.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_searchable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Path&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the PDF page with an OCR text layer, making content searchable.</span>

<span class="sd">    Requires optional dependencies. Install with: pip install &quot;natural-pdf[ocr-save]&quot;</span>

<span class="sd">    Note: OCR must have been applied to the pages beforehand</span>
<span class="sd">          (e.g., pdf.apply_ocr()).</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path: Path to save the searchable PDF.</span>
<span class="sd">        dpi: Resolution for rendering and OCR overlay (default 300).</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to the exporter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import moved here, assuming it&#39;s always available now</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.exporters.searchable_pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_searchable_pdf</span>

    <span class="c1"># Convert pathlib.Path to string if necessary</span>
    <span class="n">output_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="n">create_searchable_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path_str</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searchable PDF saved to: </span><span class="si">{</span><span class="n">output_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.show" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">144</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">render_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generates and returns an image of the page with persistent highlights rendered.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</p>
              </div>
            </td>
            <td>
                  <code>144</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional width for the output image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend for labels.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend.</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>render_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render OCR text.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL Image object of the page with highlights, or None if rendering fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates and returns an image of the page with persistent highlights rendered.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">        width: Optional width for the output image.</span>
<span class="sd">        labels: Whether to include a legend for labels.</span>
<span class="sd">        legend_position: Position of the legend.</span>
<span class="sd">        render_ocr: Whether to render OCR text.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL Image object of the page with highlights, or None if rendering fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Ensure highlights are requested</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.show_preview" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">show_preview</span><span class="p">(</span><span class="n">temporary_highlights</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">144</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">render_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generates and returns a non-stateful preview image containing only
the provided temporary highlights.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>temporary_highlights</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of highlight data dictionaries (as prepared by
                  ElementCollection._prepare_highlight_data).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</p>
              </div>
            </td>
            <td>
                  <code>144</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional width for the output image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend.</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>render_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render OCR text.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL Image object of the preview, or None if rendering fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_preview</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">temporary_highlights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates and returns a non-stateful preview image containing only</span>
<span class="sd">    the provided temporary highlights.</span>

<span class="sd">    Args:</span>
<span class="sd">        temporary_highlights: List of highlight data dictionaries (as prepared by</span>
<span class="sd">                              ElementCollection._prepare_highlight_data).</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: 144 DPI, equivalent to previous scale=2.0).</span>
<span class="sd">        width: Optional width for the output image.</span>
<span class="sd">        labels: Whether to include a legend.</span>
<span class="sd">        legend_position: Position of the legend.</span>
<span class="sd">        render_ocr: Whether to render OCR text.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL Image object of the preview, or None if rendering fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Delegate rendering to the highlighter service&#39;s preview method</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">render_preview</span><span class="p">(</span>
            <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">temporary_highlights</span><span class="o">=</span><span class="n">temporary_highlights</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
            <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HighlightingService does not have the required &#39;render_preview&#39; method.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error calling highlighter.render_preview for page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Return the rendered image directly</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">divider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Divides the page into sections based on the provided divider elements.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">divider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divides the page into sections based on the provided divider elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">start_elements</span><span class="o">=</span><span class="n">divider</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.to_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">render_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generate a PIL image of the page, using HighlightingService if needed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to save the image to.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional width for the output image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend for highlights.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend.</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>render_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render OCR text on highlights.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for base page image. If None, uses global setting or defaults to 144 DPI.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_highlights</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to render highlights.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclusions</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accepts one of the following:
         None   no masking (default)
         "mask"  mask using solid white (back-compat)
         CSS/HTML colour string (e.g. "red", "#ff0000", "#ff000080")
         Tuple of RGB or RGBA values (ints 0-255 or floats 0-1)
        All excluded regions are filled with this colour.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for pdfplumber.to_image.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL Image of the page, or None if rendering fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">render_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New parameter</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a PIL image of the page, using HighlightingService if needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Optional path to save the image to.</span>
<span class="sd">        width: Optional width for the output image.</span>
<span class="sd">        labels: Whether to include a legend for highlights.</span>
<span class="sd">        legend_position: Position of the legend.</span>
<span class="sd">        render_ocr: Whether to render OCR text on highlights.</span>
<span class="sd">        resolution: Resolution in DPI for base page image. If None, uses global setting or defaults to 144 DPI.</span>
<span class="sd">        include_highlights: Whether to render highlights.</span>
<span class="sd">        exclusions: Accepts one of the following:</span>
<span class="sd">                     None   no masking (default)</span>
<span class="sd">                     &quot;mask&quot;  mask using solid white (back-compat)</span>
<span class="sd">                     CSS/HTML colour string (e.g. &quot;red&quot;, &quot;#ff0000&quot;, &quot;#ff000080&quot;)</span>
<span class="sd">                     Tuple of RGB or RGBA values (ints 0-255 or floats 0-1)</span>
<span class="sd">                    All excluded regions are filled with this colour.</span>
<span class="sd">        **kwargs: Additional parameters for pdfplumber.to_image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL Image of the page, or None if rendering fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults, but allow explicit parameters to override</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="c1"># Use global options if parameters are not explicitly set</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">width</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>
    <span class="c1"># 1. Create cache key (excluding path)</span>
    <span class="n">cache_key_parts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">width</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">,</span>
        <span class="n">render_ocr</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="p">,</span>
        <span class="n">exclusions</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># Convert kwargs to a stable, hashable representation</span>
    <span class="n">sorted_kwargs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># Convert lists to tuples</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># If list contains unhashable items, fall back to repr or skip</span>
                <span class="c1"># For simplicity, we&#39;ll try to proceed; hashing will fail if v remains unhashable</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cache key generation: List item in kwargs[&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;] could not be converted to tuple due to unhashable elements.&quot;</span>
                <span class="p">)</span>
        <span class="n">sorted_kwargs_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="n">cache_key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sorted_kwargs_list</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cache_key_parts</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Could not create cache key for to_image due to unhashable item: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding without cache for this call.&quot;</span>
        <span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Fallback to not using cache for this call</span>

    <span class="n">image_to_return</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 2. Check cache</span>
    <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">:</span>
        <span class="n">image_to_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Returning cached image for key: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># --- This is the original logic to generate the image ---</span>
        <span class="n">rendered_image_component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># Renamed from &#39;image&#39; in original</span>
        <span class="p">)</span>
        <span class="n">render_resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Attempting to acquire pdf_render_lock for to_image...&quot;</span>
        <span class="p">)</span>
        <span class="n">lock_wait_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Acquire the global PDF rendering lock</span>
            <span class="k">with</span> <span class="n">pdf_render_lock</span><span class="p">:</span>
                <span class="n">lock_acquired_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Acquired pdf_render_lock (waited </span><span class="si">{</span><span class="n">lock_acquired_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lock_wait_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s). Starting render...&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">include_highlights</span><span class="p">:</span>
                    <span class="c1"># Delegate rendering to the central service</span>
                    <span class="n">rendered_image_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlighter</span><span class="o">.</span><span class="n">render_page</span><span class="p">(</span>
                        <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">resolution</span><span class="o">=</span><span class="n">render_resolution</span><span class="p">,</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                        <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
                        <span class="n">render_ocr</span><span class="o">=</span><span class="n">render_ocr</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rendered_image_component</span> <span class="o">=</span> <span class="n">render_plain_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render_resolution</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># rendered_image_component remains None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">render_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">thread_id</span><span class="si">}</span><span class="s2">] Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Released pdf_render_lock. Total render time (incl. lock wait): </span><span class="si">{</span><span class="n">render_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lock_wait_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rendered_image_component</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Cache the failure</span>
            <span class="c1"># Save the image if path is provided (will try to save None, handled by PIL/OS)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rendered_image_component</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Should be None here</span>
                        <span class="n">rendered_image_component</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># This line won&#39;t be hit if None</span>
                    <span class="c1"># else: logger.debug(&quot;Not saving None image&quot;) # Not strictly needed</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save image to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- Apply exclusion masking if requested ---</span>
        <span class="c1"># This modifies &#39;rendered_image_component&#39;</span>
        <span class="n">image_after_masking</span> <span class="o">=</span> <span class="n">rendered_image_component</span>  <span class="c1"># Start with the rendered image</span>

        <span class="c1"># Determine if masking is requested and establish the fill colour</span>
        <span class="n">mask_requested</span> <span class="o">=</span> <span class="n">exclusions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span>
        <span class="n">mask_color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>  <span class="c1"># default</span>

        <span class="k">if</span> <span class="n">mask_requested</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exclusions</span> <span class="o">!=</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span>
                <span class="c1"># Attempt to parse custom colour input</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="c1"># Handle RGB/RGBA tuples with ints 0-255 or floats 0-1</span>
                        <span class="n">processed</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">all_float</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exclusions</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_float</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">val</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="c1"># add full alpha</span>
                        <span class="n">mask_color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># Try using the optional &#39;colour&#39; library for rich parsing</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">colour</span><span class="w"> </span><span class="kn">import</span> <span class="n">Color</span>  <span class="c1"># type: ignore</span>

                            <span class="n">color_obj</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>
                            <span class="n">mask_color</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">red</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">green</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">color_obj</span><span class="o">.</span><span class="n">blue</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                                <span class="mi">255</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># Fallback: if parsing fails, treat as plain string accepted by PIL</span>
                            <span class="n">mask_color</span> <span class="o">=</span> <span class="n">exclusions</span>  <span class="c1"># e.g. &quot;red&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unsupported exclusions colour spec: </span><span class="si">{</span><span class="n">exclusions</span><span class="si">!r}</span><span class="s2">. Using white.&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">colour_parse_err</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to parse exclusions colour </span><span class="si">{</span><span class="n">exclusions</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">colour_parse_err</span><span class="si">}</span><span class="s2">. Using white.&quot;</span>
                    <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Ensure image is mutable (RGB or RGBA)</span>
                <span class="k">if</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">):</span>
                    <span class="n">image_after_masking</span> <span class="o">=</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

                <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span>
                    <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">exclusion_regions</span><span class="p">:</span>
                    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image_after_masking</span><span class="p">)</span>
                    <span class="c1"># Scaling factor for converting PDF pts  image px</span>
                    <span class="n">img_scale</span> <span class="o">=</span> <span class="n">render_resolution</span> <span class="o">/</span> <span class="mf">72.0</span>

                    <span class="c1"># Determine fill colour compatible with current mode</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">_mode_compatible</span><span class="p">(</span><span class="n">colour</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">image_after_masking</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">colour</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># drop alpha for RGB images</span>
                        <span class="k">return</span> <span class="n">colour</span>

                    <span class="n">fill_colour</span> <span class="o">=</span> <span class="n">_mode_compatible</span><span class="p">(</span><span class="n">mask_color</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">exclusion_regions</span><span class="p">:</span>
                        <span class="n">img_x0</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">x0</span> <span class="o">*</span> <span class="n">img_scale</span>
                        <span class="n">img_top</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">top</span> <span class="o">*</span> <span class="n">img_scale</span>
                        <span class="n">img_x1</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">x1</span> <span class="o">*</span> <span class="n">img_scale</span>
                        <span class="n">img_bottom</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">bottom</span> <span class="o">*</span> <span class="n">img_scale</span>

                        <span class="n">img_coords</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_x0</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img_top</span><span class="p">),</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">image_after_masking</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">img_x1</span><span class="p">),</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">image_after_masking</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">img_bottom</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_coords</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill_colour</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Skipping invalid exclusion rect for masking: </span><span class="si">{</span><span class="n">img_coords</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">del</span> <span class="n">draw</span>  <span class="c1"># Release drawing context</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">mask_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error applying exclusion mask to page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mask_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Continue with potentially unmasked or partially masked image</span>

        <span class="c1"># --- Resize the final image if width is provided ---</span>
        <span class="n">image_final_content</span> <span class="o">=</span> <span class="n">image_after_masking</span>  <span class="c1"># Start with image after masking</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">width</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">image_final_content</span> <span class="o">=</span> <span class="n">image_final_content</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">resize_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not resize image: </span><span class="si">{</span><span class="n">resize_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># image_final_content remains the un-resized version if resize fails</span>

        <span class="c1"># Store in cache</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_image_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_final_content</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">: Cached image for key: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_to_return</span> <span class="o">=</span> <span class="n">image_final_content</span>
    <span class="c1"># --- End of cache miss block ---</span>

    <span class="c1"># Save the image (either from cache or newly generated) if path is provided</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">image_to_return</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure directory exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># Only call makedirs if there&#39;s a directory part</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">image_to_return</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved page image to: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save image to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.until" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Select content from the top of the page until matching selector.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_endpoint</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include the endpoint element in the region</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional selection parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object representing the selected content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;Conclusion&quot;)&#39;</span><span class="p">)</span>  <span class="c1"># Select from top to conclusion</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="s1">&#39;line[width&gt;=2]&#39;</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Select up to thick line</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select content from the top of the page until matching selector.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string</span>
<span class="sd">        include_endpoint: Whether to include the endpoint element in the region</span>
<span class="sd">        **kwargs: Additional selection parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object representing the selected content</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; page.until(&#39;text:contains(&quot;Conclusion&quot;)&#39;)  # Select from top to conclusion</span>
<span class="sd">        &gt;&gt;&gt; page.until(&#39;line[width&gt;=2]&#39;, include_endpoint=False)  # Select up to thick line</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the target element</span>
    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="c1"># If target not found, return a default region (full page)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

    <span class="c1"># Create a region from the top of the page to the target</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="n">Region</span>

    <span class="c1"># Ensure target has positional attributes before using them</span>
    <span class="n">target_top</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">target_bottom</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_endpoint</span><span class="p">:</span>
        <span class="c1"># Include the target element</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">target_bottom</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Up to the target element</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">target_top</span><span class="p">))</span>

    <span class="n">region</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">target</span>
    <span class="k">return</span> <span class="n">region</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Page.viewer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">viewer</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Creates and returns an interactive ipywidget for exploring elements on this page.</p>
<p>Uses InteractiveViewerWidget.from_page() to create the viewer.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.widgets.viewer.InteractiveViewerWidget">InteractiveViewerWidget</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A InteractiveViewerWidget instance ready for display in Jupyter,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.widgets.viewer.InteractiveViewerWidget">InteractiveViewerWidget</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>or None if ipywidgets is not installed or widget creation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code># Optional</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Could raise ImportError instead of returning None</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code># ImportError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required dependencies (ipywidgets) are missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If image rendering or data preparation fails within from_page.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/core/page.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">viewer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="c1"># elements_to_render: Optional[List[&#39;Element&#39;]] = None, # No longer needed, from_page handles it</span>
    <span class="c1"># include_source_types: List[str] = [&#39;word&#39;, &#39;line&#39;, &#39;rect&#39;, &#39;region&#39;] # No longer needed</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;InteractiveViewerWidget&quot;</span><span class="p">]:</span>  <span class="c1"># Return type hint updated</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and returns an interactive ipywidget for exploring elements on this page.</span>

<span class="sd">    Uses InteractiveViewerWidget.from_page() to create the viewer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A InteractiveViewerWidget instance ready for display in Jupyter,</span>
<span class="sd">        or None if ipywidgets is not installed or widget creation fails.</span>

<span class="sd">    Raises:</span>
<span class="sd">        # Optional: Could raise ImportError instead of returning None</span>
<span class="sd">        # ImportError: If required dependencies (ipywidgets) are missing.</span>
<span class="sd">        ValueError: If image rendering or data preparation fails within from_page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for availability using the imported flag and class variable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_IPYWIDGETS_AVAILABLE</span> <span class="ow">or</span> <span class="n">InteractiveViewerWidget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Interactive viewer requires &#39;ipywidgets&#39;. &quot;</span>
            <span class="s1">&#39;Please install with: pip install &quot;ipywidgets&gt;=7.0.0,&lt;10.0.0&quot;&#39;</span>
        <span class="p">)</span>
        <span class="c1"># raise ImportError(&quot;ipywidgets not found.&quot;) # Option 1: Raise error</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Option 2: Return None gracefully</span>

    <span class="c1"># If we reach here, InteractiveViewerWidget should be the actual class</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Pass self (the Page object) to the factory method</span>
        <span class="k">return</span> <span class="n">InteractiveViewerWidget</span><span class="o">.</span><span class="n">from_page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch potential errors during widget creation (e.g., image rendering)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error creating viewer widget from page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># raise # Option 1: Re-raise error (might include ValueError from from_page)</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Option 2: Return None on creation error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="natural_pdf.Region" class="doc doc-heading">
            <code>natural_pdf.Region</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="natural_pdf.elements.base.DirectionalMixin">DirectionalMixin</span></code>, <code><span title="natural_pdf.classification.mixin.ClassificationMixin">ClassificationMixin</span></code>, <code><span title="natural_pdf.extraction.mixin.ExtractionMixin">ExtractionMixin</span></code>, <code><span title="natural_pdf.analyzers.shape_detection_mixin.ShapeDetectionMixin">ShapeDetectionMixin</span></code>, <code><span title="natural_pdf.describe.mixin.DescribeMixin">DescribeMixin</span></code></p>


        <p>Represents a rectangular region on a page.</p>
<p>Regions are fundamental building blocks in natural-pdf that define rectangular
areas of a page for analysis, extraction, and navigation. They can be created
manually or automatically through spatial navigation methods like .below(), .above(),
.left(), and .right() from elements or other regions.</p>
<p>Regions integrate multiple analysis capabilities through mixins and provide:
- Element filtering and collection within the region boundary
- OCR processing for the region area
- Table detection and extraction
- AI-powered classification and structured data extraction
- Visual rendering and debugging capabilities
- Text extraction with spatial awareness</p>
<p>The Region class supports both rectangular and polygonal boundaries, making it
suitable for complex document layouts and irregular shapes detected by layout
analysis algorithms.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.page

  
      property
   (natural_pdf.Region.page)" href="#natural_pdf.Region.page">page</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference to the parent Page object.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.bbox

  
      property
   (natural_pdf.Region.bbox)" href="#natural_pdf.Region.bbox">bbox</a></code></td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box tuple (x0, top, x1, bottom) in PDF coordinates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.x0

  
      property
   (natural_pdf.Region.x0)" href="#natural_pdf.Region.x0">x0</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Left x-coordinate.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.top

  
      property
   (natural_pdf.Region.top)" href="#natural_pdf.Region.top">top</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Top y-coordinate (minimum y).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.x1

  
      property
   (natural_pdf.Region.x1)" href="#natural_pdf.Region.x1">x1</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Right x-coordinate.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.bottom

  
      property
   (natural_pdf.Region.bottom)" href="#natural_pdf.Region.bottom">bottom</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bottom y-coordinate (maximum y).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.width

  
      property
   (natural_pdf.Region.width)" href="#natural_pdf.Region.width">width</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region width (x1 - x0).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.height

  
      property
   (natural_pdf.Region.height)" href="#natural_pdf.Region.height">height</a></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region height (bottom - top).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="natural_pdf.Region.polygon

  
      property
   (natural_pdf.Region.polygon)" href="#natural_pdf.Region.polygon">polygon</a></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of coordinate points for non-rectangular regions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.Region.label">label</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional descriptive label for the region.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="natural_pdf.Region.metadata">metadata</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary for storing analysis results and custom data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Creating regions:
<div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Manual region creation</span>
<span class="n">header_region</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Spatial navigation from elements</span>
<span class="n">summary_text</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text:contains(&quot;Summary&quot;)&#39;</span><span class="p">)</span>
<span class="n">content_region</span> <span class="o">=</span> <span class="n">summary_text</span><span class="o">.</span><span class="n">below</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="s1">&#39;text[size&gt;12]:bold&#39;</span><span class="p">)</span>

<span class="c1"># Extract content from region</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">content_region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">()</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">content_region</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
</code></pre></div></p>
<p>Advanced usage:
<div class="highlight"><pre><span></span><code><span class="c1"># OCR processing</span>
<span class="n">region</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;easyocr&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># AI-powered extraction</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">extract_structured_data</span><span class="p">(</span><span class="n">MySchema</span><span class="p">)</span>

<span class="c1"># Visual debugging</span>
<span class="n">region</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">highlights</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">])</span>
</code></pre></div></p>
</details>






              <details class="quote">
                <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Region</span><span class="p">(</span>
    <span class="n">DirectionalMixin</span><span class="p">,</span> <span class="n">ClassificationMixin</span><span class="p">,</span> <span class="n">ExtractionMixin</span><span class="p">,</span> <span class="n">ShapeDetectionMixin</span><span class="p">,</span> <span class="n">DescribeMixin</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a rectangular region on a page.</span>

<span class="sd">    Regions are fundamental building blocks in natural-pdf that define rectangular</span>
<span class="sd">    areas of a page for analysis, extraction, and navigation. They can be created</span>
<span class="sd">    manually or automatically through spatial navigation methods like .below(), .above(),</span>
<span class="sd">    .left(), and .right() from elements or other regions.</span>

<span class="sd">    Regions integrate multiple analysis capabilities through mixins and provide:</span>
<span class="sd">    - Element filtering and collection within the region boundary</span>
<span class="sd">    - OCR processing for the region area</span>
<span class="sd">    - Table detection and extraction</span>
<span class="sd">    - AI-powered classification and structured data extraction</span>
<span class="sd">    - Visual rendering and debugging capabilities</span>
<span class="sd">    - Text extraction with spatial awareness</span>

<span class="sd">    The Region class supports both rectangular and polygonal boundaries, making it</span>
<span class="sd">    suitable for complex document layouts and irregular shapes detected by layout</span>
<span class="sd">    analysis algorithms.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        page: Reference to the parent Page object.</span>
<span class="sd">        bbox: Bounding box tuple (x0, top, x1, bottom) in PDF coordinates.</span>
<span class="sd">        x0: Left x-coordinate.</span>
<span class="sd">        top: Top y-coordinate (minimum y).</span>
<span class="sd">        x1: Right x-coordinate.</span>
<span class="sd">        bottom: Bottom y-coordinate (maximum y).</span>
<span class="sd">        width: Region width (x1 - x0).</span>
<span class="sd">        height: Region height (bottom - top).</span>
<span class="sd">        polygon: List of coordinate points for non-rectangular regions.</span>
<span class="sd">        label: Optional descriptive label for the region.</span>
<span class="sd">        metadata: Dictionary for storing analysis results and custom data.</span>

<span class="sd">    Example:</span>
<span class="sd">        Creating regions:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        page = pdf.pages[0]</span>

<span class="sd">        # Manual region creation</span>
<span class="sd">        header_region = page.region(0, 0, page.width, 100)</span>

<span class="sd">        # Spatial navigation from elements</span>
<span class="sd">        summary_text = page.find(&#39;text:contains(&quot;Summary&quot;)&#39;)</span>
<span class="sd">        content_region = summary_text.below(until=&#39;text[size&gt;12]:bold&#39;)</span>

<span class="sd">        # Extract content from region</span>
<span class="sd">        tables = content_region.extract_table()</span>
<span class="sd">        text = content_region.get_text()</span>
<span class="sd">        ```</span>

<span class="sd">        Advanced usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        # OCR processing</span>
<span class="sd">        region.apply_ocr(engine=&#39;easyocr&#39;, resolution=300)</span>

<span class="sd">        # AI-powered extraction</span>
<span class="sd">        data = region.extract_structured_data(MySchema)</span>

<span class="sd">        # Visual debugging</span>
<span class="sd">        region.show(highlights=[&#39;tables&#39;, &#39;text&#39;])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">page</span><span class="p">:</span> <span class="s2">&quot;Page&quot;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a region.</span>

<span class="sd">        Creates a Region object that represents a rectangular or polygonal area on a page.</span>
<span class="sd">        Regions are used for spatial navigation, content extraction, and analysis operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            page: Parent Page object that contains this region and provides access</span>
<span class="sd">                to document elements and analysis capabilities.</span>
<span class="sd">            bbox: Bounding box coordinates as (x0, top, x1, bottom) tuple in PDF</span>
<span class="sd">                coordinate system (points, with origin at bottom-left).</span>
<span class="sd">            polygon: Optional list of coordinate points [(x1,y1), (x2,y2), ...] for</span>
<span class="sd">                non-rectangular regions. If provided, the region will use polygon-based</span>
<span class="sd">                intersection calculations instead of simple rectangle overlap.</span>
<span class="sd">            parent: Optional parent region for hierarchical document structure.</span>
<span class="sd">                Useful for maintaining tree-like relationships between regions.</span>
<span class="sd">            label: Optional descriptive label for the region, useful for debugging</span>
<span class="sd">                and identification in complex workflows.</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">            page = pdf.pages[0]</span>

<span class="sd">            # Rectangular region</span>
<span class="sd">            header = Region(page, (0, 0, page.width, 100), label=&quot;header&quot;)</span>

<span class="sd">            # Polygonal region (from layout detection)</span>
<span class="sd">            table_polygon = [(50, 100), (300, 100), (300, 400), (50, 400)]</span>
<span class="sd">            table_region = Region(page, (50, 100, 300, 400),</span>
<span class="sd">                                polygon=table_polygon, label=&quot;table&quot;)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            Regions are typically created through page methods like page.region() or</span>
<span class="sd">            spatial navigation methods like element.below(). Direct instantiation is</span>
<span class="sd">            used mainly for advanced workflows or layout analysis integration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page</span> <span class="o">=</span> <span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="o">=</span> <span class="n">polygon</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Analysis results live under self.metadata[&#39;analysis&#39;] via property</span>

        <span class="c1"># Standard attributes for all elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>  <span class="c1"># For selector compatibility</span>

        <span class="c1"># Layout detection attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Region management attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set by creation methods</span>

        <span class="c1"># Hierarchy support for nested document structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_content</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Direct text content (e.g., from Docling)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_text_elements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Native text elements that overlap with this region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_direction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cross_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Region-specific wrapper around :py:meth:`DirectionalMixin._direction`.</span>

<span class="sd">        It performs any pre-processing required by *Region* (none currently),</span>
<span class="sd">        delegates the core geometry work to the mix-in implementation via</span>
<span class="sd">        ``super()``, then attaches region-level metadata before returning the</span>
<span class="sd">        new :class:`Region` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Delegate to the shared implementation on DirectionalMixin</span>
        <span class="n">region</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
            <span class="n">cross_size</span><span class="o">=</span><span class="n">cross_size</span><span class="p">,</span>
            <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
            <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
            <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Post-process: make sure callers can trace lineage and flags</span>
        <span class="n">region</span><span class="o">.</span><span class="n">source_element</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">region</span><span class="o">.</span><span class="n">includes_source</span> <span class="o">=</span> <span class="n">include_source</span>

        <span class="k">return</span> <span class="n">region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">above</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select region above this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            height: Height of the region above, in points</span>
<span class="sd">            width: Width mode - &quot;full&quot; for full page width or &quot;element&quot; for element width</span>
<span class="sd">            include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">            until: Optional selector string to specify an upper boundary element</span>
<span class="sd">            include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">            **kwargs: Additional parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object representing the area above</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;above&quot;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">cross_size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
            <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
            <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">below</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select region below this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            height: Height of the region below, in points</span>
<span class="sd">            width: Width mode - &quot;full&quot; for full page width or &quot;element&quot; for element width</span>
<span class="sd">            include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">            until: Optional selector string to specify a lower boundary element</span>
<span class="sd">            include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">            **kwargs: Additional parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object representing the area below</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;below&quot;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">cross_size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
            <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
            <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select region to the left of this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            width: Width of the region to the left, in points</span>
<span class="sd">            height: Height mode - &quot;full&quot; for full page height or &quot;element&quot; for element height</span>
<span class="sd">            include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">            until: Optional selector string to specify a left boundary element</span>
<span class="sd">            include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">            **kwargs: Additional parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object representing the area to the left</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">cross_size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
            <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
            <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select region to the right of this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            width: Width of the region to the right, in points</span>
<span class="sd">            height: Height mode - &quot;full&quot; for full page height or &quot;element&quot; for element height</span>
<span class="sd">            include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">            until: Optional selector string to specify a right boundary element</span>
<span class="sd">            include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">            **kwargs: Additional parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region object representing the area to the right</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">cross_size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
            <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
            <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Element type.&quot;&quot;&quot;</span>
        <span class="c1"># Return the specific type if detected (e.g., from layout analysis)</span>
        <span class="c1"># or &#39;region&#39; as a default.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="ow">or</span> <span class="s2">&quot;region&quot;</span>  <span class="c1"># Prioritize specific region_type if set</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Page&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the parent page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the bounding box as (x0, top, x1, bottom).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the left coordinate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">top</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the top coordinate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the right coordinate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the bottom coordinate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the width of the region.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the height of the region.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this region has polygon coordinates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get polygon coordinates if available, otherwise return rectangle corners.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create rectangle corners from bbox as fallback</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-left</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-right</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-right</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-left</span>
            <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_point_in_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a point is inside the polygon using ray casting algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X coordinate of the point</span>
<span class="sd">            y: Y coordinate of the point</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the point is inside the polygon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

        <span class="c1"># Ray casting algorithm</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">x</span>
                <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">return</span> <span class="n">inside</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_point_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a point is inside this region using ray casting algorithm for polygons.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X coordinate of the point</span>
<span class="sd">            y: Y coordinate of the point</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the point is inside the region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

        <span class="c1"># Ray casting algorithm</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">x</span>
                <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">return</span> <span class="n">inside</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_element_center_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the center point of an element&#39;s bounding box is inside this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            element: Element to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the element&#39;s center point is inside the region, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if element is on the same page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Ensure element has necessary attributes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element </span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> lacks bounding box attributes. Cannot check center point.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

        <span class="c1"># Calculate center point</span>
        <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Use the existing is_point_inside check</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_element_in_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">,</span> <span class="n">use_boundary_tolerance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if an element intersects or is contained within this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            element: Element to check</span>
<span class="sd">            use_boundary_tolerance: Whether to apply a small tolerance for boundary elements</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the element is in the region, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if element is on the same page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_element_center_inside</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c1"># return self.intersects(element)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this region completely contains an element.</span>

<span class="sd">        Args:</span>
<span class="sd">            element: Element to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the element is completely contained within the region, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if element is on the same page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Ensure element has necessary attributes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

        <span class="c1"># For rectangular regions, check if element&#39;s bbox is fully inside region&#39;s bbox</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
            <span class="p">)</span>

        <span class="c1"># For polygon regions, check if all corners of the element are inside the polygon</span>
        <span class="n">element_corners</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-left</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-right</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-right</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-left</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">element_corners</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this region intersects with an element (any overlap).</span>

<span class="sd">        Args:</span>
<span class="sd">            element: Element to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the element overlaps with the region at all, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if element is on the same page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Ensure element has necessary attributes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

        <span class="c1"># For rectangular regions, check for bbox overlap</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
            <span class="p">)</span>

        <span class="c1"># For polygon regions, check if any corner of the element is inside the polygon</span>
        <span class="n">element_corners</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-left</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-right</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-right</span>
            <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-left</span>
        <span class="p">]</span>

        <span class="c1"># First check if any element corner is inside the polygon</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">element_corners</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Also check if any polygon corner is inside the element&#39;s rectangle</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Also check if any polygon edge intersects with any rectangle edge</span>
        <span class="c1"># This is a simplification - for complex cases, we&#39;d need a full polygon-rectangle</span>
        <span class="c1"># intersection algorithm</span>

        <span class="c1"># For now, return True if bounding boxes overlap (approximation for polygon-rectangle case)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Highlight this region on the page.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: Optional label for the highlight</span>
<span class="sd">            color: Color tuple/string for the highlight, or None to use automatic color</span>
<span class="sd">            use_color_cycling: Force color cycling even with no label (default: False)</span>
<span class="sd">            include_attrs: List of attribute names to display on the highlight (e.g., [&#39;confidence&#39;, &#39;type&#39;])</span>
<span class="sd">            existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access the highlighter service correctly</span>
        <span class="n">highlighter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_highlighter</span>

        <span class="c1"># Prepare common arguments</span>
        <span class="n">highlight_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;page_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s2">&quot;use_color_cycling&quot;</span><span class="p">:</span> <span class="n">use_color_cycling</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>  <span class="c1"># Pass the region itself so attributes can be accessed</span>
            <span class="s2">&quot;include_attrs&quot;</span><span class="p">:</span> <span class="n">include_attrs</span><span class="p">,</span>
            <span class="s2">&quot;existing&quot;</span><span class="p">:</span> <span class="n">existing</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Call the appropriate service method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
            <span class="n">highlight_args</span><span class="p">[</span><span class="s2">&quot;polygon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span>
            <span class="n">highlighter</span><span class="o">.</span><span class="n">add_polygon</span><span class="p">(</span><span class="o">**</span><span class="n">highlight_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">highlight_args</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>
            <span class="n">highlighter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">**</span><span class="n">highlight_args</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Image.Image&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an image of just this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">            crop: If True, only crop the region without highlighting its boundaries</span>
<span class="sd">            include_highlights: Whether to include existing highlights (default: True)</span>
<span class="sd">            **kwargs: Additional parameters for page.to_image()</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image of just this region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

        <span class="c1"># Handle the case where user wants the cropped region to have a specific width</span>
        <span class="n">page_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">effective_resolution</span> <span class="o">=</span> <span class="n">resolution</span>  <span class="c1"># Start with the provided resolution</span>

        <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="s2">&quot;width&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">target_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
            <span class="c1"># Calculate what resolution is needed to make the region crop have target_width</span>
            <span class="n">region_width_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>  <span class="c1"># Region width in PDF points</span>

            <span class="k">if</span> <span class="n">region_width_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Calculate scale needed: target_width / region_width_points</span>
                <span class="n">required_scale</span> <span class="o">=</span> <span class="n">target_width</span> <span class="o">/</span> <span class="n">region_width_points</span>
                <span class="c1"># Convert scale to resolution: scale * 72 DPI</span>
                <span class="n">effective_resolution</span> <span class="o">=</span> <span class="n">required_scale</span> <span class="o">*</span> <span class="mf">72.0</span>
                <span class="n">page_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>  <span class="c1"># Remove width parameter to avoid conflicts</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Calculated required resolution </span><span class="si">{</span><span class="n">effective_resolution</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> DPI for region crop width </span><span class="si">{</span><span class="n">target_width</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Invalid region width </span><span class="si">{</span><span class="n">region_width_points</span><span class="si">}</span><span class="s2">, using original resolution&quot;</span>
                <span class="p">)</span>

        <span class="c1"># First get the full page image with highlights if requested</span>
        <span class="n">page_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">effective_resolution</span><span class="p">,</span>
            <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
            <span class="o">**</span><span class="n">page_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the actual scale factor used by the page image</span>
        <span class="k">if</span> <span class="n">page_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">page_image</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to resolution-based calculation if dimensions are invalid</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mf">72.0</span>

        <span class="c1"># Apply scaling to the coordinates</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>

        <span class="c1"># Ensure coords are valid for cropping (left &lt; right, top &lt; bottom)</span>
        <span class="k">if</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">x1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> resulted in non-positive width after scaling (</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">). Cannot create image.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">top</span> <span class="o">&gt;=</span> <span class="n">bottom</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> resulted in non-positive height after scaling (</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">bottom</span><span class="si">}</span><span class="s2">). Cannot create image.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Crop the image to just this region</span>
        <span class="n">region_image</span> <span class="o">=</span> <span class="n">page_image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>

        <span class="c1"># If not crop, add a border to highlight the region boundaries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crop</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageDraw</span>

            <span class="c1"># Create a 1px border around the region</span>
            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">region_image</span><span class="p">)</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">region_image</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="c1"># Add a default color for standalone show</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add width parameter</span>
        <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># NEW: Crop output to region bounds before legend</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Image.Image&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the page with just this region highlighted temporarily.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">            labels: Whether to include a legend for labels</span>
<span class="sd">            legend_position: Position of the legend</span>
<span class="sd">            color: Color to highlight this region (default: blue)</span>
<span class="sd">            label: Optional label for this region in the legend</span>
<span class="sd">            width: Optional width for the output image in pixels</span>
<span class="sd">            crop: If True, crop the rendered image to this region&#39;s</span>
<span class="sd">                        bounding box (with a small margin handled inside</span>
<span class="sd">                        HighlightingService) before legends/overlays are added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image of the page with only this region highlighted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region must be associated with a page to show.&quot;</span><span class="p">)</span>

        <span class="c1"># Use the highlighting service via the page&#39;s property</span>
        <span class="n">service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_highlighter</span>

        <span class="c1"># Determine the label if not provided</span>
        <span class="n">display_label</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">label</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Region (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="k">else</span> <span class="s2">&quot;Region&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Prepare temporary highlight data for just this region</span>
        <span class="n">temp_highlight_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;page_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span>
            <span class="s2">&quot;polygon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>  <span class="c1"># Use provided or default color</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">display_label</span><span class="p">,</span>
            <span class="s2">&quot;use_color_cycling&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Explicitly false for single preview</span>
        <span class="p">}</span>

        <span class="c1"># Determine crop bbox if requested</span>
        <span class="n">crop_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="k">if</span> <span class="n">crop</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Use render_preview to show only this highlight</span>
        <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">render_preview</span><span class="p">(</span>
            <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">temporary_highlights</span><span class="o">=</span><span class="p">[</span><span class="n">temp_highlight_data</span><span class="p">],</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>  <span class="c1"># Pass the width parameter</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
            <span class="n">crop_bbox</span><span class="o">=</span><span class="n">crop_bbox</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the page with this region highlighted to an image file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to save the image to</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">            labels: Whether to include a legend for labels</span>
<span class="sd">            legend_position: Position of the legend</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

        <span class="c1"># Highlight this region if not already highlighted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">()</span>

        <span class="c1"># Save the highlighted image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save an image of just this region to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to save the image to</span>
<span class="sd">            resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">            crop: If True, only crop the region without highlighting its boundaries</span>
<span class="sd">            include_highlights: Whether to include existing highlights (default: True)</span>
<span class="sd">            **kwargs: Additional parameters for page.to_image()</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

        <span class="c1"># Get the region image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">crop</span><span class="o">=</span><span class="n">crop</span><span class="p">,</span>
            <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save the image</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_shrink</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim visual whitespace from the edges of this region.</span>

<span class="sd">        Similar to Python&#39;s string .strip() method, but for visual whitespace in the region image.</span>
<span class="sd">        Uses pixel analysis to detect rows/columns that are predominantly whitespace.</span>

<span class="sd">        Args:</span>
<span class="sd">            padding: Number of pixels to keep as padding after trimming (default: 1)</span>
<span class="sd">            threshold: Threshold for considering a row/column as whitespace (0.0-1.0, default: 0.95)</span>
<span class="sd">                      Higher values mean more strict whitespace detection.</span>
<span class="sd">                      E.g., 0.95 means if 95% of pixels in a row/column are white, consider it whitespace.</span>
<span class="sd">            resolution: Resolution for image rendering in DPI (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">            pre_shrink: Amount to shrink region before trimming, then expand back after (default: 0.5)</span>
<span class="sd">                       This helps avoid detecting box borders/slivers as content.</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>

<span class="sd">        New Region with visual whitespace trimmed from all edges</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        ```python</span>
<span class="sd">        # Basic trimming with 1 pixel padding and 0.5px pre-shrink</span>
<span class="sd">        trimmed = region.trim()</span>

<span class="sd">        # More aggressive trimming with no padding and no pre-shrink</span>
<span class="sd">        tight = region.trim(padding=0, threshold=0.9, pre_shrink=0)</span>

<span class="sd">        # Conservative trimming with more padding</span>
<span class="sd">        loose = region.trim(padding=3, threshold=0.98)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply global options as defaults</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

        <span class="c1"># Pre-shrink the region to avoid box slivers</span>
        <span class="n">work_region</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">left</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">right</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">top</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pre_shrink</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="bp">self</span>
        <span class="p">)</span>

        <span class="c1"># Get the region image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">work_region</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Could not generate image for trimming. Returning original region.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Convert to grayscale for easier analysis</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

        <span class="c1"># Convert PIL image to numpy array</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">))</span>  <span class="c1"># Convert to grayscale</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Image has zero dimensions. Returning original region.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Normalize pixel values to 0-1 range (255 = white = 1.0, 0 = black = 0.0)</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="c1"># Find content boundaries by analyzing row and column averages</span>

        <span class="c1"># Analyze rows (horizontal strips) to find top and bottom boundaries</span>
        <span class="n">row_averages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average each row</span>
        <span class="n">content_rows</span> <span class="o">=</span> <span class="n">row_averages</span> <span class="o">&lt;</span> <span class="n">threshold</span>  <span class="c1"># True where there&#39;s content (not whitespace)</span>

        <span class="c1"># Find first and last rows with content</span>
        <span class="n">content_row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">content_rows</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_row_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No content found, return a minimal region at the center</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No content detected during trimming. Returning center point.&quot;</span>
            <span class="p">)</span>
            <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">))</span>

        <span class="n">top_content_row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content_row_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">)</span>
        <span class="n">bottom_content_row</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content_row_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>

        <span class="c1"># Analyze columns (vertical strips) to find left and right boundaries</span>
        <span class="n">col_averages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Average each column</span>
        <span class="n">content_cols</span> <span class="o">=</span> <span class="n">col_averages</span> <span class="o">&lt;</span> <span class="n">threshold</span>  <span class="c1"># True where there&#39;s content</span>

        <span class="n">content_col_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">content_cols</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_col_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No content found in columns either</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No column content detected during trimming. Returning center point.&quot;</span>
            <span class="p">)</span>
            <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">))</span>

        <span class="n">left_content_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content_col_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">)</span>
        <span class="n">right_content_col</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content_col_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>

        <span class="c1"># Convert trimmed pixel coordinates back to PDF coordinates</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mf">72.0</span>  <span class="c1"># Scale factor used in to_image()</span>

        <span class="c1"># Calculate new PDF coordinates and ensure they are Python floats</span>
        <span class="n">trimmed_x0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">left_content_col</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">))</span>
        <span class="n">trimmed_top</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">top_content_row</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">))</span>
        <span class="n">trimmed_x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">work_region</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">((</span><span class="n">right_content_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># +1 because we want inclusive right edge</span>
        <span class="n">trimmed_bottom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">work_region</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">((</span><span class="n">bottom_content_row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># +1 because we want inclusive bottom edge</span>

        <span class="c1"># Ensure the trimmed region doesn&#39;t exceed the work region boundaries</span>
        <span class="n">final_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">trimmed_x0</span><span class="p">)</span>
        <span class="n">final_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">trimmed_top</span><span class="p">)</span>
        <span class="n">final_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">trimmed_x1</span><span class="p">)</span>
        <span class="n">final_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">trimmed_bottom</span><span class="p">)</span>

        <span class="c1"># Ensure valid coordinates (width &gt; 0, height &gt; 0)</span>
        <span class="k">if</span> <span class="n">final_x1</span> <span class="o">&lt;=</span> <span class="n">final_x0</span> <span class="ow">or</span> <span class="n">final_bottom</span> <span class="o">&lt;=</span> <span class="n">final_top</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trimming resulted in invalid dimensions. Returning original region.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Create the trimmed region</span>
        <span class="n">trimmed_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">final_x0</span><span class="p">,</span> <span class="n">final_top</span><span class="p">,</span> <span class="n">final_x1</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">))</span>

        <span class="c1"># Expand back by the pre_shrink amount to restore original positioning</span>
        <span class="k">if</span> <span class="n">pre_shrink</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trimmed_region</span> <span class="o">=</span> <span class="n">trimmed_region</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="n">left</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">pre_shrink</span>
            <span class="p">)</span>

        <span class="c1"># Copy relevant metadata</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;trimmed&quot;</span>  <span class="c1"># Indicate this is a derived region</span>
        <span class="n">trimmed_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trimmed to </span><span class="si">{</span><span class="n">trimmed_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> (padding=</span><span class="si">{</span><span class="n">padding</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">, pre_shrink=</span><span class="si">{</span><span class="n">pre_shrink</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">trimmed_region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">top</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bottom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clip this region to specific bounds, either from another object with bbox or explicit coordinates.</span>

<span class="sd">        The clipped region will be constrained to not exceed the specified boundaries.</span>
<span class="sd">        You can provide either an object with bounding box properties, specific coordinates, or both.</span>
<span class="sd">        When both are provided, explicit coordinates take precedence.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: Optional object with bbox properties (Region, Element, TextElement, etc.)</span>
<span class="sd">            left: Optional left boundary (x0) to clip to</span>
<span class="sd">            top: Optional top boundary to clip to</span>
<span class="sd">            right: Optional right boundary (x1) to clip to</span>
<span class="sd">            bottom: Optional bottom boundary to clip to</span>

<span class="sd">        Returns:</span>
<span class="sd">            New Region with bounds clipped to the specified constraints</span>

<span class="sd">        Examples:</span>
<span class="sd">            # Clip to another region&#39;s bounds</span>
<span class="sd">            clipped = region.clip(container_region)</span>

<span class="sd">            # Clip to any element&#39;s bounds</span>
<span class="sd">            clipped = region.clip(text_element)</span>

<span class="sd">            # Clip to specific coordinates</span>
<span class="sd">            clipped = region.clip(left=100, right=400)</span>

<span class="sd">            # Mix object bounds with specific overrides</span>
<span class="sd">            clipped = region.clip(obj=container, bottom=page.height/2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_bbox</span>

        <span class="c1"># Start with current region bounds</span>
        <span class="n">clip_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
        <span class="n">clip_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
        <span class="n">clip_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
        <span class="n">clip_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>

        <span class="c1"># Apply object constraints if provided</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj_bbox</span> <span class="o">=</span> <span class="n">extract_bbox</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj_bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obj_x0</span><span class="p">,</span> <span class="n">obj_top</span><span class="p">,</span> <span class="n">obj_x1</span><span class="p">,</span> <span class="n">obj_bottom</span> <span class="o">=</span> <span class="n">obj_bbox</span>
                <span class="c1"># Constrain to the intersection with the provided object</span>
                <span class="n">clip_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">obj_x0</span><span class="p">)</span>
                <span class="n">clip_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_top</span><span class="p">,</span> <span class="n">obj_top</span><span class="p">)</span>
                <span class="n">clip_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_x1</span><span class="p">,</span> <span class="n">obj_x1</span><span class="p">)</span>
                <span class="n">clip_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_bottom</span><span class="p">,</span> <span class="n">obj_bottom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Cannot extract bbox from clipping object </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Object must have bbox property or x0/top/x1/bottom attributes.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Apply explicit coordinate constraints (these take precedence)</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clip_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clip_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_top</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clip_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_x1</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clip_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">)</span>

        <span class="c1"># Ensure valid coordinates</span>
        <span class="k">if</span> <span class="n">clip_x1</span> <span class="o">&lt;=</span> <span class="n">clip_x0</span> <span class="ow">or</span> <span class="n">clip_bottom</span> <span class="o">&lt;=</span> <span class="n">clip_top</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Clipping resulted in invalid dimensions &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">clip_x0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_top</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_x1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_bottom</span><span class="si">}</span><span class="s2">). Returning minimal region.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Return a minimal region at the clip area&#39;s top-left</span>
            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">,</span> <span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">))</span>

        <span class="c1"># Create the clipped region</span>
        <span class="n">clipped_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">,</span> <span class="n">clip_x1</span><span class="p">,</span> <span class="n">clip_bottom</span><span class="p">))</span>

        <span class="c1"># Copy relevant metadata</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;clipped&quot;</span>  <span class="c1"># Indicate this is a derived region</span>
        <span class="n">clipped_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Clipped to </span><span class="si">{</span><span class="n">clipped_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(constraints: obj=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;left=</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">, top=</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s2">, right=</span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">, bottom=</span><span class="si">{</span><span class="n">bottom</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">clipped_region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_elements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all elements within this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: Optional selector to filter elements</span>
<span class="sd">            apply_exclusions: Whether to apply exclusion regions</span>
<span class="sd">            **kwargs: Additional parameters for element filtering</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of elements in the region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
            <span class="c1"># Find elements on the page matching the selector</span>
            <span class="n">page_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                <span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="c1"># Filter those elements to only include ones within this region</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">page_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element_in_region</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get all elements from the page</span>
            <span class="n">page_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">get_elements</span><span class="p">(</span><span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">)</span>
            <span class="c1"># Filter to elements in this region</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">page_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element_in_region</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract text from this region, respecting page exclusions and using pdfplumber&#39;s</span>
<span class="sd">        layout engine (chars_to_textmap).</span>

<span class="sd">        Args:</span>
<span class="sd">            apply_exclusions: Whether to apply exclusion regions defined on the parent page.</span>
<span class="sd">            debug: Enable verbose debugging output for filtering steps.</span>
<span class="sd">            **kwargs: Additional layout parameters passed directly to pdfplumber&#39;s</span>
<span class="sd">                      `chars_to_textmap` function (e.g., layout, x_density, y_density).</span>
<span class="sd">                      See Page.extract_text docstring for more.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Extracted text as string, potentially with layout-based spacing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Allow &#39;debug_exclusions&#39; for backward compatibility</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">debug</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_exclusions&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: extract_text called with kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Get Word Elements potentially within this region (initial broad phase)</span>
        <span class="c1"># Optimization: Could use spatial query if page elements were indexed</span>
        <span class="n">page_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">words</span>  <span class="c1"># Get all words from the page</span>

        <span class="c1"># 2. Gather all character dicts from words potentially in region</span>
        <span class="c1"># We filter precisely in filter_chars_spatially</span>
        <span class="n">all_char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">page_words</span><span class="p">:</span>
            <span class="c1"># Quick bbox check to avoid processing words clearly outside</span>
            <span class="k">if</span> <span class="n">get_bbox_overlap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="n">word</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_char_dicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;_char_dicts&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_char_dicts</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No character dicts found overlapping region bbox.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># 3. Get Relevant Exclusions (overlapping this region)</span>
        <span class="n">apply_exclusions_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apply_exclusions&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">)</span>
        <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">apply_exclusions_flag</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
            <span class="n">all_page_exclusions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span>
                <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
            <span class="p">)</span>
            <span class="n">overlapping_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">excl</span> <span class="ow">in</span> <span class="n">all_page_exclusions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_bbox_overlap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="n">excl</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">overlapping_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>
            <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="n">overlapping_exclusions</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Applying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclusion_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> overlapping exclusions.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Not applying exclusions.&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Spatially Filter Characters using Utility</span>
        <span class="c1"># Pass self as the target_region for precise polygon checks etc.</span>
        <span class="n">filtered_chars</span> <span class="o">=</span> <span class="n">filter_chars_spatially</span><span class="p">(</span>
            <span class="n">char_dicts</span><span class="o">=</span><span class="n">all_char_dicts</span><span class="p">,</span>
            <span class="n">exclusion_regions</span><span class="o">=</span><span class="n">exclusion_regions</span><span class="p">,</span>
            <span class="n">target_region</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># Pass self!</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 5. Generate Text Layout using Utility</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">generate_text_layout</span><span class="p">(</span>
            <span class="n">char_dicts</span><span class="o">=</span><span class="n">filtered_chars</span><span class="p">,</span>
            <span class="n">layout_context_bbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span>  <span class="c1"># Use region&#39;s bbox for context</span>
            <span class="n">user_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># Pass original kwargs to layout generator</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: extract_text finished, result length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Make method optional</span>
        <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use Optional</span>
        <span class="n">use_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ocr_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use Optional</span>
        <span class="n">text_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cell_extraction_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># --- NEW: Add tqdm control option --- #</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Controls progress bar for text method</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableResult</span><span class="p">:</span>  <span class="c1"># Return type allows Optional[str] for cells</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a table from this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: Method to use: &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                    &#39;stream&#39; is an alias for &#39;pdfplumber&#39; with text-based strategies (equivalent to</span>
<span class="sd">                    setting `vertical_strategy` and `horizontal_strategy` to &#39;text&#39;).</span>
<span class="sd">                    &#39;lattice&#39; is an alias for &#39;pdfplumber&#39; with line-based strategies (equivalent to</span>
<span class="sd">                    setting `vertical_strategy` and `horizontal_strategy` to &#39;lines&#39;).</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction (used with &#39;pdfplumber&#39;, &#39;stream&#39;, or &#39;lattice&#39; methods).</span>
<span class="sd">            use_ocr: Whether to use OCR for text extraction (currently only applicable with &#39;tatr&#39; method).</span>
<span class="sd">            ocr_config: OCR configuration parameters.</span>
<span class="sd">            text_options: Dictionary of options for the &#39;text&#39; method, corresponding to arguments</span>
<span class="sd">                          of analyze_text_table_structure (e.g., snap_tolerance, expand_bbox).</span>
<span class="sd">            cell_extraction_func: Optional callable function that takes a cell Region object</span>
<span class="sd">                                  and returns its string content. Overrides default text extraction</span>
<span class="sd">                                  for the &#39;text&#39; method.</span>
<span class="sd">            show_progress: If True, display a progress bar during cell text extraction for the &#39;text&#39; method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Table data as a list of rows, where each row is a list of cell values (str or None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default settings if none provided</span>
        <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">text_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_options</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Initialize empty dict</span>

        <span class="c1"># Auto-detect method if not specified</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If this is a TATR-detected region, use TATR method</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;tatr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;tatr&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try lattice first, then fall back to stream if no meaningful results</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Auto-detecting table extraction method...&quot;</span><span class="p">)</span>

                <span class="c1"># --- NEW: Prefer already-created table_cell regions if they exist --- #</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cell_regions_in_table</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">c</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                            <span class="s2">&quot;region[type=table_cell]&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_cells_err</span><span class="p">:</span>
                    <span class="n">cell_regions_in_table</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Fallback silently</span>

                <span class="k">if</span> <span class="n">cell_regions_in_table</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_regions_in_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> pre-computed table_cell regions  using &#39;cells&#39; method.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">TableResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_from_cells</span><span class="p">(</span><span class="n">cell_regions_in_table</span><span class="p">))</span>

                <span class="c1"># --------------------------------------------------------------- #</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first...&quot;</span><span class="p">)</span>
                    <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span>
                        <span class="s2">&quot;lattice&quot;</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="p">)</span>

                    <span class="c1"># Check if lattice found meaningful content</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">lattice_result</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                            <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">lattice_result</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful content&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Fall back to stream</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># Handle method aliases for pdfplumber</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="c1"># Set default text strategies if not already provided by the user</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
            <span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="c1"># Set default line strategies if not already provided by the user</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

        <span class="c1"># -------------------------------------------------------------</span>
        <span class="c1"># Auto-inject tolerances when text-based strategies are requested.</span>
        <span class="c1"># This must happen AFTER alias handling (so strategies are final)</span>
        <span class="c1"># and BEFORE we delegate to _extract_table_* helpers.</span>
        <span class="c1"># -------------------------------------------------------------</span>
        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">page_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># Ensure text_* tolerances passed to pdfplumber</span>
            <span class="k">if</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_cfg</span><span class="p">[</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_cfg</span><span class="p">[</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">]</span>

            <span class="c1"># Snap / join tolerances (~ line spacing)</span>
            <span class="k">if</span> <span class="s2">&quot;snap_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;snap_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="n">snap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">))</span>
                <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snap</span>
            <span class="k">if</span> <span class="s2">&quot;join_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;join_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;join_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Extracting table using method &#39;</span><span class="si">{</span><span class="n">effective_method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Use the selected method</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;tatr&quot;</span><span class="p">:</span>
            <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_tatr</span><span class="p">(</span><span class="n">use_ocr</span><span class="o">=</span><span class="n">use_ocr</span><span class="p">,</span> <span class="n">ocr_config</span><span class="o">=</span><span class="n">ocr_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="n">current_text_options</span> <span class="o">=</span> <span class="n">text_options</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">current_text_options</span><span class="p">[</span><span class="s2">&quot;cell_extraction_func&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_extraction_func</span>
            <span class="n">current_text_options</span><span class="p">[</span><span class="s2">&quot;show_progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_progress</span>
            <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_text</span><span class="p">(</span><span class="o">**</span><span class="n">current_text_options</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
            <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_plumber</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown table extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">TableResult</span><span class="p">(</span><span class="n">table_rows</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all tables from this region using pdfplumber-based methods.</span>

<span class="sd">        Note: Only &#39;pdfplumber&#39;, &#39;stream&#39;, and &#39;lattice&#39; methods are supported for extract_tables.</span>
<span class="sd">        &#39;tatr&#39; and &#39;text&#39; methods are designed for single table extraction only.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: Method to use: &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                    &#39;stream&#39; uses text-based strategies, &#39;lattice&#39; uses line-based strategies.</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tables, where each table is a list of rows, and each row is a list of cell values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Auto-detect method if not specified (try lattice first, then stream)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Auto-detecting tables extraction method...&quot;</span><span class="p">)</span>

            <span class="c1"># Try lattice first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lattice_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
                <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first for tables...&quot;</span><span class="p">)</span>
                <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">lattice_settings</span><span class="p">)</span>

                <span class="c1"># Check if lattice found meaningful tables</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">lattice_result</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span>
                            <span class="k">if</span> <span class="n">table</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">lattice_result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful tables&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Fall back to stream</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method for tables...&quot;</span><span class="p">)</span>
            <span class="n">stream_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">stream_settings</span><span class="p">)</span>

        <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># Handle method aliases</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
            <span class="p">)</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

        <span class="c1"># Use the selected method</span>
        <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown tables extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tables_plumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all tables using pdfplumber&#39;s table extraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tables, where each table is a list of rows, and each row is a list of cell values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inject global PDF-level text tolerances if not explicitly present</span>
        <span class="n">pdf_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">_uses_text</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">x_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">,</span> <span class="n">x_tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">y_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">,</span> <span class="n">y_tol</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;snap_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;snap_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">))</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="n">snap</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;join_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;join_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">join</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_x_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;join_y_tolerance&quot;</span><span class="p">,</span> <span class="n">join</span><span class="p">)</span>

        <span class="c1"># Create a crop of the page for this region</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>

        <span class="c1"># Extract all tables from the cropped area</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="n">cropped</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>

        <span class="c1"># Return the tables or an empty list if none found</span>
        <span class="k">return</span> <span class="n">tables</span> <span class="k">if</span> <span class="n">tables</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_table_plumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract table using pdfplumber&#39;s table extraction.</span>
<span class="sd">        This method extracts the largest table within the region.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_settings: Settings for pdfplumber table extraction</span>

<span class="sd">        Returns:</span>
<span class="sd">            Table data as a list of rows, where each row is a list of cell values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inject global PDF-level text tolerances if not explicitly present</span>
        <span class="n">pdf_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">_uses_text</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
            <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">x_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">,</span> <span class="n">x_tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_uses_text</span>
            <span class="ow">and</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
            <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span>
        <span class="p">):</span>
            <span class="n">y_tol</span> <span class="o">=</span> <span class="n">pdf_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">,</span> <span class="n">y_tol</span><span class="p">)</span>

        <span class="c1"># Create a crop of the page for this region</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>

        <span class="c1"># Extract the single largest table from the cropped area</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">cropped</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>

        <span class="c1"># Return the table or an empty list if none found</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">table</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_table_tatr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ocr_config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract table using TATR structure detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_ocr: Whether to apply OCR to each cell for better text extraction</span>
<span class="sd">            ocr_config: Optional OCR configuration parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Table data as a list of rows, where each row is a list of cell values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find all rows and headers in this table</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;region[type=table-row][model=tatr]&quot;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;region[type=table-column-header][model=tatr]&quot;</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;region[type=table-column][model=tatr]&quot;</span><span class="p">)</span>

        <span class="c1"># Filter to only include rows/headers/columns that overlap with this table region</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">is_in_table</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
            <span class="c1"># Check for overlap - simplifying to center point for now</span>
            <span class="n">region_center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">region</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">region_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">region</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">region_center_x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">region_center_y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
            <span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">row</span><span class="p">)]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">header</span><span class="p">)]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">column</span><span class="p">)]</span>

        <span class="c1"># Sort rows by vertical position (top to bottom)</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>

        <span class="c1"># Sort columns by horizontal position (left to right)</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

        <span class="c1"># Create table data structure</span>
        <span class="n">table_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Prepare OCR config if needed</span>
        <span class="k">if</span> <span class="n">use_ocr</span><span class="p">:</span>
            <span class="c1"># Default OCR config focuses on small text with low confidence</span>
            <span class="n">default_ocr_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Lower than default to catch more text</span>
                <span class="s2">&quot;detection_params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;text_threshold&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Lower threshold for low-contrast text</span>
                    <span class="s2">&quot;link_threshold&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Lower threshold for connecting text components</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Merge with provided config if any</span>
            <span class="k">if</span> <span class="n">ocr_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ocr_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Update default config with provided values</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ocr_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_ocr_config</span>
                            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_ocr_config</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="c1"># Merge nested dicts</span>
                            <span class="n">default_ocr_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Replace value</span>
                            <span class="n">default_ocr_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Not a dict, use as is</span>
                    <span class="n">default_ocr_config</span> <span class="o">=</span> <span class="n">ocr_config</span>

            <span class="c1"># Use the merged config</span>
            <span class="n">ocr_config</span> <span class="o">=</span> <span class="n">default_ocr_config</span>

        <span class="c1"># Add header row if headers were detected</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">header_texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_ocr</span><span class="p">:</span>
                    <span class="c1"># Try OCR for better text extraction</span>
                    <span class="n">ocr_elements</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">ocr_config</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ocr_elements</span><span class="p">:</span>
                        <span class="n">ocr_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ocr_elements</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">ocr_text</span><span class="p">:</span>
                            <span class="n">header_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span>
                            <span class="k">continue</span>

                <span class="c1"># Fallback to normal extraction</span>
                <span class="n">header_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">table_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_texts</span><span class="p">)</span>

        <span class="c1"># Process rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">row_cells</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># If we have columns, use them to extract cells</span>
            <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># Create a cell region at the intersection of row and column</span>
                    <span class="n">cell_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

                    <span class="c1"># Create a region for this cell</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.region</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># Import here to avoid circular imports</span>
                        <span class="n">Region</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">cell_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="n">cell_bbox</span><span class="p">)</span>

                    <span class="c1"># Extract text from the cell</span>
                    <span class="k">if</span> <span class="n">use_ocr</span><span class="p">:</span>
                        <span class="c1"># Apply OCR to the cell</span>
                        <span class="n">ocr_elements</span> <span class="o">=</span> <span class="n">cell_region</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">ocr_config</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ocr_elements</span><span class="p">:</span>
                            <span class="c1"># Get text from OCR elements</span>
                            <span class="n">ocr_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ocr_elements</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">ocr_text</span><span class="p">:</span>
                                <span class="n">row_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span>
                                <span class="k">continue</span>

                    <span class="c1"># Fallback to normal extraction</span>
                    <span class="n">cell_text</span> <span class="o">=</span> <span class="n">cell_region</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">row_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No column information, just extract the whole row text</span>
                <span class="k">if</span> <span class="n">use_ocr</span><span class="p">:</span>
                    <span class="c1"># Try OCR on the whole row</span>
                    <span class="n">ocr_elements</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">ocr_config</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ocr_elements</span><span class="p">:</span>
                        <span class="n">ocr_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ocr_elements</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">ocr_text</span><span class="p">:</span>
                            <span class="n">row_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span>
                            <span class="k">continue</span>

                <span class="c1"># Fallback to normal extraction</span>
                <span class="n">row_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">table_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_cells</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_table_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">text_options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts table content based on text alignment analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            **text_options: Options passed to analyze_text_table_structure,</span>
<span class="sd">                          plus optional &#39;cell_extraction_func&#39;, &#39;coordinate_grouping_tolerance&#39;,</span>
<span class="sd">                          and &#39;show_progress&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Table data as list of lists of strings (or None for empty cells).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_extraction_func</span> <span class="o">=</span> <span class="n">text_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cell_extraction_func&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># --- Get show_progress option --- #</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="n">text_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;show_progress&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Analyze structure first (or use cached results)</span>
        <span class="k">if</span> <span class="s2">&quot;text_table_structure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
            <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="s2">&quot;text_table_structure&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached text table structure analysis results.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_text_table_structure</span><span class="p">(</span><span class="o">**</span><span class="n">text_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">analysis_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysis_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No cells found using &#39;text&#39; method.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">cell_dicts</span> <span class="o">=</span> <span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>

        <span class="c1"># --- Grid Reconstruction Logic --- #</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_dicts</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 1. Get unique sorted top and left coordinates (cell boundaries)</span>
        <span class="n">coord_tolerance</span> <span class="o">=</span> <span class="n">text_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coordinate_grouping_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tops</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">coord_tolerance</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_tolerance</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_dicts</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">lefts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">coord_tolerance</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_tolerance</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_dicts</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Refine boundaries (cluster_coords helper remains the same)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cluster_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coords</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">clustered</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">current_cluster</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">coord_tolerance</span><span class="p">:</span>
                    <span class="n">current_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clustered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">current_cluster</span><span class="p">))</span>
                    <span class="n">current_cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">clustered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">current_cluster</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">clustered</span>

        <span class="n">unique_tops</span> <span class="o">=</span> <span class="n">cluster_coords</span><span class="p">(</span><span class="n">tops</span><span class="p">)</span>
        <span class="n">unique_lefts</span> <span class="o">=</span> <span class="n">cluster_coords</span><span class="p">(</span><span class="n">lefts</span><span class="p">)</span>

        <span class="c1"># Determine iterable for tqdm</span>
        <span class="n">cell_iterator</span> <span class="o">=</span> <span class="n">cell_dicts</span>
        <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
            <span class="c1"># Only wrap if progress should be shown</span>
            <span class="n">cell_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">cell_dicts</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Extracting text from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_dicts</span><span class="p">)</span><span class="si">}</span><span class="s2"> cells (text method)&quot;</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Optional: Keep bar after completion</span>
            <span class="p">)</span>
        <span class="c1"># --- End tqdm Setup --- #</span>

        <span class="c1"># 2. Create a lookup map for cell text: {(rounded_top, rounded_left): cell_text}</span>
        <span class="n">cell_text_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># --- Use the potentially wrapped iterator --- #</span>
        <span class="k">for</span> <span class="n">cell_data</span> <span class="ow">in</span> <span class="n">cell_iterator</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cell_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="o">**</span><span class="n">cell_data</span><span class="p">)</span>
                <span class="n">cell_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">cell_extraction_func</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cell_value</span> <span class="o">=</span> <span class="n">cell_extraction_func</span><span class="p">(</span><span class="n">cell_region</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Custom cell_extraction_func returned non-string/None type (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span><span class="si">}</span><span class="s2">) for cell </span><span class="si">{</span><span class="n">cell_data</span><span class="si">}</span><span class="s2">. Treating as None.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">cell_value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">func_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error executing custom cell_extraction_func for cell </span><span class="si">{</span><span class="n">cell_data</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">func_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">cell_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cell_value</span> <span class="o">=</span> <span class="n">cell_region</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span>
                        <span class="n">layout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="n">rounded_top</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">coord_tolerance</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_tolerance</span>
                <span class="n">rounded_left</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">coord_tolerance</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_tolerance</span>
                <span class="n">cell_text_map</span><span class="p">[(</span><span class="n">rounded_top</span><span class="p">,</span> <span class="n">rounded_left</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cell_value</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not process cell </span><span class="si">{</span><span class="n">cell_data</span><span class="si">}</span><span class="s2"> for text extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Build the final list-of-lists table (loop remains the same)</span>
        <span class="n">final_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_top</span> <span class="ow">in</span> <span class="n">unique_tops</span><span class="p">:</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col_left</span> <span class="ow">in</span> <span class="n">unique_lefts</span><span class="p">:</span>
                <span class="n">best_match_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">min_dist_sq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">map_top</span><span class="p">,</span> <span class="n">map_left</span> <span class="ow">in</span> <span class="n">cell_text_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">abs</span><span class="p">(</span><span class="n">map_top</span> <span class="o">-</span> <span class="n">row_top</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">coord_tolerance</span>
                        <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">map_left</span> <span class="o">-</span> <span class="n">col_left</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">coord_tolerance</span>
                    <span class="p">):</span>
                        <span class="n">dist_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_top</span> <span class="o">-</span> <span class="n">row_top</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">map_left</span> <span class="o">-</span> <span class="n">col_left</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="k">if</span> <span class="n">dist_sq</span> <span class="o">&lt;</span> <span class="n">min_dist_sq</span><span class="p">:</span>
                            <span class="n">min_dist_sq</span> <span class="o">=</span> <span class="n">dist_sq</span>
                            <span class="n">best_match_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_top</span><span class="p">,</span> <span class="n">map_left</span><span class="p">)</span>
                <span class="n">cell_value</span> <span class="o">=</span> <span class="n">cell_text_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">best_match_key</span><span class="p">)</span>
                <span class="n">row_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
            <span class="n">final_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_table</span>

    <span class="c1"># --- END MODIFIED METHOD --- #</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># New parameter for containment behavior</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the first element in this region matching the selector OR text content.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            contains: How to determine if elements are inside: &#39;all&#39; (fully inside),</span>
<span class="sd">                     &#39;any&#39; (any overlap), or &#39;center&#39; (center point inside).</span>
<span class="sd">                     (default: &quot;all&quot;)</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional parameters for element filtering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            First matching element or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Delegate validation and selector construction to find_all</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">contains</span><span class="o">=</span><span class="n">contains</span><span class="p">,</span>
            <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
            <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">first</span> <span class="k">if</span> <span class="n">elements</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
        <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># New parameter to control inside/overlap behavior</span>
        <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all elements in this region matching the selector OR text content.</span>

<span class="sd">        Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: CSS-like selector string.</span>
<span class="sd">            text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">            contains: How to determine if elements are inside: &#39;all&#39; (fully inside),</span>
<span class="sd">                     &#39;any&#39; (any overlap), or &#39;center&#39; (center point inside).</span>
<span class="sd">                     (default: &quot;all&quot;)</span>
<span class="sd">            apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">            regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">            case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">            **kwargs: Additional parameters for element filtering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ElementCollection with matching elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate contains parameter</span>
        <span class="k">if</span> <span class="n">contains</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid contains value: </span><span class="si">{</span><span class="n">contains</span><span class="si">}</span><span class="s2">. Must be &#39;all&#39;, &#39;any&#39;, or &#39;center&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

        <span class="c1"># Normal case: Region is on a single page</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Parse the final selector string</span>
            <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

            <span class="c1"># Get all potentially relevant elements from the page</span>
            <span class="c1"># Let the page handle its exclusion logic if needed</span>
            <span class="n">potential_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>
                <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
                <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Filter these elements based on the specified containment method</span>
            <span class="n">region_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>
            <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>  <span class="c1"># Fully inside (strict)</span>
                <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">el</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">top</span> <span class="o">&gt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">x1</span> <span class="o">&lt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>  <span class="c1"># Any overlap</span>
                <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">el</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>  <span class="c1"># Center point inside</span>
                <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_element_center_inside</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">matching_elements</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during find_all in region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ocr_params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply OCR to this region and return the created text elements.</span>

<span class="sd">        This method supports two modes:</span>
<span class="sd">        1. **Built-in OCR Engines** (default)  identical to previous behaviour. Pass typical</span>
<span class="sd">           parameters like ``engine=&#39;easyocr&#39;`` or ``languages=[&#39;en&#39;]`` and the method will</span>
<span class="sd">           route the request through :class:`OCRManager`.</span>
<span class="sd">        2. **Custom OCR Function**  pass a *callable* under the keyword ``function`` (or</span>
<span class="sd">           ``ocr_function``). The callable will receive *this* Region instance and should</span>
<span class="sd">           return the extracted text (``str``) or ``None``.  Internally the call is</span>
<span class="sd">           delegated to :pymeth:`apply_custom_ocr` so the same logic (replacement, element</span>
<span class="sd">           creation, etc.) is re-used.</span>

<span class="sd">        Examples</span>
<span class="sd">        ---------</span>
<span class="sd">        ```python</span>
<span class="sd">        def llm_ocr(region):</span>
<span class="sd">            image = region.to_image(resolution=300, crop=True)</span>
<span class="sd">            return my_llm_client.ocr(image)</span>
<span class="sd">        region.apply_ocr(function=llm_ocr)</span>
<span class="sd">        ```</span>

<span class="sd">        Args:</span>
<span class="sd">            replace: Whether to remove existing OCR elements first (default ``True``).</span>
<span class="sd">            **ocr_params: Parameters for the built-in OCR manager *or* the special</span>
<span class="sd">                          ``function``/``ocr_function`` keyword to trigger custom mode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Self  for chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- Custom OCR function path --------------------------------------------------</span>
        <span class="n">custom_func</span> <span class="o">=</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ocr_function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">custom_func</span><span class="p">):</span>
            <span class="c1"># Delegate to the specialised helper while preserving key kwargs</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_custom_ocr</span><span class="p">(</span>
                <span class="n">ocr_function</span><span class="o">=</span><span class="n">custom_func</span><span class="p">,</span>
                <span class="n">source_label</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;source_label&quot;</span><span class="p">,</span> <span class="s2">&quot;custom-ocr&quot;</span><span class="p">),</span>
                <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">add_to_page</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_to_page&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># --- Original built-in OCR engine path (unchanged except docstring) ------------</span>
        <span class="c1"># Ensure OCRManager is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_ocr_manager&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OCRManager not available on parent PDF. Cannot apply OCR to region.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># If replace is True, find and remove existing OCR elements in this region</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying new OCR.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># --- Robust removal: iterate through all OCR elements on the page and</span>
            <span class="c1">#     remove those that overlap this region. This avoids reliance on</span>
            <span class="c1">#     identitybased look-ups that can break if the ElementManager</span>
            <span class="c1">#     rebuilt its internal lists.</span>

            <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Helper to remove a single element safely</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_safe_remove</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">removed_count</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                    <span class="n">etype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;words&quot;</span>
                    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;chars&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="n">etype</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">etype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">etype</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">etype_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">removed_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Remove OCR WORD elements overlapping region</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
                    <span class="n">_safe_remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

            <span class="c1"># Remove OCR CHAR dicts overlapping region</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">):</span>
                <span class="c1"># char can be dict or TextElement; normalise</span>
                <span class="n">char_src</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">char_src</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span><span class="p">:</span>
                    <span class="c1"># Rough bbox for dicts</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="c1"># Quick overlap check</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">cx1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">or</span> <span class="n">cx0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">or</span> <span class="n">cbottom</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">or</span> <span class="n">ctop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="p">):</span>
                        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> existing OCR elements (words &amp; chars) before re-applying OCR.&quot;</span>
            <span class="p">)</span>

        <span class="n">ocr_mgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_ocr_manager</span>

        <span class="c1"># Determine rendering resolution from parameters</span>
        <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">final_resolution</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_parent&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
            <span class="n">final_resolution</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">final_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_resolution</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Applying OCR with resolution </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI and params: </span><span class="si">{</span><span class="n">ocr_params</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Render the page region to an image using the determined resolution</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">region_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">final_resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">region_image</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to render region to image for OCR.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region rendered to image size: </span><span class="si">{</span><span class="n">region_image</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering region to image for OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Prepare args for the OCR Manager</span>
        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">region_image</span><span class="p">,</span>
            <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;engine&quot;</span><span class="p">),</span>
            <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;languages&quot;</span><span class="p">),</span>
            <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_confidence&quot;</span><span class="p">),</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">),</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">),</span>
            <span class="s2">&quot;detect_only&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;detect_only&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># Run OCR on this region&#39;s image using the manager</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">ocr_mgr</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;OCRManager returned unexpected type for single region image: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region OCR processing returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert results to TextElements</span>
        <span class="n">scale_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region OCR scaling factors (PDF/Img): x=</span><span class="si">{</span><span class="n">scale_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">scale_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">created_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img_x0</span><span class="p">,</span> <span class="n">img_top</span><span class="p">,</span> <span class="n">img_x1</span><span class="p">,</span> <span class="n">img_bottom</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>
                <span class="n">pdf_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_bottom</span> <span class="o">-</span> <span class="n">img_top</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_y</span>
                <span class="n">page_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_x0</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">)</span>
                <span class="n">page_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_top</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">)</span>
                <span class="n">page_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_x1</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">)</span>
                <span class="n">page_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_bottom</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">)</span>
                <span class="n">raw_conf</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span>
                <span class="c1"># Convert confidence to float unless it is None/invalid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">confidence_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_conf</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">confidence_val</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">text_val</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>  <span class="c1"># May legitimately be None in detect_only mode</span>

                <span class="n">element_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_val</span><span class="p">,</span>
                    <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">page_x0</span><span class="p">,</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="n">page_top</span><span class="p">,</span>
                    <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">page_x1</span><span class="p">,</span>
                    <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">page_bottom</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">page_x1</span> <span class="o">-</span> <span class="n">page_x0</span><span class="p">,</span>
                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">page_bottom</span> <span class="o">-</span> <span class="n">page_top</span><span class="p">,</span>
                    <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ocr&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence_val</span><span class="p">,</span>
                    <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="s2">&quot;OCR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pdf_height</span><span class="p">)</span> <span class="k">if</span> <span class="n">pdf_height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">10.0</span><span class="p">,</span>
                    <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                    <span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;italic&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;doctop&quot;</span><span class="p">:</span> <span class="n">page_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">initial_doctop</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ocr_char_dict</span> <span class="o">=</span> <span class="n">element_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">ocr_char_dict</span><span class="p">[</span><span class="s2">&quot;object_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;char&quot;</span>
                <span class="n">ocr_char_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;adv&quot;</span><span class="p">,</span> <span class="n">ocr_char_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">element_data</span><span class="p">[</span><span class="s2">&quot;_char_dicts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ocr_char_dict</span><span class="p">]</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextElement</span>

                <span class="n">elem</span> <span class="o">=</span> <span class="n">TextElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>
                <span class="n">created_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;words&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">ocr_char_dict</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;chars&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to convert region OCR result to element: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements from OCR.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_custom_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ocr_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">source_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;custom-ocr&quot;</span><span class="p">,</span>
        <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_to_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a custom OCR function to this region and create text elements from the results.</span>

<span class="sd">        This is useful when you want to use a custom OCR method (e.g., an LLM API,</span>
<span class="sd">        specialized OCR service, or any custom logic) instead of the built-in OCR engines.</span>

<span class="sd">        Args:</span>
<span class="sd">            ocr_function: A callable that takes a Region and returns the OCR&#39;d text (or None).</span>
<span class="sd">                          The function receives this region as its argument and should return</span>
<span class="sd">                          the extracted text as a string, or None if no text was found.</span>
<span class="sd">            source_label: Label to identify the source of these text elements (default: &quot;custom-ocr&quot;).</span>
<span class="sd">                          This will be set as the &#39;source&#39; attribute on created elements.</span>
<span class="sd">            replace: If True (default), removes existing OCR elements in this region before</span>
<span class="sd">                     adding new ones. If False, adds new OCR elements alongside existing ones.</span>
<span class="sd">            confidence: Optional confidence score for the OCR result (0.0-1.0).</span>
<span class="sd">                        If None, defaults to 1.0 if text is returned, 0.0 if None is returned.</span>
<span class="sd">            add_to_page: If True (default), adds the created text element to the page.</span>
<span class="sd">                         If False, creates the element but doesn&#39;t add it to the page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Using with an LLM</span>
<span class="sd">            def ocr_with_llm(region):</span>
<span class="sd">                image = region.to_image(resolution=300, crop=True)</span>
<span class="sd">                # Call your LLM API here</span>
<span class="sd">                return llm_client.ocr(image)</span>

<span class="sd">            region.apply_custom_ocr(ocr_with_llm)</span>

<span class="sd">            # Using with a custom OCR service</span>
<span class="sd">            def ocr_with_service(region):</span>
<span class="sd">                img_bytes = region.to_image(crop=True).tobytes()</span>
<span class="sd">                response = ocr_service.process(img_bytes)</span>
<span class="sd">                return response.text</span>

<span class="sd">            region.apply_custom_ocr(ocr_with_service, source_label=&quot;my-ocr-service&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If replace is True, remove existing OCR elements in this region</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying custom OCR.&quot;</span>
            <span class="p">)</span>

            <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Helper to remove a single element safely</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_safe_remove</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">removed_count</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                    <span class="n">etype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;words&quot;</span>
                    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;chars&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">etype_key</span> <span class="o">=</span> <span class="n">etype</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">etype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">etype</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">etype_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">removed_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Remove ALL OCR elements overlapping this region</span>
            <span class="c1"># Remove elements with source==&quot;ocr&quot; (built-in OCR) or matching the source_label (previous custom OCR)</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
                <span class="n">word_source</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># Match built-in OCR behavior: remove elements with source &quot;ocr&quot; exactly</span>
                <span class="c1"># Also remove elements with the same source_label to avoid duplicates</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">word_source</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">or</span> <span class="n">word_source</span> <span class="o">==</span> <span class="n">source_label</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
                    <span class="n">_safe_remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

            <span class="c1"># Also remove char dicts if needed (matching built-in OCR)</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">):</span>
                <span class="c1"># char can be dict or TextElement; normalize</span>
                <span class="n">char_src</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">char_src</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">or</span> <span class="n">char_src</span> <span class="o">==</span> <span class="n">source_label</span><span class="p">:</span>
                    <span class="c1"># Rough bbox for dicts</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="c1"># Quick overlap check</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">cx1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">or</span> <span class="n">cx0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">or</span> <span class="n">cbottom</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">or</span> <span class="n">ctop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
                    <span class="p">):</span>
                        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">removed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> existing OCR elements.&quot;</span><span class="p">)</span>

        <span class="c1"># Call the custom OCR function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Calling custom OCR function...&quot;</span><span class="p">)</span>
            <span class="n">ocr_text</span> <span class="o">=</span> <span class="n">ocr_function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ocr_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Custom OCR function returned non-string type (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span><span class="si">}</span><span class="s2">). &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Converting to string.&quot;</span>
                <span class="p">)</span>
                <span class="n">ocr_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error calling custom OCR function for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Create text element if we got text</span>
        <span class="k">if</span> <span class="n">ocr_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use the to_text_element method to create the element</span>
            <span class="n">text_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_text_element</span><span class="p">(</span>
                <span class="n">text_content</span><span class="o">=</span><span class="n">ocr_text</span><span class="p">,</span>
                <span class="n">source_label</span><span class="o">=</span><span class="n">source_label</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
                <span class="n">add_to_page</span><span class="o">=</span><span class="n">add_to_page</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Created text element with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; and added to page&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">add_to_page</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Custom OCR function returned None (no text found)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_section_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a section between two elements within this region.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_element: Element marking the start of the section</span>
<span class="sd">            end_element: Element marking the end of the section</span>
<span class="sd">            boundary_inclusion: How to include boundary elements: &#39;start&#39;, &#39;end&#39;, &#39;both&#39;, or &#39;none&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Region representing the section</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get elements only within this region first</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>

        <span class="c1"># If no elements, return self or empty region?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;get_section_between called on region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> with no contained elements.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Return an empty region at the start of the parent region</span>
            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">))</span>

        <span class="c1"># Sort elements in reading order</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>

        <span class="c1"># Find start index</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">start_element</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_element</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Start element not in region, use first element</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start element not found in region, using first element.&quot;</span><span class="p">)</span>
                <span class="n">start_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Use the actual first element</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Default start is first element</span>

        <span class="c1"># Find end index</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">end_element</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end_element</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># End element not in region, use last element</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;End element not found in region, using last element.&quot;</span><span class="p">)</span>
                <span class="n">end_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use the actual last element</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Default end is last element</span>

        <span class="c1"># Adjust indexes based on boundary inclusion</span>
        <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">start_element</span>
        <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">end_element</span>

        <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">end_idx</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Ensure valid indexes</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">)</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span>

        <span class="c1"># If no valid elements in range, return empty region</span>
        <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="n">end_idx</span> <span class="ow">or</span> <span class="n">start_element_for_bbox</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end_element_for_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No valid elements in range for get_section_between.&quot;</span><span class="p">)</span>
            <span class="c1"># Return an empty region positioned at the start element boundary</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="n">start_element</span> <span class="k">if</span> <span class="n">start_element</span> <span class="k">else</span> <span class="bp">self</span>
            <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">top</span><span class="p">))</span>

        <span class="c1"># Get elements in range based on adjusted indices</span>
        <span class="n">section_elements</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create bounding box around the ELEMENTS included based on indices</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x0</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">bottom</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>

        <span class="c1"># Create new region</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>
        <span class="c1"># Store the original boundary elements for reference</span>
        <span class="n">section</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">start_element</span>
        <span class="n">section</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_element</span>

        <span class="k">return</span> <span class="n">section</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_sections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get sections within this region based on start/end elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_elements: Elements or selector string that mark the start of sections</span>
<span class="sd">            end_elements: Elements or selector string that mark the end of sections</span>
<span class="sd">            boundary_inclusion: How to include boundary elements: &#39;start&#39;, &#39;end&#39;, &#39;both&#39;, or &#39;none&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Region objects representing the extracted sections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

        <span class="c1"># Process string selectors to find elements WITHIN THIS REGION</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">start_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">start_elements</span><span class="p">)</span>  <span class="c1"># Use region&#39;s find_all</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
                <span class="n">start_elements</span> <span class="o">=</span> <span class="n">start_elements</span><span class="o">.</span><span class="n">elements</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">end_elements</span><span class="p">)</span>  <span class="c1"># Use region&#39;s find_all</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
                <span class="n">end_elements</span> <span class="o">=</span> <span class="n">end_elements</span><span class="o">.</span><span class="n">elements</span>

        <span class="c1"># Ensure start_elements is a list (or similar iterable)</span>
        <span class="k">if</span> <span class="n">start_elements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;get_sections requires valid start_elements (selector or list). Returning empty.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># Ensure end_elements is a list if provided</span>
        <span class="k">if</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;end_elements must be iterable if provided. Ignoring.&quot;</span><span class="p">)</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If no start elements found within the region, return empty list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start_elements</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Sort all elements within the region in reading order</span>
        <span class="n">all_elements_in_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
        <span class="n">all_elements_in_region</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_elements_in_region</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Cannot create sections if region is empty</span>

        <span class="c1"># Map elements to their indices in the sorted list</span>
        <span class="n">element_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_elements_in_region</span><span class="p">)}</span>

        <span class="c1"># Mark section boundaries using indices from the sorted list</span>
        <span class="n">section_boundaries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Add start element indexes</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">start_elements</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">element_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">section_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
            <span class="c1"># else: Element found by selector might not be geometrically in region? Log warning?</span>

        <span class="c1"># Add end element indexes if provided</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">end_elements</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">element_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">section_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span>

        <span class="c1"># Sort boundaries by index (document order within the region)</span>
        <span class="n">section_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

        <span class="c1"># Generate sections</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">section_boundaries</span><span class="p">):</span>
            <span class="c1"># If it&#39;s a start boundary and we don&#39;t have a current start</span>
            <span class="k">if</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span> <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="n">boundary</span>

            <span class="c1"># If it&#39;s an end boundary and we have a current start</span>
            <span class="k">elif</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create a section from current_start to this boundary</span>
                <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
                <span class="n">end_element</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
                <span class="c1"># Use the helper, ensuring elements are from within the region</span>
                <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="p">)</span>
                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
                <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Reset</span>

            <span class="c1"># If it&#39;s another start boundary and we have a current start (split by starts only)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span>
                <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">end_elements</span>
            <span class="p">):</span>
                <span class="c1"># End the previous section just before this start boundary</span>
                <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
                <span class="c1"># Find the element immediately preceding this start in the sorted list</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]:</span>
                    <span class="n">end_element</span> <span class="o">=</span> <span class="n">all_elements_in_region</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span>
                        <span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span>
                    <span class="p">)</span>
                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
                <span class="c1"># Else: Section started and ended by consecutive start elements? Create empty?</span>
                <span class="c1"># For now, just reset and start new section</span>

                <span class="c1"># Start the new section</span>
                <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="n">boundary</span>

        <span class="c1"># Handle the last section if we have a current start</span>
        <span class="k">if</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="c1"># End at the last element within the region</span>
            <span class="n">end_element</span> <span class="o">=</span> <span class="n">all_elements_in_region</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="p">)</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create cell regions for a detected table by intersecting its</span>
<span class="sd">        row and column regions, and add them to the page.</span>

<span class="sd">        Assumes child row and column regions are already present on the page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure this is called on a table region</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;table&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tableofcontents&quot;</span><span class="p">,</span>
        <span class="p">):</span>  <span class="c1"># Allow for ToC which might have structure</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;create_cells should be called on a &#39;table&#39; or &#39;tableofcontents&#39; region, not &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Find rows and columns associated with this page</span>
        <span class="c1"># Remove the model-specific filter</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table-row]&quot;</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table-column]&quot;</span><span class="p">)</span>

        <span class="c1"># Filter to only include those that overlap with this table region</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">is_in_table</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="c1"># Use a simple overlap check (more robust than just center point)</span>
            <span class="c1"># Check if element&#39;s bbox overlaps with self.bbox</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>  <span class="c1"># Ensure element has bbox</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
                <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
            <span class="p">)</span>

        <span class="n">table_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">table_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_rows</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">table_columns</span><span class="p">:</span>
            <span class="c1"># Use page&#39;s logger if available</span>
            <span class="n">logger_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
            <span class="n">logger_instance</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Cannot create cells. No overlapping row or column regions found.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self even if no cells created</span>

        <span class="c1"># Sort rows and columns</span>
        <span class="n">table_rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
        <span class="n">table_columns</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

        <span class="c1"># Create cells and add them to the page&#39;s element manager</span>
        <span class="n">created_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table_rows</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">:</span>
                <span class="c1"># Calculate intersection bbox for the cell</span>
                <span class="n">cell_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>
                <span class="n">cell_y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
                <span class="n">cell_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span>
                <span class="n">cell_y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

                <span class="c1"># Only create a cell if the intersection is valid (positive width/height)</span>
                <span class="k">if</span> <span class="n">cell_x1</span> <span class="o">&gt;</span> <span class="n">cell_x0</span> <span class="ow">and</span> <span class="n">cell_y1</span> <span class="o">&gt;</span> <span class="n">cell_y0</span><span class="p">:</span>
                    <span class="c1"># Create cell region at the intersection</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">cell_x0</span><span class="p">,</span> <span class="n">cell_y0</span><span class="p">,</span> <span class="n">cell_x1</span><span class="p">,</span> <span class="n">cell_y1</span><span class="p">)</span>
                    <span class="c1"># Set metadata</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;derived&quot;</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>  <span class="c1"># Explicitly set type</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>  <span class="c1"># And normalized type</span>
                    <span class="c1"># Inherit model from the parent table region</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Link cell to parent table region</span>

                    <span class="c1"># Add the cell region to the page&#39;s element manager</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="n">created_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Optional: Add created cells to the table region&#39;s children</span>
        <span class="c1"># self.child_regions.extend(cells_created_in_this_call) # Needs list management</span>

        <span class="n">logger_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="n">logger_instance</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> (Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">): Created and added </span><span class="si">{</span><span class="n">created_count</span><span class="si">}</span><span class="s2"> cell regions.&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">question</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
        <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask a question about the region content using document QA.</span>

<span class="sd">        This method uses a document question answering model to extract answers from the region content.</span>
<span class="sd">        It leverages both textual content and layout information for better understanding.</span>

<span class="sd">        Args:</span>
<span class="sd">            question: The question to ask about the region content</span>
<span class="sd">            min_confidence: Minimum confidence threshold for answers (0.0-1.0)</span>
<span class="sd">            model: Optional model name to use for QA (if None, uses default model)</span>
<span class="sd">            **kwargs: Additional parameters to pass to the QA engine</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with answer details: {</span>
<span class="sd">                &quot;answer&quot;: extracted text,</span>
<span class="sd">                &quot;confidence&quot;: confidence score,</span>
<span class="sd">                &quot;found&quot;: whether an answer was found,</span>
<span class="sd">                &quot;page_num&quot;: page number,</span>
<span class="sd">                &quot;region&quot;: reference to this region,</span>
<span class="sd">                &quot;source_elements&quot;: list of elements that contain the answer (if found)</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa.document_qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Question answering requires optional dependencies. Install with `pip install natural-pdf[ai]`&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Get or initialize QA engine with specified model</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize QA engine (model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Ask the question using the QA engine</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask_pdf_region</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during qa_engine.ask_pdf_region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a child region to this region.</span>

<span class="sd">        Used for hierarchical document structure when using models like Docling</span>
<span class="sd">        that understand document hierarchy.</span>

<span class="sd">        Args:</span>
<span class="sd">            child: Region object to add as a child</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get immediate child regions, optionally filtered by selector.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: Optional selector to filter children</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of child regions matching the selector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;natural_pdf.elements.region&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span>

        <span class="c1"># Use existing selector parser to filter</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
            <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">)</span>  <span class="c1"># Removed region=self</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">child</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;get_children: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> children matching &#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">matched</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying selector in get_children: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list on error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_descendants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all descendant regions (children, grandchildren, etc.), optionally filtered by selector.</span>

<span class="sd">        Args:</span>
<span class="sd">            selector: Optional selector to filter descendants</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of descendant regions matching the selector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;natural_pdf.elements.region&quot;</span><span class="p">)</span>

        <span class="n">all_descendants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span>  <span class="c1"># Start with direct children</span>

        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_descendants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="c1"># Add current&#39;s children to the queue for processing</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;child_regions&quot;</span><span class="p">):</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_descendants: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_descendants</span><span class="p">)</span><span class="si">}</span><span class="s2"> total descendants&quot;</span><span class="p">)</span>

        <span class="c1"># Filter by selector if provided</span>
        <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
                <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">)</span>  <span class="c1"># Removed region=self</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">all_descendants</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">desc</span><span class="p">)]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_descendants: filtered to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching &#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">matched</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying selector in get_descendants: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list on error</span>

        <span class="k">return</span> <span class="n">all_descendants</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation of the region.&quot;&quot;&quot;</span>
        <span class="n">poly_info</span> <span class="o">=</span> <span class="s2">&quot; (Polygon)&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">name_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">type_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; type=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">source_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; source=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Region</span><span class="si">{</span><span class="n">name_info</span><span class="si">}{</span><span class="n">type_info</span><span class="si">}{</span><span class="n">source_info</span><span class="si">}</span><span class="s2"> bbox=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}{</span><span class="n">poly_info</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>  <span class="c1"># Return self for chaining</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies corrections to OCR-generated text elements within this region</span>
<span class="sd">        using a user-provided callback function.</span>

<span class="sd">        Finds text elements within this region whose &#39;source&#39; attribute starts</span>
<span class="sd">        with &#39;ocr&#39; and calls the `correction_callback` for each, passing the</span>
<span class="sd">        element itself.</span>

<span class="sd">        The `correction_callback` should contain the logic to:</span>
<span class="sd">        1. Determine if the element needs correction.</span>
<span class="sd">        2. Perform the correction (e.g., call an LLM).</span>
<span class="sd">        3. Return the new text (`str`) or `None`.</span>

<span class="sd">        If the callback returns a string, the element&#39;s `.text` is updated.</span>
<span class="sd">        Metadata updates (source, confidence, etc.) should happen within the callback.</span>

<span class="sd">        Args:</span>
<span class="sd">            correction_callback: A function accepting an element and returning</span>
<span class="sd">                                 `Optional[str]` (new text or None).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find OCR elements specifically within this region</span>
        <span class="c1"># Note: We typically want to correct even if the element falls in an excluded area</span>
        <span class="n">target_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Delegate to the utility function</span>
        <span class="n">_apply_ocr_correction_to_elements</span><span class="p">(</span>
            <span class="n">elements</span><span class="o">=</span><span class="n">target_elements</span><span class="p">,</span>  <span class="c1"># Pass the ElementCollection directly</span>
            <span class="n">correction_callback</span><span class="o">=</span><span class="n">correction_callback</span><span class="p">,</span>
            <span class="n">caller_info</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Region(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>  <span class="c1"># Pass caller info</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>

    <span class="c1"># --- Classification Mixin Implementation --- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClassificationManager&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="s2">&quot;get_manager&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;ClassificationManager cannot be accessed: Parent Page, PDF, or get_manager method missing.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the PDF&#39;s manager registry accessor via page</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="s2">&quot;classification&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Wrap potential errors from get_manager for clarity</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to get ClassificationManager from PDF via Page: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_classification_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Image&quot;</span><span class="p">]:</span>  <span class="c1"># Use &quot;Image&quot; for lazy import</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Simple join for classification</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text_content</span> <span class="ow">or</span> <span class="n">text_content</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot classify region with &#39;text&#39; model: No text content found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text_content</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;vision&quot;</span><span class="p">:</span>
            <span class="c1"># Get resolution from manager/kwargs if possible, else default</span>
            <span class="c1"># We access manager via the method to ensure it&#39;s available</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_classification_manager</span><span class="p">()</span>
            <span class="n">default_resolution</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># Manager doesn&#39;t store default res, set here</span>
            <span class="c1"># Note: classify() passes resolution via **kwargs if user specifies</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">default_resolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span>
                <span class="k">else</span> <span class="n">default_resolution</span>
            <span class="p">)</span>

            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># No highlights for classification input</span>
                <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Just the region content</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot classify region with &#39;vision&#39; model: Failed to render image.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model_type for classification: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_metadata_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># Ensure metadata exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

    <span class="c1"># --- End Classification Mixin Implementation --- #</span>

    <span class="c1"># --- NEW METHOD: analyze_text_table_structure ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_text_table_structure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">snap_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">join_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">min_words_vertical</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">min_words_horizontal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">intersection_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">expand_bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes the text elements within the region (or slightly expanded area)</span>
<span class="sd">        to find potential table structure (lines, cells) using text alignment logic</span>
<span class="sd">        adapted from pdfplumber.</span>

<span class="sd">        Args:</span>
<span class="sd">            snap_tolerance: Tolerance for snapping parallel lines.</span>
<span class="sd">            join_tolerance: Tolerance for joining collinear lines.</span>
<span class="sd">            min_words_vertical: Minimum words needed to define a vertical line.</span>
<span class="sd">            min_words_horizontal: Minimum words needed to define a horizontal line.</span>
<span class="sd">            intersection_tolerance: Tolerance for detecting line intersections.</span>
<span class="sd">            expand_bbox: Optional dictionary to expand the search area slightly beyond</span>
<span class="sd">                         the region&#39;s exact bounds (e.g., {&#39;left&#39;: 5, &#39;right&#39;: 5}).</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to</span>
<span class="sd">                      find_text_based_tables (e.g., specific x/y tolerances).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary containing &#39;horizontal_edges&#39;, &#39;vertical_edges&#39;, &#39;cells&#39; (list of dicts),</span>
<span class="sd">            and &#39;intersections&#39;, or None if pdfplumber is unavailable or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine the search region (expand if requested)</span>
        <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">expand_bbox</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_bbox</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">**</span><span class="n">expand_bbox</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expanded search region for text table analysis to: </span><span class="si">{</span><span class="n">search_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not expand region bbox: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using original region.&quot;</span><span class="p">)</span>
                <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Find text elements within the search region</span>
        <span class="n">text_elements</span> <span class="o">=</span> <span class="n">search_region</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># Use unfiltered text</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text_elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No text elements found for text table analysis.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;horizontal_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;vertical_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;intersections&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="c1"># Extract bounding boxes</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">text_elements</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bboxes</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No bboxes extracted from text elements.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;horizontal_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;vertical_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;intersections&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="c1"># Call the utility function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">analysis_results</span> <span class="o">=</span> <span class="n">find_text_based_tables</span><span class="p">(</span>
                <span class="n">bboxes</span><span class="o">=</span><span class="n">bboxes</span><span class="p">,</span>
                <span class="n">snap_tolerance</span><span class="o">=</span><span class="n">snap_tolerance</span><span class="p">,</span>
                <span class="n">join_tolerance</span><span class="o">=</span><span class="n">join_tolerance</span><span class="p">,</span>
                <span class="n">min_words_vertical</span><span class="o">=</span><span class="n">min_words_vertical</span><span class="p">,</span>
                <span class="n">min_words_horizontal</span><span class="o">=</span><span class="n">min_words_horizontal</span><span class="p">,</span>
                <span class="n">intersection_tolerance</span><span class="o">=</span><span class="n">intersection_tolerance</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># Pass through any extra specific tolerance args</span>
            <span class="p">)</span>
            <span class="c1"># Store results in the region&#39;s analyses cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="s2">&quot;text_table_structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_results</span>
            <span class="k">return</span> <span class="n">analysis_results</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;pdfplumber library is required for &#39;text&#39; table analysis but not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during text-based table analysis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- END NEW METHOD ---</span>

    <span class="c1"># --- NEW METHOD: get_text_table_cells ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_text_table_cells</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">snap_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">join_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">min_words_vertical</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">min_words_horizontal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">intersection_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">expand_bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes text alignment to find table cells and returns them as</span>
<span class="sd">        temporary Region objects without adding them to the page.</span>

<span class="sd">        Args:</span>
<span class="sd">            snap_tolerance: Tolerance for snapping parallel lines.</span>
<span class="sd">            join_tolerance: Tolerance for joining collinear lines.</span>
<span class="sd">            min_words_vertical: Minimum words needed to define a vertical line.</span>
<span class="sd">            min_words_horizontal: Minimum words needed to define a horizontal line.</span>
<span class="sd">            intersection_tolerance: Tolerance for detecting line intersections.</span>
<span class="sd">            expand_bbox: Optional dictionary to expand the search area slightly beyond</span>
<span class="sd">                         the region&#39;s exact bounds (e.g., {&#39;left&#39;: 5, &#39;right&#39;: 5}).</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to</span>
<span class="sd">                      find_text_based_tables (e.g., specific x/y tolerances).</span>

<span class="sd">        Returns:</span>
<span class="sd">            An ElementCollection containing temporary Region objects for each detected cell,</span>
<span class="sd">            or an empty ElementCollection if no cells are found or an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

        <span class="c1"># 1. Perform the analysis (or use cached results)</span>
        <span class="k">if</span> <span class="s2">&quot;text_table_structure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
            <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="s2">&quot;text_table_structure&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_text_table_cells: Using cached analysis results.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_text_table_structure</span><span class="p">(</span>
                <span class="n">snap_tolerance</span><span class="o">=</span><span class="n">snap_tolerance</span><span class="p">,</span>
                <span class="n">join_tolerance</span><span class="o">=</span><span class="n">join_tolerance</span><span class="p">,</span>
                <span class="n">min_words_vertical</span><span class="o">=</span><span class="n">min_words_vertical</span><span class="p">,</span>
                <span class="n">min_words_horizontal</span><span class="o">=</span><span class="n">min_words_horizontal</span><span class="p">,</span>
                <span class="n">intersection_tolerance</span><span class="o">=</span><span class="n">intersection_tolerance</span><span class="p">,</span>
                <span class="n">expand_bbox</span><span class="o">=</span><span class="n">expand_bbox</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># 2. Check if analysis was successful and cells were found</span>
        <span class="k">if</span> <span class="n">analysis_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysis_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No cells found by text table analysis.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Return empty collection</span>

        <span class="c1"># 3. Create temporary Region objects for each cell dictionary</span>
        <span class="n">cell_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell_data</span> <span class="ow">in</span> <span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use page.region to create the region object</span>
                <span class="c1"># It expects left, top, right, bottom keys</span>
                <span class="n">cell_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="o">**</span><span class="n">cell_data</span><span class="p">)</span>

                <span class="c1"># Set metadata on the temporary region</span>
                <span class="n">cell_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>
                <span class="n">cell_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>
                <span class="n">cell_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber-text&quot;</span>
                <span class="n">cell_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;volatile&quot;</span>  <span class="c1"># Indicate it&#39;s not managed/persistent</span>
                <span class="n">cell_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Link back to the region it came from</span>

                <span class="n">cell_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_region</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create Region object for cell data </span><span class="si">{</span><span class="n">cell_data</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Return the list wrapped in an ElementCollection</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_text_table_cells: Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> temporary cell regions.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">)</span>

    <span class="c1"># --- END NEW METHOD ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_text_element</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">source_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;derived_from_region&quot;</span><span class="p">,</span>
        <span class="n">object_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>  <span class="c1"># Or &quot;char&quot;, controls how it&#39;s categorized</span>
        <span class="n">default_font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">default_font_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RegionContent&quot;</span><span class="p">,</span>
        <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Allow overriding confidence</span>
        <span class="n">add_to_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># NEW: Option to add to page</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TextElement&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new TextElement object based on this region&#39;s geometry.</span>

<span class="sd">        The text for the new TextElement can be provided directly,</span>
<span class="sd">        generated by a callback function, or left as None.</span>

<span class="sd">        Args:</span>
<span class="sd">            text_content:</span>
<span class="sd">                - If a string, this will be the text of the new TextElement.</span>
<span class="sd">                - If a callable, it will be called with this region instance</span>
<span class="sd">                  and its return value (a string or None) will be the text.</span>
<span class="sd">                - If None (default), the TextElement&#39;s text will be None.</span>
<span class="sd">            source_label: The &#39;source&#39; attribute for the new TextElement.</span>
<span class="sd">            object_type: The &#39;object_type&#39; for the TextElement&#39;s data dict</span>
<span class="sd">                         (e.g., &quot;word&quot;, &quot;char&quot;).</span>
<span class="sd">            default_font_size: Placeholder font size if text is generated.</span>
<span class="sd">            default_font_name: Placeholder font name if text is generated.</span>
<span class="sd">            confidence: Confidence score for the text. If text_content is None,</span>
<span class="sd">                        defaults to 0.0. If text is provided/generated, defaults to 1.0</span>
<span class="sd">                        unless specified.</span>
<span class="sd">            add_to_page: If True, the created TextElement will be added to the</span>
<span class="sd">                         region&#39;s parent page. (Default: False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new TextElement instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the region does not have a valid &#39;page&#39; attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actual_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">actual_text</span> <span class="o">=</span> <span class="n">text_content</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">text_content</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">actual_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error executing text_content callback for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">actual_text</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensure actual_text is None on error</span>

        <span class="n">final_confidence</span> <span class="o">=</span> <span class="n">confidence</span>
        <span class="k">if</span> <span class="n">final_confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_confidence</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">actual_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">actual_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region must have a valid &#39;page&#39; attribute to create a TextElement.&quot;</span><span class="p">)</span>

        <span class="c1"># Create character dictionaries for the text</span>
        <span class="n">char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">actual_text</span><span class="p">:</span>
            <span class="c1"># Create a single character dict that spans the entire region</span>
            <span class="c1"># This is a simplified approach - OCR engines typically create one per character</span>
            <span class="n">char_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">actual_text</span><span class="p">,</span>
                <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
                <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span>
                <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
                <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="n">default_font_name</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">default_font_size</span><span class="p">,</span>
                <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;adv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_label</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
                <span class="s2">&quot;stroking_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">char_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_dict</span><span class="p">)</span>

        <span class="n">elem_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">actual_text</span><span class="p">,</span>
            <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
            <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="n">object_type</span><span class="p">,</span>
            <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
            <span class="s2">&quot;stroking_color&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stroking_color&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="n">default_font_name</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">default_font_size</span><span class="p">,</span>
            <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;adv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_label</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
            <span class="s2">&quot;_char_dicts&quot;</span><span class="p">:</span> <span class="n">char_dicts</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">text_element</span> <span class="o">=</span> <span class="n">TextElement</span><span class="p">(</span><span class="n">elem_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_to_page</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">add_as_type</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;words&quot;</span>
                    <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;chars&quot;</span> <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span> <span class="k">else</span> <span class="n">object_type</span>
                <span class="p">)</span>
                <span class="c1"># REMOVED try-except block around add_element</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">text_element</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="n">add_as_type</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TextElement created from region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> and added to page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">add_as_type</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Also add character dictionaries to the chars collection</span>
                <span class="k">if</span> <span class="n">char_dicts</span> <span class="ow">and</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">char_dict</span> <span class="ow">in</span> <span class="n">char_dicts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">char_dict</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;chars&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">page_num_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;page_number&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot add TextElement to page: Page </span><span class="si">{</span><span class="n">page_num_str</span><span class="si">}</span><span class="s2"> for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> is missing &#39;_element_mgr&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">text_element</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Unified analysis storage (maps to metadata[&quot;analysis&quot;])</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="nd">@analyses</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># New helper: build table from pre-computed table_cell regions</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_table_from_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a table (list-of-lists) from table_cell regions.</span>

<span class="sd">        This assumes each cell Region has metadata.row_index / col_index as written by</span>
<span class="sd">        detect_table_structure_from_lines().  If these keys are missing we will</span>
<span class="sd">        fall back to sorting by geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_regions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Attempt to use explicit indices first</span>
        <span class="n">all_row_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_col_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_regions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;row_index&quot;</span><span class="p">))</span>
                <span class="n">c_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;col_index&quot;</span><span class="p">))</span>
                <span class="n">all_row_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_idx</span><span class="p">)</span>
                <span class="n">all_col_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_idx</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Not all cells have indices  clear the lists so we switch to geometric sorting</span>
                <span class="n">all_row_idxs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_col_idxs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">all_row_idxs</span> <span class="ow">and</span> <span class="n">all_col_idxs</span><span class="p">:</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_row_idxs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_col_idxs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Initialise blank grid</span>
            <span class="n">table_grid</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cols</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_regions</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;row_index&quot;</span><span class="p">))</span>
                    <span class="n">c_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;col_index&quot;</span><span class="p">))</span>
                    <span class="n">text_val</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">table_grid</span><span class="p">[</span><span class="n">r_idx</span><span class="p">][</span><span class="n">c_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_val</span> <span class="k">if</span> <span class="n">text_val</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_err</span><span class="p">:</span>
                    <span class="c1"># Skip problematic cell</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">table_grid</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Fallback: derive order purely from geometry if indices are absent</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Sort unique centers to define ordering</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NumPy required for geometric cell ordering; returning empty result.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Build arrays of centers</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[(</span><span class="n">c</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_regions</span><span class="p">])</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Cluster unique row Y positions and column X positions with a tolerance</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_cluster</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="n">sorted_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sorted_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sorted_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>

        <span class="n">row_centers</span> <span class="o">=</span> <span class="n">_cluster</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">col_centers</span> <span class="o">=</span> <span class="n">_cluster</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_centers</span><span class="p">)</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_centers</span><span class="p">)</span>

        <span class="n">table_grid</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cols</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">)]</span>

        <span class="c1"># Assign each cell to nearest row &amp; col center</span>
        <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">,</span> <span class="n">centers</span><span class="p">):</span>
            <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">cy</span> <span class="o">-</span> <span class="n">rc</span><span class="p">)</span> <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">row_centers</span><span class="p">]))</span>
            <span class="n">col_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">col_centers</span><span class="p">]))</span>

            <span class="n">text_val</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">table_grid</span><span class="p">[</span><span class="n">row_idx</span><span class="p">][</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_val</span> <span class="k">if</span> <span class="n">text_val</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">table_grid</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





<h6 id="natural_pdf.Region-attributes">Attributes</h6>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.bbox" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">bbox</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the bounding box as (x0, top, x1, bottom).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.bottom" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">bottom</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the bottom coordinate.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.has_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">has_polygon</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Check if this region has polygon coordinates.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.height" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">height</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the height of the region.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.page" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">page</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the parent page.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">polygon</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get polygon coordinates if available, otherwise return rectangle corners.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.top" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">top</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the top coordinate.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">type</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Element type.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.width" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">width</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the width of the region.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.x0" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">x0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the left coordinate.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="natural_pdf.Region.x1" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">x1</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Get the right coordinate.</p>

    </div>

</div>

<h6 id="natural_pdf.Region-functions">Functions</h6>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">polygon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Initialize a region.</p>
<p>Creates a Region object that represents a rectangular or polygonal area on a page.
Regions are used for spatial navigation, content extraction, and analysis operations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>page</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Page (natural_pdf.core.page.Page)" href="#natural_pdf.Page">Page</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parent Page object that contains this region and provides access
to document elements and analysis capabilities.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bbox</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box coordinates as (x0, top, x1, bottom) tuple in PDF
coordinate system (points, with origin at bottom-left).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>polygon</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of coordinate points [(x1,y1), (x2,y2), ...] for
non-rectangular regions. If provided, the region will use polygon-based
intersection calculations instead of simple rectangle overlap.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parent</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parent region for hierarchical document structure.
Useful for maintaining tree-like relationships between regions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional descriptive label for the region, useful for debugging
and identification in complex workflows.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">npdf</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Rectangular region</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="p">)</span>

<span class="c1"># Polygonal region (from layout detection)</span>
<span class="n">table_polygon</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">400</span><span class="p">)]</span>
<span class="n">table_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
                    <span class="n">polygon</span><span class="o">=</span><span class="n">table_polygon</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Regions are typically created through page methods like page.region() or
spatial navigation methods like element.below(). Direct instantiation is
used mainly for advanced workflows or layout analysis integration.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">page</span><span class="p">:</span> <span class="s2">&quot;Page&quot;</span><span class="p">,</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a region.</span>

<span class="sd">    Creates a Region object that represents a rectangular or polygonal area on a page.</span>
<span class="sd">    Regions are used for spatial navigation, content extraction, and analysis operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        page: Parent Page object that contains this region and provides access</span>
<span class="sd">            to document elements and analysis capabilities.</span>
<span class="sd">        bbox: Bounding box coordinates as (x0, top, x1, bottom) tuple in PDF</span>
<span class="sd">            coordinate system (points, with origin at bottom-left).</span>
<span class="sd">        polygon: Optional list of coordinate points [(x1,y1), (x2,y2), ...] for</span>
<span class="sd">            non-rectangular regions. If provided, the region will use polygon-based</span>
<span class="sd">            intersection calculations instead of simple rectangle overlap.</span>
<span class="sd">        parent: Optional parent region for hierarchical document structure.</span>
<span class="sd">            Useful for maintaining tree-like relationships between regions.</span>
<span class="sd">        label: Optional descriptive label for the region, useful for debugging</span>
<span class="sd">            and identification in complex workflows.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        pdf = npdf.PDF(&quot;document.pdf&quot;)</span>
<span class="sd">        page = pdf.pages[0]</span>

<span class="sd">        # Rectangular region</span>
<span class="sd">        header = Region(page, (0, 0, page.width, 100), label=&quot;header&quot;)</span>

<span class="sd">        # Polygonal region (from layout detection)</span>
<span class="sd">        table_polygon = [(50, 100), (300, 100), (300, 400), (50, 400)]</span>
<span class="sd">        table_region = Region(page, (50, 100, 300, 400),</span>
<span class="sd">                            polygon=table_polygon, label=&quot;table&quot;)</span>
<span class="sd">        ```</span>

<span class="sd">    Note:</span>
<span class="sd">        Regions are typically created through page methods like page.region() or</span>
<span class="sd">        spatial navigation methods like element.below(). Direct instantiation is</span>
<span class="sd">        used mainly for advanced workflows or layout analysis integration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_page</span> <span class="o">=</span> <span class="n">page</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span> <span class="o">=</span> <span class="n">bbox</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="o">=</span> <span class="n">polygon</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Analysis results live under self.metadata[&#39;analysis&#39;] via property</span>

    <span class="c1"># Standard attributes for all elements</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>  <span class="c1"># For selector compatibility</span>

    <span class="c1"># Layout detection attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Region management attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set by creation methods</span>

    <span class="c1"># Hierarchy support for nested document structure</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text_content</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Direct text content (e.g., from Docling)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">associated_text_elements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Native text elements that overlap with this region</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>String representation of the region.</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;String representation of the region.&quot;&quot;&quot;</span>
    <span class="n">poly_info</span> <span class="o">=</span> <span class="s2">&quot; (Polygon)&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">name_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">type_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; type=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">source_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; source=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Region</span><span class="si">{</span><span class="n">name_info</span><span class="si">}{</span><span class="n">type_info</span><span class="si">}{</span><span class="n">source_info</span><span class="si">}</span><span class="s2"> bbox=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}{</span><span class="n">poly_info</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.above" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">above</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">include_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Select region above this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height of the region above, in points</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width mode - "full" for full page width or "element" for element width</p>
              </div>
            </td>
            <td>
                  <code>&#39;full&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_source</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include this region in the result (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>until</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector string to specify an upper boundary element</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_endpoint</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include the boundary element in the region (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object representing the area above</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">above</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
    <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select region above this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        height: Height of the region above, in points</span>
<span class="sd">        width: Width mode - &quot;full&quot; for full page width or &quot;element&quot; for element width</span>
<span class="sd">        include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">        until: Optional selector string to specify an upper boundary element</span>
<span class="sd">        include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">        **kwargs: Additional parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object representing the area above</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;above&quot;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">cross_size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
        <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.add_child" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Add a child region to this region.</p>
<p>Used for hierarchical document structure when using models like Docling
that understand document hierarchy.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>child</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object to add as a child</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a child region to this region.</span>

<span class="sd">    Used for hierarchical document structure when using models like Docling</span>
<span class="sd">    that understand document hierarchy.</span>

<span class="sd">    Args:</span>
<span class="sd">        child: Region object to add as a child</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
    <span class="n">child</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.analyze_text_table_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">analyze_text_table_structure</span><span class="p">(</span><span class="n">snap_tolerance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">join_tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_words_vertical</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_words_horizontal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">intersection_tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expand_bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Analyzes the text elements within the region (or slightly expanded area)
to find potential table structure (lines, cells) using text alignment logic
adapted from pdfplumber.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>snap_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for snapping parallel lines.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>join_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for joining collinear lines.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_words_vertical</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum words needed to define a vertical line.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_words_horizontal</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum words needed to define a horizontal line.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intersection_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for detecting line intersections.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expand_bbox</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary to expand the search area slightly beyond
         the region's exact bounds (e.g., {'left': 5, 'right': 5}).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to
      find_text_based_tables (e.g., specific x/y tolerances).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing 'horizontal_edges', 'vertical_edges', 'cells' (list of dicts),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and 'intersections', or None if pdfplumber is unavailable or an error occurs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_text_table_structure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">snap_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">join_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">min_words_vertical</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">min_words_horizontal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">intersection_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">expand_bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyzes the text elements within the region (or slightly expanded area)</span>
<span class="sd">    to find potential table structure (lines, cells) using text alignment logic</span>
<span class="sd">    adapted from pdfplumber.</span>

<span class="sd">    Args:</span>
<span class="sd">        snap_tolerance: Tolerance for snapping parallel lines.</span>
<span class="sd">        join_tolerance: Tolerance for joining collinear lines.</span>
<span class="sd">        min_words_vertical: Minimum words needed to define a vertical line.</span>
<span class="sd">        min_words_horizontal: Minimum words needed to define a horizontal line.</span>
<span class="sd">        intersection_tolerance: Tolerance for detecting line intersections.</span>
<span class="sd">        expand_bbox: Optional dictionary to expand the search area slightly beyond</span>
<span class="sd">                     the region&#39;s exact bounds (e.g., {&#39;left&#39;: 5, &#39;right&#39;: 5}).</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to</span>
<span class="sd">                  find_text_based_tables (e.g., specific x/y tolerances).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing &#39;horizontal_edges&#39;, &#39;vertical_edges&#39;, &#39;cells&#39; (list of dicts),</span>
<span class="sd">        and &#39;intersections&#39;, or None if pdfplumber is unavailable or an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Determine the search region (expand if requested)</span>
    <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">if</span> <span class="n">expand_bbox</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_bbox</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">**</span><span class="n">expand_bbox</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expanded search region for text table analysis to: </span><span class="si">{</span><span class="n">search_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not expand region bbox: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using original region.&quot;</span><span class="p">)</span>
            <span class="n">search_region</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="c1"># Find text elements within the search region</span>
    <span class="n">text_elements</span> <span class="o">=</span> <span class="n">search_region</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
        <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>  <span class="c1"># Use unfiltered text</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text_elements</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No text elements found for text table analysis.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;horizontal_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;vertical_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;intersections&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># Extract bounding boxes</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">bbox</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">text_elements</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bboxes</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No bboxes extracted from text elements.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;horizontal_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;vertical_edges&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;cells&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;intersections&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># Call the utility function</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">analysis_results</span> <span class="o">=</span> <span class="n">find_text_based_tables</span><span class="p">(</span>
            <span class="n">bboxes</span><span class="o">=</span><span class="n">bboxes</span><span class="p">,</span>
            <span class="n">snap_tolerance</span><span class="o">=</span><span class="n">snap_tolerance</span><span class="p">,</span>
            <span class="n">join_tolerance</span><span class="o">=</span><span class="n">join_tolerance</span><span class="p">,</span>
            <span class="n">min_words_vertical</span><span class="o">=</span><span class="n">min_words_vertical</span><span class="p">,</span>
            <span class="n">min_words_horizontal</span><span class="o">=</span><span class="n">min_words_horizontal</span><span class="p">,</span>
            <span class="n">intersection_tolerance</span><span class="o">=</span><span class="n">intersection_tolerance</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># Pass through any extra specific tolerance args</span>
        <span class="p">)</span>
        <span class="c1"># Store results in the region&#39;s analyses cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="s2">&quot;text_table_structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_results</span>
        <span class="k">return</span> <span class="n">analysis_results</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;pdfplumber library is required for &#39;text&#39; table analysis but not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during text-based table analysis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.apply_custom_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">apply_custom_ocr</span><span class="p">(</span><span class="n">ocr_function</span><span class="p">,</span> <span class="n">source_label</span><span class="o">=</span><span class="s1">&#39;custom-ocr&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_to_page</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Apply a custom OCR function to this region and create text elements from the results.</p>
<p>This is useful when you want to use a custom OCR method (e.g., an LLM API,
specialized OCR service, or any custom logic) instead of the built-in OCR engines.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ocr_function</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A callable that takes a Region and returns the OCR'd text (or None).
          The function receives this region as its argument and should return
          the extracted text as a string, or None if no text was found.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Label to identify the source of these text elements (default: "custom-ocr").
          This will be set as the 'source' attribute on created elements.</p>
              </div>
            </td>
            <td>
                  <code>&#39;custom-ocr&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>replace</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), removes existing OCR elements in this region before
     adding new ones. If False, adds new OCR elements alongside existing ones.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional confidence score for the OCR result (0.0-1.0).
        If None, defaults to 1.0 if text is returned, 0.0 if None is returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_to_page</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), adds the created text element to the page.
         If False, creates the element but doesn't add it to the page.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h6 id="natural_pdf.Region.apply_custom_ocr--using-with-an-llm">Using with an LLM</h6>
<p>def ocr_with_llm(region):
    image = region.to_image(resolution=300, crop=True)
    # Call your LLM API here
    return llm_client.ocr(image)</p>
<p>region.apply_custom_ocr(ocr_with_llm)</p>
<h6 id="natural_pdf.Region.apply_custom_ocr--using-with-a-custom-ocr-service">Using with a custom OCR service</h6>
<p>def ocr_with_service(region):
    img_bytes = region.to_image(crop=True).tobytes()
    response = ocr_service.process(img_bytes)
    return response.text</p>
<p>region.apply_custom_ocr(ocr_with_service, source_label="my-ocr-service")</p>
</details>

            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_custom_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ocr_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">source_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;custom-ocr&quot;</span><span class="p">,</span>
    <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_to_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a custom OCR function to this region and create text elements from the results.</span>

<span class="sd">    This is useful when you want to use a custom OCR method (e.g., an LLM API,</span>
<span class="sd">    specialized OCR service, or any custom logic) instead of the built-in OCR engines.</span>

<span class="sd">    Args:</span>
<span class="sd">        ocr_function: A callable that takes a Region and returns the OCR&#39;d text (or None).</span>
<span class="sd">                      The function receives this region as its argument and should return</span>
<span class="sd">                      the extracted text as a string, or None if no text was found.</span>
<span class="sd">        source_label: Label to identify the source of these text elements (default: &quot;custom-ocr&quot;).</span>
<span class="sd">                      This will be set as the &#39;source&#39; attribute on created elements.</span>
<span class="sd">        replace: If True (default), removes existing OCR elements in this region before</span>
<span class="sd">                 adding new ones. If False, adds new OCR elements alongside existing ones.</span>
<span class="sd">        confidence: Optional confidence score for the OCR result (0.0-1.0).</span>
<span class="sd">                    If None, defaults to 1.0 if text is returned, 0.0 if None is returned.</span>
<span class="sd">        add_to_page: If True (default), adds the created text element to the page.</span>
<span class="sd">                     If False, creates the element but doesn&#39;t add it to the page.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Using with an LLM</span>
<span class="sd">        def ocr_with_llm(region):</span>
<span class="sd">            image = region.to_image(resolution=300, crop=True)</span>
<span class="sd">            # Call your LLM API here</span>
<span class="sd">            return llm_client.ocr(image)</span>

<span class="sd">        region.apply_custom_ocr(ocr_with_llm)</span>

<span class="sd">        # Using with a custom OCR service</span>
<span class="sd">        def ocr_with_service(region):</span>
<span class="sd">            img_bytes = region.to_image(crop=True).tobytes()</span>
<span class="sd">            response = ocr_service.process(img_bytes)</span>
<span class="sd">            return response.text</span>

<span class="sd">        region.apply_custom_ocr(ocr_with_service, source_label=&quot;my-ocr-service&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If replace is True, remove existing OCR elements in this region</span>
    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying custom OCR.&quot;</span>
        <span class="p">)</span>

        <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Helper to remove a single element safely</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_safe_remove</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">removed_count</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                <span class="n">etype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;words&quot;</span>
                <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;chars&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="n">etype</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">etype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">etype</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">etype_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">removed_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Remove ALL OCR elements overlapping this region</span>
        <span class="c1"># Remove elements with source==&quot;ocr&quot; (built-in OCR) or matching the source_label (previous custom OCR)</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
            <span class="n">word_source</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Match built-in OCR behavior: remove elements with source &quot;ocr&quot; exactly</span>
            <span class="c1"># Also remove elements with the same source_label to avoid duplicates</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">word_source</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">or</span> <span class="n">word_source</span> <span class="o">==</span> <span class="n">source_label</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
                <span class="n">_safe_remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

        <span class="c1"># Also remove char dicts if needed (matching built-in OCR)</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">):</span>
            <span class="c1"># char can be dict or TextElement; normalize</span>
            <span class="n">char_src</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">char_src</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">or</span> <span class="n">char_src</span> <span class="o">==</span> <span class="n">source_label</span><span class="p">:</span>
                <span class="c1"># Rough bbox for dicts</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">bottom</span>
                <span class="c1"># Quick overlap check</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">cx1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">or</span> <span class="n">cx0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">or</span> <span class="n">cbottom</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">or</span> <span class="n">ctop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
                <span class="p">):</span>
                    <span class="n">_safe_remove</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">removed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> existing OCR elements.&quot;</span><span class="p">)</span>

    <span class="c1"># Call the custom OCR function</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Calling custom OCR function...&quot;</span><span class="p">)</span>
        <span class="n">ocr_text</span> <span class="o">=</span> <span class="n">ocr_function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ocr_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom OCR function returned non-string type (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Converting to string.&quot;</span>
            <span class="p">)</span>
            <span class="n">ocr_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error calling custom OCR function for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Create text element if we got text</span>
    <span class="k">if</span> <span class="n">ocr_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use the to_text_element method to create the element</span>
        <span class="n">text_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_text_element</span><span class="p">(</span>
            <span class="n">text_content</span><span class="o">=</span><span class="n">ocr_text</span><span class="p">,</span>
            <span class="n">source_label</span><span class="o">=</span><span class="n">source_label</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">add_to_page</span><span class="o">=</span><span class="n">add_to_page</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Created text element with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ocr_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; and added to page&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">add_to_page</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Custom OCR function returned None (no text found)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.apply_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ocr_params</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Apply OCR to this region and return the created text elements.</p>
<p>This method supports two modes:
1. <strong>Built-in OCR Engines</strong> (default)  identical to previous behaviour. Pass typical
   parameters like <code>engine='easyocr'</code> or <code>languages=['en']</code> and the method will
   route the request through :class:<code>OCRManager</code>.
2. <strong>Custom OCR Function</strong>  pass a <em>callable</em> under the keyword <code>function</code> (or
   <code>ocr_function</code>). The callable will receive <em>this</em> Region instance and should
   return the extracted text (<code>str</code>) or <code>None</code>.  Internally the call is
   delegated to :pymeth:<code>apply_custom_ocr</code> so the same logic (replacement, element
   creation, etc.) is re-used.</p>
<h6 id="natural_pdf.Region.apply_ocr--examples">Examples</h6>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">llm_ocr</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">my_llm_client</span><span class="o">.</span><span class="n">ocr</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">region</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">llm_ocr</span><span class="p">)</span>
</code></pre></div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>replace</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to remove existing OCR elements first (default <code>True</code>).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**ocr_params</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters for the built-in OCR manager <em>or</em> the special
          <code>function</code>/<code>ocr_function</code> keyword to trigger custom mode.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>
        <h6 id="natural_pdf.Region.apply_ocr--returns">Returns</h6>
<div class="highlight"><pre><span></span><code>Self  for chaining.
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_ocr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ocr_params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply OCR to this region and return the created text elements.</span>

<span class="sd">    This method supports two modes:</span>
<span class="sd">    1. **Built-in OCR Engines** (default)  identical to previous behaviour. Pass typical</span>
<span class="sd">       parameters like ``engine=&#39;easyocr&#39;`` or ``languages=[&#39;en&#39;]`` and the method will</span>
<span class="sd">       route the request through :class:`OCRManager`.</span>
<span class="sd">    2. **Custom OCR Function**  pass a *callable* under the keyword ``function`` (or</span>
<span class="sd">       ``ocr_function``). The callable will receive *this* Region instance and should</span>
<span class="sd">       return the extracted text (``str``) or ``None``.  Internally the call is</span>
<span class="sd">       delegated to :pymeth:`apply_custom_ocr` so the same logic (replacement, element</span>
<span class="sd">       creation, etc.) is re-used.</span>

<span class="sd">    Examples</span>
<span class="sd">    ---------</span>
<span class="sd">    ```python</span>
<span class="sd">    def llm_ocr(region):</span>
<span class="sd">        image = region.to_image(resolution=300, crop=True)</span>
<span class="sd">        return my_llm_client.ocr(image)</span>
<span class="sd">    region.apply_ocr(function=llm_ocr)</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        replace: Whether to remove existing OCR elements first (default ``True``).</span>
<span class="sd">        **ocr_params: Parameters for the built-in OCR manager *or* the special</span>
<span class="sd">                      ``function``/``ocr_function`` keyword to trigger custom mode.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Self  for chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Custom OCR function path --------------------------------------------------</span>
    <span class="n">custom_func</span> <span class="o">=</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ocr_function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">custom_func</span><span class="p">):</span>
        <span class="c1"># Delegate to the specialised helper while preserving key kwargs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_custom_ocr</span><span class="p">(</span>
            <span class="n">ocr_function</span><span class="o">=</span><span class="n">custom_func</span><span class="p">,</span>
            <span class="n">source_label</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;source_label&quot;</span><span class="p">,</span> <span class="s2">&quot;custom-ocr&quot;</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">add_to_page</span><span class="o">=</span><span class="n">ocr_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_to_page&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># --- Original built-in OCR engine path (unchanged except docstring) ------------</span>
    <span class="c1"># Ensure OCRManager is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_ocr_manager&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_ocr_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OCRManager not available on parent PDF. Cannot apply OCR to region.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># If replace is True, find and remove existing OCR elements in this region</span>
    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removing existing OCR elements before applying new OCR.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- Robust removal: iterate through all OCR elements on the page and</span>
        <span class="c1">#     remove those that overlap this region. This avoids reliance on</span>
        <span class="c1">#     identitybased look-ups that can break if the ElementManager</span>
        <span class="c1">#     rebuilt its internal lists.</span>

        <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Helper to remove a single element safely</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_safe_remove</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">removed_count</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">):</span>
                <span class="n">etype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;words&quot;</span>
                <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="s2">&quot;chars&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">etype_key</span> <span class="o">=</span> <span class="n">etype</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">etype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">etype</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">etype_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">removed_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Remove OCR WORD elements overlapping region</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">words</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
                <span class="n">_safe_remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

        <span class="c1"># Remove OCR CHAR dicts overlapping region</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">chars</span><span class="p">):</span>
            <span class="c1"># char can be dict or TextElement; normalise</span>
            <span class="n">char_src</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">char_src</span> <span class="o">==</span> <span class="s2">&quot;ocr&quot;</span><span class="p">:</span>
                <span class="c1"># Rough bbox for dicts</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">char</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cx0</span><span class="p">,</span> <span class="n">ctop</span><span class="p">,</span> <span class="n">cx1</span><span class="p">,</span> <span class="n">cbottom</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">char</span><span class="o">.</span><span class="n">bottom</span>
                <span class="c1"># Quick overlap check</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">cx1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">or</span> <span class="n">cx0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="ow">or</span> <span class="n">cbottom</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">or</span> <span class="n">ctop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
                <span class="p">):</span>
                    <span class="n">_safe_remove</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Removed </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> existing OCR elements (words &amp; chars) before re-applying OCR.&quot;</span>
        <span class="p">)</span>

    <span class="n">ocr_mgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_ocr_manager</span>

    <span class="c1"># Determine rendering resolution from parameters</span>
    <span class="n">final_resolution</span> <span class="o">=</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_resolution</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_parent&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
        <span class="n">final_resolution</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">final_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_resolution</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Applying OCR with resolution </span><span class="si">{</span><span class="n">final_resolution</span><span class="si">}</span><span class="s2"> DPI and params: </span><span class="si">{</span><span class="n">ocr_params</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Render the page region to an image using the determined resolution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">region_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">final_resolution</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">region_image</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to render region to image for OCR.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region rendered to image size: </span><span class="si">{</span><span class="n">region_image</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering region to image for OCR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Prepare args for the OCR Manager</span>
    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">region_image</span><span class="p">,</span>
        <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;engine&quot;</span><span class="p">),</span>
        <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;languages&quot;</span><span class="p">),</span>
        <span class="s2">&quot;min_confidence&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_confidence&quot;</span><span class="p">),</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">),</span>
        <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">),</span>
        <span class="s2">&quot;detect_only&quot;</span><span class="p">:</span> <span class="n">ocr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;detect_only&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">manager_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">manager_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># Run OCR on this region&#39;s image using the manager</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ocr_mgr</span><span class="o">.</span><span class="n">apply_ocr</span><span class="p">(</span><span class="o">**</span><span class="n">manager_args</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;OCRManager returned unexpected type for single region image: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region OCR processing returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>

    <span class="c1"># Convert results to TextElements</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="k">if</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region OCR scaling factors (PDF/Img): x=</span><span class="si">{</span><span class="n">scale_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">scale_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">created_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img_x0</span><span class="p">,</span> <span class="n">img_top</span><span class="p">,</span> <span class="n">img_x1</span><span class="p">,</span> <span class="n">img_bottom</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>
            <span class="n">pdf_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_bottom</span> <span class="o">-</span> <span class="n">img_top</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_y</span>
            <span class="n">page_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_x0</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">)</span>
            <span class="n">page_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_top</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">)</span>
            <span class="n">page_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_x1</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">)</span>
            <span class="n">page_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_bottom</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">)</span>
            <span class="n">raw_conf</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span>
            <span class="c1"># Convert confidence to float unless it is None/invalid</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">confidence_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_conf</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">confidence_val</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">text_val</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>  <span class="c1"># May legitimately be None in detect_only mode</span>

            <span class="n">element_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_val</span><span class="p">,</span>
                <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">page_x0</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="n">page_top</span><span class="p">,</span>
                <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">page_x1</span><span class="p">,</span>
                <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">page_bottom</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">page_x1</span> <span class="o">-</span> <span class="n">page_x0</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">page_bottom</span> <span class="o">-</span> <span class="n">page_top</span><span class="p">,</span>
                <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ocr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence_val</span><span class="p">,</span>
                <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="s2">&quot;OCR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pdf_height</span><span class="p">)</span> <span class="k">if</span> <span class="n">pdf_height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">10.0</span><span class="p">,</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;italic&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;doctop&quot;</span><span class="p">:</span> <span class="n">page_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">initial_doctop</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ocr_char_dict</span> <span class="o">=</span> <span class="n">element_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ocr_char_dict</span><span class="p">[</span><span class="s2">&quot;object_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;char&quot;</span>
            <span class="n">ocr_char_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;adv&quot;</span><span class="p">,</span> <span class="n">ocr_char_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">element_data</span><span class="p">[</span><span class="s2">&quot;_char_dicts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ocr_char_dict</span><span class="p">]</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextElement</span>

            <span class="n">elem</span> <span class="o">=</span> <span class="n">TextElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>
            <span class="n">created_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;words&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">ocr_char_dict</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;chars&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to convert region OCR result to element: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_elements</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements from OCR.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.ask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Ask a question about the region content using document QA.</p>
<p>This method uses a document question answering model to extract answers from the region content.
It leverages both textual content and layout information for better understanding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>question</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>], <span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, ...]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The question to ask about the region content</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_confidence</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum confidence threshold for answers (0.0-1.0)</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional model name to use for QA (if None, uses default model)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters to pass to the QA engine</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>], <span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with answer details: {
"answer": extracted text,
"confidence": confidence score,
"found": whether an answer was found,
"page_num": page number,
"region": reference to this region,
"source_elements": list of elements that contain the answer (if found)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>], <span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">question</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
    <span class="n">min_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask a question about the region content using document QA.</span>

<span class="sd">    This method uses a document question answering model to extract answers from the region content.</span>
<span class="sd">    It leverages both textual content and layout information for better understanding.</span>

<span class="sd">    Args:</span>
<span class="sd">        question: The question to ask about the region content</span>
<span class="sd">        min_confidence: Minimum confidence threshold for answers (0.0-1.0)</span>
<span class="sd">        model: Optional model name to use for QA (if None, uses default model)</span>
<span class="sd">        **kwargs: Additional parameters to pass to the QA engine</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with answer details: {</span>
<span class="sd">            &quot;answer&quot;: extracted text,</span>
<span class="sd">            &quot;confidence&quot;: confidence score,</span>
<span class="sd">            &quot;found&quot;: whether an answer was found,</span>
<span class="sd">            &quot;page_num&quot;: page number,</span>
<span class="sd">            &quot;region&quot;: reference to this region,</span>
<span class="sd">            &quot;source_elements&quot;: list of elements that contain the answer (if found)</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.qa.document_qa</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qa_engine</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Question answering requires optional dependencies. Install with `pip install natural-pdf[ai]`&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Get or initialize QA engine with specified model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">qa_engine</span> <span class="o">=</span> <span class="n">get_qa_engine</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="n">get_qa_engine</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize QA engine (model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Ask the question using the QA engine</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qa_engine</span><span class="o">.</span><span class="n">ask_pdf_region</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during qa_engine.ask_pdf_region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="s2">&quot;source_elements&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.below" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">below</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">include_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Select region below this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height of the region below, in points</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width mode - "full" for full page width or "element" for element width</p>
              </div>
            </td>
            <td>
                  <code>&#39;full&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_source</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include this region in the result (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>until</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector string to specify a lower boundary element</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_endpoint</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include the boundary element in the region (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object representing the area below</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">below</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
    <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select region below this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        height: Height of the region below, in points</span>
<span class="sd">        width: Width mode - &quot;full&quot; for full page width or &quot;element&quot; for element width</span>
<span class="sd">        include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">        until: Optional selector string to specify a lower boundary element</span>
<span class="sd">        include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">        **kwargs: Additional parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object representing the area below</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;below&quot;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">cross_size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
        <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.clip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Clip this region to specific bounds, either from another object with bbox or explicit coordinates.</p>
<p>The clipped region will be constrained to not exceed the specified boundaries.
You can provide either an object with bounding box properties, specific coordinates, or both.
When both are provided, explicit coordinates take precedence.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>obj</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional object with bbox properties (Region, Element, TextElement, etc.)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional left boundary (x0) to clip to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional top boundary to clip to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional right boundary (x1) to clip to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bottom</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional bottom boundary to clip to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New Region with bounds clipped to the specified constraints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <h6 id="natural_pdf.Region.clip--clip-to-another-regions-bounds">Clip to another region's bounds</h6>
<p>clipped = region.clip(container_region)</p>
<h6 id="natural_pdf.Region.clip--clip-to-any-elements-bounds">Clip to any element's bounds</h6>
<p>clipped = region.clip(text_element)</p>
<h6 id="natural_pdf.Region.clip--clip-to-specific-coordinates">Clip to specific coordinates</h6>
<p>clipped = region.clip(left=100, right=400)</p>
<h6 id="natural_pdf.Region.clip--mix-object-bounds-with-specific-overrides">Mix object bounds with specific overrides</h6>
<p>clipped = region.clip(obj=container, bottom=page.height/2)</p>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">top</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bottom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip this region to specific bounds, either from another object with bbox or explicit coordinates.</span>

<span class="sd">    The clipped region will be constrained to not exceed the specified boundaries.</span>
<span class="sd">    You can provide either an object with bounding box properties, specific coordinates, or both.</span>
<span class="sd">    When both are provided, explicit coordinates take precedence.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: Optional object with bbox properties (Region, Element, TextElement, etc.)</span>
<span class="sd">        left: Optional left boundary (x0) to clip to</span>
<span class="sd">        top: Optional top boundary to clip to</span>
<span class="sd">        right: Optional right boundary (x1) to clip to</span>
<span class="sd">        bottom: Optional bottom boundary to clip to</span>

<span class="sd">    Returns:</span>
<span class="sd">        New Region with bounds clipped to the specified constraints</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Clip to another region&#39;s bounds</span>
<span class="sd">        clipped = region.clip(container_region)</span>

<span class="sd">        # Clip to any element&#39;s bounds</span>
<span class="sd">        clipped = region.clip(text_element)</span>

<span class="sd">        # Clip to specific coordinates</span>
<span class="sd">        clipped = region.clip(left=100, right=400)</span>

<span class="sd">        # Mix object bounds with specific overrides</span>
<span class="sd">        clipped = region.clip(obj=container, bottom=page.height/2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_bbox</span>

    <span class="c1"># Start with current region bounds</span>
    <span class="n">clip_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
    <span class="n">clip_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
    <span class="n">clip_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
    <span class="n">clip_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>

    <span class="c1"># Apply object constraints if provided</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj_bbox</span> <span class="o">=</span> <span class="n">extract_bbox</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj_bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj_x0</span><span class="p">,</span> <span class="n">obj_top</span><span class="p">,</span> <span class="n">obj_x1</span><span class="p">,</span> <span class="n">obj_bottom</span> <span class="o">=</span> <span class="n">obj_bbox</span>
            <span class="c1"># Constrain to the intersection with the provided object</span>
            <span class="n">clip_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">obj_x0</span><span class="p">)</span>
            <span class="n">clip_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_top</span><span class="p">,</span> <span class="n">obj_top</span><span class="p">)</span>
            <span class="n">clip_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_x1</span><span class="p">,</span> <span class="n">obj_x1</span><span class="p">)</span>
            <span class="n">clip_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_bottom</span><span class="p">,</span> <span class="n">obj_bottom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Cannot extract bbox from clipping object </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Object must have bbox property or x0/top/x1/bottom attributes.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Apply explicit coordinate constraints (these take precedence)</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clip_top</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_x1</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clip_bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">)</span>

    <span class="c1"># Ensure valid coordinates</span>
    <span class="k">if</span> <span class="n">clip_x1</span> <span class="o">&lt;=</span> <span class="n">clip_x0</span> <span class="ow">or</span> <span class="n">clip_bottom</span> <span class="o">&lt;=</span> <span class="n">clip_top</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Clipping resulted in invalid dimensions &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">clip_x0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_top</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_x1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">clip_bottom</span><span class="si">}</span><span class="s2">). Returning minimal region.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Return a minimal region at the clip area&#39;s top-left</span>
        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">,</span> <span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">))</span>

    <span class="c1"># Create the clipped region</span>
    <span class="n">clipped_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_x0</span><span class="p">,</span> <span class="n">clip_top</span><span class="p">,</span> <span class="n">clip_x1</span><span class="p">,</span> <span class="n">clip_bottom</span><span class="p">))</span>

    <span class="c1"># Copy relevant metadata</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;clipped&quot;</span>  <span class="c1"># Indicate this is a derived region</span>
    <span class="n">clipped_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Clipped to </span><span class="si">{</span><span class="n">clipped_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(constraints: obj=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;left=</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">, top=</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s2">, right=</span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">, bottom=</span><span class="si">{</span><span class="n">bottom</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">clipped_region</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.contains" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Check if this region completely contains an element.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>element</code>
            </td>
            <td>
                  <code><span title="natural_pdf.elements.base.Element">Element</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element to check</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the element is completely contained within the region, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if this region completely contains an element.</span>

<span class="sd">    Args:</span>
<span class="sd">        element: Element to check</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the element is completely contained within the region, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if element is on the same page</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Ensure element has necessary attributes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

    <span class="c1"># For rectangular regions, check if element&#39;s bbox is fully inside region&#39;s bbox</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
        <span class="p">)</span>

    <span class="c1"># For polygon regions, check if all corners of the element are inside the polygon</span>
    <span class="n">element_corners</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-left</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-right</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-right</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-left</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">element_corners</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.correct_ocr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">correct_ocr</span><span class="p">(</span><span class="n">correction_callback</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Applies corrections to OCR-generated text elements within this region
using a user-provided callback function.</p>
<p>Finds text elements within this region whose 'source' attribute starts
with 'ocr' and calls the <code>correction_callback</code> for each, passing the
element itself.</p>
<p>The <code>correction_callback</code> should contain the logic to:
1. Determine if the element needs correction.
2. Perform the correction (e.g., call an LLM).
3. Return the new text (<code>str</code>) or <code>None</code>.</p>
<p>If the callback returns a string, the element's <code>.text</code> is updated.
Metadata updates (source, confidence, etc.) should happen within the callback.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>correction_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function accepting an element and returning
                 <code>Optional[str]</code> (new text or None).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_ocr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">correction_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>  <span class="c1"># Return self for chaining</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies corrections to OCR-generated text elements within this region</span>
<span class="sd">    using a user-provided callback function.</span>

<span class="sd">    Finds text elements within this region whose &#39;source&#39; attribute starts</span>
<span class="sd">    with &#39;ocr&#39; and calls the `correction_callback` for each, passing the</span>
<span class="sd">    element itself.</span>

<span class="sd">    The `correction_callback` should contain the logic to:</span>
<span class="sd">    1. Determine if the element needs correction.</span>
<span class="sd">    2. Perform the correction (e.g., call an LLM).</span>
<span class="sd">    3. Return the new text (`str`) or `None`.</span>

<span class="sd">    If the callback returns a string, the element&#39;s `.text` is updated.</span>
<span class="sd">    Metadata updates (source, confidence, etc.) should happen within the callback.</span>

<span class="sd">    Args:</span>
<span class="sd">        correction_callback: A function accepting an element and returning</span>
<span class="sd">                             `Optional[str]` (new text or None).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find OCR elements specifically within this region</span>
    <span class="c1"># Note: We typically want to correct even if the element falls in an excluded area</span>
    <span class="n">target_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;text[source=ocr]&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Delegate to the utility function</span>
    <span class="n">_apply_ocr_correction_to_elements</span><span class="p">(</span>
        <span class="n">elements</span><span class="o">=</span><span class="n">target_elements</span><span class="p">,</span>  <span class="c1"># Pass the ElementCollection directly</span>
        <span class="n">correction_callback</span><span class="o">=</span><span class="n">correction_callback</span><span class="p">,</span>
        <span class="n">caller_info</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Region(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>  <span class="c1"># Pass caller info</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.create_cells" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">create_cells</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Create cell regions for a detected table by intersecting its
row and column regions, and add them to the page.</p>
<p>Assumes child row and column regions are already present on the page.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create cell regions for a detected table by intersecting its</span>
<span class="sd">    row and column regions, and add them to the page.</span>

<span class="sd">    Assumes child row and column regions are already present on the page.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure this is called on a table region</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tableofcontents&quot;</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># Allow for ToC which might have structure</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;create_cells should be called on a &#39;table&#39; or &#39;tableofcontents&#39; region, not &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Find rows and columns associated with this page</span>
    <span class="c1"># Remove the model-specific filter</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table-row]&quot;</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;region[type=table-column]&quot;</span><span class="p">)</span>

    <span class="c1"># Filter to only include those that overlap with this table region</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_in_table</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="c1"># Use a simple overlap check (more robust than just center point)</span>
        <span class="c1"># Check if element&#39;s bbox overlaps with self.bbox</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>  <span class="c1"># Ensure element has bbox</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
            <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
        <span class="p">)</span>

    <span class="n">table_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="n">table_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">is_in_table</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_rows</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">table_columns</span><span class="p">:</span>
        <span class="c1"># Use page&#39;s logger if available</span>
        <span class="n">logger_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="n">logger_instance</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Cannot create cells. No overlapping row or column regions found.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self even if no cells created</span>

    <span class="c1"># Sort rows and columns</span>
    <span class="n">table_rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
    <span class="n">table_columns</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>

    <span class="c1"># Create cells and add them to the page&#39;s element manager</span>
    <span class="n">created_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table_rows</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">:</span>
            <span class="c1"># Calculate intersection bbox for the cell</span>
            <span class="n">cell_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>
            <span class="n">cell_y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
            <span class="n">cell_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">cell_y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

            <span class="c1"># Only create a cell if the intersection is valid (positive width/height)</span>
            <span class="k">if</span> <span class="n">cell_x1</span> <span class="o">&gt;</span> <span class="n">cell_x0</span> <span class="ow">and</span> <span class="n">cell_y1</span> <span class="o">&gt;</span> <span class="n">cell_y0</span><span class="p">:</span>
                <span class="c1"># Create cell region at the intersection</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">create_region</span><span class="p">(</span><span class="n">cell_x0</span><span class="p">,</span> <span class="n">cell_y0</span><span class="p">,</span> <span class="n">cell_x1</span><span class="p">,</span> <span class="n">cell_y1</span><span class="p">)</span>
                <span class="c1"># Set metadata</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;derived&quot;</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>  <span class="c1"># Explicitly set type</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>  <span class="c1"># And normalized type</span>
                <span class="c1"># Inherit model from the parent table region</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Link cell to parent table region</span>

                <span class="c1"># Add the cell region to the page&#39;s element manager</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_region</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">created_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Optional: Add created cells to the table region&#39;s children</span>
    <span class="c1"># self.child_regions.extend(cells_created_in_this_call) # Needs list management</span>

    <span class="n">logger_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
    <span class="n">logger_instance</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> (Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">): Created and added </span><span class="si">{</span><span class="n">created_count</span><span class="si">}</span><span class="s2"> cell regions.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self for chaining</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.extract_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ocr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ocr_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_extraction_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract a table from this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method to use: 'tatr', 'pdfplumber', 'text', 'stream', 'lattice', or None (auto-detect).
    'stream' is an alias for 'pdfplumber' with text-based strategies (equivalent to
    setting <code>vertical_strategy</code> and <code>horizontal_strategy</code> to 'text').
    'lattice' is an alias for 'pdfplumber' with line-based strategies (equivalent to
    setting <code>vertical_strategy</code> and <code>horizontal_strategy</code> to 'lines').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_settings</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Settings for pdfplumber table extraction (used with 'pdfplumber', 'stream', or 'lattice' methods).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ocr</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use OCR for text extraction (currently only applicable with 'tatr' method).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ocr_config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OCR configuration parameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_options</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of options for the 'text' method, corresponding to arguments
          of analyze_text_table_structure (e.g., snap_tolerance, expand_bbox).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cell_extraction_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable function that takes a cell Region object
                  and returns its string content. Overrides default text extraction
                  for the 'text' method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, display a progress bar during cell text extraction for the 'text' method.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.tables.TableResult">TableResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Table data as a list of rows, where each row is a list of cell values (str or None).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_table</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Make method optional</span>
    <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use Optional</span>
    <span class="n">use_ocr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ocr_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use Optional</span>
    <span class="n">text_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell_extraction_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># --- NEW: Add tqdm control option --- #</span>
    <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Controls progress bar for text method</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableResult</span><span class="p">:</span>  <span class="c1"># Return type allows Optional[str] for cells</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract a table from this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        method: Method to use: &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                &#39;stream&#39; is an alias for &#39;pdfplumber&#39; with text-based strategies (equivalent to</span>
<span class="sd">                setting `vertical_strategy` and `horizontal_strategy` to &#39;text&#39;).</span>
<span class="sd">                &#39;lattice&#39; is an alias for &#39;pdfplumber&#39; with line-based strategies (equivalent to</span>
<span class="sd">                setting `vertical_strategy` and `horizontal_strategy` to &#39;lines&#39;).</span>
<span class="sd">        table_settings: Settings for pdfplumber table extraction (used with &#39;pdfplumber&#39;, &#39;stream&#39;, or &#39;lattice&#39; methods).</span>
<span class="sd">        use_ocr: Whether to use OCR for text extraction (currently only applicable with &#39;tatr&#39; method).</span>
<span class="sd">        ocr_config: OCR configuration parameters.</span>
<span class="sd">        text_options: Dictionary of options for the &#39;text&#39; method, corresponding to arguments</span>
<span class="sd">                      of analyze_text_table_structure (e.g., snap_tolerance, expand_bbox).</span>
<span class="sd">        cell_extraction_func: Optional callable function that takes a cell Region object</span>
<span class="sd">                              and returns its string content. Overrides default text extraction</span>
<span class="sd">                              for the &#39;text&#39; method.</span>
<span class="sd">        show_progress: If True, display a progress bar during cell text extraction for the &#39;text&#39; method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table data as a list of rows, where each row is a list of cell values (str or None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default settings if none provided</span>
    <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">text_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">text_options</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Initialize empty dict</span>

    <span class="c1"># Auto-detect method if not specified</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If this is a TATR-detected region, use TATR method</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;tatr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
            <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;tatr&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try lattice first, then fall back to stream if no meaningful results</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Auto-detecting table extraction method...&quot;</span><span class="p">)</span>

            <span class="c1"># --- NEW: Prefer already-created table_cell regions if they exist --- #</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cell_regions_in_table</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="s2">&quot;region[type=table_cell]&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_cells_err</span><span class="p">:</span>
                <span class="n">cell_regions_in_table</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Fallback silently</span>

            <span class="k">if</span> <span class="n">cell_regions_in_table</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_regions_in_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> pre-computed table_cell regions  using &#39;cells&#39; method.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">TableResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_from_cells</span><span class="p">(</span><span class="n">cell_regions_in_table</span><span class="p">))</span>

            <span class="c1"># --------------------------------------------------------------- #</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first...&quot;</span><span class="p">)</span>
                <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span>
                    <span class="s2">&quot;lattice&quot;</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c1"># Check if lattice found meaningful content</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">lattice_result</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">lattice_result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful content&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Fall back to stream</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="c1"># Handle method aliases for pdfplumber</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="c1"># Set default text strategies if not already provided by the user</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
        <span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="c1"># Set default line strategies if not already provided by the user</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------</span>
    <span class="c1"># Auto-inject tolerances when text-based strategies are requested.</span>
    <span class="c1"># This must happen AFTER alias handling (so strategies are final)</span>
    <span class="c1"># and BEFORE we delegate to _extract_table_* helpers.</span>
    <span class="c1"># -------------------------------------------------------------</span>
    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">),</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="n">page_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Ensure text_* tolerances passed to pdfplumber</span>
        <span class="k">if</span> <span class="s2">&quot;text_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;text_x_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_cfg</span><span class="p">[</span><span class="s2">&quot;x_tolerance&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;text_y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;y_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;text_y_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_cfg</span><span class="p">[</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">]</span>

        <span class="c1"># Snap / join tolerances (~ line spacing)</span>
        <span class="k">if</span> <span class="s2">&quot;snap_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;snap_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">page_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_tolerance&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">))</span>
            <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snap</span>
        <span class="k">if</span> <span class="s2">&quot;join_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span> <span class="ow">and</span> <span class="s2">&quot;join_x_tolerance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_settings</span><span class="p">:</span>
            <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;join_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_settings</span><span class="p">[</span><span class="s2">&quot;snap_tolerance&quot;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Extracting table using method &#39;</span><span class="si">{</span><span class="n">effective_method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Use the selected method</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;tatr&quot;</span><span class="p">:</span>
        <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_tatr</span><span class="p">(</span><span class="n">use_ocr</span><span class="o">=</span><span class="n">use_ocr</span><span class="p">,</span> <span class="n">ocr_config</span><span class="o">=</span><span class="n">ocr_config</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
        <span class="n">current_text_options</span> <span class="o">=</span> <span class="n">text_options</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">current_text_options</span><span class="p">[</span><span class="s2">&quot;cell_extraction_func&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_extraction_func</span>
        <span class="n">current_text_options</span><span class="p">[</span><span class="s2">&quot;show_progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_text</span><span class="p">(</span><span class="o">**</span><span class="n">current_text_options</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
        <span class="n">table_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_table_plumber</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown table extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;tatr&#39;, &#39;pdfplumber&#39;, &#39;text&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">TableResult</span><span class="p">(</span><span class="n">table_rows</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.extract_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">extract_tables</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract all tables from this region using pdfplumber-based methods.</p>
<p>Note: Only 'pdfplumber', 'stream', and 'lattice' methods are supported for extract_tables.
'tatr' and 'text' methods are designed for single table extraction only.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method to use: 'pdfplumber', 'stream', 'lattice', or None (auto-detect).
    'stream' uses text-based strategies, 'lattice' uses line-based strategies.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_settings</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Settings for pdfplumber table extraction.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tables, where each table is a list of rows, and each row is a list of cell values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_tables</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">table_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract all tables from this region using pdfplumber-based methods.</span>

<span class="sd">    Note: Only &#39;pdfplumber&#39;, &#39;stream&#39;, and &#39;lattice&#39; methods are supported for extract_tables.</span>
<span class="sd">    &#39;tatr&#39; and &#39;text&#39; methods are designed for single table extraction only.</span>

<span class="sd">    Args:</span>
<span class="sd">        method: Method to use: &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;, or None (auto-detect).</span>
<span class="sd">                &#39;stream&#39; uses text-based strategies, &#39;lattice&#39; uses line-based strategies.</span>
<span class="sd">        table_settings: Settings for pdfplumber table extraction.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of tables, where each table is a list of rows, and each row is a list of cell values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">table_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Auto-detect method if not specified (try lattice first, then stream)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Auto-detecting tables extraction method...&quot;</span><span class="p">)</span>

        <span class="c1"># Try lattice first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lattice_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
            <span class="n">lattice_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trying &#39;lattice&#39; method first for tables...&quot;</span><span class="p">)</span>
            <span class="n">lattice_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">lattice_settings</span><span class="p">)</span>

            <span class="c1"># Check if lattice found meaningful tables</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">lattice_result</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">cell</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span>
                        <span class="k">if</span> <span class="n">table</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">lattice_result</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice_result</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">lattice_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method found no meaningful tables&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: &#39;lattice&#39; method failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fall back to stream</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Falling back to &#39;stream&#39; method for tables...&quot;</span><span class="p">)</span>
        <span class="n">stream_settings</span> <span class="o">=</span> <span class="n">table_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">stream_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">stream_settings</span><span class="p">)</span>

    <span class="n">effective_method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="c1"># Handle method aliases</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using &#39;stream&#39; method alias for &#39;pdfplumber&#39; with text-based strategies.&quot;</span><span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;lattice&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Using &#39;lattice&#39; method alias for &#39;pdfplumber&#39; with line-based strategies.&quot;</span>
        <span class="p">)</span>
        <span class="n">effective_method</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber&quot;</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;vertical_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;horizontal_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">)</span>

    <span class="c1"># Use the selected method</span>
    <span class="k">if</span> <span class="n">effective_method</span> <span class="o">==</span> <span class="s2">&quot;pdfplumber&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tables_plumber</span><span class="p">(</span><span class="n">table_settings</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown tables extraction method: &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;. Choose from &#39;pdfplumber&#39;, &#39;stream&#39;, &#39;lattice&#39;.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.extract_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Extract text from this region, respecting page exclusions and using pdfplumber's
layout engine (chars_to_textmap).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions defined on the parent page.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable verbose debugging output for filtering steps.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional layout parameters passed directly to pdfplumber's
      <code>chars_to_textmap</code> function (e.g., layout, x_density, y_density).
      See Page.extract_text docstring for more.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extracted text as string, potentially with layout-based spacing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract text from this region, respecting page exclusions and using pdfplumber&#39;s</span>
<span class="sd">    layout engine (chars_to_textmap).</span>

<span class="sd">    Args:</span>
<span class="sd">        apply_exclusions: Whether to apply exclusion regions defined on the parent page.</span>
<span class="sd">        debug: Enable verbose debugging output for filtering steps.</span>
<span class="sd">        **kwargs: Additional layout parameters passed directly to pdfplumber&#39;s</span>
<span class="sd">                  `chars_to_textmap` function (e.g., layout, x_density, y_density).</span>
<span class="sd">                  See Page.extract_text docstring for more.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Extracted text as string, potentially with layout-based spacing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allow &#39;debug_exclusions&#39; for backward compatibility</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">debug</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_exclusions&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: extract_text called with kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Get Word Elements potentially within this region (initial broad phase)</span>
    <span class="c1"># Optimization: Could use spatial query if page elements were indexed</span>
    <span class="n">page_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">words</span>  <span class="c1"># Get all words from the page</span>

    <span class="c1"># 2. Gather all character dicts from words potentially in region</span>
    <span class="c1"># We filter precisely in filter_chars_spatially</span>
    <span class="n">all_char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">page_words</span><span class="p">:</span>
        <span class="c1"># Quick bbox check to avoid processing words clearly outside</span>
        <span class="k">if</span> <span class="n">get_bbox_overlap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="n">word</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_char_dicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;_char_dicts&quot;</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_char_dicts</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No character dicts found overlapping region bbox.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># 3. Get Relevant Exclusions (overlapping this region)</span>
    <span class="n">apply_exclusions_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apply_exclusions&quot;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">)</span>
    <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">apply_exclusions_flag</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
        <span class="n">all_page_exclusions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_get_exclusion_regions</span><span class="p">(</span>
            <span class="n">include_callable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
        <span class="p">)</span>
        <span class="n">overlapping_exclusions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">excl</span> <span class="ow">in</span> <span class="n">all_page_exclusions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_bbox_overlap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="n">excl</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">overlapping_exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>
        <span class="n">exclusion_regions</span> <span class="o">=</span> <span class="n">overlapping_exclusions</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Applying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclusion_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> overlapping exclusions.&quot;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Not applying exclusions.&quot;</span><span class="p">)</span>

    <span class="c1"># 4. Spatially Filter Characters using Utility</span>
    <span class="c1"># Pass self as the target_region for precise polygon checks etc.</span>
    <span class="n">filtered_chars</span> <span class="o">=</span> <span class="n">filter_chars_spatially</span><span class="p">(</span>
        <span class="n">char_dicts</span><span class="o">=</span><span class="n">all_char_dicts</span><span class="p">,</span>
        <span class="n">exclusion_regions</span><span class="o">=</span><span class="n">exclusion_regions</span><span class="p">,</span>
        <span class="n">target_region</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># Pass self!</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 5. Generate Text Layout using Utility</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">generate_text_layout</span><span class="p">(</span>
        <span class="n">char_dicts</span><span class="o">=</span><span class="n">filtered_chars</span><span class="p">,</span>
        <span class="n">layout_context_bbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span>  <span class="c1"># Use region&#39;s bbox for context</span>
        <span class="n">user_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># Pass original kwargs to layout generator</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: extract_text finished, result length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.find" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find the first element in this region matching the selector OR text content.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>contains</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to determine if elements are inside: 'all' (fully inside),
     'any' (any overlap), or 'center' (center point inside).
     (default: "all")</p>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for element filtering.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="natural_pdf.elements.base.Element">Element</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First matching element or None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
    <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># New parameter for containment behavior</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the first element in this region matching the selector OR text content.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        contains: How to determine if elements are inside: &#39;all&#39; (fully inside),</span>
<span class="sd">                 &#39;any&#39; (any overlap), or &#39;center&#39; (center point inside).</span>
<span class="sd">                 (default: &quot;all&quot;)</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional parameters for element filtering.</span>

<span class="sd">    Returns:</span>
<span class="sd">        First matching element or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delegate validation and selector construction to find_all</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
        <span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
        <span class="n">contains</span><span class="o">=</span><span class="n">contains</span><span class="p">,</span>
        <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
        <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
        <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">first</span> <span class="k">if</span> <span class="n">elements</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.find_all" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_all</span><span class="p">(</span><span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementCollection</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <p>Find all elements in this region matching the selector OR text content.</p>
<p>Provide EITHER <code>selector</code> OR <code>text</code>, but not both.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CSS-like selector string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text content to search for (equivalent to 'text:contains(...)').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>contains</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to determine if elements are inside: 'all' (fully inside),
     'any' (any overlap), or 'center' (center point inside).
     (default: "all")</p>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to exclude elements in exclusion regions (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>regex</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use regex for text search (<code>selector</code> or <code>text</code>) (default: False).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>case</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to do case-sensitive text search (<code>selector</code> or <code>text</code>) (default: True).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for element filtering.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ElementCollection with matching elements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_all</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Now optional</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># New text parameter</span>
    <span class="n">contains</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># New parameter to control inside/overlap behavior</span>
    <span class="n">apply_exclusions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">case</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all elements in this region matching the selector OR text content.</span>

<span class="sd">    Provide EITHER `selector` OR `text`, but not both.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: CSS-like selector string.</span>
<span class="sd">        text: Text content to search for (equivalent to &#39;text:contains(...)&#39;).</span>
<span class="sd">        contains: How to determine if elements are inside: &#39;all&#39; (fully inside),</span>
<span class="sd">                 &#39;any&#39; (any overlap), or &#39;center&#39; (center point inside).</span>
<span class="sd">                 (default: &quot;all&quot;)</span>
<span class="sd">        apply_exclusions: Whether to exclude elements in exclusion regions (default: True).</span>
<span class="sd">        regex: Whether to use regex for text search (`selector` or `text`) (default: False).</span>
<span class="sd">        case: Whether to do case-sensitive text search (`selector` or `text`) (default: True).</span>
<span class="sd">        **kwargs: Additional parameters for element filtering.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ElementCollection with matching elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;, not both.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either &#39;selector&#39; or &#39;text&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Validate contains parameter</span>
    <span class="k">if</span> <span class="n">contains</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid contains value: </span><span class="si">{</span><span class="n">contains</span><span class="si">}</span><span class="s2">. Must be &#39;all&#39;, &#39;any&#39;, or &#39;center&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Construct selector if &#39;text&#39; is provided</span>
    <span class="n">effective_selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;text:contains(&quot;</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using text shortcut: find_all(text=&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;) -&gt; find_all(&#39;</span><span class="si">{</span><span class="n">effective_selector</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_selector</span> <span class="o">=</span> <span class="n">selector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: No selector or text provided.&quot;</span><span class="p">)</span>

    <span class="c1"># Normal case: Region is on a single page</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse the final selector string</span>
        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">effective_selector</span><span class="p">)</span>

        <span class="c1"># Get all potentially relevant elements from the page</span>
        <span class="c1"># Let the page handle its exclusion logic if needed</span>
        <span class="n">potential_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="n">selector</span><span class="o">=</span><span class="n">effective_selector</span><span class="p">,</span>
            <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
            <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Filter these elements based on the specified containment method</span>
        <span class="n">region_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>
        <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>  <span class="c1"># Fully inside (strict)</span>
            <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">el</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">top</span> <span class="o">&gt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">x1</span> <span class="o">&lt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="n">region_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>  <span class="c1"># Any overlap</span>
            <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">el</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">contains</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>  <span class="c1"># Center point inside</span>
            <span class="n">matching_elements</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">potential_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_element_center_inside</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">matching_elements</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during find_all in region: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_children" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get immediate child regions, optionally filtered by selector.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector to filter children</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of child regions matching the selector</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get immediate child regions, optionally filtered by selector.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: Optional selector to filter children</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of child regions matching the selector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;natural_pdf.elements.region&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span>

    <span class="c1"># Use existing selector parser to filter</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">)</span>  <span class="c1"># Removed region=self</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">child</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;get_children: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> children matching &#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">matched</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying selector in get_children: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list on error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_descendants" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get all descendant regions (children, grandchildren, etc.), optionally filtered by selector.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector to filter descendants</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of descendant regions matching the selector</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_descendants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all descendant regions (children, grandchildren, etc.), optionally filtered by selector.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: Optional selector to filter descendants</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of descendant regions matching the selector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;natural_pdf.elements.region&quot;</span><span class="p">)</span>

    <span class="n">all_descendants</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span>  <span class="c1"># Start with direct children</span>

    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_descendants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="c1"># Add current&#39;s children to the queue for processing</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;child_regions&quot;</span><span class="p">):</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">child_regions</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_descendants: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_descendants</span><span class="p">)</span><span class="si">}</span><span class="s2"> total descendants&quot;</span><span class="p">)</span>

    <span class="c1"># Filter by selector if provided</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selector_obj</span> <span class="o">=</span> <span class="n">parse_selector</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
            <span class="n">filter_func</span> <span class="o">=</span> <span class="n">selector_to_filter_func</span><span class="p">(</span><span class="n">selector_obj</span><span class="p">)</span>  <span class="c1"># Removed region=self</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">all_descendants</span> <span class="k">if</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">desc</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_descendants: filtered to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching &#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matched</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying selector in get_descendants: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list on error</span>

    <span class="k">return</span> <span class="n">all_descendants</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_elements</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get all elements within this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>selector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector to filter elements</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_exclusions</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply exclusion regions</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for element filtering</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="natural_pdf.elements.base.Element">Element</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of elements in the region</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_elements</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all elements within this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        selector: Optional selector to filter elements</span>
<span class="sd">        apply_exclusions: Whether to apply exclusion regions</span>
<span class="sd">        **kwargs: Additional parameters for element filtering</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of elements in the region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
        <span class="c1"># Find elements on the page matching the selector</span>
        <span class="n">page_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="n">selector</span><span class="p">,</span> <span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># Filter those elements to only include ones within this region</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">page_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element_in_region</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get all elements from the page</span>
        <span class="n">page_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">get_elements</span><span class="p">(</span><span class="n">apply_exclusions</span><span class="o">=</span><span class="n">apply_exclusions</span><span class="p">)</span>
        <span class="c1"># Filter to elements in this region</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">page_elements</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element_in_region</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_section_between" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get a section between two elements within this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start_element</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element marking the start of the section</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_element</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element marking the end of the section</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary_inclusion</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to include boundary elements: 'start', 'end', 'both', or 'none'</p>
              </div>
            </td>
            <td>
                  <code>&#39;both&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region representing the section</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_section_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a section between two elements within this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_element: Element marking the start of the section</span>
<span class="sd">        end_element: Element marking the end of the section</span>
<span class="sd">        boundary_inclusion: How to include boundary elements: &#39;start&#39;, &#39;end&#39;, &#39;both&#39;, or &#39;none&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region representing the section</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get elements only within this region first</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>

    <span class="c1"># If no elements, return self or empty region?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;get_section_between called on region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> with no contained elements.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Return an empty region at the start of the parent region</span>
        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">))</span>

    <span class="c1"># Sort elements in reading order</span>
    <span class="n">elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>

    <span class="c1"># Find start index</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">start_element</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_element</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Start element not in region, use first element</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start element not found in region, using first element.&quot;</span><span class="p">)</span>
            <span class="n">start_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Use the actual first element</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Default start is first element</span>

    <span class="c1"># Find end index</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">end_element</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end_element</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># End element not in region, use last element</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;End element not found in region, using last element.&quot;</span><span class="p">)</span>
            <span class="n">end_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use the actual last element</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end_element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Default end is last element</span>

    <span class="c1"># Adjust indexes based on boundary inclusion</span>
    <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">start_element</span>
    <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">end_element</span>

    <span class="k">if</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end_idx</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
        <span class="n">end_idx</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">end_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">boundary_inclusion</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
        <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start_element_for_bbox</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Ensure valid indexes</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">)</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span>

    <span class="c1"># If no valid elements in range, return empty region</span>
    <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="n">end_idx</span> <span class="ow">or</span> <span class="n">start_element_for_bbox</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end_element_for_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No valid elements in range for get_section_between.&quot;</span><span class="p">)</span>
        <span class="c1"># Return an empty region positioned at the start element boundary</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="n">start_element</span> <span class="k">if</span> <span class="n">start_element</span> <span class="k">else</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">anchor</span><span class="o">.</span><span class="n">top</span><span class="p">))</span>

    <span class="c1"># Get elements in range based on adjusted indices</span>
    <span class="n">section_elements</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Create bounding box around the ELEMENTS included based on indices</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x0</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">bottom</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">section_elements</span><span class="p">)</span>

    <span class="c1"># Create new region</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>
    <span class="c1"># Store the original boundary elements for reference</span>
    <span class="n">section</span><span class="o">.</span><span class="n">start_element</span> <span class="o">=</span> <span class="n">start_element</span>
    <span class="n">section</span><span class="o">.</span><span class="n">end_element</span> <span class="o">=</span> <span class="n">end_element</span>

    <span class="k">return</span> <span class="n">section</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_sections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Get sections within this region based on start/end elements.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start_elements</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Elements or selector string that mark the start of sections</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_elements</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Elements or selector string that mark the end of sections</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary_inclusion</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to include boundary elements: 'start', 'end', 'both', or 'none'</p>
              </div>
            </td>
            <td>
                  <code>&#39;both&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Region objects representing the extracted sections</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_sections</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">start_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_elements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="o">=</span><span class="s2">&quot;both&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get sections within this region based on start/end elements.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_elements: Elements or selector string that mark the start of sections</span>
<span class="sd">        end_elements: Elements or selector string that mark the end of sections</span>
<span class="sd">        boundary_inclusion: How to include boundary elements: &#39;start&#39;, &#39;end&#39;, &#39;both&#39;, or &#39;none&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of Region objects representing the extracted sections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

    <span class="c1"># Process string selectors to find elements WITHIN THIS REGION</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">start_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">start_elements</span><span class="p">)</span>  <span class="c1"># Use region&#39;s find_all</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
            <span class="n">start_elements</span> <span class="o">=</span> <span class="n">start_elements</span><span class="o">.</span><span class="n">elements</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">end_elements</span><span class="p">)</span>  <span class="c1"># Use region&#39;s find_all</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;elements&quot;</span><span class="p">):</span>
            <span class="n">end_elements</span> <span class="o">=</span> <span class="n">end_elements</span><span class="o">.</span><span class="n">elements</span>

    <span class="c1"># Ensure start_elements is a list (or similar iterable)</span>
    <span class="k">if</span> <span class="n">start_elements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_elements</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;get_sections requires valid start_elements (selector or list). Returning empty.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Ensure end_elements is a list if provided</span>
    <span class="k">if</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end_elements</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;end_elements must be iterable if provided. Ignoring.&quot;</span><span class="p">)</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">end_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end_elements</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># If no start elements found within the region, return empty list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">start_elements</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Sort all elements within the region in reading order</span>
    <span class="n">all_elements_in_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
    <span class="n">all_elements_in_region</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_elements_in_region</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Cannot create sections if region is empty</span>

    <span class="c1"># Map elements to their indices in the sorted list</span>
    <span class="n">element_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_elements_in_region</span><span class="p">)}</span>

    <span class="c1"># Mark section boundaries using indices from the sorted list</span>
    <span class="n">section_boundaries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Add start element indexes</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">start_elements</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">element_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">section_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
        <span class="c1"># else: Element found by selector might not be geometrically in region? Log warning?</span>

    <span class="c1"># Add end element indexes if provided</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">end_elements</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">element_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">section_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span>

    <span class="c1"># Sort boundaries by index (document order within the region)</span>
    <span class="n">section_boundaries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

    <span class="c1"># Generate sections</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">section_boundaries</span><span class="p">):</span>
        <span class="c1"># If it&#39;s a start boundary and we don&#39;t have a current start</span>
        <span class="k">if</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span> <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="n">boundary</span>

        <span class="c1"># If it&#39;s an end boundary and we have a current start</span>
        <span class="k">elif</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a section from current_start to this boundary</span>
            <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="n">end_element</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="c1"># Use the helper, ensuring elements are from within the region</span>
            <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="p">)</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Reset</span>

        <span class="c1"># If it&#39;s another start boundary and we have a current start (split by starts only)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span>
            <span class="ow">and</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">end_elements</span>
        <span class="p">):</span>
            <span class="c1"># End the previous section just before this start boundary</span>
            <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="c1"># Find the element immediately preceding this start in the sorted list</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">end_idx</span> <span class="o">&gt;=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]:</span>
                <span class="n">end_element</span> <span class="o">=</span> <span class="n">all_elements_in_region</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span>
                <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span>
                    <span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span>
                <span class="p">)</span>
                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="c1"># Else: Section started and ended by consecutive start elements? Create empty?</span>
            <span class="c1"># For now, just reset and start new section</span>

            <span class="c1"># Start the new section</span>
            <span class="n">current_start_boundary</span> <span class="o">=</span> <span class="n">boundary</span>

    <span class="c1"># Handle the last section if we have a current start</span>
    <span class="k">if</span> <span class="n">current_start_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_element</span> <span class="o">=</span> <span class="n">current_start_boundary</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="c1"># End at the last element within the region</span>
        <span class="n">end_element</span> <span class="o">=</span> <span class="n">all_elements_in_region</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_between</span><span class="p">(</span><span class="n">start_element</span><span class="p">,</span> <span class="n">end_element</span><span class="p">,</span> <span class="n">boundary_inclusion</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.get_text_table_cells" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">get_text_table_cells</span><span class="p">(</span><span class="n">snap_tolerance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">join_tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_words_vertical</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_words_horizontal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">intersection_tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expand_bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Analyzes text alignment to find table cells and returns them as
temporary Region objects without adding them to the page.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>snap_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for snapping parallel lines.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>join_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for joining collinear lines.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_words_vertical</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum words needed to define a vertical line.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_words_horizontal</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum words needed to define a horizontal line.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intersection_tolerance</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for detecting line intersections.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expand_bbox</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary to expand the search area slightly beyond
         the region's exact bounds (e.g., {'left': 5, 'right': 5}).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to
      find_text_based_tables (e.g., specific x/y tolerances).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An ElementCollection containing temporary Region objects for each detected cell,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.collections.ElementCollection">ElementCollection</span>[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>or an empty ElementCollection if no cells are found or an error occurs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_text_table_cells</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">snap_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">join_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">min_words_vertical</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">min_words_horizontal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">intersection_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">expand_bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ElementCollection[Region]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyzes text alignment to find table cells and returns them as</span>
<span class="sd">    temporary Region objects without adding them to the page.</span>

<span class="sd">    Args:</span>
<span class="sd">        snap_tolerance: Tolerance for snapping parallel lines.</span>
<span class="sd">        join_tolerance: Tolerance for joining collinear lines.</span>
<span class="sd">        min_words_vertical: Minimum words needed to define a vertical line.</span>
<span class="sd">        min_words_horizontal: Minimum words needed to define a horizontal line.</span>
<span class="sd">        intersection_tolerance: Tolerance for detecting line intersections.</span>
<span class="sd">        expand_bbox: Optional dictionary to expand the search area slightly beyond</span>
<span class="sd">                     the region&#39;s exact bounds (e.g., {&#39;left&#39;: 5, &#39;right&#39;: 5}).</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to</span>
<span class="sd">                  find_text_based_tables (e.g., specific x/y tolerances).</span>

<span class="sd">    Returns:</span>
<span class="sd">        An ElementCollection containing temporary Region objects for each detected cell,</span>
<span class="sd">        or an empty ElementCollection if no cells are found or an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">natural_pdf.elements.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElementCollection</span>

    <span class="c1"># 1. Perform the analysis (or use cached results)</span>
    <span class="k">if</span> <span class="s2">&quot;text_table_structure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
        <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="s2">&quot;text_table_structure&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_text_table_cells: Using cached analysis results.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">analysis_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_text_table_structure</span><span class="p">(</span>
            <span class="n">snap_tolerance</span><span class="o">=</span><span class="n">snap_tolerance</span><span class="p">,</span>
            <span class="n">join_tolerance</span><span class="o">=</span><span class="n">join_tolerance</span><span class="p">,</span>
            <span class="n">min_words_vertical</span><span class="o">=</span><span class="n">min_words_vertical</span><span class="p">,</span>
            <span class="n">min_words_horizontal</span><span class="o">=</span><span class="n">min_words_horizontal</span><span class="p">,</span>
            <span class="n">intersection_tolerance</span><span class="o">=</span><span class="n">intersection_tolerance</span><span class="p">,</span>
            <span class="n">expand_bbox</span><span class="o">=</span><span class="n">expand_bbox</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># 2. Check if analysis was successful and cells were found</span>
    <span class="k">if</span> <span class="n">analysis_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysis_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No cells found by text table analysis.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">([])</span>  <span class="c1"># Return empty collection</span>

    <span class="c1"># 3. Create temporary Region objects for each cell dictionary</span>
    <span class="n">cell_regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cell_data</span> <span class="ow">in</span> <span class="n">analysis_results</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use page.region to create the region object</span>
            <span class="c1"># It expects left, top, right, bottom keys</span>
            <span class="n">cell_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="o">**</span><span class="n">cell_data</span><span class="p">)</span>

            <span class="c1"># Set metadata on the temporary region</span>
            <span class="n">cell_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>
            <span class="n">cell_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="s2">&quot;table-cell&quot;</span>
            <span class="n">cell_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;pdfplumber-text&quot;</span>
            <span class="n">cell_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;volatile&quot;</span>  <span class="c1"># Indicate it&#39;s not managed/persistent</span>
            <span class="n">cell_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Link back to the region it came from</span>

            <span class="n">cell_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_region</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create Region object for cell data </span><span class="si">{</span><span class="n">cell_data</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4. Return the list wrapped in an ElementCollection</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_text_table_cells: Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> temporary cell regions.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ElementCollection</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.highlight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_color_cycling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Highlight this region on the page.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional label for the highlight</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color tuple/string for the highlight, or None to use automatic color</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_color_cycling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Force color cycling even with no label (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_attrs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of attribute names to display on the highlight (e.g., ['confidence', 'type'])</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>existing</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to handle existing highlights ('append' or 'replace').</p>
              </div>
            </td>
            <td>
                  <code>&#39;append&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_color_cycling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">existing</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Highlight this region on the page.</span>

<span class="sd">    Args:</span>
<span class="sd">        label: Optional label for the highlight</span>
<span class="sd">        color: Color tuple/string for the highlight, or None to use automatic color</span>
<span class="sd">        use_color_cycling: Force color cycling even with no label (default: False)</span>
<span class="sd">        include_attrs: List of attribute names to display on the highlight (e.g., [&#39;confidence&#39;, &#39;type&#39;])</span>
<span class="sd">        existing: How to handle existing highlights (&#39;append&#39; or &#39;replace&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Access the highlighter service correctly</span>
    <span class="n">highlighter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_highlighter</span>

    <span class="c1"># Prepare common arguments</span>
    <span class="n">highlight_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;page_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
        <span class="s2">&quot;use_color_cycling&quot;</span><span class="p">:</span> <span class="n">use_color_cycling</span><span class="p">,</span>
        <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>  <span class="c1"># Pass the region itself so attributes can be accessed</span>
        <span class="s2">&quot;include_attrs&quot;</span><span class="p">:</span> <span class="n">include_attrs</span><span class="p">,</span>
        <span class="s2">&quot;existing&quot;</span><span class="p">:</span> <span class="n">existing</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Call the appropriate service method</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
        <span class="n">highlight_args</span><span class="p">[</span><span class="s2">&quot;polygon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span>
        <span class="n">highlighter</span><span class="o">.</span><span class="n">add_polygon</span><span class="p">(</span><span class="o">**</span><span class="n">highlight_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">highlight_args</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>
        <span class="n">highlighter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">**</span><span class="n">highlight_args</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.intersects" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Check if this region intersects with an element (any overlap).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>element</code>
            </td>
            <td>
                  <code><span title="natural_pdf.elements.base.Element">Element</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element to check</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the element overlaps with the region at all, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if this region intersects with an element (any overlap).</span>

<span class="sd">    Args:</span>
<span class="sd">        element: Element to check</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the element overlaps with the region at all, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if element is on the same page</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Ensure element has necessary attributes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

    <span class="c1"># For rectangular regions, check for bbox overlap</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
        <span class="p">)</span>

    <span class="c1"># For polygon regions, check if any corner of the element is inside the polygon</span>
    <span class="n">element_corners</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-left</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>  <span class="c1"># top-right</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-right</span>
        <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>  <span class="c1"># bottom-left</span>
    <span class="p">]</span>

    <span class="c1"># First check if any element corner is inside the polygon</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">element_corners</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Also check if any polygon corner is inside the element&#39;s rectangle</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Also check if any polygon edge intersects with any rectangle edge</span>
    <span class="c1"># This is a simplification - for complex cases, we&#39;d need a full polygon-rectangle</span>
    <span class="c1"># intersection algorithm</span>

    <span class="c1"># For now, return True if bounding boxes overlap (approximation for polygon-rectangle case)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">x0</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">top</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.is_element_center_inside" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">is_element_center_inside</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Check if the center point of an element's bounding box is inside this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>element</code>
            </td>
            <td>
                  <code><span title="natural_pdf.elements.base.Element">Element</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Element to check</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the element's center point is inside the region, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_element_center_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the center point of an element&#39;s bounding box is inside this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        element: Element to check</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the element&#39;s center point is inside the region, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if element is on the same page</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">page</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Ensure element has necessary attributes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Element </span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> lacks bounding box attributes. Cannot check center point.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Cannot determine position</span>

    <span class="c1"># Calculate center point</span>
    <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Use the existing is_point_inside check</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.is_point_inside" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">is_point_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Check if a point is inside this region using ray casting algorithm for polygons.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>X coordinate of the point</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Y coordinate of the point</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the point is inside the region</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_point_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a point is inside this region using ray casting algorithm for polygons.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: X coordinate of the point</span>
<span class="sd">        y: Y coordinate of the point</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the point is inside the region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span>

    <span class="c1"># Ray casting algorithm</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">x</span>
            <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">return</span> <span class="n">inside</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.left" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">left</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">include_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Select region to the left of this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width of the region to the left, in points</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height mode - "full" for full page height or "element" for element height</p>
              </div>
            </td>
            <td>
                  <code>&#39;full&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_source</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include this region in the result (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>until</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector string to specify a left boundary element</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_endpoint</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include the boundary element in the region (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object representing the area to the left</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
    <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select region to the left of this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        width: Width of the region to the left, in points</span>
<span class="sd">        height: Height mode - &quot;full&quot; for full page height or &quot;element&quot; for element height</span>
<span class="sd">        include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">        until: Optional selector string to specify a left boundary element</span>
<span class="sd">        include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">        **kwargs: Additional parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object representing the area to the left</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">cross_size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
        <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.right" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">right</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">include_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Select region to the right of this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Width of the region to the right, in points</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>height</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Height mode - "full" for full page height or "element" for element height</p>
              </div>
            </td>
            <td>
                  <code>&#39;full&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_source</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include this region in the result (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>until</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional selector string to specify a right boundary element</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_endpoint</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include the boundary element in the region (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Region object representing the area to the right</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
    <span class="n">include_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">until</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select region to the right of this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        width: Width of the region to the right, in points</span>
<span class="sd">        height: Height mode - &quot;full&quot; for full page height or &quot;element&quot; for element height</span>
<span class="sd">        include_source: Whether to include this region in the result (default: False)</span>
<span class="sd">        until: Optional selector string to specify a right boundary element</span>
<span class="sd">        include_endpoint: Whether to include the boundary element in the region (default: True)</span>
<span class="sd">        **kwargs: Additional parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        Region object representing the area to the right</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">(</span>
        <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">cross_size</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">include_source</span><span class="o">=</span><span class="n">include_source</span><span class="p">,</span>
        <span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">,</span>
        <span class="n">include_endpoint</span><span class="o">=</span><span class="n">include_endpoint</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Save the page with this region highlighted to an image file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the image to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend for labels</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the page with this region highlighted to an image file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to save the image to</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">        labels: Whether to include a legend for labels</span>
<span class="sd">        legend_position: Position of the legend</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

    <span class="c1"># Highlight this region if not already highlighted</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">highlight</span><span class="p">()</span>

    <span class="c1"># Save the highlighted image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.save_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Save an image of just this region to a file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the image to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only crop the region without highlighting its boundaries</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_highlights</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include existing highlights (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for page.to_image()</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save an image of just this region to a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to save the image to</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">        crop: If True, only crop the region without highlighting its boundaries</span>
<span class="sd">        include_highlights: Whether to include existing highlights (default: True)</span>
<span class="sd">        **kwargs: Additional parameters for page.to_image()</span>

<span class="sd">    Returns:</span>
<span class="sd">        Self for method chaining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

    <span class="c1"># Get the region image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="n">crop</span><span class="o">=</span><span class="n">crop</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save the image</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.show" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Show the page with just this region highlighted temporarily.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include a legend for labels</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>legend_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position of the legend</p>
              </div>
            </td>
            <td>
                  <code>&#39;right&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color to highlight this region (default: blue)</p>
              </div>
            </td>
            <td>
                  <code>&#39;blue&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional label for this region in the legend</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>width</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional width for the output image in pixels</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, crop the rendered image to this region's
        bounding box (with a small margin handled inside
        HighlightingService) before legends/overlays are added.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="PIL.Image.Image.Image">Image</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL Image of the page with only this region highlighted</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_position</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="c1"># Add a default color for standalone show</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add width parameter</span>
    <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># NEW: Crop output to region bounds before legend</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Image.Image&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show the page with just this region highlighted temporarily.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">        labels: Whether to include a legend for labels</span>
<span class="sd">        legend_position: Position of the legend</span>
<span class="sd">        color: Color to highlight this region (default: blue)</span>
<span class="sd">        label: Optional label for this region in the legend</span>
<span class="sd">        width: Optional width for the output image in pixels</span>
<span class="sd">        crop: If True, crop the rendered image to this region&#39;s</span>
<span class="sd">                    bounding box (with a small margin handled inside</span>
<span class="sd">                    HighlightingService) before legends/overlays are added.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL Image of the page with only this region highlighted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region must be associated with a page to show.&quot;</span><span class="p">)</span>

    <span class="c1"># Use the highlighting service via the page&#39;s property</span>
    <span class="n">service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">_highlighter</span>

    <span class="c1"># Determine the label if not provided</span>
    <span class="n">display_label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">label</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Region (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="k">else</span> <span class="s2">&quot;Region&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Prepare temporary highlight data for just this region</span>
    <span class="n">temp_highlight_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;page_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span>
        <span class="s2">&quot;polygon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_polygon</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>  <span class="c1"># Use provided or default color</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">display_label</span><span class="p">,</span>
        <span class="s2">&quot;use_color_cycling&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Explicitly false for single preview</span>
    <span class="p">}</span>

    <span class="c1"># Determine crop bbox if requested</span>
    <span class="n">crop_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="k">if</span> <span class="n">crop</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Use render_preview to show only this highlight</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">render_preview</span><span class="p">(</span>
        <span class="n">page_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">temporary_highlights</span><span class="o">=</span><span class="p">[</span><span class="n">temp_highlight_data</span><span class="p">],</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>  <span class="c1"># Pass the width parameter</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="n">legend_position</span><span class="p">,</span>
        <span class="n">crop_bbox</span><span class="o">=</span><span class="n">crop_bbox</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.to_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generate an image of just this region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>crop</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only crop the region without highlighting its boundaries</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_highlights</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include existing highlights (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional parameters for page.to_image()</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="PIL.Image.Image.Image">Image</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL Image of just this region</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_highlights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Image.Image&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an image of just this region.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolution: Resolution in DPI for rendering (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">        crop: If True, only crop the region without highlighting its boundaries</span>
<span class="sd">        include_highlights: Whether to include existing highlights (default: True)</span>
<span class="sd">        **kwargs: Additional parameters for page.to_image()</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL Image of just this region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

    <span class="c1"># Handle the case where user wants the cropped region to have a specific width</span>
    <span class="n">page_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">effective_resolution</span> <span class="o">=</span> <span class="n">resolution</span>  <span class="c1"># Start with the provided resolution</span>

    <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="s2">&quot;width&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">target_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
        <span class="c1"># Calculate what resolution is needed to make the region crop have target_width</span>
        <span class="n">region_width_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>  <span class="c1"># Region width in PDF points</span>

        <span class="k">if</span> <span class="n">region_width_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Calculate scale needed: target_width / region_width_points</span>
            <span class="n">required_scale</span> <span class="o">=</span> <span class="n">target_width</span> <span class="o">/</span> <span class="n">region_width_points</span>
            <span class="c1"># Convert scale to resolution: scale * 72 DPI</span>
            <span class="n">effective_resolution</span> <span class="o">=</span> <span class="n">required_scale</span> <span class="o">*</span> <span class="mf">72.0</span>
            <span class="n">page_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>  <span class="c1"># Remove width parameter to avoid conflicts</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Calculated required resolution </span><span class="si">{</span><span class="n">effective_resolution</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> DPI for region crop width </span><span class="si">{</span><span class="n">target_width</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Invalid region width </span><span class="si">{</span><span class="n">region_width_points</span><span class="si">}</span><span class="s2">, using original resolution&quot;</span>
            <span class="p">)</span>

    <span class="c1"># First get the full page image with highlights if requested</span>
    <span class="n">page_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">effective_resolution</span><span class="p">,</span>
        <span class="n">include_highlights</span><span class="o">=</span><span class="n">include_highlights</span><span class="p">,</span>
        <span class="o">**</span><span class="n">page_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the actual scale factor used by the page image</span>
    <span class="k">if</span> <span class="n">page_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">page_image</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page</span><span class="o">.</span><span class="n">width</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to resolution-based calculation if dimensions are invalid</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mf">72.0</span>

    <span class="c1"># Apply scaling to the coordinates</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>

    <span class="c1"># Ensure coords are valid for cropping (left &lt; right, top &lt; bottom)</span>
    <span class="k">if</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">x1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> resulted in non-positive width after scaling (</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">). Cannot create image.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">top</span> <span class="o">&gt;=</span> <span class="n">bottom</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> resulted in non-positive height after scaling (</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">bottom</span><span class="si">}</span><span class="s2">). Cannot create image.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Crop the image to just this region</span>
    <span class="n">region_image</span> <span class="o">=</span> <span class="n">page_image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>

    <span class="c1"># If not crop, add a border to highlight the region boundaries</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">crop</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageDraw</span>

        <span class="c1"># Create a 1px border around the region</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">region_image</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">region_image</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">region_image</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">outline</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">region_image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.to_text_element" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">to_text_element</span><span class="p">(</span><span class="n">text_content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_label</span><span class="o">=</span><span class="s1">&#39;derived_from_region&#39;</span><span class="p">,</span> <span class="n">object_type</span><span class="o">=</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="n">default_font_size</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">default_font_name</span><span class="o">=</span><span class="s1">&#39;RegionContent&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_to_page</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Creates a new TextElement object based on this region's geometry.</p>
<p>The text for the new TextElement can be provided directly,
generated by a callback function, or left as None.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>text_content</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="natural_pdf.Region (natural_pdf.elements.region.Region)" href="#natural_pdf.Region">Region</a>], <span title="typing.Optional">Optional</span>[<span title="str">str</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>If a string, this will be the text of the new TextElement.</li>
<li>If a callable, it will be called with this region instance
  and its return value (a string or None) will be the text.</li>
<li>If None (default), the TextElement's text will be None.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The 'source' attribute for the new TextElement.</p>
              </div>
            </td>
            <td>
                  <code>&#39;derived_from_region&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>object_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The 'object_type' for the TextElement's data dict
         (e.g., "word", "char").</p>
              </div>
            </td>
            <td>
                  <code>&#39;word&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_font_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Placeholder font size if text is generated.</p>
              </div>
            </td>
            <td>
                  <code>10.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_font_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Placeholder font name if text is generated.</p>
              </div>
            </td>
            <td>
                  <code>&#39;RegionContent&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Confidence score for the text. If text_content is None,
        defaults to 0.0. If text is provided/generated, defaults to 1.0
        unless specified.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_to_page</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the created TextElement will be added to the
         region's parent page. (Default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="natural_pdf.elements.text.TextElement">TextElement</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new TextElement instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the region does not have a valid 'page' attribute.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_text_element</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">text_content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Region&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">source_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;derived_from_region&quot;</span><span class="p">,</span>
    <span class="n">object_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>  <span class="c1"># Or &quot;char&quot;, controls how it&#39;s categorized</span>
    <span class="n">default_font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">default_font_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RegionContent&quot;</span><span class="p">,</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Allow overriding confidence</span>
    <span class="n">add_to_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># NEW: Option to add to page</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TextElement&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new TextElement object based on this region&#39;s geometry.</span>

<span class="sd">    The text for the new TextElement can be provided directly,</span>
<span class="sd">    generated by a callback function, or left as None.</span>

<span class="sd">    Args:</span>
<span class="sd">        text_content:</span>
<span class="sd">            - If a string, this will be the text of the new TextElement.</span>
<span class="sd">            - If a callable, it will be called with this region instance</span>
<span class="sd">              and its return value (a string or None) will be the text.</span>
<span class="sd">            - If None (default), the TextElement&#39;s text will be None.</span>
<span class="sd">        source_label: The &#39;source&#39; attribute for the new TextElement.</span>
<span class="sd">        object_type: The &#39;object_type&#39; for the TextElement&#39;s data dict</span>
<span class="sd">                     (e.g., &quot;word&quot;, &quot;char&quot;).</span>
<span class="sd">        default_font_size: Placeholder font size if text is generated.</span>
<span class="sd">        default_font_name: Placeholder font name if text is generated.</span>
<span class="sd">        confidence: Confidence score for the text. If text_content is None,</span>
<span class="sd">                    defaults to 0.0. If text is provided/generated, defaults to 1.0</span>
<span class="sd">                    unless specified.</span>
<span class="sd">        add_to_page: If True, the created TextElement will be added to the</span>
<span class="sd">                     region&#39;s parent page. (Default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new TextElement instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the region does not have a valid &#39;page&#39; attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">actual_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">actual_text</span> <span class="o">=</span> <span class="n">text_content</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">text_content</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">actual_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error executing text_content callback for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">actual_text</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensure actual_text is None on error</span>

    <span class="n">final_confidence</span> <span class="o">=</span> <span class="n">confidence</span>
    <span class="k">if</span> <span class="n">final_confidence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_confidence</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">actual_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">actual_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region must have a valid &#39;page&#39; attribute to create a TextElement.&quot;</span><span class="p">)</span>

    <span class="c1"># Create character dictionaries for the text</span>
    <span class="n">char_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">actual_text</span><span class="p">:</span>
        <span class="c1"># Create a single character dict that spans the entire region</span>
        <span class="c1"># This is a simplified approach - OCR engines typically create one per character</span>
        <span class="n">char_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">actual_text</span><span class="p">,</span>
            <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
            <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span>
            <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
            <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="n">default_font_name</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">default_font_size</span><span class="p">,</span>
            <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;adv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_label</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
            <span class="s2">&quot;stroking_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">char_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_dict</span><span class="p">)</span>

    <span class="n">elem_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">actual_text</span><span class="p">,</span>
        <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span>
        <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="s2">&quot;object_type&quot;</span><span class="p">:</span> <span class="n">object_type</span><span class="p">,</span>
        <span class="s2">&quot;page_number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">,</span>
        <span class="s2">&quot;stroking_color&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stroking_color&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;non_stroking_color&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="s2">&quot;fontname&quot;</span><span class="p">:</span> <span class="n">default_font_name</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">default_font_size</span><span class="p">,</span>
        <span class="s2">&quot;upright&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;adv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_label</span><span class="p">,</span>
        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
        <span class="s2">&quot;_char_dicts&quot;</span><span class="p">:</span> <span class="n">char_dicts</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">text_element</span> <span class="o">=</span> <span class="n">TextElement</span><span class="p">(</span><span class="n">elem_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">add_to_page</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;_element_mgr&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_as_type</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;words&quot;</span>
                <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span>
                <span class="k">else</span> <span class="s2">&quot;chars&quot;</span> <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span> <span class="k">else</span> <span class="n">object_type</span>
            <span class="p">)</span>
            <span class="c1"># REMOVED try-except block around add_element</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">text_element</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="n">add_as_type</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;TextElement created from region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> and added to page </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">add_as_type</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Also add character dictionaries to the chars collection</span>
            <span class="k">if</span> <span class="n">char_dicts</span> <span class="ow">and</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">char_dict</span> <span class="ow">in</span> <span class="n">char_dicts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">_element_mgr</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">char_dict</span><span class="p">,</span> <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;chars&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page_num_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">page_number</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;page_number&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot add TextElement to page: Page </span><span class="si">{</span><span class="n">page_num_str</span><span class="si">}</span><span class="s2"> for region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> is missing &#39;_element_mgr&#39;.&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">text_element</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="natural_pdf.Region.trim" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pre_shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Trim visual whitespace from the edges of this region.</p>
<p>Similar to Python's string .strip() method, but for visual whitespace in the region image.
Uses pixel analysis to detect rows/columns that are predominantly whitespace.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>padding</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of pixels to keep as padding after trimming (default: 1)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for considering a row/column as whitespace (0.0-1.0, default: 0.95)
      Higher values mean more strict whitespace detection.
      E.g., 0.95 means if 95% of pixels in a row/column are white, consider it whitespace.</p>
              </div>
            </td>
            <td>
                  <code>0.95</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution for image rendering in DPI (default: uses global options, fallback to 144 DPI)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pre_shrink</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amount to shrink region before trimming, then expand back after (default: 0.5)
       This helps avoid detecting box borders/slivers as content.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
      </tbody>
    </table>
        <h6 id="natural_pdf.Region.trim--returns">Returns</h6>
<p>New Region with visual whitespace trimmed from all edges</p>
<h6 id="natural_pdf.Region.trim--examples">Examples</h6>
<div class="highlight"><pre><span></span><code><span class="c1"># Basic trimming with 1 pixel padding and 0.5px pre-shrink</span>
<span class="n">trimmed</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>

<span class="c1"># More aggressive trimming with no padding and no pre-shrink</span>
<span class="n">tight</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">pre_shrink</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Conservative trimming with more padding</span>
<span class="n">loose</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/elements/region.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_shrink</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Region&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trim visual whitespace from the edges of this region.</span>

<span class="sd">    Similar to Python&#39;s string .strip() method, but for visual whitespace in the region image.</span>
<span class="sd">    Uses pixel analysis to detect rows/columns that are predominantly whitespace.</span>

<span class="sd">    Args:</span>
<span class="sd">        padding: Number of pixels to keep as padding after trimming (default: 1)</span>
<span class="sd">        threshold: Threshold for considering a row/column as whitespace (0.0-1.0, default: 0.95)</span>
<span class="sd">                  Higher values mean more strict whitespace detection.</span>
<span class="sd">                  E.g., 0.95 means if 95% of pixels in a row/column are white, consider it whitespace.</span>
<span class="sd">        resolution: Resolution for image rendering in DPI (default: uses global options, fallback to 144 DPI)</span>
<span class="sd">        pre_shrink: Amount to shrink region before trimming, then expand back after (default: 0.5)</span>
<span class="sd">                   This helps avoid detecting box borders/slivers as content.</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>

<span class="sd">    New Region with visual whitespace trimmed from all edges</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    ```python</span>
<span class="sd">    # Basic trimming with 1 pixel padding and 0.5px pre-shrink</span>
<span class="sd">    trimmed = region.trim()</span>

<span class="sd">    # More aggressive trimming with no padding and no pre-shrink</span>
<span class="sd">    tight = region.trim(padding=0, threshold=0.9, pre_shrink=0)</span>

<span class="sd">    # Conservative trimming with more padding</span>
<span class="sd">    loose = region.trim(padding=3, threshold=0.98)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply global options as defaults</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">natural_pdf</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">natural_pdf</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="mi">144</span>  <span class="c1"># Default resolution when none specified</span>

    <span class="c1"># Pre-shrink the region to avoid box slivers</span>
    <span class="n">work_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">left</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">right</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">top</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=-</span><span class="n">pre_shrink</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pre_shrink</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="bp">self</span>
    <span class="p">)</span>

    <span class="c1"># Get the region image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">work_region</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_highlights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Could not generate image for trimming. Returning original region.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Convert to grayscale for easier analysis</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="c1"># Convert PIL image to numpy array</span>
    <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">))</span>  <span class="c1"># Convert to grayscale</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Image has zero dimensions. Returning original region.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Normalize pixel values to 0-1 range (255 = white = 1.0, 0 = black = 0.0)</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

    <span class="c1"># Find content boundaries by analyzing row and column averages</span>

    <span class="c1"># Analyze rows (horizontal strips) to find top and bottom boundaries</span>
    <span class="n">row_averages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average each row</span>
    <span class="n">content_rows</span> <span class="o">=</span> <span class="n">row_averages</span> <span class="o">&lt;</span> <span class="n">threshold</span>  <span class="c1"># True where there&#39;s content (not whitespace)</span>

    <span class="c1"># Find first and last rows with content</span>
    <span class="n">content_row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">content_rows</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_row_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No content found, return a minimal region at the center</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No content detected during trimming. Returning center point.&quot;</span>
        <span class="p">)</span>
        <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">))</span>

    <span class="n">top_content_row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content_row_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">)</span>
    <span class="n">bottom_content_row</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content_row_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>

    <span class="c1"># Analyze columns (vertical strips) to find left and right boundaries</span>
    <span class="n">col_averages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Average each column</span>
    <span class="n">content_cols</span> <span class="o">=</span> <span class="n">col_averages</span> <span class="o">&lt;</span> <span class="n">threshold</span>  <span class="c1"># True where there&#39;s content</span>

    <span class="n">content_col_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">content_cols</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_col_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No content found in columns either</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: No column content detected during trimming. Returning center point.&quot;</span>
        <span class="p">)</span>
        <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">))</span>

    <span class="n">left_content_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content_col_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">)</span>
    <span class="n">right_content_col</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content_col_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>

    <span class="c1"># Convert trimmed pixel coordinates back to PDF coordinates</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mf">72.0</span>  <span class="c1"># Scale factor used in to_image()</span>

    <span class="c1"># Calculate new PDF coordinates and ensure they are Python floats</span>
    <span class="n">trimmed_x0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">left_content_col</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">))</span>
    <span class="n">trimmed_top</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">top_content_row</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">))</span>
    <span class="n">trimmed_x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">work_region</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="p">((</span><span class="n">right_content_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># +1 because we want inclusive right edge</span>
    <span class="n">trimmed_bottom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">work_region</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="p">((</span><span class="n">bottom_content_row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># +1 because we want inclusive bottom edge</span>

    <span class="c1"># Ensure the trimmed region doesn&#39;t exceed the work region boundaries</span>
    <span class="n">final_x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">trimmed_x0</span><span class="p">)</span>
    <span class="n">final_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">trimmed_top</span><span class="p">)</span>
    <span class="n">final_x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">trimmed_x1</span><span class="p">)</span>
    <span class="n">final_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">work_region</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">trimmed_bottom</span><span class="p">)</span>

    <span class="c1"># Ensure valid coordinates (width &gt; 0, height &gt; 0)</span>
    <span class="k">if</span> <span class="n">final_x1</span> <span class="o">&lt;=</span> <span class="n">final_x0</span> <span class="ow">or</span> <span class="n">final_bottom</span> <span class="o">&lt;=</span> <span class="n">final_top</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trimming resulted in invalid dimensions. Returning original region.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Create the trimmed region</span>
    <span class="n">trimmed_region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">final_x0</span><span class="p">,</span> <span class="n">final_top</span><span class="p">,</span> <span class="n">final_x1</span><span class="p">,</span> <span class="n">final_bottom</span><span class="p">))</span>

    <span class="c1"># Expand back by the pre_shrink amount to restore original positioning</span>
    <span class="k">if</span> <span class="n">pre_shrink</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">trimmed_region</span> <span class="o">=</span> <span class="n">trimmed_region</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">pre_shrink</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">pre_shrink</span>
        <span class="p">)</span>

    <span class="c1"># Copy relevant metadata</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">region_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_type</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">normalized_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_type</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;trimmed&quot;</span>  <span class="c1"># Indicate this is a derived region</span>
    <span class="n">trimmed_region</span><span class="o">.</span><span class="n">parent_region</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2">: Trimmed to </span><span class="si">{</span><span class="n">trimmed_region</span><span class="o">.</span><span class="n">bbox</span><span class="si">}</span><span class="s2"> (padding=</span><span class="si">{</span><span class="n">padding</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">, pre_shrink=</span><span class="si">{</span><span class="n">pre_shrink</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">trimmed_region</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h4 id="natural_pdf-functions">Functions</h4>

<div class="doc doc-object doc-function">


<h5 id="natural_pdf.configure_logging" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">natural_pdf</span><span class="o">.</span><span class="n">configure_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Configure logging for the natural_pdf package.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>level</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logging level (e.g., logging.INFO, logging.DEBUG)</p>
              </div>
            </td>
            <td>
                  <code><span title="logging.INFO">INFO</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>handler</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional custom handler. Defaults to a StreamHandler.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>natural_pdf/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">configure_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure logging for the natural_pdf package.</span>

<span class="sd">    Args:</span>
<span class="sd">        level: Logging level (e.g., logging.INFO, logging.DEBUG)</span>
<span class="sd">        handler: Optional custom handler. Defaults to a StreamHandler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Avoid adding duplicate handlers</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023-2025 Jonathan Soma
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jsoma/natural-pdf" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/natural-pdf/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "navigation.tracking", "navigation.instant", "navigation.indexes", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy", "content.code.annotate", "toc.follow"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>